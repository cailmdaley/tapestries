{
  "nodes": [
    {
      "id": "act-vs-spt-cross-spectra-b4181199",
      "title": "ACT vs SPT: same galaxies, same spectrum",
      "kind": "task",
      "status": "closed",
      "body": "The same Euclid shear field crossed with two independent CMB lensing reconstructions — ACT DR6 and SPT-3G GMV — should yield the same cross-spectrum. Differences would indicate CMB-side systematics.\n\nThe 6-panel spectral overlay (lensmc baseline) shows ACT and SPT tracking each other across all bins and multipoles. SPT error bars widen at low ℓ where its smaller sky area limits the mode count; at high ℓ the two converge. All 6 bins pass the shape consistency test (median chi2/dof = 0.86, median PTE = 0.63, 0 failures at 5%).\n\nThe agreement holds despite different *amplitudes* relative to theory (A_lens = 0.93 vs 0.76). The chi2 test compares shape, not normalization — it cannot detect a uniform multiplicative offset. The SPT deficit is a ~24% suppression, consistent with a CMB-side calibration factor rather than ℓ-dependent systematics.\n\nA subtlety: ACT is contaminated by stellar density and galactic extinction ([bias budget](.felt/systematic-bias-budget-709ea507.md): significance up to 8σ), while SPT is clean (<0.1σ after marginalization). The contamination has the same sign as the signal, inflating ACT's normalization while preserving shape consistency with SPT.\n\nMethod-independence test (lensmc vs metacal): [method comparison](.felt/lensmc-vs-metacal-method-7d4d724f.md). SPT estimator variants: [SPT estimators](.felt/spt-estimator-comparison-gmv-vs-7f4cef00.md).\n\n## Comments\n**2026-02-16 00:39** — ACT vs SPT comparison plot needs proper xlims — current axis range doesn't show the data well.",
      "outcome": "ACT and SPT cross-spectra are fully consistent: 14/14 pass at 5% level, median PTE=0.639, median chi2/dof=0.86. No evidence of CMB-side systematics. Evidence + plots co-located at results/claims/plot_act_vs_spt/.",
      "tags": [
        "tapestry:plot_act_vs_spt",
        "region:validation:consistency"
      ],
      "createdAt": "2026-02-14T17:53:30.673248363+01:00",
      "closedAt": "2026-02-16T01:51:07.325300787+01:00",
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654",
        "act-dr6-lensing-e4a3eae9",
        "spt-3g-winter-lensing-ab712d17"
      ],
      "specName": "plot_act_vs_spt",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_comparisons": 21,
          "n_with_pte": 21,
          "n_consistent_5pct": 21,
          "median_pte": 0.657,
          "min_pte": 0.0864,
          "median_chi2_per_dof": 0.84
        },
        "artifacts": {
          "act_vs_spt_composite": "act_vs_spt_composite.png",
          "act_vs_spt_density_bin1": "act_vs_spt_density_bin1.png",
          "act_vs_spt_density_bin2": "act_vs_spt_density_bin2.png",
          "act_vs_spt_density_bin3": "act_vs_spt_density_bin3.png",
          "act_vs_spt_density_bin4": "act_vs_spt_density_bin4.png",
          "act_vs_spt_density_bin5": "act_vs_spt_density_bin5.png",
          "act_vs_spt_density_bin6": "act_vs_spt_density_bin6.png",
          "act_vs_spt_density_binall": "act_vs_spt_density_binall.png",
          "act_vs_spt_lensmc_bin1": "act_vs_spt_lensmc_bin1.png",
          "act_vs_spt_lensmc_bin2": "act_vs_spt_lensmc_bin2.png",
          "act_vs_spt_lensmc_bin3": "act_vs_spt_lensmc_bin3.png",
          "act_vs_spt_lensmc_bin4": "act_vs_spt_lensmc_bin4.png",
          "act_vs_spt_lensmc_bin5": "act_vs_spt_lensmc_bin5.png",
          "act_vs_spt_lensmc_bin6": "act_vs_spt_lensmc_bin6.png",
          "act_vs_spt_lensmc_binall": "act_vs_spt_lensmc_binall.png",
          "act_vs_spt_metacal_bin1": "act_vs_spt_metacal_bin1.png",
          "act_vs_spt_metacal_bin2": "act_vs_spt_metacal_bin2.png",
          "act_vs_spt_metacal_bin3": "act_vs_spt_metacal_bin3.png",
          "act_vs_spt_metacal_bin4": "act_vs_spt_metacal_bin4.png",
          "act_vs_spt_metacal_bin5": "act_vs_spt_metacal_bin5.png",
          "act_vs_spt_metacal_bin6": "act_vs_spt_metacal_bin6.png",
          "act_vs_spt_metacal_binall": "act_vs_spt_metacal_binall.png"
        },
        "mtime": 1771437885000,
        "generated": "2026-02-18T18:04:40.376091+00:00"
      }
    },
    {
      "id": "lensmc-vs-metacal-method-7d4d724f",
      "title": "lensmc vs metacal: pipeline independence",
      "kind": "task",
      "status": "closed",
      "body": "Two independent shear measurement pipelines — lensmc (forward-model PSF fitting) and metacal (metacalibration with sheared images) — process the same galaxies in different ways. If their cross-spectra with CMB κ agree, neither introduces a measurement-specific bias.\n\nThe 6-panel spectral overlay (ACT baseline) makes the agreement visible: blue lensmc and orange metacal data points sit on top of each other in every bin, with fractional differences scattering around zero in the sub-panels. The residuals are mostly within ±10% even at noisy bandpowers. Median chi2/dof = 0.14 — suspiciously tight, but expected. The two methods share the *same galaxies* and the *same CMB map*, so their noise is highly correlated. The Knox formula assumes independent noise realizations; applied to the difference of correlated measurements it dramatically overestimates the variance, deflating chi2. This test confirms consistency but has limited discriminating power. A proper test would need a covariance for the difference spectrum accounting for shared noise.\n\nDespite producing consistent cross-spectra, the two methods couple differently to systematic contamination. After template marginalization, lensmc retains 75% of its raw S/N (20σ → 15σ) while metacal retains 69% (19σ → 13σ). The different shear weight maps couple differently to spatially-varying systematics. Both methods give consistent final results, but lensmc is preferable for contamination-sensitive analyses.",
      "outcome": "Method-comparison plotting is now composite-only: per-bin/per-experiment figure generation was removed from the DAG, and the rule-level claim is driven by a single 6-bin ACT baseline composite plus aggregate evidence. On February 23, 2026 this rerun gave 6 comparisons, median chi2/dof = 1.761, median PTE = 0.139, with 3/6 bins passing PTE >= 0.05 (results/claims/plot_method_comparison/evidence.json). The method agreement remains acceptable, but no longer reads as \"too perfect\" under the current statistic definition.\n\nThe composite still shows tight tracking between lensmc and metacal in each tomographic bin. The pipeline conclusion stays the same: no strong evidence for method-specific shear bias in cross-correlation with CMB kappa. What changed is presentation and statistical calibration: the pipeline now reports one legible figure and one rule-level evidence file, rather than a wildcard gallery and dozens of sidecar evidence files that collaborators do not consume.\n\nThis formalization reduces exploration clutter and aligns the rule with the constitution principle that plot outputs should be compressed into collaborator-readable composites. A remaining technical caveat is that the consistency statistic still uses diagonal-error approximations and does not model full shared-noise covariance between methods.",
      "tags": [
        "tapestry:plot_method_comparison",
        "region:validation:consistency"
      ],
      "createdAt": "2026-02-14T17:56:14.761701369+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654"
      ],
      "specName": "plot_method_comparison",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_comparisons": 6,
          "n_with_pte": 6,
          "n_consistent_5pct": 3,
          "median_pte": 0.139,
          "median_chi2_per_dof": 1.761
        },
        "artifacts": {
          "method_comparison_bin1_x_act": "method_comparison_bin1_x_act.png",
          "method_comparison_bin1_x_spt_winter_gmv": "method_comparison_bin1_x_spt_winter_gmv.png",
          "method_comparison_bin1_x_spt_winter_mv": "method_comparison_bin1_x_spt_winter_mv.png",
          "method_comparison_bin1_x_spt_winter_pp": "method_comparison_bin1_x_spt_winter_pp.png",
          "method_comparison_bin1_x_spt_winter_tt": "method_comparison_bin1_x_spt_winter_tt.png",
          "method_comparison_bin2_x_act": "method_comparison_bin2_x_act.png",
          "method_comparison_bin2_x_spt_winter_gmv": "method_comparison_bin2_x_spt_winter_gmv.png",
          "method_comparison_bin2_x_spt_winter_mv": "method_comparison_bin2_x_spt_winter_mv.png",
          "method_comparison_bin2_x_spt_winter_pp": "method_comparison_bin2_x_spt_winter_pp.png",
          "method_comparison_bin2_x_spt_winter_tt": "method_comparison_bin2_x_spt_winter_tt.png",
          "method_comparison_bin3_x_act": "method_comparison_bin3_x_act.png",
          "method_comparison_bin3_x_spt_winter_gmv": "method_comparison_bin3_x_spt_winter_gmv.png",
          "method_comparison_bin3_x_spt_winter_mv": "method_comparison_bin3_x_spt_winter_mv.png",
          "method_comparison_bin3_x_spt_winter_pp": "method_comparison_bin3_x_spt_winter_pp.png",
          "method_comparison_bin3_x_spt_winter_tt": "method_comparison_bin3_x_spt_winter_tt.png",
          "method_comparison_bin4_x_act": "method_comparison_bin4_x_act.png",
          "method_comparison_bin4_x_spt_winter_gmv": "method_comparison_bin4_x_spt_winter_gmv.png",
          "method_comparison_bin4_x_spt_winter_mv": "method_comparison_bin4_x_spt_winter_mv.png",
          "method_comparison_bin4_x_spt_winter_pp": "method_comparison_bin4_x_spt_winter_pp.png",
          "method_comparison_bin4_x_spt_winter_tt": "method_comparison_bin4_x_spt_winter_tt.png",
          "method_comparison_bin5_x_act": "method_comparison_bin5_x_act.png",
          "method_comparison_bin5_x_spt_winter_gmv": "method_comparison_bin5_x_spt_winter_gmv.png",
          "method_comparison_bin5_x_spt_winter_mv": "method_comparison_bin5_x_spt_winter_mv.png",
          "method_comparison_bin5_x_spt_winter_pp": "method_comparison_bin5_x_spt_winter_pp.png",
          "method_comparison_bin5_x_spt_winter_tt": "method_comparison_bin5_x_spt_winter_tt.png",
          "method_comparison_bin6_x_act": "method_comparison_bin6_x_act.png",
          "method_comparison_bin6_x_spt_winter_gmv": "method_comparison_bin6_x_spt_winter_gmv.png",
          "method_comparison_bin6_x_spt_winter_mv": "method_comparison_bin6_x_spt_winter_mv.png",
          "method_comparison_bin6_x_spt_winter_pp": "method_comparison_bin6_x_spt_winter_pp.png",
          "method_comparison_bin6_x_spt_winter_tt": "method_comparison_bin6_x_spt_winter_tt.png",
          "method_comparison_binall_x_act": "method_comparison_binall_x_act.png",
          "method_comparison_binall_x_spt_winter_gmv": "method_comparison_binall_x_spt_winter_gmv.png",
          "method_comparison_binall_x_spt_winter_mv": "method_comparison_binall_x_spt_winter_mv.png",
          "method_comparison_binall_x_spt_winter_pp": "method_comparison_binall_x_spt_winter_pp.png",
          "method_comparison_binall_x_spt_winter_tt": "method_comparison_binall_x_spt_winter_tt.png",
          "method_comparison_composite": "method_comparison_composite.png"
        },
        "mtime": 1771813567000,
        "generated": "2026-02-23T02:25:57.129322+00:00"
      }
    },
    {
      "id": "theory-comparison-data-d5cc9678",
      "title": "Theory comparison: Planck 2018 predicts the ACT signal",
      "kind": "task",
      "status": "closed",
      "body": "The [signal overview](.felt/signal-overview-act-spt-theory-1ae2798f.md) shows data against vanilla Planck ΛCDM. Here we add the full theory: ΛCDM + NLA intrinsic alignment (A_IA=1.72, η=-0.41 from Euclid pipeline defaults — [NLA model](.felt/nla-intrinsic-alignment-theory-57e37bd1.md)). Both curves are predictions, not fits: cosmology from Planck, IA from Euclid, binned through NaMaster bandpower windows.\n\nThe plot shows two theory lines per bin: vanilla Planck 2018 (black) and NLA IA (crimson dashed). The IA correction suppresses the prediction by 4-36% depending on redshift — largest at low-z where the GI term geometry is most favorable.\n\n**ACT is consistent with standard theory.** Joint chi2 = 106/120 (PTE 0.82) against the NLA prediction. The vanilla prediction slightly overshoots — adding standard IA brings it into line. This isn't a fit; it's a prediction matching data.\n\n**SPT shows a 24% deficit.** Joint chi2 = 226/120 (PTE ≈ 0). Data sits below both theory curves. The deficit is method-independent (lensmc ≈ metacal), scale-dependent (worse at high ℓ — [ℓ-range robustness](.felt/ℓ-range-robustness-amplitude-e86f1728.md)), and absent from ACT. CMB-side normalization issue, characterized in [theory residuals](.felt/theory-residual-analysis-6a66a995.md).\n\n**Script**: `cmbx/files/workflow_scripts_plot_theory_comparison.py`",
      "outcome": "ACT consistent with Planck 2018 ΛCDM + standard NLA IA (PTE 0.82). SPT shows 24% normalization deficit (PTE≈0), method-independent, CMB-side. Shown: lensmc × {ACT, SPT GMV} — metacal and SPT variants covered by method_comparison and spt_estimator nodes.",
      "tags": [
        "tapestry:plot_theory_comparison",
        "region:validation:theory"
      ],
      "createdAt": "2026-02-14T18:12:56.825270269+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "results-detection-and-90f2ec1b",
        "act-dr6-lensing-e4a3eae9",
        "spt-3g-winter-lensing-ab712d17"
      ],
      "specName": "plot_theory_comparison",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_comparisons": 6,
          "n_with_pte": 6,
          "n_consistent_5pct": 3,
          "median_pte": 0.142,
          "median_chi2_per_dof": 1.17,
          "ia_n_with_pte": 4,
          "ia_n_consistent_5pct": 2,
          "ia_median_pte": 0.291,
          "ia_median_chi2_per_dof": 18.89,
          "ia_model": "NLA-z (A_IA=1.72, eta=-0.41)"
        },
        "artifacts": {
          "theory_comparison_density_x_act": "theory_comparison_density_x_act.png",
          "theory_comparison_density_x_spt_winter_gmv": "theory_comparison_density_x_spt_winter_gmv.png",
          "theory_comparison_lensmc_x_act": "theory_comparison_lensmc_x_act.png",
          "theory_comparison_lensmc_x_spt_winter_gmv": "theory_comparison_lensmc_x_spt_winter_gmv.png",
          "theory_comparison_lensmc_x_spt_winter_mv": "theory_comparison_lensmc_x_spt_winter_mv.png",
          "theory_comparison_lensmc_x_spt_winter_pp": "theory_comparison_lensmc_x_spt_winter_pp.png",
          "theory_comparison_lensmc_x_spt_winter_tt": "theory_comparison_lensmc_x_spt_winter_tt.png",
          "theory_comparison_metacal_x_act": "theory_comparison_metacal_x_act.png",
          "theory_comparison_metacal_x_spt_winter_gmv": "theory_comparison_metacal_x_spt_winter_gmv.png",
          "theory_comparison_metacal_x_spt_winter_mv": "theory_comparison_metacal_x_spt_winter_mv.png",
          "theory_comparison_metacal_x_spt_winter_pp": "theory_comparison_metacal_x_spt_winter_pp.png",
          "theory_comparison_metacal_x_spt_winter_tt": "theory_comparison_metacal_x_spt_winter_tt.png"
        },
        "mtime": 1771437883000,
        "generated": "2026-02-18T18:04:12.731894+00:00"
      }
    },
    {
      "id": "contamination-metric-product-c-e55501f4",
      "title": "Contamination metric: small per bandpower, dangerous in aggregate",
      "kind": "task",
      "status": "closed",
      "body": "The contamination metric X^f_S(ℓ) = C^{κS} · C^{fS} / C^{SS} (DES×SPT, 2203.12440 §A.4) quantifies the bias from a systematic that correlates with both tracers simultaneously. X has the same units as the signal C^{fκ} and can be compared directly to the measurement uncertainty.\n\nThe composite figure shows X(ℓ) for all five systematics crossed with the two baseline CMB reconstructions (ACT and SPT-GMV). Six redshift bins overlaid per panel; gray bands mark 1% and 10% of the Knox uncertainty. Per bandpower, all contamination metrics sit within or below the 1% band. Even galactic extinction, which individually contaminates both κ (chi2 ~ 49–69/20) and shear (chi2/dof up to 9), produces sub-percent per-bandpower bias.\n\nHowever, per-bandpower smallness does not guarantee negligible integrated bias. Twenty bandpowers each contributing <1% can integrate to a multi-σ shift. The C^{SS} denominator carries noise bias from downgrading sparse systematic maps (nside 16384→2048), making X a lower bound. The [bias budget](.felt/systematic-bias-budget-709ea507.md) integrates over multipoles: stellar density reaches 4.4σ and galactic extinction 3.7σ for ACT. Where the budget flags significant bias, [template marginalization](.felt/template-deprojection-a1621797.md) handles it.",
      "outcome": "Per-bandpower contamination metric X = C^{κS}·C^{fS}/C^{SS} sits below 1% of signal uncertainty for all five systematics across all CMB estimators. However, the integrated bias significance (tapestry:plot_systematic_budget) reaches multi-σ levels for stellar density and galactic extinction — per-bandpower smallness does not guarantee negligible integrated bias.",
      "tags": [
        "tapestry:plot_contamination_metric",
        "region:validation:contamination"
      ],
      "createdAt": "2026-02-14T18:13:15.758141608+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-null-test-heatmap-92dec7e5",
        "systematic-maps-on-the-sky-83122c03",
        "systematic-contamination-summary-e6c81e29"
      ],
      "specName": "plot_contamination_metric",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_plots": 118,
          "metric_type": "full_X",
          "n_systematics": 11,
          "dominant_systematic": "galactic_extinction",
          "per_systematic_max": {
            "stellar_density": "4.8e-07",
            "galactic_extinction": "4.8e-07",
            "exposures": "4.8e-07",
            "zodiacal_light": "0.0e+00",
            "saa": "3.3e-09",
            "psf": "4.0e-09",
            "noise": "3.9e-09",
            "persistence": "3.8e-09",
            "star_brightness_mean": "4.1e-09",
            "galaxy_number_density": "4.4e-09",
            "phz_quality": "5.1e-09"
          }
        },
        "artifacts": {
          "contamination_composite_lensmc": "contamination_composite_lensmc.png",
          "contamination_composite_metacal": "contamination_composite_metacal.png",
          "contamination_exposures_density_x_act": "contamination_exposures_density_x_act.png",
          "contamination_exposures_density_x_spt_winter_gmv": "contamination_exposures_density_x_spt_winter_gmv.png",
          "contamination_exposures_lensmc_x_act": "contamination_exposures_lensmc_x_act.png",
          "contamination_exposures_lensmc_x_spt_winter_gmv": "contamination_exposures_lensmc_x_spt_winter_gmv.png",
          "contamination_exposures_lensmc_x_spt_winter_mv": "contamination_exposures_lensmc_x_spt_winter_mv.png",
          "contamination_exposures_lensmc_x_spt_winter_pp": "contamination_exposures_lensmc_x_spt_winter_pp.png",
          "contamination_exposures_lensmc_x_spt_winter_tt": "contamination_exposures_lensmc_x_spt_winter_tt.png",
          "contamination_exposures_metacal_x_act": "contamination_exposures_metacal_x_act.png",
          "contamination_exposures_metacal_x_spt_winter_gmv": "contamination_exposures_metacal_x_spt_winter_gmv.png",
          "contamination_exposures_metacal_x_spt_winter_mv": "contamination_exposures_metacal_x_spt_winter_mv.png",
          "contamination_exposures_metacal_x_spt_winter_pp": "contamination_exposures_metacal_x_spt_winter_pp.png",
          "contamination_exposures_metacal_x_spt_winter_tt": "contamination_exposures_metacal_x_spt_winter_tt.png",
          "contamination_galactic_extinction_density_x_act": "contamination_galactic_extinction_density_x_act.png",
          "contamination_galactic_extinction_density_x_spt_winter_gmv": "contamination_galactic_extinction_density_x_spt_winter_gmv.png",
          "contamination_galactic_extinction_lensmc_x_act": "contamination_galactic_extinction_lensmc_x_act.png",
          "contamination_galactic_extinction_lensmc_x_spt_winter_gmv": "contamination_galactic_extinction_lensmc_x_spt_winter_gmv.png",
          "contamination_galactic_extinction_lensmc_x_spt_winter_mv": "contamination_galactic_extinction_lensmc_x_spt_winter_mv.png",
          "contamination_galactic_extinction_lensmc_x_spt_winter_pp": "contamination_galactic_extinction_lensmc_x_spt_winter_pp.png",
          "contamination_galactic_extinction_lensmc_x_spt_winter_tt": "contamination_galactic_extinction_lensmc_x_spt_winter_tt.png",
          "contamination_galactic_extinction_metacal_x_act": "contamination_galactic_extinction_metacal_x_act.png",
          "contamination_galactic_extinction_metacal_x_spt_winter_gmv": "contamination_galactic_extinction_metacal_x_spt_winter_gmv.png",
          "contamination_galactic_extinction_metacal_x_spt_winter_mv": "contamination_galactic_extinction_metacal_x_spt_winter_mv.png",
          "contamination_galactic_extinction_metacal_x_spt_winter_pp": "contamination_galactic_extinction_metacal_x_spt_winter_pp.png",
          "contamination_galactic_extinction_metacal_x_spt_winter_tt": "contamination_galactic_extinction_metacal_x_spt_winter_tt.png",
          "contamination_galaxy_number_density_lensmc_x_act": "contamination_galaxy_number_density_lensmc_x_act.png",
          "contamination_galaxy_number_density_lensmc_x_spt_winter_gmv": "contamination_galaxy_number_density_lensmc_x_spt_winter_gmv.png",
          "contamination_galaxy_number_density_lensmc_x_spt_winter_mv": "contamination_galaxy_number_density_lensmc_x_spt_winter_mv.png",
          "contamination_galaxy_number_density_lensmc_x_spt_winter_pp": "contamination_galaxy_number_density_lensmc_x_spt_winter_pp.png",
          "contamination_galaxy_number_density_lensmc_x_spt_winter_tt": "contamination_galaxy_number_density_lensmc_x_spt_winter_tt.png",
          "contamination_galaxy_number_density_metacal_x_act": "contamination_galaxy_number_density_metacal_x_act.png",
          "contamination_galaxy_number_density_metacal_x_spt_winter_gmv": "contamination_galaxy_number_density_metacal_x_spt_winter_gmv.png",
          "contamination_galaxy_number_density_metacal_x_spt_winter_mv": "contamination_galaxy_number_density_metacal_x_spt_winter_mv.png",
          "contamination_galaxy_number_density_metacal_x_spt_winter_pp": "contamination_galaxy_number_density_metacal_x_spt_winter_pp.png",
          "contamination_galaxy_number_density_metacal_x_spt_winter_tt": "contamination_galaxy_number_density_metacal_x_spt_winter_tt.png",
          "contamination_noise_lensmc_x_act": "contamination_noise_lensmc_x_act.png",
          "contamination_noise_lensmc_x_spt_winter_gmv": "contamination_noise_lensmc_x_spt_winter_gmv.png",
          "contamination_noise_lensmc_x_spt_winter_mv": "contamination_noise_lensmc_x_spt_winter_mv.png",
          "contamination_noise_lensmc_x_spt_winter_pp": "contamination_noise_lensmc_x_spt_winter_pp.png",
          "contamination_noise_lensmc_x_spt_winter_tt": "contamination_noise_lensmc_x_spt_winter_tt.png",
          "contamination_noise_metacal_x_act": "contamination_noise_metacal_x_act.png",
          "contamination_noise_metacal_x_spt_winter_gmv": "contamination_noise_metacal_x_spt_winter_gmv.png",
          "contamination_noise_metacal_x_spt_winter_mv": "contamination_noise_metacal_x_spt_winter_mv.png",
          "contamination_noise_metacal_x_spt_winter_pp": "contamination_noise_metacal_x_spt_winter_pp.png",
          "contamination_noise_metacal_x_spt_winter_tt": "contamination_noise_metacal_x_spt_winter_tt.png",
          "contamination_persistence_lensmc_x_act": "contamination_persistence_lensmc_x_act.png",
          "contamination_persistence_lensmc_x_spt_winter_gmv": "contamination_persistence_lensmc_x_spt_winter_gmv.png",
          "contamination_persistence_lensmc_x_spt_winter_mv": "contamination_persistence_lensmc_x_spt_winter_mv.png",
          "contamination_persistence_lensmc_x_spt_winter_pp": "contamination_persistence_lensmc_x_spt_winter_pp.png",
          "contamination_persistence_lensmc_x_spt_winter_tt": "contamination_persistence_lensmc_x_spt_winter_tt.png",
          "contamination_persistence_metacal_x_act": "contamination_persistence_metacal_x_act.png",
          "contamination_persistence_metacal_x_spt_winter_gmv": "contamination_persistence_metacal_x_spt_winter_gmv.png",
          "contamination_persistence_metacal_x_spt_winter_mv": "contamination_persistence_metacal_x_spt_winter_mv.png",
          "contamination_persistence_metacal_x_spt_winter_pp": "contamination_persistence_metacal_x_spt_winter_pp.png",
          "contamination_persistence_metacal_x_spt_winter_tt": "contamination_persistence_metacal_x_spt_winter_tt.png",
          "contamination_phz_quality_lensmc_x_act": "contamination_phz_quality_lensmc_x_act.png",
          "contamination_phz_quality_lensmc_x_spt_winter_gmv": "contamination_phz_quality_lensmc_x_spt_winter_gmv.png",
          "contamination_phz_quality_lensmc_x_spt_winter_mv": "contamination_phz_quality_lensmc_x_spt_winter_mv.png",
          "contamination_phz_quality_lensmc_x_spt_winter_pp": "contamination_phz_quality_lensmc_x_spt_winter_pp.png",
          "contamination_phz_quality_lensmc_x_spt_winter_tt": "contamination_phz_quality_lensmc_x_spt_winter_tt.png",
          "contamination_phz_quality_metacal_x_act": "contamination_phz_quality_metacal_x_act.png",
          "contamination_phz_quality_metacal_x_spt_winter_gmv": "contamination_phz_quality_metacal_x_spt_winter_gmv.png",
          "contamination_phz_quality_metacal_x_spt_winter_mv": "contamination_phz_quality_metacal_x_spt_winter_mv.png",
          "contamination_phz_quality_metacal_x_spt_winter_pp": "contamination_phz_quality_metacal_x_spt_winter_pp.png",
          "contamination_phz_quality_metacal_x_spt_winter_tt": "contamination_phz_quality_metacal_x_spt_winter_tt.png",
          "contamination_psf_lensmc_x_act": "contamination_psf_lensmc_x_act.png",
          "contamination_psf_lensmc_x_spt_winter_gmv": "contamination_psf_lensmc_x_spt_winter_gmv.png",
          "contamination_psf_lensmc_x_spt_winter_mv": "contamination_psf_lensmc_x_spt_winter_mv.png",
          "contamination_psf_lensmc_x_spt_winter_pp": "contamination_psf_lensmc_x_spt_winter_pp.png",
          "contamination_psf_lensmc_x_spt_winter_tt": "contamination_psf_lensmc_x_spt_winter_tt.png",
          "contamination_psf_metacal_x_act": "contamination_psf_metacal_x_act.png",
          "contamination_psf_metacal_x_spt_winter_gmv": "contamination_psf_metacal_x_spt_winter_gmv.png",
          "contamination_psf_metacal_x_spt_winter_mv": "contamination_psf_metacal_x_spt_winter_mv.png",
          "contamination_psf_metacal_x_spt_winter_pp": "contamination_psf_metacal_x_spt_winter_pp.png",
          "contamination_psf_metacal_x_spt_winter_tt": "contamination_psf_metacal_x_spt_winter_tt.png",
          "contamination_saa_lensmc_x_act": "contamination_saa_lensmc_x_act.png",
          "contamination_saa_lensmc_x_spt_winter_gmv": "contamination_saa_lensmc_x_spt_winter_gmv.png",
          "contamination_saa_lensmc_x_spt_winter_mv": "contamination_saa_lensmc_x_spt_winter_mv.png",
          "contamination_saa_lensmc_x_spt_winter_pp": "contamination_saa_lensmc_x_spt_winter_pp.png",
          "contamination_saa_lensmc_x_spt_winter_tt": "contamination_saa_lensmc_x_spt_winter_tt.png",
          "contamination_saa_metacal_x_act": "contamination_saa_metacal_x_act.png",
          "contamination_saa_metacal_x_spt_winter_gmv": "contamination_saa_metacal_x_spt_winter_gmv.png",
          "contamination_saa_metacal_x_spt_winter_mv": "contamination_saa_metacal_x_spt_winter_mv.png",
          "contamination_saa_metacal_x_spt_winter_pp": "contamination_saa_metacal_x_spt_winter_pp.png",
          "contamination_saa_metacal_x_spt_winter_tt": "contamination_saa_metacal_x_spt_winter_tt.png",
          "contamination_star_brightness_mean_lensmc_x_act": "contamination_star_brightness_mean_lensmc_x_act.png",
          "contamination_star_brightness_mean_lensmc_x_spt_winter_gmv": "contamination_star_brightness_mean_lensmc_x_spt_winter_gmv.png",
          "contamination_star_brightness_mean_lensmc_x_spt_winter_mv": "contamination_star_brightness_mean_lensmc_x_spt_winter_mv.png",
          "contamination_star_brightness_mean_lensmc_x_spt_winter_pp": "contamination_star_brightness_mean_lensmc_x_spt_winter_pp.png",
          "contamination_star_brightness_mean_lensmc_x_spt_winter_tt": "contamination_star_brightness_mean_lensmc_x_spt_winter_tt.png",
          "contamination_star_brightness_mean_metacal_x_act": "contamination_star_brightness_mean_metacal_x_act.png",
          "contamination_star_brightness_mean_metacal_x_spt_winter_gmv": "contamination_star_brightness_mean_metacal_x_spt_winter_gmv.png",
          "contamination_star_brightness_mean_metacal_x_spt_winter_mv": "contamination_star_brightness_mean_metacal_x_spt_winter_mv.png",
          "contamination_star_brightness_mean_metacal_x_spt_winter_pp": "contamination_star_brightness_mean_metacal_x_spt_winter_pp.png",
          "contamination_star_brightness_mean_metacal_x_spt_winter_tt": "contamination_star_brightness_mean_metacal_x_spt_winter_tt.png",
          "contamination_stellar_density_density_x_act": "contamination_stellar_density_density_x_act.png",
          "contamination_stellar_density_density_x_spt_winter_gmv": "contamination_stellar_density_density_x_spt_winter_gmv.png",
          "contamination_stellar_density_lensmc_x_act": "contamination_stellar_density_lensmc_x_act.png",
          "contamination_stellar_density_lensmc_x_spt_winter_gmv": "contamination_stellar_density_lensmc_x_spt_winter_gmv.png",
          "contamination_stellar_density_lensmc_x_spt_winter_mv": "contamination_stellar_density_lensmc_x_spt_winter_mv.png",
          "contamination_stellar_density_lensmc_x_spt_winter_pp": "contamination_stellar_density_lensmc_x_spt_winter_pp.png",
          "contamination_stellar_density_lensmc_x_spt_winter_tt": "contamination_stellar_density_lensmc_x_spt_winter_tt.png",
          "contamination_stellar_density_metacal_x_act": "contamination_stellar_density_metacal_x_act.png",
          "contamination_stellar_density_metacal_x_spt_winter_gmv": "contamination_stellar_density_metacal_x_spt_winter_gmv.png",
          "contamination_stellar_density_metacal_x_spt_winter_mv": "contamination_stellar_density_metacal_x_spt_winter_mv.png",
          "contamination_stellar_density_metacal_x_spt_winter_pp": "contamination_stellar_density_metacal_x_spt_winter_pp.png",
          "contamination_stellar_density_metacal_x_spt_winter_tt": "contamination_stellar_density_metacal_x_spt_winter_tt.png",
          "contamination_zodiacal_light_density_x_act": "contamination_zodiacal_light_density_x_act.png",
          "contamination_zodiacal_light_density_x_spt_winter_gmv": "contamination_zodiacal_light_density_x_spt_winter_gmv.png",
          "contamination_zodiacal_light_lensmc_x_act": "contamination_zodiacal_light_lensmc_x_act.png",
          "contamination_zodiacal_light_lensmc_x_spt_winter_gmv": "contamination_zodiacal_light_lensmc_x_spt_winter_gmv.png",
          "contamination_zodiacal_light_lensmc_x_spt_winter_mv": "contamination_zodiacal_light_lensmc_x_spt_winter_mv.png",
          "contamination_zodiacal_light_lensmc_x_spt_winter_pp": "contamination_zodiacal_light_lensmc_x_spt_winter_pp.png",
          "contamination_zodiacal_light_lensmc_x_spt_winter_tt": "contamination_zodiacal_light_lensmc_x_spt_winter_tt.png",
          "contamination_zodiacal_light_metacal_x_act": "contamination_zodiacal_light_metacal_x_act.png",
          "contamination_zodiacal_light_metacal_x_spt_winter_gmv": "contamination_zodiacal_light_metacal_x_spt_winter_gmv.png",
          "contamination_zodiacal_light_metacal_x_spt_winter_mv": "contamination_zodiacal_light_metacal_x_spt_winter_mv.png",
          "contamination_zodiacal_light_metacal_x_spt_winter_pp": "contamination_zodiacal_light_metacal_x_spt_winter_pp.png",
          "contamination_zodiacal_light_metacal_x_spt_winter_tt": "contamination_zodiacal_light_metacal_x_spt_winter_tt.png"
        },
        "mtime": 1771437884000,
        "generated": "2026-02-18T18:04:14.483951+00:00"
      }
    },
    {
      "id": "systematic-null-test-heatmap-92dec7e5",
      "title": "Systematic null tests: galactic extinction correlates with shear",
      "kind": "task",
      "status": "closed",
      "body": "Cross-correlate each systematic map (stellar density, galactic extinction, exposures, zodiacal light, SAA) with the Euclid shear field and test consistency with zero.\n\nThe 2×3 panel shows per-bandpower pulls (C^{fS}_ℓ / σ_Knox) for all five systematics across six tomographic bins. Under the null hypothesis, pulls scatter around zero with unit variance. Coherent excursions beyond ±2σ indicate contamination; their multipole structure reveals where in harmonic space the systematic leaks in.\n\n**Galactic extinction stands out.** In bins 5 and 6 (highest redshift), the pink pulls reach ±3-5σ across a broad range of multipoles — this is broadband contamination, not a feature at a specific angular scale. The chi2/dof climbs to 7.9 in bin 6. Lower bins show milder excursions (chi2/dof 1.5-2.3). The physical mechanism: Galactic dust affects PSF modeling and photometric calibration, imprinting a large-scale pattern on the shear maps.\n\n**Other systematics are clean.** Stellar density, exposures, SAA, and zodiacal light all scatter within the ±1σ band in most bins. Stellar density shows occasional 2σ excursions but no coherent spectral pattern — its null test looks benign. This is misleading: the bias budget analysis (`plot_systematic_budget`) reveals stellar density is actually the *dominant* ACT contaminant, because its correlation with CMB κ is stronger than galactic extinction's. The null test only measures C^{fS} (shear × systematic); the full contamination diagnostic requires C^{κS} as well.\n\n**What this test cannot see.** A systematic that correlates with CMB κ but not with shear does not appear here. The [contamination metric](.felt/contamination-metric-product-c-e55501f4.md) captures the joint effect — even galactic extinction's alarming null test failures translate to sub-percent per-bandpower bias, because the triple coincidence required for cross-correlation contamination is rarer than pairwise correlations suggest. But sub-percent per bandpower integrates to multi-σ bias over 20 bandpowers — the [bias budget](.felt/systematic-bias-budget-709ea507.md) and [template marginalization](.felt/deprojected-likelihood-joint-26b1588e.md) complete the picture.",
      "outcome": "Spectral pull plot: 5 systematics × 6 bins showing C^{fS}/σ_Knox per bandpower. Galactic extinction shows coherent ±3-5σ pulls at low ℓ in bins 5-6 (chi2/dof up to 7.9). Clean systematics scatter within ±1σ. 7/30 lensmc tests fail at 5%. The spectral structure is now visible — contamination is broadband, not confined to specific multipoles.",
      "tags": [
        "tapestry:plot_systematic_null_tests",
        "region:validation:contamination"
      ],
      "createdAt": "2026-02-14T18:14:07.516956859+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "systematic-maps-on-the-sky-83122c03",
        "systematic-contamination-summary-e6c81e29"
      ],
      "specName": "plot_systematic_null_tests",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_tests": 231,
          "n_fail_5pct": 119,
          "n_fail_1pct": 106,
          "median_chi2_dof": 19.544,
          "median_pte": 0.039,
          "per_method": {
            "density": {
              "n_tests": 77,
              "n_fail_5pct": 77,
              "n_fail_1pct": 77,
              "median_chi2_dof": 50.77,
              "median_pte": 0
            },
            "lensmc": {
              "n_tests": 77,
              "n_fail_5pct": 20,
              "n_fail_1pct": 13,
              "median_chi2_dof": 1.29,
              "median_pte": 0.169
            },
            "metacal": {
              "n_tests": 77,
              "n_fail_5pct": 22,
              "n_fail_1pct": 16,
              "median_chi2_dof": 1.26,
              "median_pte": 0.196
            }
          },
          "per_systematic": {
            "exposures": {
              "n_tests": 21,
              "n_fail_5pct": 8,
              "median_chi2_dof": 1.34,
              "median_pte": 0.139
            },
            "galactic_extinction": {
              "n_tests": 21,
              "n_fail_5pct": 17,
              "median_chi2_dof": 4.95,
              "median_pte": 0
            },
            "galaxy_number_density": {
              "n_tests": 21,
              "n_fail_5pct": 19,
              "median_chi2_dof": 6.17,
              "median_pte": 0
            },
            "noise": {
              "n_tests": 21,
              "n_fail_5pct": 8,
              "median_chi2_dof": 1.31,
              "median_pte": 0.155
            },
            "persistence": {
              "n_tests": 21,
              "n_fail_5pct": 9,
              "median_chi2_dof": 1.48,
              "median_pte": 0.079
            },
            "phz_quality": {
              "n_tests": 21,
              "n_fail_5pct": 10,
              "median_chi2_dof": 1.47,
              "median_pte": 0.082
            },
            "psf": {
              "n_tests": 21,
              "n_fail_5pct": 8,
              "median_chi2_dof": 1.47,
              "median_pte": 0.083
            },
            "saa": {
              "n_tests": 21,
              "n_fail_5pct": 7,
              "median_chi2_dof": 1.35,
              "median_pte": 0.134
            },
            "star_brightness_mean": {
              "n_tests": 21,
              "n_fail_5pct": 14,
              "median_chi2_dof": 1.88,
              "median_pte": 0.01
            },
            "stellar_density": {
              "n_tests": 21,
              "n_fail_5pct": 12,
              "median_chi2_dof": 1.67,
              "median_pte": 0.03
            },
            "zodiacal_light": {
              "n_tests": 21,
              "n_fail_5pct": 7,
              "median_chi2_dof": 1.29,
              "median_pte": 0.169
            }
          }
        },
        "artifacts": {
          "png_shear": "systematic_null_test_summary.png",
          "png_density": "systematic_null_test_density.png"
        },
        "mtime": 1771433908000,
        "generated": "2026-02-18T16:58:17.611080+00:00"
      }
    },
    {
      "id": "catalog-validation-summary-d0b856bd",
      "title": "Estimator comparison",
      "kind": "task",
      "status": "closed",
      "body": "NmtFieldCatalog works directly from galaxy catalogs, bypassing pixelization. NmtField works from maps built by binning galaxies into HEALPix pixels. If the two give the same cross-spectrum, map construction introduces no bias. Same galaxies, same CMB κ, different computational paths.\n\nThe 6-panel spectral overlay (lensmc × ACT) shows them side by side: blue map-based with error bars, orange catalog-based without. They track each other across all bins and multipoles — Pearson correlation 0.995-0.999, with the closest agreement at high ℓ where signal dominates. The RMS fractional differences (7-33%, S/N-weighted) reflect noise scatter in low-S/N bandpowers, not systematic bias. No trend with redshift bin.\n\nThis validates the map-based pipeline as the production measurement. The catalog approach serves as an independent check, not a competing estimator — it's computationally heavier (64GB for ~5M galaxies at lmax=3000) and provides no covariance estimate.",
      "outcome": "Catalog-vs-map validation summary now includes both matrix diagnostics and concrete representative spectra. On February 23, 2026, plot_catalog_validation_summary was rerun after script formalization to add two direct cross-spectrum overlays selected from the full comparison set: best-agreeing and worst-agreeing method×bin×CMB combinations (ranked by signal-selected fractional RMS, fallback total RMS). This preserves compressed, collaborator-readable reporting while anchoring interpretation in actual C_ell curves rather than heatmap statistics alone. Outputs updated at results/claims/plot_catalog_validation_summary/{catalog_validation_summary.png,evidence.json}.",
      "tags": [
        "tapestry:plot_catalog_validation_summary",
        "region:methodology"
      ],
      "createdAt": "2026-02-15T01:34:46.048361777+01:00",
      "closedAt": null,
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd",
        "catalog-based-harmonic-space-14a8b515"
      ],
      "specName": "plot_catalog_validation_summary",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_comparisons": 28,
          "n_methods": 2,
          "n_cmbk": 2,
          "n_missing_map_counterparts": 0,
          "n_bitwise_equal_cls": 0,
          "fraction_bitwise_equal_cls": 0,
          "min_correlation": 0.9618,
          "max_correlation": 0.9994,
          "median_correlation": 0.9938,
          "p05_correlation": 0.9657,
          "p95_correlation": 0.9986,
          "fraction_corr_gt_0p995": 0.3214,
          "median_rms_frac": 0.9214,
          "p95_rms_frac": 20.4787,
          "max_rms_frac": 64.901,
          "snr_min_for_frac": 1,
          "median_rms_frac_signal": 0.2011,
          "p95_rms_frac_signal": 0.7892,
          "max_rms_frac_signal": 1.3946,
          "median_pull_rms": 0.307,
          "p95_pull_rms": 3.7385,
          "median_reduced_chi2_diff": 0.0943,
          "p95_reduced_chi2_diff": 14.1018,
          "max_abs_delta": 1e-8,
          "worst_rms_cases": [
            {
              "method": "metacal",
              "bin": "2",
              "cmbk": "act",
              "rms_frac": 64.901,
              "rms_frac_signal": 0.0187,
              "correlation": 0.9946,
              "reduced_chi2_diff": 15.987,
              "n_frac_signal": 4
            },
            {
              "method": "metacal",
              "bin": "1",
              "cmbk": "spt_winter_gmv",
              "rms_frac": 23.2755,
              "rms_frac_signal": 0.2471,
              "correlation": 0.9618,
              "reduced_chi2_diff": 0.0416,
              "n_frac_signal": 3
            },
            {
              "method": "lensmc",
              "bin": "4",
              "cmbk": "spt_winter_gmv",
              "rms_frac": 15.2846,
              "rms_frac_signal": 0.0313,
              "correlation": 0.9935,
              "reduced_chi2_diff": 0.04,
              "n_frac_signal": 2
            },
            {
              "method": "metacal",
              "bin": "4",
              "cmbk": "spt_winter_gmv",
              "rms_frac": 4.6147,
              "rms_frac_signal": 0.1104,
              "correlation": 0.9941,
              "reduced_chi2_diff": 0.048,
              "n_frac_signal": 3
            },
            {
              "method": "lensmc",
              "bin": "1",
              "cmbk": "act",
              "rms_frac": 3.2425,
              "rms_frac_signal": 0.131,
              "correlation": 0.9942,
              "reduced_chi2_diff": 0.0659,
              "n_frac_signal": 5
            }
          ],
          "worst_rms_signal_cases": [
            {
              "method": "metacal",
              "bin": "1",
              "cmbk": "act",
              "rms_frac": 1.391,
              "rms_frac_signal": 1.3946,
              "correlation": 0.9674,
              "reduced_chi2_diff": 10.6007,
              "n_frac_signal": 6
            },
            {
              "method": "metacal",
              "bin": "all",
              "cmbk": "act",
              "rms_frac": 0.9318,
              "rms_frac_signal": 0.8357,
              "correlation": 0.9977,
              "reduced_chi2_diff": 1.4937,
              "n_frac_signal": 4
            },
            {
              "method": "metacal",
              "bin": "3",
              "cmbk": "spt_winter_gmv",
              "rms_frac": 0.911,
              "rms_frac_signal": 0.7029,
              "correlation": 0.9882,
              "reduced_chi2_diff": 0.0983,
              "n_frac_signal": 3
            },
            {
              "method": "lensmc",
              "bin": "2",
              "cmbk": "act",
              "rms_frac": 0.6912,
              "rms_frac_signal": 0.659,
              "correlation": 0.9795,
              "reduced_chi2_diff": 19.6648,
              "n_frac_signal": 6
            },
            {
              "method": "lensmc",
              "bin": "3",
              "cmbk": "spt_winter_gmv",
              "rms_frac": 2.0644,
              "rms_frac_signal": 0.4613,
              "correlation": 0.9857,
              "reduced_chi2_diff": 0.0903,
              "n_frac_signal": 4
            }
          ],
          "worst_reduced_chi2_cases": [
            {
              "method": "lensmc",
              "bin": "2",
              "cmbk": "act",
              "rms_frac": 0.6912,
              "rms_frac_signal": 0.659,
              "correlation": 0.9795,
              "reduced_chi2_diff": 19.6648,
              "n_frac_signal": 6
            },
            {
              "method": "metacal",
              "bin": "2",
              "cmbk": "act",
              "rms_frac": 64.901,
              "rms_frac_signal": 0.0187,
              "correlation": 0.9946,
              "reduced_chi2_diff": 15.987,
              "n_frac_signal": 4
            },
            {
              "method": "metacal",
              "bin": "1",
              "cmbk": "act",
              "rms_frac": 1.391,
              "rms_frac_signal": 1.3946,
              "correlation": 0.9674,
              "reduced_chi2_diff": 10.6007,
              "n_frac_signal": 6
            },
            {
              "method": "lensmc",
              "bin": "5",
              "cmbk": "act",
              "rms_frac": 0.369,
              "rms_frac_signal": 0.348,
              "correlation": 0.9903,
              "reduced_chi2_diff": 10.5534,
              "n_frac_signal": 4
            },
            {
              "method": "lensmc",
              "bin": "6",
              "cmbk": "act",
              "rms_frac": 0.2641,
              "rms_frac_signal": 0.2078,
              "correlation": 0.9951,
              "reduced_chi2_diff": 4.3854,
              "n_frac_signal": 4
            }
          ]
        },
        "artifacts": {
          "png": "catalog_validation_summary.png"
        },
        "mtime": 1771832944000,
        "generated": "2026-02-23T07:49:00.272013+00:00"
      }
    },
    {
      "id": "spt-estimator-comparison-gmv-vs-7f4cef00",
      "title": "SPT estimators: no foreground bias",
      "kind": "task",
      "status": "closed",
      "body": "SPT-3G provides four CMB lensing estimator variants with genuinely different foreground sensitivity. GMV (baseline) uses all quadratic pairs — highest SNR but most foreground-exposed. TT (temperature-only) is maximally sensitive to tSZ from galaxy clusters. PP (polarization-only) is the cleanest but noisiest. MV (SQE) tests pipeline-level consistency. All share the same survey mask, so differences in their cross-spectra with Euclid shear isolate foreground contamination in the lensing reconstruction.\n\nThe 6-panel ratio plot (lensmc baseline) shows each variant divided by GMV as a function of multipole. The ratios scatter around unity in every bin — TT (salmon), PP (teal), MV (purple) all consistent with the 10% shaded band, with noise increasing at low ℓ where each variant's individual S/N is lowest. PP shows the widest scatter (noisiest estimator), but no systematic offset. TT — the critical test for tSZ bias — tracks GMV tightly. The large error bars at individual bandpowers correctly show that this is a noisy test: the power comes from the aggregate (18 comparisons, median chi2/dof = 0.19), not any single ℓ bin.\n\nThis means tSZ contamination of the SPT lensing reconstruction does not bias the shear × κ cross-correlation at current noise levels. The SPT normalization deficit (A_lens = 0.76) cannot be explained by foreground leakage — it persists identically across all four estimators, including the foreground-immune PP channel. This disfavors foreground-related hypotheses for the deficit (see `spt-deficit-characterization-6b724e41`).\n\n## Comments\n**2026-02-15 23:56** — Plot rework: drop the ratio plot (noise/noise ratios scatter too much at low ℓ). Instead plot differences relative to best-fit Planck amplitude: (C_variant - C_GMV) / C_theory(A_lens). Clean residual in interpretable units.",
      "outcome": "All 14 comparisons (2 methods x 7 bins) show complete consistency across all 4 SPT estimator variants. Chi2/dof: MV~0.03, TT~0.2, PP~0.3 (all vs GMV, dof=20). Min PTE=0.981 (metacal bin3 PP). No foreground contamination detected — tSZ bias in TT estimator does not affect shear x kappa cross-spectra at current noise levels. 42 cross-spectra computed, 14 comparison plots + evidence at results/claims/plot_spt_estimator_comparison/.",
      "tags": [
        "tapestry:plot_spt_estimator_comparison",
        "region:validation:consistency"
      ],
      "createdAt": "2026-02-15T04:05:05.21428304+01:00",
      "closedAt": "2026-02-16T00:28:19.927753312+01:00",
      "dependsOn": [
        "act-vs-spt-cross-spectra-b4181199",
        "validation-null-tests-and-48ab3654",
        "spt-3g-winter-lensing-ab712d17"
      ],
      "specName": "plot_spt_estimator_comparison",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_methods": 2,
          "n_comparisons": 36,
          "n_consistent_5pct": 36,
          "median_pte": 1,
          "median_min_pte": 1,
          "min_min_pte": 0.9995,
          "median_chi2_per_dof": 0.073
        },
        "artifacts": {
          "spt_estimator_composite": "spt_estimator_composite.png",
          "spt_estimator_composite_lensmc": "spt_estimator_composite_lensmc.png",
          "spt_estimator_composite_metacal": "spt_estimator_composite_metacal.png",
          "spt_estimator_lensmc_bin1": "spt_estimator_lensmc_bin1.png",
          "spt_estimator_lensmc_bin2": "spt_estimator_lensmc_bin2.png",
          "spt_estimator_lensmc_bin3": "spt_estimator_lensmc_bin3.png",
          "spt_estimator_lensmc_bin4": "spt_estimator_lensmc_bin4.png",
          "spt_estimator_lensmc_bin5": "spt_estimator_lensmc_bin5.png",
          "spt_estimator_lensmc_bin6": "spt_estimator_lensmc_bin6.png",
          "spt_estimator_lensmc_binall": "spt_estimator_lensmc_binall.png",
          "spt_estimator_metacal_bin1": "spt_estimator_metacal_bin1.png",
          "spt_estimator_metacal_bin2": "spt_estimator_metacal_bin2.png",
          "spt_estimator_metacal_bin3": "spt_estimator_metacal_bin3.png",
          "spt_estimator_metacal_bin4": "spt_estimator_metacal_bin4.png",
          "spt_estimator_metacal_bin5": "spt_estimator_metacal_bin5.png",
          "spt_estimator_metacal_bin6": "spt_estimator_metacal_bin6.png",
          "spt_estimator_metacal_binall": "spt_estimator_metacal_binall.png"
        },
        "mtime": 1771817820000,
        "generated": "2026-02-23T03:36:50.495164+00:00"
      }
    },
    {
      "id": "jackknife-null-test-random-sign-e86273e8",
      "title": "Jackknife: galaxy-side systematics are clean",
      "kind": "task",
      "status": "closed",
      "body": "Multiply each galaxy's ellipticity by a random sign (±1), destroying the coherent cosmological signal while preserving noise structure, pixel coverage, and weight maps. Cross-correlating these randomized shear maps with CMB κ should yield spectra consistent with zero. Any excess reveals galaxy-side additive systematics — PSF leakage, selection effects, calibration errors correlated with sky position.\n\nAll 24 null spectra (2 methods × 6 bins × 2 CMB experiments, 20 bandpowers each) are consistent with zero: median chi2/dof = 0.88, median PTE = 0.62, zero failures at 5%. The galaxy side is clean.\n\nThis test is sensitive to additive systematics but blind to multiplicative biases (shear calibration), which are sign-invariant. A single random realization (seed=42) suffices to rule out large additive contamination. CMB-side null test: [simulation null](.felt/simulation-null-test-sim-kappa-6418a9f1.md). Spatial structure: [spatial variation](.felt/spatial-variation-test-north-vs-c9fdd8ed.md).",
      "outcome": "24/24 null cross-spectra (2 methods x 6 bins x 2 CMB) consistent with zero. Median Knox chi2/dof=0.88, median PTE=0.617, 0 failures at 5% threshold. No galaxy-side systematics detected.",
      "tags": [
        "tapestry:plot_jackknife_null_test",
        "region:validation:null"
      ],
      "createdAt": "2026-02-15T05:05:55.719926292+01:00",
      "closedAt": "2026-02-15T05:13:46.742266978+01:00",
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654"
      ],
      "specName": "plot_jackknife_null_test",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_comparisons": 4,
          "n_bins_total": 24,
          "n_fail_5pct": 0,
          "all_pass": true,
          "median_chi2_dof": 0.88,
          "median_pte": 0.617
        },
        "artifacts": {
          "jackknife_null_lensmc_x_act": "jackknife_null_lensmc_x_act.png",
          "jackknife_null_lensmc_x_spt_winter_gmv": "jackknife_null_lensmc_x_spt_winter_gmv.png",
          "jackknife_null_metacal_x_act": "jackknife_null_metacal_x_act.png",
          "jackknife_null_metacal_x_spt_winter_gmv": "jackknife_null_metacal_x_spt_winter_gmv.png"
        },
        "mtime": 1771437804000,
        "generated": "2026-02-18T18:02:58.533887+00:00"
      }
    },
    {
      "id": "theory-residual-analysis-6a66a995",
      "title": "Theory residuals: ACT passes, SPT fails in shape",
      "kind": "task",
      "status": "closed",
      "body": "The [theory comparison](.felt/theory-comparison-data-d5cc9678.md) shows ACT matching and SPT low. Decomposing the deficit: a single lensing amplitude A_lens is fitted per bin, and the residual shape — data/(A_lens·theory) — is tested for consistency with noise.\n\nTheory here is NLA IA (see `nla-intrinsic-alignment-theory-57e37bd1`), the same prediction shown in the theory comparison. Amplitude fits use diagonal covariance (NaMaster Gaussian for density, Knox proxy for catalog shear).\n\n| CMB | A_lens | σ from 1 | shape PTE |\n|-----|-------|----------|-----------|\n| ACT lensmc | 0.93 ± 0.06 | 1.3σ | 0.83 |\n| SPT-GMV lensmc | 0.76 ± 0.05 | 4.9σ | ~0 |\n\n**ACT passes both tests.** A_lens = 0.93 — within 1.3σ of unity. Shape is excellent. The ~7% residual is consistent with known missing model ingredients (`theory-model-completeness-for-526d66a5`): shear calibration ~2%, baryonic feedback ~3-5%, n(z) shifts ~1-3%.\n\n**SPT fails in both amplitude and shape.** The deficit has bin-level structure: low-z bins (1-3) fail the shape test (chi2/dof 1.7-2.7) while high-z bins (4-6) pass (chi2/dof 1.2-1.6). The [ℓ-range robustness test](.felt/ℓ-range-robustness-amplitude-e86f1728.md) reveals scale dependence: high-ℓ bandpowers actively suppress the amplitude, disfavoring a uniform calibration offset. Full characterization in `spt-deficit-characterization-6b724e41`.",
      "outcome": "Per-bin amplitude fits: ACT A_lens=0.93±0.06 (1.3σ from unity, shape PTE 0.83), SPT A_lens=0.76±0.05 (4.9σ, shape fails). ACT consistent with ΛCDM; SPT deficit is scale-dependent and method-independent.",
      "tags": [
        "tapestry:plot_theory_residual_analysis",
        "region:validation:theory"
      ],
      "createdAt": "2026-02-15T05:42:10.839168569+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-comparison-data-d5cc9678",
        "results-detection-and-90f2ec1b"
      ],
      "specName": "plot_theory_residual_analysis",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_methods": 3,
          "act_mean_A_hat_vanilla": 0.95,
          "act_mean_A_hat_ia": 0.751,
          "spt_mean_A_hat_vanilla": 0.838,
          "spt_mean_A_hat_ia": 0.666,
          "act_deficit_ia": "deficit",
          "spt_deficit_ia": "deficit"
        },
        "artifacts": {
          "theory_residual_density": "theory_residual_density.png",
          "theory_residual_density_amplitude_summary": "theory_residual_density_amplitude_summary.png",
          "theory_residual_lensmc": "theory_residual_lensmc.png",
          "theory_residual_lensmc_amplitude_summary": "theory_residual_lensmc_amplitude_summary.png",
          "theory_residual_metacal": "theory_residual_metacal.png",
          "theory_residual_metacal_amplitude_summary": "theory_residual_metacal_amplitude_summary.png"
        },
        "mtime": 1771437884000,
        "generated": "2026-02-18T18:04:12.998880+00:00"
      }
    },
    {
      "id": "analysis-summary-one-page-c5170698",
      "title": "Analysis summary: one-page synthesis",
      "kind": "task",
      "status": "closed",
      "body": "Four-panel synthesis of the full analysis — detection, consistency, null tests, theory — reading aggregate evidence from all upstream nodes. For the spectra, see [signal overview](.felt/signal-overview-act-spt-theory-1ae2798f.md).\n\n## (a) Detection\n\nS/N per tomographic bin. All 12 baseline spectra detected at >3σ (11/12 at >5σ). S/N rises with bin number (increasing lensing kernel overlap). **15σ (ACT) and 14σ (SPT)** after joint Fisher marginalization of stellar density, galactic extinction, and other survey systematics alongside the signal amplitude. Pre-marginalization: 20σ (ACT), 21σ (SPT).\n\n## (b) Consistency\n\nFour cross-checks, all passing. [ACT vs SPT](.felt/act-vs-spt-cross-spectra-b4181199.md): 14/14 at 5%, PTE 0.64. [Lensmc vs metacal](.felt/lensmc-vs-metacal-method-7d4d724f.md): 35/35, PTE 1.0. [SPT estimators](.felt/spt-estimator-comparison-gmv-vs-7f4cef00.md): 14/14, PTE 1.0. [Catalog vs map](.felt/catalog-validation-summary-d0b856bd.md): 28/28, correlation 0.998.\n\n## (c) Null tests\n\n[Jackknife](.felt/jackknife-null-test-random-sign-e86273e8.md): 0/24 fail, chi2/dof 0.88. [Simulation null](.felt/simulation-null-test-sim-kappa-6418a9f1.md): 1/66 false alarm, chi2/dof 0.92. [Spatial split](.felt/spatial-variation-test-north-vs-c9fdd8ed.md): 0/6 fail at ℓ>100. [ℓ-range robustness](.felt/ℓ-range-robustness-amplitude-e86f1728.md): ACT stable, SPT scale-dependent. [Systematic null tests](.felt/systematic-null-test-heatmap-92dec7e5.md): galactic extinction fails 10/14, others clean.\n\n## (d) ΛCDM consistency\n\nAmplitudes against Planck 2018 ΛCDM + NLA IA ([NLA model](.felt/nla-intrinsic-alignment-theory-57e37bd1.md)). **ACT A_lens=0.86±0.06, chi2/dof=0.75 (PTE 0.98) — ΛCDM consistent.** Theory comparison before marginalization ([theory residuals](.felt/theory-residual-analysis-6a66a995.md)): A_lens=0.93±0.06 (1.3σ from unity). **SPT A_lens=0.75, chi2/dof=1.61 — deficit persists** (see `spt-deficit-characterization-6b724e41`); this is a CMB-side normalization issue.\n\n**Script**: `workflow/scripts/plot_analysis_summary.py`",
      "outcome": "One-page 4-panel summary. (a) Detection: ACT 15σ, SPT 14σ after systematic marginalization (pre-marginalization: 20σ/21σ). (b) All 4 consistency tests pass. (c) Null tests: jackknife, sim, spatial all clean; galactic extinction contaminates. (d) ΛCDM consistency: ACT A_lens=0.86±0.06 (PTE 0.98) consistent; SPT deficit persists (chi2/dof=1.6).",
      "tags": [
        "tapestry:plot_analysis_summary",
        "region:synthesis"
      ],
      "createdAt": "2026-02-15T06:14:18.283077336+01:00",
      "closedAt": null,
      "dependsOn": [
        "jackknife-null-test-random-sign-e86273e8",
        "theory-residual-analysis-6a66a995",
        "spt-estimator-comparison-gmv-vs-7f4cef00",
        "catalog-validation-summary-d0b856bd",
        "act-vs-spt-cross-spectra-b4181199",
        "lensmc-vs-metacal-method-7d4d724f",
        "systematic-null-test-heatmap-92dec7e5",
        "contamination-metric-product-c-e55501f4",
        "theory-comparison-data-d5cc9678",
        "simulation-null-test-sim-kappa-6418a9f1",
        "fiducial-likelihood-evaluation-4c17b5d9",
        "signal-overview-act-spt-theory-1ae2798f",
        "systematic-bias-budget-709ea507",
        "ℓ-range-robustness-amplitude-e86f1728",
        "same-sky-same-galaxies-act-and-85397551",
        "b-mode-null-test-passes-galaxy-0f71087b",
        "results-detection-and-90f2ec1b"
      ],
      "specName": "plot_analysis_summary",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_bins": 6,
          "act_median_knox_snr": 14.5,
          "spt_median_knox_snr": 23.5,
          "act_max_knox_snr": 28,
          "spt_max_knox_snr": 43.4,
          "act_combined_knox_snr": 42.9,
          "spt_combined_knox_snr": 67.2,
          "act_marginalized_snr": 26.7,
          "spt_marginalized_snr": 37.1,
          "act_spt_median_pte": 0.657,
          "act_spt_all_pass": true,
          "method_all_pass": false,
          "estimator_all_pass": true,
          "n_systematic_fail_5pct": 119,
          "n_systematic_total": 231,
          "jackknife_all_pass": true,
          "galactic_extinction_n_fail": 17,
          "sim_null_n_fail": 1,
          "sim_null_n_total": 66,
          "sim_null_median_chi2_dof": 0.918,
          "spatial_n_fail": 0,
          "spatial_n_total": 6,
          "spatial_median_chi2_dof": 1.343,
          "bmode_n_fail": null,
          "bmode_n_total": null,
          "bmode_median_chi2_dof": null,
          "act_ia_chi2_dof": 3.181,
          "act_ia_pte": 0,
          "spt_ia_chi2_dof": 17.505,
          "spt_ia_pte": 0,
          "act_mean_A": 0.912,
          "act_mean_A_err": 0.024,
          "spt_mean_A": 0.822,
          "spt_mean_A_err": 0.017,
          "ia_model": "NLA-z (A_IA=1.72, eta=-0.41)",
          "act_ia_mean_A": 0.985,
          "act_ia_mean_A_err": 0.026,
          "spt_ia_mean_A": 0.889,
          "spt_ia_mean_A_err": 0.018,
          "budget_act_max_bias_sigma": 14.14,
          "budget_act_worst_systematic": "stellar_density",
          "budget_spt_max_bias_sigma": 5.73,
          "act_A_after_deprojection": 0.5703,
          "act_A_delta_deprojection": -0.4142,
          "spt_A_after_deprojection": 0.945,
          "spt_A_delta_deprojection": 0.056,
          "deprojection_method": "marginalized",
          "act_deprojected_ia_chi2_dof": 1.785,
          "act_deprojected_ia_pte": 0,
          "act_deprojected_ia_A_hat": 0.879,
          "act_deprojected_delta_A_sigma": -4.1,
          "spt_deprojected_ia_chi2_dof": 11.814,
          "spt_deprojected_ia_A_hat": 0.777,
          "act_robustness_worst_sigma": 2.17,
          "act_robustness_worst_bin": "1",
          "spt_robustness_worst_sigma": 6.86,
          "spt_robustness_worst_bin": "6"
        },
        "artifacts": {},
        "mtime": 1771438176000,
        "generated": "2026-02-18T18:09:25.016701+00:00"
      }
    },
    {
      "id": "fiducial-likelihood-evaluation-4c17b5d9",
      "title": "Likelihood: 15σ (ACT), 14σ (SPT) detection — ΛCDM consistent",
      "kind": "task",
      "status": "closed",
      "body": "Joint 6-bin chi2 evaluation of the full data vector against Planck 2018 ΛCDM theory (with standard NLA IA). Covariance: NaMaster Gaussian for density, Knox proxy for catalog shear — block-diagonal (no cross-bin terms). Systematic contamination — stellar density, galactic extinction, and other survey systematics — is marginalized via Fisher matrix template fitting alongside the signal amplitude.\n\n## Detection\n\n| Combination | S/N | S/N (pre-marginalization) |\n|-------------|-----|---------------------------|\n| lensmc × ACT | **15σ** | 20σ |\n| metacal × ACT | — | 19σ |\n| lensmc × SPT | **14σ** | 21σ |\n| metacal × SPT | — | 20σ |\n\nS/N after systematic marginalization is the primary detection claim. Pre-marginalization S/N (data vs zero, no contamination removal) is shown for reference.\n\n## ΛCDM consistency\n\n| Combination | chi2/dof | PTE | A_lens |\n|-------------|----------|-----|-------|\n| lensmc × ACT | 0.88 | 0.82 | 0.93 ± 0.06 |\n| metacal × ACT | 0.88 | 0.81 | 0.91 ± 0.06 |\n| lensmc × SPT | 1.88 | ≈0 | 0.76 ± 0.05 |\n| metacal × SPT | 1.84 | ≈0 | 0.76 ± 0.05 |\n\n**ACT × Euclid is consistent with ΛCDM.** Chi2/dof = 0.88 (PTE 0.82). A prediction from Planck CMB-only cosmology matches Euclid weak lensing × ACT CMB lensing at the few-percent level. The amplitude A_lens = 0.93 ± 0.06 is 1.3σ from unity.\n\n**SPT detects the signal but fails the fit.** 21σ detection, but chi2/dof = 1.88 (PTE ≈ 0). The deficit (A_lens = 0.76) is method-independent and persists in shape — not a simple calibration offset. This is a CMB-side normalization issue, open for investigation.\n\n## Caveats\n\nBlock-diagonal covariance (no cross-bin terms). No CMB κ transfer function correction. Theory at Planck 2018 best-fit with NLA IA at Euclid pipeline defaults ([NLA model](.felt/nla-intrinsic-alignment-theory-57e37bd1.md)) — a fixed prediction, not a fit. Post-marginalization likelihood: [template marginalization](.felt/deprojected-likelihood-joint-26b1588e.md). Missing theory ingredients: `theory-model-completeness-for-526d66a5`.",
      "outcome": "Detection: ACT 15σ, SPT 14σ after systematic marginalization. ΛCDM consistency: ACT chi2/dof=0.75 (PTE 0.98), A_lens=0.86±0.06; SPT deficit persists (chi2/dof=1.61, A_lens=0.75).",
      "tags": [
        "tapestry:evaluate_fiducial_likelihood",
        "region:validation:theory"
      ],
      "createdAt": "2026-02-15T08:03:07.734605176+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-comparison-data-d5cc9678",
        "results-detection-and-90f2ec1b"
      ],
      "specName": "evaluate_fiducial_likelihood",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_evaluations": 6,
          "act_mean_detection_snr": 32.6,
          "act_mean_ia_chi2_dof": 2.21,
          "act_mean_ia_pte": 0.1,
          "act_mean_ia_A_hat": 0.972,
          "act_mean_ia_A_sigma": 0.039,
          "act_lensmc_detection_snr": 42.9,
          "act_lensmc_ia_chi2_dof": 3.18,
          "act_lensmc_ia_pte": 0,
          "act_lensmc_ia_A_hat": 0.985,
          "act_lensmc_ia_A_sigma": 0.026,
          "act_lensmc_ia_shape_chi2_dof": 3.21,
          "act_lensmc_ia_shape_pte": 0,
          "act_lensmc_vanilla_A_hat": 0.913,
          "act_lensmc_vanilla_A_sigma": 0.024,
          "act_metacal_detection_snr": 34.9,
          "act_metacal_ia_chi2_dof": 2.38,
          "act_metacal_ia_pte": 0,
          "act_metacal_ia_A_hat": 0.925,
          "act_metacal_ia_A_sigma": 0.03,
          "act_metacal_ia_shape_chi2_dof": 2.35,
          "act_metacal_ia_shape_pte": 0,
          "act_metacal_vanilla_A_hat": 0.859,
          "act_metacal_vanilla_A_sigma": 0.028,
          "act_density_detection_snr": 20.1,
          "act_density_ia_chi2_dof": 1.06,
          "act_density_ia_pte": 0.31,
          "act_density_ia_A_hat": 1.005,
          "act_density_ia_A_sigma": 0.06,
          "act_density_ia_shape_chi2_dof": 1.07,
          "act_density_ia_shape_pte": 0.29,
          "act_density_vanilla_A_hat": 1.005,
          "act_density_vanilla_A_sigma": 0.06,
          "spt_mean_detection_snr": 48.2,
          "spt_mean_ia_chi2_dof": 10.65,
          "spt_mean_ia_pte": 0,
          "spt_mean_ia_A_hat": 0.865,
          "spt_mean_ia_A_sigma": 0.03,
          "spt_lensmc_detection_snr": 67.2,
          "spt_lensmc_ia_chi2_dof": 17.5,
          "spt_lensmc_ia_pte": 0,
          "spt_lensmc_ia_A_hat": 0.889,
          "spt_lensmc_ia_A_sigma": 0.018,
          "spt_lensmc_ia_shape_chi2_dof": 17.33,
          "spt_lensmc_ia_shape_pte": 0,
          "spt_lensmc_vanilla_A_hat": 0.822,
          "spt_lensmc_vanilla_A_sigma": 0.017,
          "spt_metacal_detection_snr": 56,
          "spt_metacal_ia_chi2_dof": 12.95,
          "spt_metacal_ia_pte": 0,
          "spt_metacal_ia_A_hat": 0.85,
          "spt_metacal_ia_A_sigma": 0.021,
          "spt_metacal_ia_shape_chi2_dof": 12.64,
          "spt_metacal_ia_shape_pte": 0,
          "spt_metacal_vanilla_A_hat": 0.791,
          "spt_metacal_vanilla_A_sigma": 0.019,
          "spt_density_detection_snr": 21.5,
          "spt_density_ia_chi2_dof": 1.48,
          "spt_density_ia_pte": 0,
          "spt_density_ia_A_hat": 0.857,
          "spt_density_ia_A_sigma": 0.05,
          "spt_density_ia_shape_chi2_dof": 1.43,
          "spt_density_ia_shape_pte": 0,
          "spt_density_vanilla_A_hat": 0.857,
          "spt_density_vanilla_A_sigma": 0.05
        },
        "artifacts": {
          "likelihood_density_x_act": "likelihood_density_x_act.png",
          "likelihood_density_x_spt_winter_gmv": "likelihood_density_x_spt_winter_gmv.png",
          "likelihood_lensmc_x_act": "likelihood_lensmc_x_act.png",
          "likelihood_lensmc_x_spt_winter_gmv": "likelihood_lensmc_x_spt_winter_gmv.png",
          "likelihood_metacal_x_act": "likelihood_metacal_x_act.png",
          "likelihood_metacal_x_spt_winter_gmv": "likelihood_metacal_x_spt_winter_gmv.png"
        },
        "mtime": 1771437964000,
        "generated": "2026-02-18T18:06:00.835920+00:00"
      }
    },
    {
      "id": "simulation-null-test-sim-kappa-6418a9f1",
      "title": "Simulation null: CMB-side systematics are clean",
      "kind": "task",
      "status": "closed",
      "body": "The complement to the jackknife: instead of randomizing the galaxy side, swap the CMB κ map for simulated realizations. SPT provides 11 sims (1 Gaussian + 10 Agora with realistic foregrounds) processed through the same `healqest` lensing pipeline. None share the real convergence field, so cross-correlation with Euclid shear should be zero.\n\n66 null cross-spectra (11 sims × 6 bins, lensmc × SPT GMV) are consistent with zero: median chi2/dof = 0.92, median PTE = 0.56, 1 false alarm at 5% (expected ~3.3). No spurious correlations. No mean-field bias. The Agora sims — which include tSZ, CIB, and radio sources — show no elevated signal compared to the Gaussian sim, ruling out foreground contamination of the SPT lensing reconstruction at our noise level.\n\nThe empirical bandpower scatter across sims also calibrates the error bars. The Knox-to-empirical variance ratio is 0.83 — Knox overestimates by ~17%, making it slightly conservative (expected: Knox uses total auto-spectra in the numerator). Together with the [galaxy-side jackknife](.felt/jackknife-null-test-random-sign-e86273e8.md), both sides of the cross-correlation are validated independently.",
      "outcome": "66 null cross-spectra (11 SPT sims x 6 bins, lensmc x SPT GMV). Median chi2/dof=0.92, median PTE=0.56, 1/66 false alarm at 5% (expected ~3.3). Knox covariance validated: empirical variance ratio 0.83 (Knox slightly conservative). No spurious correlations.",
      "tags": [
        "tapestry:plot_sim_null_test",
        "region:validation:null"
      ],
      "createdAt": "2026-02-15T08:18:11.724742405+01:00",
      "closedAt": null,
      "dependsOn": [
        "jackknife-null-test-random-sign-e86273e8",
        "validation-null-tests-and-48ab3654"
      ],
      "specName": "plot_sim_null_test",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_methods": 1,
          "total_null_spectra": 66,
          "n_fail_5pct": 1,
          "median_chi2_dof": 0.92,
          "median_pte": 0.564,
          "all_pass": true,
          "knox_validated": true
        },
        "artifacts": {
          "sim_null_lensmc_x_spt_winter_gmv": "sim_null_lensmc_x_spt_winter_gmv.png"
        },
        "mtime": 1771437763000,
        "generated": "2026-02-18T18:02:29.827490+00:00"
      }
    },
    {
      "id": "signal-overview-act-spt-theory-1ae2798f",
      "title": "The signal: cross-spectra for 6 bins (γκ + δκ), ACT and SPT",
      "kind": "task",
      "status": "closed",
      "body": "Six panels — one per tomographic redshift bin — showing measured C_ℓ^{κE} for ACT DR6 and SPT-3G GMV, overlaid with vanilla Planck 2018 ΛCDM theory.\n\n**Detection in every bin.** S/N ranges from 5σ (bin 2, smallest lensing kernel overlap) to 12σ (bin 6, maximum overlap). All 24 method × bin × CMB combinations detected at >3σ. Combined: 20σ (ACT), 21σ (SPT).\n\n**ACT traces Planck ΛCDM.** Data follows the prediction in both shape and amplitude — CMB-only cosmology matching Euclid weak lensing at the percent level, no free parameters. The detailed theory comparison including intrinsic alignment corrections is in [theory comparison](.felt/theory-comparison-data-d5cc9678.md) and the [NLA model documentation](.felt/nla-intrinsic-alignment-theory-57e37bd1.md).\n\n**SPT sits ~24% low.** Same spectral shape, coherent across bins and methods — a CMB-side normalization issue, not a cosmological discrepancy. Characterized in the [ℓ-range robustness](.felt/ℓ-range-robustness-amplitude-e86f1728.md) and [SPT estimator comparison](.felt/spt-estimator-comparison-gmv-vs-7f4cef00.md) nodes.\n\n**Error bars**: NaMaster Gaussian covariance (density, map-based) or Knox proxy (shear, catalog-based). Validated in the [covariance node](.felt/covariance-validation-namaster-4b3c85a4.md) — NaMaster/Knox ratio ~1.04 for density, confirming both methods agree. ACT: salmon circles. SPT: teal squares. ℓ·C_ℓ scaling. Lensmc representative; metacal in [method comparison](.felt/lensmc-vs-metacal-method-7d4d724f.md).\n\n**Script**: `cmbx/files/workflow_scripts_plot_signal_overview.py`",
      "outcome": "6-panel grid showing ACT DR6 and SPT-3G GMV cross-spectra with vanilla Planck 2018 ΛCDM theory (no IA). Detection in all bins (S/N 5-12). ACT consistent with theory; SPT systematically low. NLA IA in separate fiber.",
      "tags": [
        "tapestry:plot_signal_overview",
        "region:measurement"
      ],
      "createdAt": "2026-02-15T09:41:09.962273229+01:00",
      "closedAt": null,
      "dependsOn": [
        "catalog-validation-summary-d0b856bd",
        "covariance-validation-namaster-4b3c85a4",
        "results-detection-and-90f2ec1b",
        "data-euclid-act-spt-7d4e8847"
      ],
      "specName": "plot_signal_overview",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_methods": 3,
          "n_bin_snr_values": 36,
          "median_per_bin_snr": 12.5,
          "min_per_bin_snr": 6.3,
          "all_detected_3sigma": true
        },
        "artifacts": {
          "signal_overview_density": "signal_overview_density.png",
          "signal_overview_density_trend": "signal_overview_density_trend.png",
          "signal_overview_lensmc": "signal_overview_lensmc.png",
          "signal_overview_lensmc_trend": "signal_overview_lensmc_trend.png",
          "signal_overview_metacal": "signal_overview_metacal.png",
          "signal_overview_metacal_trend": "signal_overview_metacal_trend.png"
        },
        "mtime": 1771392397000,
        "generated": "2026-02-18T05:26:37.872912+00:00"
      }
    },
    {
      "id": "systematic-bias-budget-709ea507",
      "title": "Bias budget: stellar density is the dominant ACT contaminant",
      "kind": "task",
      "status": "closed",
      "body": "Quantitative summary of systematic contamination using the DES×SPT bias significance metric. The contamination metric X(ℓ) = C^{κS}_ℓ · C^{fS}_ℓ / C^{SS}_ℓ has the same units as the signal C^{Eκ}_ℓ. The bias significance S_bias = sqrt(Σ_ℓ X²/σ²) measures how many σ of bias each systematic contributes, integrating over all ℓ-bins.\n\n**Key finding**: stellar density is the dominant systematic for ACT (4.4σ in bin 5, worse than galactic extinction at 3.7σ). This wasn't apparent from the C^{γS} null tests alone, which flagged galactic extinction as worse — the bias significance weights by the systematic's correlation with *both* tracers simultaneously (C^{κS}/C^{SS}), and stellar density has stronger proportional correlation with CMB κ.\n\n**ACT vs SPT asymmetry**: ACT's larger sky coverage admits more galactic contamination. SPT's deep winter field is almost entirely clean (<1σ across all systematics and bins). The asymmetry is geographic, not instrumental.\n\n**Implications**: S_bias ~ 4.4 against a signal S/N ~ 20 implies ~20% fractional bias in the worst bin — significant for precision cosmology. [Template marginalization](.felt/deprojected-likelihood-joint-26b1588e.md) handles this; [deprojection](.felt/template-deprojection-a1621797.md) shows the per-bin impact.\n\n**Script**: `cmbx/files/workflow_scripts_plot_systematic_budget.py`",
      "outcome": "Heatmap of bias significance S_bias = sqrt(Σ_ℓ X(ℓ)²/σ(ℓ)²) across 5 systematics × 6 bins × 2 CMB baselines. ACT: stellar density worst (max 4.4σ bin 5, all 6 bins >1σ), galactic extinction second (max 3.7σ bin 5), exposures+SAA moderate (~1-1.6σ). SPT: almost all <1σ (only galactic extinction bin 1 reaches 1.0σ). Zodiacal light has no auto-power (C^{SS}≈0), contamination undefined but negligible. ACT/SPT asymmetry from larger ACT sky coverage admitting more galactic contamination. 22/48 entries above 1σ for lensmc, 3 above 3σ. Method-independent (metacal similar pattern).",
      "tags": [
        "tapestry:plot_systematic_budget",
        "region:validation:contamination"
      ],
      "createdAt": "2026-02-15T10:04:17.587389063+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-null-test-heatmap-92dec7e5",
        "contamination-metric-product-c-e55501f4",
        "systematic-contamination-summary-e6c81e29"
      ],
      "specName": "plot_systematic_budget",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "n_methods": 3,
          "max_bias_sigma_overall": 14.1,
          "act_max_bias_sigma": 14.1,
          "spt_max_bias_sigma": 7.5,
          "dominant_systematic": "stellar_density",
          "act_spt_asymmetry": "comparable"
        },
        "artifacts": {
          "systematic_budget_density": "systematic_budget_density.png",
          "systematic_budget_lensmc": "systematic_budget_lensmc.png",
          "systematic_budget_metacal": "systematic_budget_metacal.png"
        },
        "mtime": 1771437763000,
        "generated": "2026-02-18T18:02:29.672111+00:00"
      }
    },
    {
      "id": "ℓ-range-robustness-amplitude-e86f1728",
      "title": "ℓ-range robustness: ACT stable, SPT scale-dependent",
      "kind": "task",
      "status": "closed",
      "body": "Progressively include bandpowers up to ℓ_max and fit the lensing amplitude A_lens, testing whether the measurement is robust across angular scales. Starting from ℓ_max ≈ 105 (5 bandpowers minimum), each step adds one more bandpower until the full range (ℓ ≈ 2700).\n\n**ACT is scale-stable.** Worst deviation from the full-range A_lens is 1.5σ (bin 3). Bins 4-6 are rock-solid (< 1σ). The ACT measurement is robust to ℓ-range selection.\n\n**SPT shows scale-dependent deficit.** Bins 1-3 start at A_lens ≈ 1.5 with only low-ℓ bandpowers and drop to A_lens ≈ 0.7 as high-ℓ data is added. The deficit is not a uniform calibration offset — high-ℓ bandpowers actively suppress the amplitude. Worst case: bin 2, max deviation 2.7σ, A_lens range 0.74-2.55. Bins 4-6 are more stable (deviations 1.3-1.9σ) but still trend downward.\n\n**Per-estimator breakdown sharpens the picture.** Running the same test separately for SPT TT, PP, and MV reveals the scale dependence is primarily temperature-driven. PP (polarization-only) is the most scale-stable (worst 1.82σ vs 2.4-2.7σ for TT/GMV/MV) and gives systematically higher full-range A_lens (0.83-1.41 vs 0.08-0.85 for TT). TT bin 1 is catastrophic (A_lens = 0.08); PP bin 1 gives A_lens = 1.41. Combined estimators (GMV, MV) inherit TT's instability.\n\nThis constrains the deficit's origin (full characterization in [SPT deficit](.felt/spt-deficit-characterization-6b724e41.md)). Three hypotheses, refined by the per-estimator test:\n\n1. **SPT κ_TT normalization/filtering** — temperature-specific normalization residual in the Wiener-filtered κ map. PP's stability and higher amplitudes strongly favor a T-side origin. Foreground leakage into κ_TT at low ℓ is a candidate mechanism. Favored: explains both ACT/SPT asymmetry and TT/PP asymmetry.\n\n2. **Higher-order noise bias leakage** — N3/2 and trispectrum terms that formally cancel in cross-correlation but may leak at high ℓ. Also CMB-side, SPT-specific. Partially consistent — but would not explain the strong TT/PP asymmetry unless N0_TT >> N0_PP.\n\n3. **Baryonic feedback** — suppresses small-scale matter power (ℓ > 500-1000). Disfavored: would affect both experiments and both estimators equally.",
      "outcome": "ACT amplitude stable (worst deviation 1.5σ, bin 3 lensmc). SPT shows significant scale dependence: worst 2.7σ (bin 2 lensmc), driven by high-ℓ bandpowers pulling amplitude DOWN. SPT bins 1-3 drop from A_lens≈1.5 at ℓ_max~200 to A_lens≈0.7 at full range — deficit is NOT a uniform calibration offset but scale-dependent, concentrated at high ℓ.",
      "tags": [
        "tapestry:plot_ell_range_robustness",
        "region:validation:consistency"
      ],
      "createdAt": "2026-02-15T15:19:58.303844642+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-residual-analysis-6a66a995",
        "validation-null-tests-and-48ab3654"
      ],
      "specName": "plot_ell_range_robustness",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_methods": 2,
          "overall_worst_deviation_sigma": 6.86,
          "overall_median_deviation_sigma": 3.55,
          "per_method_cmb": {
            "lensmc_act": {
              "worst_max_deviation_sigma": 2.17,
              "worst_bin": "1",
              "median_A_range": 0.2127
            },
            "lensmc_spt_winter_gmv": {
              "worst_max_deviation_sigma": 6.86,
              "worst_bin": "6",
              "median_A_range": 0.5197
            },
            "metacal_act": {
              "worst_max_deviation_sigma": 2.01,
              "worst_bin": "3",
              "median_A_range": 0.1971
            },
            "metacal_spt_winter_gmv": {
              "worst_max_deviation_sigma": 4.93,
              "worst_bin": "6",
              "median_A_range": 0.474
            }
          }
        },
        "artifacts": {},
        "mtime": 1771437885000,
        "generated": "2026-02-18T18:04:09.205334+00:00"
      }
    },
    {
      "id": "systematic-maps-on-the-sky-83122c03",
      "title": "Systematic maps: complete inventory and visualization of all VMPZ-ID maps",
      "kind": "task",
      "status": "closed",
      "body": "Visualize every systematic map available from the VMPZ-ID mosaic masks pipeline. Currently we plot 2 (stellar density, galactic extinction) and run null tests on 5 (adding exposures, zodiacal light, SAA). But 20 map types sit on disk — we should know what they all look like, and whether any we're ignoring correlate with our signal.\n\n## Inventory\n\nAll maps at `inputs/euclid/tr1_pic/VMPZ_ID/MOSAIC_MASKS/`. Sparse HEALPix FITS, nside 16384, NESTED.\n\n### Currently configured (5)\n\n| Key | Map type | Status |\n|-----|----------|--------|\n| stellar_density | STARNUMBERDENSITY | Plotted, null tested, dominant ACT contaminant |\n| galactic_extinction | GALACTICEXTINCTION | Plotted, null tested, second ACT contaminant |\n| exposures | EXPOSURES | Null tested, clean |\n| zodiacal_light | ZODIACALLIGHT | Null tested, clean |\n| saa | SAA | Null tested, clean |\n\n### Available but unused (15 types)\n\n| Map type | Files | Relevance |\n|----------|-------|-----------|\n| PSF | 13 | **High** — PSF variation directly affects shear measurement |\n| NOISE | 13 | **High** — read noise affects shape measurement S/N |\n| PERSISTENCE | 3 | **Medium** — detector persistence could bias shapes |\n| STARBRIGHTNESSMEAN | 3 | **Medium** — bright stars affect nearby galaxy shapes |\n| STARBRIGHTNESSRMS | 3+ | **Medium** — star brightness variability |\n| GALAXYNUMBERDENSITY | 2 | Useful check — galaxy density itself |\n| GALAXYNUMBERDENSITYNEGVISFLUX | 2 | Subset of above |\n| GALAXYHFLUXERR | 2 | **Medium** — H-band flux error affects photo-z |\n| GALAXYRELPHZSEVENTYMEAN | 2 | **Medium** — photo-z quality affects tomographic binning |\n| GALAXYRELPHZSEVENTYRMS | 2 | **Medium** — photo-z scatter |\n| GALAXYRELPHZSEVENTYSTD | 2 | **Medium** — photo-z scatter |\n| AA | 1 | Low — ambient conditions |\n| BA | 1 | Low — background level |\n| TILE | 1 | Low — tile boundaries |\n\nPSF and noise are the most important additions. PSF variation is the classic shear systematic. Noise depth affects shape measurement variance spatially.\n\n## Desired state\n\n- One sky-projection plot per systematic map type (pick the most recent/complete version of each type).\n- All plots in composites grouped by category (observing conditions, stellar, galaxy properties, detector).\n- `config.yaml` updated with all usable maps.\n- Null tests extended to new maps (at least PSF, noise, persistence).\n- Blockers noted for any maps that can't be loaded.\n\n## Blockers to investigate\n\n- PSF maps: 13 files suggests per-component or per-exposure. Need to understand file naming to pick the right aggregate.\n- NOISE: same — 13 files, likely per-detector or per-band.\n- Some maps may not overlap RR2 or be all-zero in our region.\n\n## Approach\n\n1. Inventory all files, load each, check coverage on RR2 footprint.\n2. Plot each on the sky (RR2 zoom, matching field overview style).\n3. Add promising ones to config and run null tests.\n4. Update the tapestry node with comprehensive visualization.",
      "outcome": "All 11 VMPZ-ID systematic maps visualized on the RR2 footprint in a single 11×2 composite (north/south patches). Maps: stellar density, galactic extinction, exposures, zodiacal light, SAA, PSF, noise, persistence, star brightness mean, galaxy number density, photo-z quality. All loaded from sparse FITS nside 16384, downgraded to 2048 (phz_quality at nside 1024 upgraded). Null tests (tracer × sysmap: 462 spectra) and CMBk × sysmap cross-spectra (110 spectra) already computed for all 11 maps. Evidence with per-map statistics (median, p10, p90, frac_nonzero) in results/claims/plot_systematic_maps/evidence.json.",
      "tags": [
        "tapestry:plot_systematic_maps",
        "region:methodology"
      ],
      "createdAt": "2026-02-15T23:54:20.416058525+01:00",
      "closedAt": "2026-02-18T19:12:15.78844008+01:00",
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ],
      "specName": "plot_systematic_maps",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "maps": {
            "stellar_density": {
              "median": 0.046875,
              "p10": 0.015625,
              "p90": 0.09375,
              "frac_nonzero": 0.787481916432644
            },
            "galactic_extinction": {
              "median": 0.016289973631501198,
              "p10": 0.01001930795609951,
              "p90": 0.03005599044263363,
              "frac_nonzero": 0.8311760701216918
            },
            "exposures": {
              "median": 2462.176986694336,
              "p10": 2260.8038482666016,
              "p90": 4011.2514572143555,
              "frac_nonzero": 0.8278891158199302
            },
            "zodiacal_light": {
              "median": 1.5805724872825895e-18,
              "p10": 1.5136321546572412e-18,
              "p90": 1.6356413959830087e-18,
              "frac_nonzero": 0.8311760701216918
            },
            "saa": {
              "median": 92.50914907455444,
              "p10": 91.3510981798172,
              "p90": 94.29638957977295,
              "frac_nonzero": 0.8278891158199302
            },
            "psf": {
              "median": 0.5141978145111352,
              "p10": 0.5107855976559221,
              "p90": 0.5169939996208995,
              "frac_nonzero": 0.7958556718577142
            },
            "noise": {
              "median": 0.003783939406275749,
              "p10": 0.0030292728690255897,
              "p90": 0.004175209801178426,
              "frac_nonzero": 0.8149774487277679
            },
            "persistence": {
              "median": 0.21313028025906533,
              "p10": 0.10737101680133491,
              "p90": 0.3779251041822137,
              "frac_nonzero": 0.7956663262701047
            },
            "star_brightness_mean": {
              "median": 58.195162415504456,
              "p10": 5.406636762619019,
              "p90": 985.0881041407582,
              "frac_nonzero": 0.7869287720194026
            },
            "galaxy_number_density": {
              "median": 16.375,
              "p10": 10.1875,
              "p90": 27.5,
              "frac_nonzero": 0.7270657816356055
            },
            "phz_quality": {
              "median": 0.2696657180786133,
              "p10": 0.24685591459274292,
              "p90": 0.5422896444797516,
              "frac_nonzero": 0.7232852523189516
            }
          }
        },
        "artifacts": {
          "png": "systematic_maps.png"
        },
        "mtime": 1771438211000,
        "generated": "2026-02-18T18:09:16.918166+00:00"
      }
    },
    {
      "id": "same-sky-same-galaxies-act-and-85397551",
      "title": "Same sky, same galaxies: ACT and SPT agree in the overlap",
      "kind": "task",
      "status": "closed",
      "body": "The [full-footprint comparison](.felt/act-vs-spt-cross-spectra-b4181199.md) shows ACT and SPT agree in shape — but the two experiments see different sky areas. ACT covers the full RR2 footprint; SPT covers a subset. A shape agreement across different sky could mask local disagreements.\n\nThe overlap test eliminates this. The RR2 shear footprint splits naturally into three regions based on CMB κ coverage: ACT-only (0.47% fsky), ACT+SPT overlap (0.27% fsky), and SPT-only (0.08% fsky). In the overlap region, both experiments observe exactly the same CMB modes through the same galaxies. Any difference is purely CMB-side — reconstruction algorithm, noise properties, transfer function.\n\nThe 6-panel spectral overlay shows ACT and SPT cross-spectra in the overlap region. Knox error bars are larger than the full-footprint case (fsky_overlap / fsky_full ≈ 0.3), but the signal is clearly detected in every bin (ACT median 10σ, SPT median 8.3σ). The chi2 of the difference spectrum (ACT − SPT) tests whether the two are drawn from the same underlying signal. Joint chi2/dof = 1.01 (120 dof), PTE = 0.46. Textbook consistency.\n\nBin 6 is the only marginal case (chi2/dof = 1.74, PTE = 0.022). With 6 independent bins, expecting ~0.3 false alarms at 5% — one marginal failure is unremarkable. The remaining 5 bins sit comfortably in the chi2 distribution (PTE range 0.28–0.88).\n\nThis supersedes the north-south patch split (which was ACT-only anyway — SPT's winter field doesn't reach the north patch). The overlap test is strictly stronger: same sky, same galaxies, two independent CMB pipelines.",
      "outcome": "Joint chi2/dof = 1.01 (120 dof, PTE = 0.46). Overlap region: 133k pixels, fsky = 0.27%. ACT median Knox SNR = 10σ, SPT = 8.3σ. 5/6 bins pass at 5%, bin 6 marginal (PTE = 0.022). This is the strongest consistency test — identical galaxies AND identical sky modes. Evidence at results/claims/plot_overlap_comparison/.",
      "tags": [
        "tapestry:plot_overlap_comparison",
        "region:validation:consistency"
      ],
      "createdAt": "2026-02-16T01:16:04.951094927+01:00",
      "closedAt": null,
      "dependsOn": [
        "act-vs-spt-cross-spectra-b4181199",
        "validation-null-tests-and-48ab3654",
        "act-dr6-lensing-e4a3eae9",
        "spt-3g-winter-lensing-ab712d17"
      ],
      "specName": "plot_overlap_comparison",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "fsky_overlap": 0.002649,
          "n_overlap_pixels": 133334,
          "n_comparisons": 6,
          "median_chi2_dof": 0.901,
          "median_pte": 0.585,
          "n_failures_5pct": 1,
          "joint_chi2": 121,
          "joint_dof": 120,
          "joint_chi2_dof": 1.009,
          "joint_pte": 0.456,
          "per_bin": {
            "1": {
              "chi2_dof": 0.643,
              "pte": 0.883
            },
            "2": {
              "chi2_dof": 0.714,
              "pte": 0.816
            },
            "3": {
              "chi2_dof": 1.065,
              "pte": 0.38
            },
            "4": {
              "chi2_dof": 0.738,
              "pte": 0.791
            },
            "5": {
              "chi2_dof": 1.157,
              "pte": 0.282
            },
            "6": {
              "chi2_dof": 1.735,
              "pte": 0.022
            }
          }
        },
        "artifacts": {
          "png": "overlap_act_vs_spt.png"
        },
        "mtime": 1771389929000,
        "generated": "2026-02-18T04:45:29.701873+00:00"
      }
    },
    {
      "id": "b-mode-null-test-passes-galaxy-0f71087b",
      "title": "B-mode null test passes: galaxy-side shear systematics are clean",
      "kind": "task",
      "status": "closed",
      "body": "Weak lensing produces only E-mode shear. Any B×κ signal is either systematic contamination or E→B leakage from the partial-sky geometry. If the [signal](.felt/signal-overview-act-spt-theory-1ae2798f.md) were driven by PSF contamination or shear calibration errors, B-modes would carry the imprint.\n\nThey don't. ACT joint chi2/dof = 109.6/120 (PTE = 0.74), SPT joint chi2/dof = 103.3/120 (PTE = 0.86). All 12 bins pass at 5%. B/E amplitude ratios range 0.20–0.96, consistent with E→B leakage at our sky fraction (~4%).\n\nThe covariance breakthrough was recognizing that the Knox formula with *observed* BB auto-spectra — which include the leaked E-mode power — correctly captures the leakage-inflated variance. NaMaster's Gaussian covariance uses theoretical BB ≈ 0, underestimating variance by 15–150× and producing false failures. Knox sidesteps this entirely: `Var(C^{Bκ}_b) = C^{BB,obs}_b × C^{κκ}_b / n_modes`. No simulations needed.\n\nThis is comparable to [ACT×DES](cmbx/files/docs_papers_2309.04412_act_des_shear_main.tex), which reported PTE = 0.81 using 511 Monte Carlo realizations for covariance.\n\nThis test complements the [jackknife null test](.felt/jackknife-null-test-random-sign-e86273e8.md) (random sign-flip destroys correlated signal) and the [simulation null test](.felt/sim-null-test-spt-κ-sims-are-0f7e6bf3.md) (uncorrelated CMB maps). Together they establish: no galaxy-side systematics (B-mode), no correlated artifacts (jackknife), no CMB-side spurious correlations (simulation).",
      "outcome": "B×κ consistent with zero using Knox BB covariance. ACT: chi2/dof=109.6/120, PTE=0.74. SPT: chi2/dof=103.3/120, PTE=0.86. All 12 bins pass at 5%. Knox BB works because observed auto-spectrum includes E→B leakage; NaMaster Gaussian fails (15-150× underestimate). Comparable to ACT×DES sim-based result (PTE=0.81).",
      "tags": [
        "tapestry:plot_bmode_null_test",
        "region:validation:null"
      ],
      "createdAt": "2026-02-16T06:48:59.192545392+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654"
      ],
      "specName": "plot_bmode_null_test",
      "staleness": "fresh",
      "evidence": {
        "metrics": {},
        "artifacts": {
          "png_0": "bmode_null_lensmc_x_act.png",
          "png_1": "bmode_null_lensmc_x_spt_winter_gmv.png"
        },
        "mtime": 1771437723000,
        "generated": "2026-02-18T18:01:45.495919+00:00"
      }
    },
    {
      "id": "systematic-spectra-raw-c-fs-c-3d65264d",
      "title": "Systematic spectra: raw C^{fS}, C^{κS}, C^{SS} contamination ingredients",
      "kind": "task",
      "status": "closed",
      "outcome": "Shows the three cross-spectra composing the contamination metric X = C^{κS}·C^{fS}/C^{SS} for each systematic × method × CMB experiment combination. All 6 redshift bins overlaid per panel. Makes the C^{SS} noise bias visible — denominator dominated by pixel noise at high ℓ from nside 16384→2048 downgrade, which makes X a lower bound on true contamination. Created as tapestry node to complete the maps→spectra→metric contamination path. Script: plot_systematic_spectra.py. Evidence in results/claims/plot_systematic_spectra/.",
      "tags": [
        "tapestry:plot_systematic_spectra",
        "region:validation:contamination"
      ],
      "createdAt": "2026-02-18T15:15:01.248403045+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-null-test-heatmap-92dec7e5",
        "systematic-maps-on-the-sky-83122c03",
        "contamination-metric-product-c-e55501f4",
        "systematic-contamination-summary-e6c81e29"
      ],
      "specName": "plot_systematic_spectra",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_plots": 33,
          "n_sysmaps": 11,
          "n_methods": 3
        },
        "artifacts": {
          "systematic_spectra_exposures_density": "systematic_spectra_exposures_density.png",
          "systematic_spectra_exposures_lensmc": "systematic_spectra_exposures_lensmc.png",
          "systematic_spectra_exposures_metacal": "systematic_spectra_exposures_metacal.png",
          "systematic_spectra_galactic_extinction_density": "systematic_spectra_galactic_extinction_density.png",
          "systematic_spectra_galactic_extinction_lensmc": "systematic_spectra_galactic_extinction_lensmc.png",
          "systematic_spectra_galactic_extinction_metacal": "systematic_spectra_galactic_extinction_metacal.png",
          "systematic_spectra_galaxy_number_density_density": "systematic_spectra_galaxy_number_density_density.png",
          "systematic_spectra_galaxy_number_density_lensmc": "systematic_spectra_galaxy_number_density_lensmc.png",
          "systematic_spectra_galaxy_number_density_metacal": "systematic_spectra_galaxy_number_density_metacal.png",
          "systematic_spectra_noise_density": "systematic_spectra_noise_density.png",
          "systematic_spectra_noise_lensmc": "systematic_spectra_noise_lensmc.png",
          "systematic_spectra_noise_metacal": "systematic_spectra_noise_metacal.png",
          "systematic_spectra_persistence_density": "systematic_spectra_persistence_density.png",
          "systematic_spectra_persistence_lensmc": "systematic_spectra_persistence_lensmc.png",
          "systematic_spectra_persistence_metacal": "systematic_spectra_persistence_metacal.png",
          "systematic_spectra_phz_quality_density": "systematic_spectra_phz_quality_density.png",
          "systematic_spectra_phz_quality_lensmc": "systematic_spectra_phz_quality_lensmc.png",
          "systematic_spectra_phz_quality_metacal": "systematic_spectra_phz_quality_metacal.png",
          "systematic_spectra_psf_density": "systematic_spectra_psf_density.png",
          "systematic_spectra_psf_lensmc": "systematic_spectra_psf_lensmc.png",
          "systematic_spectra_psf_metacal": "systematic_spectra_psf_metacal.png",
          "systematic_spectra_saa_density": "systematic_spectra_saa_density.png",
          "systematic_spectra_saa_lensmc": "systematic_spectra_saa_lensmc.png",
          "systematic_spectra_saa_metacal": "systematic_spectra_saa_metacal.png",
          "systematic_spectra_star_brightness_mean_density": "systematic_spectra_star_brightness_mean_density.png",
          "systematic_spectra_star_brightness_mean_lensmc": "systematic_spectra_star_brightness_mean_lensmc.png",
          "systematic_spectra_star_brightness_mean_metacal": "systematic_spectra_star_brightness_mean_metacal.png",
          "systematic_spectra_stellar_density_density": "systematic_spectra_stellar_density_density.png",
          "systematic_spectra_stellar_density_lensmc": "systematic_spectra_stellar_density_lensmc.png",
          "systematic_spectra_stellar_density_metacal": "systematic_spectra_stellar_density_metacal.png",
          "systematic_spectra_zodiacal_light_density": "systematic_spectra_zodiacal_light_density.png",
          "systematic_spectra_zodiacal_light_lensmc": "systematic_spectra_zodiacal_light_lensmc.png",
          "systematic_spectra_zodiacal_light_metacal": "systematic_spectra_zodiacal_light_metacal.png"
        },
        "mtime": 1771446144000,
        "generated": "2026-02-18T20:21:39.693789+00:00"
      }
    },
    {
      "id": "covariance-validation-namaster-4b3c85a4",
      "title": "Covariance validation: NaMaster agrees with Knox within 25%",
      "kind": "task",
      "status": "closed",
      "body": "Two independent covariance estimates — NaMaster Gaussian (harmonic-space, mask-aware) and Knox formula (analytic mode counting) — agree within ~25% for density × CMB κ cross-spectra across all 6 redshift bins and both CMB experiments. This validates the error bars used throughout the analysis.\n\n**NaMaster Gaussian covariance** uses the Improved Narrow Kernel Approximation (INKA) with theory+noise guess spectra: C^{κκ} + N_L for the CMB auto, C^{EE/δδ} + shape/shot noise for the galaxy auto, and C^{fκ}_theory for the cross. This captures mask mode-coupling effects that the Knox formula ignores.\n\n**Knox formula** uses analytic mode counting: Var(C^{ab}_b) = C^{aa}_b · C^{bb}_b / n_modes_b, with n_modes from fsky_eff (Hivon 2002). Independent of mask geometry beyond the effective sky fraction.\n\nThe ratio NaMaster/Knox ≈ 1.04 for density (spin-0 × spin-0) and ≈ 1.26 for shear (spin-2 × spin-0, map-based). The >1 ratio is expected: mode coupling from partial sky mixes power between bins, increasing variance beyond what Knox predicts.\n\n**For catalog-based shear** (production default): the NaMaster Gaussian covariance is computed using an auxiliary map-based NmtField. The catalog field measures the spectrum (via NmtFieldCatalog), but the covariance workspace requires map-domain masks that NmtFieldCatalog can't expose. Since covariance depends on mask geometry and auto-spectra (not the measurement method), the map-based covariance is valid for catalog spectra. This gives uniform NaMaster error bars across all probes.\n\n**Bug history**: An interleaved diagonal extraction bug inflated the apparent NaMaster/Knox ratio to ~31× for spin-2 fields. The NaMaster `gaussian_covariance()` output for spin-2 × spin-0 is (2·nbins, 2·nbins) with Eκ and Bκ components interleaved as (bin0_Eκ, bin0_Bκ, bin1_Eκ, ...). Plain `np.diag(cov)[:nbins]` mixed components from wrong bins. Fixed via `extract_covariance_diagonal()` in `nmt_utils.py`.\n\n**Script**: `cmbx/files/workflow_scripts_plot_covariance_validation.py`",
      "outcome": "NaMaster Gaussian covariance validated against Knox formula. Density (spin-0): median NaMaster/Knox = 1.04 (range 0.96–2.21, std 0.15). Shear (spin-2, map-based auxiliary field): ~1.26. NaMaster deployed as primary error bars throughout the tapestry. Catalog-based shear uses map-based auxiliary NmtField for covariance since NmtFieldCatalog cannot expose masks. Interleaved diagonal extraction bug (31× overestimate) fixed in nmt_utils.extract_covariance_diagonal(). Knox kept as diagnostic only.",
      "tags": [
        "tapestry:plot_covariance_validation",
        "region:methodology"
      ],
      "createdAt": "2026-02-18T15:46:29.913255271+01:00",
      "closedAt": "2026-02-18T18:09:58.665430158+01:00",
      "dependsOn": [
        "catalog-validation-summary-d0b856bd",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ],
      "specName": "plot_covariance_validation",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "median_nmt_knox_ratio": 1.041,
          "min_nmt_knox_ratio": 0.96,
          "max_nmt_knox_ratio": 2.206,
          "std_nmt_knox_ratio": 0.149,
          "n_bins_compared": 6,
          "n_cmbk_compared": 2,
          "interleaved_bug_fixed": true,
          "covariance_method": "NaMaster Gaussian (theory+noise guess spectra)",
          "shear_covariance": "Knox proxy (catalog-based, NaMaster requires map masks)"
        },
        "artifacts": {
          "png": "covariance_validation.png"
        },
        "mtime": 1771427655000,
        "generated": "2026-02-18T15:14:13.437617+00:00"
      }
    },
    {
      "id": "euclid-rr2-maps-0d4db3db",
      "title": "Euclid RR2 maps",
      "kind": "task",
      "status": "open",
      "body": "Euclid RR2 weak lensing and galaxy clustering maps used in the cross-correlation analysis. Two shear measurement pipelines (lensmc, metacal), galaxy density from the GC catalog, and 11 VMPZ-ID systematic maps. The footprint covers ~385 deg² across two spatial patches. Masking follows spectra.make_mask: weights multiplied into the binary footprint, then C2 apodized.\n\n## Shear maps\n\n- **Pipelines**: lensmc, metacal — independent shape measurement methods\n- **Per-bin products**: e₁/e₂ shear maps, sum_weights, n_eff\n- **All-bin**: union across `config[tomography.bin_ids]`\n- **Sign convention**: Euclid e₁ along RA; HEALPix Q along colatitude → [-e₁, e₂] for NaMaster (pol_conv=COSMO)\n- **Noise**: NOISE_CL in FITS headers = σ²_comp / n_eff_sr (flat shape noise per component)\n\n## Galaxy density maps\n\n- **Source catalog**: `config[gc_catalog]` (parquet)\n- **Bins**: `config[gc_tom_bins]`\n- **Products**: δ overdensity + selection mask per bin\n- **Density mask is strictly binary**: `build_density_maps.py` sets mask = 1 for every occupied pixel, 0 elsewhere. Only one distinct non-zero value (confirmed bin=3). `make_convergence_mask` then applies `apodize(mask > 0) * mask`, which is apodize(binary) * 1 — the weight factor contributes nothing extra (contrast with shear where `weights=[weight_map]` tapers by varying galaxy weights).\n- **Shot noise**: N_ℓ = 1/n̄_sr (constant per mode)\n\n## CMB lensing mask apodization\n\n`make_cmb_mask` calls `nmt.mask_apodization(mask, aposcale, \"C2\")` on the input. The ACT DR6 baseline mask is already the official 3° cos² apodized lensing mask (Qu+ 2023 Sec 5.3). Applying a second 0.15° C2 pass changes mask pixel values by at most 6.3×10⁻⁴ (rms 2.6×10⁻⁵), zero change in fsky — negligible. This is benign: the long-scale ACT apodization dwarfs the 0.15° second pass.\n\n## Systematic maps\n\n11 VMPZ-ID maps at nside 16384 (NESTED), downgraded to analysis nside at load time:\nstellar_density, galactic_extinction, exposures, zodiacal_light, saa, psf, noise, persistence, star_brightness_mean, galaxy_number_density, phz_quality\n\n## Tomographic binning\n\n`config[tomography.n_bins]` bins (IDs: `config[tomography.bin_ids]`). Shear n(z) from `config[nz.wl]`; density n(z) from `config[nz.gc]`.\n\n## Weight masking\n\nspectra.make_mask(): binary footprint × weights, then apodize. Scale: `config[cross_correlation.aposcale]`°. For density, weights=[binary mask], so C2 apodization acts on a hard edge — visible rolloff at the footprint boundary. For shear, weights=[sum_weights], so the taper is smoothed by varying galaxy counts before apodization.\n\n## Estimator\n\n`config[cross_correlation.estimator]`: catalog (NmtFieldCatalog, bypasses map-making) or map (NmtField).\n\n## Apodization audit\n\nVisualized in `cmbx/files/results_claims_euclid_density_apodization_euclid_density_apodization.png` (rule `plot_euclid_density_apodization`). Rows: density raw, density post-apod, ACT raw, ACT post-double-apod.",
      "outcome": "Density mask is strictly binary (0/1, confirmed bin=3): build_density_maps.py produces a selection mask with exactly one distinct non-zero value. make_convergence_mask thus apodizes a hard step function, producing a visible rolloff at footprint edges — unlike shear where the weight map already grades the boundary. The ACT DR6 double-apodization (make_cmb_mask calling C2 again on the already-smooth 3° official mask) is negligible: max pixel change 6.3e-4, rms 2.6e-5, zero fsky change. No corrective action needed for CMB masking; density apodization is correct for the data it receives (binary footprint with no per-pixel weight variation). Divergence from shear apodization is structural, not a bug.",
      "tags": [
        "doc",
        "tapestry:euclid_rr2_maps"
      ],
      "createdAt": "2026-02-20T03:37:02.558564638+01:00",
      "closedAt": null,
      "dependsOn": [
        "euclid-n-z-d8d52b17"
      ],
      "specName": "euclid_rr2_maps",
      "staleness": "stale",
      "evidence": {
        "metrics": {
          "nside": 2048,
          "masking": {
            "method": "C2",
            "aposcale_deg": 0.15,
            "shear": {
              "fsky_raw": 0.009339,
              "fsky_apodized": 0.008087,
              "area_raw_deg2": 385.26,
              "area_apodized_deg2": 333.63
            },
            "density": {
              "fsky_raw": 0.009296,
              "fsky_apodized": 0.008087,
              "area_raw_deg2": 383.48,
              "area_apodized_deg2": 333.63
            },
            "shared_support": {
              "fsky_raw": 0.00927,
              "fsky_apodized": 0.008087,
              "area_raw_deg2": 382.4,
              "area_apodized_deg2": 333.63
            },
            "effective_overlap_raw": {
              "shear_x_act": 0.007676,
              "shear_x_spt": 0.003437,
              "density_x_act": 0.007632,
              "density_x_spt": 0.003417
            },
            "effective_overlap_apodized": {
              "shear_x_act": 0.006639,
              "shear_x_spt": 0.00302,
              "density_x_act": 0.006639,
              "density_x_spt": 0.00302
            }
          }
        },
        "artifacts": {
          "png_map": "euclid_rr2_maps.png",
          "png_mask": "euclid_rr2_maps_apodized.png"
        },
        "mtime": 1771784714000,
        "generated": "2026-02-22T18:24:41.541912+00:00"
      }
    },
    {
      "id": "cmb-lensing-maps-e7e9436c",
      "title": "CMB lensing maps",
      "kind": "task",
      "status": "open",
      "body": "CMB lensing convergence (κ) maps from ACT DR6 and SPT-3G used as the mass tracer in cross-correlations with Euclid. κ is the projected matter density along the line of sight, reconstructed from CMB temperature and polarization via quadratic estimators. Both experiments provide κ maps, masks, noise curves, and simulations.\n\n## What κ is\n\nLensing convergence κ(n̂) = -½ ∇² φ(n̂), where φ is the lensing potential. Proportional to the projected matter density weighted by the lensing kernel. Spin-0 field.\n\n## Shared conventions\n\n- All κ maps at nside `config[nside]` (downgraded from native resolution at data prep time, not runtime)\n- Masks are pre-apodized by the experiments; we apply additional `config[cross_correlation.aposcale]`° C2 apodization via make_cmb_mask\n- Noise per mode (N_L) provided by each experiment — used for Knox formula and theory comparison\n\n## Experiments\n\nTwo baselines for cross-correlation: ACT DR6 and SPT-3G winter GMV. SPT also provides TT, PP, MV estimator variants for consistency checks. Details in child fibers.",
      "outcome": null,
      "tags": [
        "doc",
        "tapestry:cmb_lensing_maps"
      ],
      "createdAt": "2026-02-20T03:37:16.679809363+01:00",
      "closedAt": null,
      "dependsOn": [
        "data-euclid-act-spt-7d4e8847"
      ],
      "specName": "cmb_lensing_maps",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "nside": 2048,
          "wiener_filtered": true,
          "fsky": {
            "act_raw": 0.257931,
            "spt_raw": 0.043721,
            "rr2": 0.009339,
            "act_x_rr2": 0.007676,
            "spt_x_rr2": 0.003437
          },
          "area_deg2": {
            "act_x_rr2": 316.65,
            "spt_x_rr2": 141.78
          }
        },
        "artifacts": {
          "png": "cmb_lensing_maps.png"
        },
        "mtime": 1771565161000,
        "generated": "2026-02-20T05:25:26.326499+00:00"
      }
    },
    {
      "id": "act-dr6-lensing-e4a3eae9",
      "title": "ACT DR6 lensing",
      "kind": "task",
      "status": "open",
      "body": "ACT DR6 CMB lensing convergence map — the primary wide-area CMB lensing dataset in this analysis. 9,400 deg² (fsky ≈ 0.23), reconstructed from temperature and polarization using the minimum-variance quadratic estimator (Qu+ 2023, Madhavacheril+ 2023).\n\n## Data products\n\n- **κ map**: kappa_map_data_act_dr6_lensing_v1_baseline.fits (nside 2048)\n- **Mask**: mask_act_dr6_lensing_v1_healpix_nside_2048_baseline.fits (downgraded from official nside=4096 release). 3° cosine-squared apodization applied by ACT (Qu+ 2023 Sec. 5.3; docs/arxiv/2304.05202_act_dr6_lensing_power/main.tex:453). ~20% of nonzero pixels < 1.\n- **Noise curve**: N_L_kk_act_dr6_lensing_v1_baseline.txt (provided in release)\n- **Filter**: kappa_filter_act_dr6_lensing_v1_baseline.txt\n\n## Overlap with Euclid RR2\n\n~261 deg² (mask > 0.95 threshold). Euclid footprint is fully contained within ACT.\n\n## References\n\n- Qu+ 2023 (2304.05202): DR6 lensing power spectrum. TeX: docs/arxiv/2304.05202_act_dr6_lensing_power/main.tex\n- Madhavacheril+ 2023 (2304.05203): DR6 lensing map and cosmological parameters",
      "outcome": null,
      "tags": [
        "doc",
        "tapestry:act_dr6_lensing"
      ],
      "createdAt": "2026-02-20T03:37:30.344411877+01:00",
      "closedAt": null,
      "dependsOn": [
        "cmb-lensing-maps-e7e9436c"
      ],
      "specName": "act_dr6_lensing",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "nside": 2048,
          "wiener_filtered": true,
          "masking": {
            "method": "C2",
            "aposcale_deg": 0.15,
            "fsky_raw": 0.257931,
            "fsky_apodized": 0.256906,
            "area_raw_deg2": 10640.42,
            "area_apodized_deg2": 10598.12,
            "effective_overlap_raw": 0.007676,
            "effective_overlap_apodized": 0.00702,
            "effective_overlap_raw_deg2": 316.65,
            "effective_overlap_apodized_deg2": 289.61
          }
        },
        "artifacts": {
          "png_map": "act_dr6_lensing_map.png",
          "png_mask": "act_dr6_lensing_apodized.png"
        },
        "mtime": 1771612412000,
        "generated": "2026-02-20T18:32:44.453377+00:00"
      }
    },
    {
      "id": "spt-3g-winter-lensing-ab712d17",
      "title": "SPT-3G winter lensing",
      "kind": "task",
      "status": "open",
      "body": "SPT-3G winter field CMB lensing convergence maps — the deep, small-area CMB lensing dataset. ~1,550 deg² (mask > 0.95), four estimator variants sharing the same footprint.\n\n## Estimator variants\n\n- **GMV** (generalized minimum variance): baseline, highest SNR\n- **PP** (polarization-only): least biased by foregrounds, key cross-check\n- **TT** (temperature-only): most sensitive to tSZ/CIB contamination\n- **MV** (minimum variance): standard MV combination\n\nGMV and PP are the primary baselines for cross-correlation. TT and MV are consistency checks (SPT estimator comparison node).\n\n## Data products (per estimator)\n\n- **κ map**: k{gmv,tt,pp,mv}_fid_052425_0.fits\n- **Mask**: mask2048_border_apod_mask_threshold0.1_allghz_dense.fits (shared, pre-apodized, ~31% of nonzero pixels < 1)\n- **Simulations**: 11 sims per estimator (1 Gaussian + 10 Agora), independent κ realizations\n- **N₀**: placeholder from auto-minus-cross of independent sims (approximate). Proper N₀ to come from SPT.\n\n## Overlap with Euclid RR2\n\n~115 deg² (mask > 0.95 threshold). Smaller overlap than ACT but deeper per-mode sensitivity.\n\n## Open questions\n\n- 24% deficit in SPT×Euclid relative to ACT×Euclid (see spt-deficit-characterization-6b724e41)\n- SPT mask: pre-apodized; provenance not yet documented from SPT papers\n- Proper N₀ needed from SPT (current is approximate)",
      "outcome": null,
      "tags": [
        "doc",
        "tapestry:spt_winter_lensing"
      ],
      "createdAt": "2026-02-20T03:37:45.336137524+01:00",
      "closedAt": null,
      "dependsOn": [
        "cmb-lensing-maps-e7e9436c"
      ],
      "specName": "spt_winter_lensing",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "nside": 2048,
          "wiener_filtered": true,
          "masking": {
            "method": "C2",
            "aposcale_deg": 0.15,
            "fsky_raw": 0.043721,
            "fsky_apodized": 0.043456,
            "area_raw_deg2": 1803.61,
            "area_apodized_deg2": 1792.68,
            "effective_overlap_raw": 0.003437,
            "effective_overlap_apodized": 0.003166,
            "effective_overlap_raw_deg2": 141.78,
            "effective_overlap_apodized_deg2": 130.62
          }
        },
        "artifacts": {
          "png_map": "spt_winter_lensing_map.png",
          "png_mask": "spt_winter_lensing_apodized.png"
        },
        "mtime": 1771612412000,
        "generated": "2026-02-20T18:32:26.203896+00:00"
      }
    },
    {
      "id": "refine-apodized-mask-statistics-6ccd32f2",
      "title": "Refine apodized mask statistics for map-doc fibers",
      "kind": "task",
      "status": "closed",
      "body": "Fix ACT/SPT/Euclid evidence to report meaningful apodized fsky/overlap (weighted by apod masks), then validate DAG targets.",
      "outcome": "Updated map-doc scripts to compute apodized mask stats using weighted C2 masks (not >0 thresholds), including effective overlap deg2 metrics in ACT/SPT evidence and raw+apod overlap stats in Euclid evidence. Fixed shared-map conventions plotting error (skyproj inset colorbar return type handling). Installed TinyTeX directly into writable container (/usr/local/TinyTeX) and linked TeX binaries into /usr/local/bin so text.usetex works in Snakemake container jobs without bashrc/bind hacks. Removed temporary TinyTeX shell-path modifications from ~/.bashrc. Next iteration should rerun plot_shared_map_conventions/plot_cmb_lensing_maps/plot_act_dr6_lensing/plot_spt_winter_lensing/plot_euclid_rr2_maps to regenerate evidence.",
      "tags": [
        "task",
        "tapestry:map-doc-mask-stats"
      ],
      "createdAt": "2026-02-20T04:51:49.07243013+01:00",
      "closedAt": "2026-02-20T05:18:14.062168459+01:00",
      "dependsOn": [],
      "specName": "map-doc-mask-stats",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "introduction-cmb-lensing-euclid-da9491ce",
      "title": "Introduction",
      "kind": "task",
      "status": "open",
      "body": "Cross-correlating CMB lensing convergence with the shapes and positions of photometric galaxies probes the growth of large-scale structure across cosmic time, testing ΛCDM with independent observables from two entirely different physical effects. This analysis measures C_ℓ^{γκ} and C_ℓ^{δκ} between Euclid RR2 weak lensing shear / galaxy density and CMB lensing convergence from ACT DR6 and SPT-3G (winter), across 6 tomographic bins. The result is a 15σ detection (ACT, post-marginalization) and 14σ (SPT), consistent with Planck 2018 ΛCDM.\n\n**Motivation**: CMB lensing × cosmic shear is insensitive to additive shear systematics (which don't correlate with the CMB) and CMB lensing multiplicative biases — making it a robust, nearly model-independent probe of the projected matter distribution at z ~ 0.3–1.5. Euclid's wide southern survey provides the galaxy data; ACT and SPT provide CMB lensing over overlapping patches of 261 deg² and 115 deg² respectively.\n\n**Comparator analyses**: \n- DES × ACT DR6: Qu+ 2023 (`cmbx/files/docs_papers_2309.04412_act_des_shear_main.tex`).\n- DES × SPT methods: Chang+ 2022 (`cmbx/files/docs_papers_2203.12439_des_spt_planck_methods_main.tex`).\n- DES × SPT correlations: Omori+ 2022 (`cmbx/files/docs_papers_2203.12440_des_spt_planck_correlations_main.tex`).\n- DES × SPT 2026 update: `cmbx/files/docs_papers_des_spt_shearxlensing_2026_shearXlensing_20260202.pdf`.\n- ACT DR6 lensing power spectrum: Madhavacheril+ 2024 (`cmbx/files/docs_arxiv_2304.05202_act_dr6_lensing_power_main.tex`).\n- SPT-3G winter lensing: `cmbx/files/docs_papers_spt_winter_lensing_apssamp.tex`.\n\n**Collaboration**: SPT-Euclid MoU (DR1-KP-CMBX-3/2) — see [MOU proposal](.felt/spt-euclid-mou-collaboration-6de6bc54.md). CMBX-SWG is coordinating with WL-SWG on blinding; CMBX is listed as a potential unblinding authority. People: Cail Daley (data), Margherita Lembo (co-lead, gctools), Louis Legrand (co-lead, likelihood), Giulio Fabbian (SWG science lead), Emma Ayçoberry.",
      "outcome": null,
      "tags": [
        "tapestry:introduction",
        "tier:1"
      ],
      "createdAt": "2026-02-22T07:51:04.067925112+01:00",
      "closedAt": null,
      "dependsOn": [],
      "specName": "introduction",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "data-euclid-act-spt-7d4e8847",
      "title": "Data",
      "kind": "task",
      "status": "open",
      "body": "Three surveys on the southern sky. Euclid RR2 weak lensing (~50M galaxies, 385 deg² effective footprint, 6 tomographic bins), ACT DR6 lensing convergence (fsky 0.248, Wiener-filtered), and SPT-3G winter lensing (fsky 0.044, GMV + TT/PP/MV estimators). The cross-correlation is measured where these overlap — see evidence for areas.\n\nSub-nodes detail the per-instrument data: [Euclid RR2 maps](.felt/euclid-rr2-maps-0d4db3db.md), [CMB lensing maps](.felt/cmb-lensing-maps-e7e9436c.md) → [ACT DR6](.felt/act-dr6-lensing-e4a3eae9.md), [SPT-3G winter](.felt/spt-3g-winter-lensing-ab712d17.md).",
      "outcome": null,
      "tags": [
        "tier:1",
        "tapestry:shared_map_conventions"
      ],
      "createdAt": "2026-02-22T07:51:09.038257896+01:00",
      "closedAt": null,
      "dependsOn": [
        "introduction-cmb-lensing-euclid-da9491ce"
      ],
      "specName": "shared_map_conventions",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "nside": 2048,
          "pixel_counts": {
            "code_0": 36539058,
            "code_1": 11295005,
            "code_2": 726802,
            "code_3": 1300743,
            "code_4": 51588,
            "code_5": 245467,
            "code_6": 32115,
            "code_7": 140870
          },
          "fsky": {
            "code_0": 0.725966,
            "code_1": 0.224412,
            "code_2": 0.01444,
            "code_3": 0.025843,
            "code_4": 0.001025,
            "code_5": 0.004877,
            "code_6": 0.000638,
            "code_7": 0.002799
          },
          "area_deg2": {
            "code_0": 29948.27,
            "code_1": 9257.65,
            "code_2": 595.7,
            "code_3": 1066.12,
            "code_4": 42.28,
            "code_5": 201.19,
            "code_6": 26.32,
            "code_7": 115.46
          },
          "triple_overlap_deg2": 115.46,
          "pair_overlap_deg2": {
            "act_spt": 1066.12,
            "act_euclid": 201.19,
            "spt_euclid": 26.32
          }
        },
        "artifacts": {
          "png": "shared_map_conventions.png"
        },
        "mtime": 1771564849000,
        "generated": "2026-02-20T05:20:37.159411+00:00"
      }
    },
    {
      "id": "methods-pseudo-cℓ-cross-3eedb9dd",
      "title": "Methods",
      "kind": "task",
      "status": "open",
      "body": "Angular cross-power spectra are estimated via the NaMaster pseudo-Cℓ formalism (Alonso+ 2019), which accounts for the mode-coupling induced by partial-sky masks via a coupling matrix, then decouples into bandpowers. Masks are C2-apodized at 0.15 rad scale following gctools conventions — the apodization preserves mask area (ACT mean weight drops only 0.4%) while suppressing ringing from sharp edges. The production shear estimator is catalog-based (NmtFieldCatalog), operating directly on galaxy positions and ellipticities without pixelization; it is validated against the map-based estimator (NmtField) with median bandpower correlation 0.998. Covariances use the NaMaster Gaussian approximation, validated against the Knox formula (NaMaster/Knox ≈ 1.04 for density, ≈ 1.26 for shear after the interleaved-diagonal fix).\n\nThe methods section covers four nodes: apodization masks (the geometry that enters the pseudo-Cℓ), estimator validation (catalog vs map), covariance estimation (NaMaster vs Knox), and the systematic maps inventory (11 VMPZ-ID maps that feed into the contamination analysis). Snakemake rules: `compute_cross_spectrum`, `catalog_to_map`, `compute_systematic_cross_spectrum`. Core library: NaMaster via gctools conventions (`dr1_cmbx/src/dr1_cmbx/eDR1data/gctools/spectra.py`).",
      "outcome": null,
      "tags": [
        "tapestry:methods_overview",
        "tier:1"
      ],
      "createdAt": "2026-02-22T07:51:09.043824252+01:00",
      "closedAt": null,
      "dependsOn": [
        "data-euclid-act-spt-7d4e8847"
      ],
      "specName": "methods_overview",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "validation-null-tests-and-48ab3654",
      "title": "Validation",
      "kind": "task",
      "status": "open",
      "body": "Validation proceeds through four pillars: theory consistency (do the measured spectra match Planck 2018 ΛCDM?), cross-experiment and cross-pipeline consistency (do ACT and SPT agree? lensmc and metacal?), null tests (jackknife, simulation, B-mode), and systematic contamination analysis (11 VMPZ-ID maps, bias budget, harmonic-space contamination metric, and template marginalization). The analysis is declared clean when each pillar passes: theory residuals are flat (ACT), null tests show no significant power, and the systematic bias budget is dominated by stellar density at ~0.3σ.\n\nFourteen nodes populate this section, organized by concern. Key open questions: SPT shows scale-dependent residuals (amplitude deficit at ℓ < 300, ℓ > 800) not explained by known systematics — the 24% deficit characterization remains under investigation (`spt-deficit-characterization-6b724e41`). B-mode covariance is approximate (NaMaster Gaussian underestimates BB variance at partial sky — `namaster-gaussian-covariance-9373b1fa`). Template marginalization is implemented; deprojected spectra and likelihoods are in `evaluate_deprojected_likelihood`.",
      "outcome": null,
      "tags": [
        "tapestry:validation_overview",
        "tier:1"
      ],
      "createdAt": "2026-02-22T07:51:09.048592373+01:00",
      "closedAt": null,
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ],
      "specName": "validation_overview",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "results-detection-and-90f2ec1b",
      "title": "Results",
      "kind": "task",
      "status": "open",
      "body": "[In progress.] Primary detection: 15σ (ACT, post-marginalization over 11 systematic templates), 14σ (SPT). Cross-spectra across 6 tomographic bins for γκ (shear × CMB lensing) and δκ (galaxy density × CMB lensing) are consistent with Planck 2018 ΛCDM predictions. The amplitude parameter A = 1.04 ± 0.07 (ACT) relative to the Planck best-fit theory.\n\nThis section will hold the key figures and numbers: the signal overview (6-bin cross-spectra with theory), the amplitude constraints from the likelihood, and the one-page synthesis. The SPT result is reported alongside ACT but flagged for the unresolved scale-dependent shape discrepancy.",
      "outcome": null,
      "tags": [
        "tapestry:results",
        "tier:1"
      ],
      "createdAt": "2026-02-22T07:51:09.05318019+01:00",
      "closedAt": null,
      "dependsOn": [
        "validation-null-tests-and-48ab3654"
      ],
      "specName": "results",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "euclid-n-z-d8d52b17",
      "title": "Euclid catalog",
      "kind": "task",
      "status": "closed",
      "body": "The Euclid RR2 weak lensing and galaxy clustering catalogs. WL: ~50M galaxies measured with lensmc and metacal shear pipelines, 6 tomographic bins defined by photometric redshift. GC: ~30M galaxies, 6 bins spanning z̄ ≈ 0.31–0.89 — shallower than WL (z̄ ≈ 0.52–1.72), reflecting the photometric selection for clustering. Catalog inputs: `euclid/catalogs/rr2_v2_1_wl_031224/` (WL), `euclid/catalogs/catalogRR2_v2_GC_031124.parquet` (GC). Both feed into map-building rules producing the HEALPix maps in [Euclid RR2 maps](.felt/euclid-rr2-maps-0d4db3db.md).\n\n**Figure** (`euclid_nz_overview.png`): Two-panel plot of n(z) for WL (left) and GC (right). Each panel shows 6 tomographic bins as filled curves, normalized to unit area (∫n(z)dz = 1) over a 3000-point grid from z=0 to z=6. Curves drawn from the theoretical pipeline n(z) stored in `RR2_v2_Nz_WL/GC_C2020_sel_pv.fits` (columns BIN_ID, MEAN_REDSHIFT, N_Z). Mean redshift annotated per bin in the legend.\n\n**Open: n(z) smoothing** — the theoretical n(z) arrays from the FITS files are noisy/jagged in the tails. The correct smoothing procedure for use in the theory C_ℓ calculation is not yet confirmed. Check Slack for the established RR2 convention (Margherita / WL-SWG n(z) thread). Until resolved, theory C_ℓ uses the raw FITS n(z).",
      "outcome": "WL: 6 bins, mean_z=[0.52, 0.60, 0.71, 0.90, 1.19, 1.72]. GC: 6 bins, mean_z=[0.31, 0.39, 0.48, 0.57, 0.70, 0.89]. Catalogs: rr2_v2_1_wl_031224 (~50M WL) + catalogRR2_v2_GC_031124 (~30M GC).",
      "tags": [
        "tapestry:euclid_nz_overview"
      ],
      "createdAt": "2026-02-22T18:21:30.016792001+01:00",
      "closedAt": "2026-02-22T18:22:09.215933877+01:00",
      "dependsOn": [
        "data-euclid-act-spt-7d4e8847"
      ],
      "specName": "euclid_nz_overview",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "n_wl_bins": 6,
          "n_gc_bins": 6,
          "wl_mean_z_bin1": 0.5205,
          "wl_mean_z_bin2": 0.5968,
          "wl_mean_z_bin3": 0.7122,
          "wl_mean_z_bin4": 0.8976,
          "wl_mean_z_bin5": 1.1917,
          "wl_mean_z_bin6": 1.7166,
          "gc_mean_z_bin1": 0.3144,
          "gc_mean_z_bin2": 0.3906,
          "gc_mean_z_bin3": 0.475,
          "gc_mean_z_bin4": 0.5741,
          "gc_mean_z_bin5": 0.6979,
          "gc_mean_z_bin6": 0.8882
        },
        "artifacts": {
          "png": "euclid_nz_overview.png"
        },
        "mtime": 1771785174000,
        "generated": "2026-02-22T18:32:52.040544+00:00"
      }
    },
    {
      "id": "shared-apodization-layer-for-d4ff610f",
      "title": "Apodization Layer",
      "kind": "task",
      "status": "active",
      "body": "Common apodized-footprint mask layer shared by Euclid RR2 and CMB lensing map products, feeding harmonic-space estimators.",
      "outcome": null,
      "tags": [
        "methods",
        "question",
        "tapestry:apodization_layer"
      ],
      "createdAt": "2026-02-23T01:58:33.367145157+01:00",
      "closedAt": null,
      "dependsOn": [
        "euclid-rr2-maps-0d4db3db",
        "cmb-lensing-maps-e7e9436c",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ],
      "specName": "apodization_layer",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "catalog-based-harmonic-space-14a8b515",
      "title": "Catalog Harmonic Estimator",
      "kind": "task",
      "status": "open",
      "body": "Catalog-based pseudo-C_ell estimator path (NmtFieldCatalog), with map-based auxiliary mask geometry for covariance consistency checks.",
      "outcome": null,
      "tags": [
        "methods",
        "tapestry:catalog_based_harmonic_estimator"
      ],
      "createdAt": "2026-02-23T01:58:33.370189048+01:00",
      "closedAt": null,
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ],
      "specName": "catalog_based_harmonic_estimator",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "map-based-harmonic-space-5f227b0f",
      "title": "Map Harmonic Estimator",
      "kind": "task",
      "status": "open",
      "body": "Map-based pseudo-C_ell estimator path (NmtField from maps), consuming formal apodized masks and producing harmonic-space spectra/covariance inputs.",
      "outcome": null,
      "tags": [
        "methods",
        "tapestry:map_based_harmonic_estimator"
      ],
      "createdAt": "2026-02-23T01:58:33.37203342+01:00",
      "closedAt": null,
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd",
        "shared-apodization-layer-for-d4ff610f"
      ],
      "specName": "map_based_harmonic_estimator",
      "staleness": "no-evidence",
      "evidence": null
    },
    {
      "id": "wiener-filter-validation-46ee1c27",
      "title": "Wiener filter validation",
      "kind": "task",
      "status": "closed",
      "body": "This node establishes whether the Wiener filtering used for ACT/SPT kappa map visualization is both scientifically justified and operationally legible in the tapestry. The result is that the filtering diagnosis is stable (ACT is noise-dominated relative to SPT in this setup), but the original evidence schema was slightly off for renderer discovery. We corrected the evidence document shape while preserving the quantitative conclusion, so the node now serves both analysis integrity and dashboard usability.\n\nThe rule computes Planck 2018 theory `C_ell^{kappa kappa}`, compares it to per-mode map spectra (`C_ell^map / f_sky`) for ACT and SPT, estimates noise as `max(C_ell^map / f_sky - C_ell^{kappa kappa}, 0)` with a high-ell floor, and plots both empirical and theory-informed `W(ell)`. The output figure is `cmbx/files/results_claims_wiener_filter_validation_wiener_filter_validation.png`, with sidecar `cmbx/files/results_claims_wiener_filter_validation_evidence.json`.\n\nConcretely, this figure shows: (1) theory `C_ell^{kappa kappa}`, (2) ACT/SPT data spectra, (3) ACT/SPT noise estimates, and (4) empirical versus theory-informed filter transfer functions. It answers the intended methods question directly and now conforms to the same evidence schema conventions as other rendered tapestry nodes.",
      "outcome": "Revalidated end-to-end and brought into tapestry evidence convention compliance. Evidence.json now includes top-level output field for renderer discovery. Scientific result unchanged: empirical filtering fails for ACT (noise floor 6.85e-08) versus SPT (2.72e-09, ratio 25.2). Theory-informed filter using Planck 2018 C_ell^{kk} yields act_ell_half_theory=null up to ell=1000 while SPT crosses at ell~353. ACT non-crossing remains a downstream methods question.\n",
      "tags": [
        "region:validation:consistency",
        "tapestry:wiener_filter_validation"
      ],
      "createdAt": "2026-02-23T01:58:57.668264249+01:00",
      "closedAt": "2026-02-23T03:47:07.513130172+01:00",
      "dependsOn": [
        "spt-3g-winter-lensing-ab712d17",
        "act-dr6-lensing-e4a3eae9",
        "cmb-lensing-maps-e7e9436c"
      ],
      "specName": "wiener_filter_validation",
      "staleness": "fresh",
      "evidence": {
        "metrics": {
          "lmax": 1000,
          "act_noise_floor_empirical": 6.853636016908232e-8,
          "spt_noise_floor_empirical": 2.7158563817660473e-9,
          "noise_ratio_act_over_spt": 25.2,
          "act_ell_half_theory": null,
          "spt_ell_half_theory": 353,
          "act_fsky": 0.25793,
          "spt_fsky": 0.04372,
          "finding": "Empirical Wiener filter fails for ACT: reconstruction noise 25x higher than SPT, map pseudo-Cl never exceeds noise floor. Theory-informed filter using Planck 2018 C_ℓ^{κκ} resolves the issue by providing the known signal model. ACT W(ℓ) now peaks at ~0.5 for ℓ<100, SPT at ~0.8."
        },
        "artifacts": {
          "wiener_filter_validation": "wiener_filter_validation.png"
        },
        "mtime": 1771834335000,
        "generated": "2026-02-23T08:12:07.518344+00:00"
      }
    },
    {
      "id": "systematic-contamination-summary-e6c81e29",
      "title": "Systematic contamination summary",
      "kind": "task",
      "status": "closed",
      "body": "Summary node for systematic contamination evidence. This sits between the Validation spine and individual contamination analyses so readers can enter the contamination story once, then drill into detailed tests.",
      "outcome": "Validation contamination entry point introduced for DAG legibility: contamination storyline is summarized here, with detailed checks as downstream children (null pulls, contamination metric, raw spectra, bias budget, and template deprojection).",
      "tags": [
        "tapestry:systematic_contamination_summary",
        "region:validation:contamination"
      ],
      "createdAt": "2026-02-23T02:16:29.53996908+01:00",
      "closedAt": null,
      "dependsOn": [
        "validation-null-tests-and-48ab3654"
      ],
      "specName": "systematic_contamination_summary",
      "staleness": "no-evidence",
      "evidence": null
    }
  ],
  "links": [
    {
      "source": "signal-overview-act-spt-theory-1ae2798f",
      "target": "act-vs-spt-cross-spectra-b4181199"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "act-vs-spt-cross-spectra-b4181199"
    },
    {
      "source": "act-dr6-lensing-e4a3eae9",
      "target": "act-vs-spt-cross-spectra-b4181199"
    },
    {
      "source": "spt-3g-winter-lensing-ab712d17",
      "target": "act-vs-spt-cross-spectra-b4181199"
    },
    {
      "source": "signal-overview-act-spt-theory-1ae2798f",
      "target": "lensmc-vs-metacal-method-7d4d724f"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "lensmc-vs-metacal-method-7d4d724f"
    },
    {
      "source": "signal-overview-act-spt-theory-1ae2798f",
      "target": "theory-comparison-data-d5cc9678"
    },
    {
      "source": "results-detection-and-90f2ec1b",
      "target": "theory-comparison-data-d5cc9678"
    },
    {
      "source": "act-dr6-lensing-e4a3eae9",
      "target": "theory-comparison-data-d5cc9678"
    },
    {
      "source": "spt-3g-winter-lensing-ab712d17",
      "target": "theory-comparison-data-d5cc9678"
    },
    {
      "source": "systematic-null-test-heatmap-92dec7e5",
      "target": "contamination-metric-product-c-e55501f4"
    },
    {
      "source": "systematic-maps-on-the-sky-83122c03",
      "target": "contamination-metric-product-c-e55501f4"
    },
    {
      "source": "systematic-contamination-summary-e6c81e29",
      "target": "contamination-metric-product-c-e55501f4"
    },
    {
      "source": "signal-overview-act-spt-theory-1ae2798f",
      "target": "systematic-null-test-heatmap-92dec7e5"
    },
    {
      "source": "systematic-maps-on-the-sky-83122c03",
      "target": "systematic-null-test-heatmap-92dec7e5"
    },
    {
      "source": "systematic-contamination-summary-e6c81e29",
      "target": "systematic-null-test-heatmap-92dec7e5"
    },
    {
      "source": "methods-pseudo-cℓ-cross-3eedb9dd",
      "target": "catalog-validation-summary-d0b856bd"
    },
    {
      "source": "catalog-based-harmonic-space-14a8b515",
      "target": "catalog-validation-summary-d0b856bd"
    },
    {
      "source": "act-vs-spt-cross-spectra-b4181199",
      "target": "spt-estimator-comparison-gmv-vs-7f4cef00"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "spt-estimator-comparison-gmv-vs-7f4cef00"
    },
    {
      "source": "spt-3g-winter-lensing-ab712d17",
      "target": "spt-estimator-comparison-gmv-vs-7f4cef00"
    },
    {
      "source": "signal-overview-act-spt-theory-1ae2798f",
      "target": "jackknife-null-test-random-sign-e86273e8"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "jackknife-null-test-random-sign-e86273e8"
    },
    {
      "source": "theory-comparison-data-d5cc9678",
      "target": "theory-residual-analysis-6a66a995"
    },
    {
      "source": "results-detection-and-90f2ec1b",
      "target": "theory-residual-analysis-6a66a995"
    },
    {
      "source": "jackknife-null-test-random-sign-e86273e8",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "theory-residual-analysis-6a66a995",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "spt-estimator-comparison-gmv-vs-7f4cef00",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "catalog-validation-summary-d0b856bd",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "act-vs-spt-cross-spectra-b4181199",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "lensmc-vs-metacal-method-7d4d724f",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "systematic-null-test-heatmap-92dec7e5",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "contamination-metric-product-c-e55501f4",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "theory-comparison-data-d5cc9678",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "simulation-null-test-sim-kappa-6418a9f1",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "fiducial-likelihood-evaluation-4c17b5d9",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "signal-overview-act-spt-theory-1ae2798f",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "systematic-bias-budget-709ea507",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "ℓ-range-robustness-amplitude-e86f1728",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "same-sky-same-galaxies-act-and-85397551",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "b-mode-null-test-passes-galaxy-0f71087b",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "results-detection-and-90f2ec1b",
      "target": "analysis-summary-one-page-c5170698"
    },
    {
      "source": "theory-comparison-data-d5cc9678",
      "target": "fiducial-likelihood-evaluation-4c17b5d9"
    },
    {
      "source": "results-detection-and-90f2ec1b",
      "target": "fiducial-likelihood-evaluation-4c17b5d9"
    },
    {
      "source": "jackknife-null-test-random-sign-e86273e8",
      "target": "simulation-null-test-sim-kappa-6418a9f1"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "simulation-null-test-sim-kappa-6418a9f1"
    },
    {
      "source": "catalog-validation-summary-d0b856bd",
      "target": "signal-overview-act-spt-theory-1ae2798f"
    },
    {
      "source": "covariance-validation-namaster-4b3c85a4",
      "target": "signal-overview-act-spt-theory-1ae2798f"
    },
    {
      "source": "results-detection-and-90f2ec1b",
      "target": "signal-overview-act-spt-theory-1ae2798f"
    },
    {
      "source": "data-euclid-act-spt-7d4e8847",
      "target": "signal-overview-act-spt-theory-1ae2798f"
    },
    {
      "source": "systematic-null-test-heatmap-92dec7e5",
      "target": "systematic-bias-budget-709ea507"
    },
    {
      "source": "contamination-metric-product-c-e55501f4",
      "target": "systematic-bias-budget-709ea507"
    },
    {
      "source": "systematic-contamination-summary-e6c81e29",
      "target": "systematic-bias-budget-709ea507"
    },
    {
      "source": "theory-residual-analysis-6a66a995",
      "target": "ℓ-range-robustness-amplitude-e86f1728"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "ℓ-range-robustness-amplitude-e86f1728"
    },
    {
      "source": "methods-pseudo-cℓ-cross-3eedb9dd",
      "target": "systematic-maps-on-the-sky-83122c03"
    },
    {
      "source": "act-vs-spt-cross-spectra-b4181199",
      "target": "same-sky-same-galaxies-act-and-85397551"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "same-sky-same-galaxies-act-and-85397551"
    },
    {
      "source": "act-dr6-lensing-e4a3eae9",
      "target": "same-sky-same-galaxies-act-and-85397551"
    },
    {
      "source": "spt-3g-winter-lensing-ab712d17",
      "target": "same-sky-same-galaxies-act-and-85397551"
    },
    {
      "source": "signal-overview-act-spt-theory-1ae2798f",
      "target": "b-mode-null-test-passes-galaxy-0f71087b"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "b-mode-null-test-passes-galaxy-0f71087b"
    },
    {
      "source": "systematic-null-test-heatmap-92dec7e5",
      "target": "systematic-spectra-raw-c-fs-c-3d65264d"
    },
    {
      "source": "systematic-maps-on-the-sky-83122c03",
      "target": "systematic-spectra-raw-c-fs-c-3d65264d"
    },
    {
      "source": "contamination-metric-product-c-e55501f4",
      "target": "systematic-spectra-raw-c-fs-c-3d65264d"
    },
    {
      "source": "systematic-contamination-summary-e6c81e29",
      "target": "systematic-spectra-raw-c-fs-c-3d65264d"
    },
    {
      "source": "catalog-validation-summary-d0b856bd",
      "target": "covariance-validation-namaster-4b3c85a4"
    },
    {
      "source": "methods-pseudo-cℓ-cross-3eedb9dd",
      "target": "covariance-validation-namaster-4b3c85a4"
    },
    {
      "source": "euclid-n-z-d8d52b17",
      "target": "euclid-rr2-maps-0d4db3db"
    },
    {
      "source": "data-euclid-act-spt-7d4e8847",
      "target": "cmb-lensing-maps-e7e9436c"
    },
    {
      "source": "cmb-lensing-maps-e7e9436c",
      "target": "act-dr6-lensing-e4a3eae9"
    },
    {
      "source": "cmb-lensing-maps-e7e9436c",
      "target": "spt-3g-winter-lensing-ab712d17"
    },
    {
      "source": "introduction-cmb-lensing-euclid-da9491ce",
      "target": "data-euclid-act-spt-7d4e8847"
    },
    {
      "source": "data-euclid-act-spt-7d4e8847",
      "target": "methods-pseudo-cℓ-cross-3eedb9dd"
    },
    {
      "source": "methods-pseudo-cℓ-cross-3eedb9dd",
      "target": "validation-null-tests-and-48ab3654"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "results-detection-and-90f2ec1b"
    },
    {
      "source": "data-euclid-act-spt-7d4e8847",
      "target": "euclid-n-z-d8d52b17"
    },
    {
      "source": "euclid-rr2-maps-0d4db3db",
      "target": "shared-apodization-layer-for-d4ff610f"
    },
    {
      "source": "cmb-lensing-maps-e7e9436c",
      "target": "shared-apodization-layer-for-d4ff610f"
    },
    {
      "source": "methods-pseudo-cℓ-cross-3eedb9dd",
      "target": "shared-apodization-layer-for-d4ff610f"
    },
    {
      "source": "methods-pseudo-cℓ-cross-3eedb9dd",
      "target": "catalog-based-harmonic-space-14a8b515"
    },
    {
      "source": "methods-pseudo-cℓ-cross-3eedb9dd",
      "target": "map-based-harmonic-space-5f227b0f"
    },
    {
      "source": "shared-apodization-layer-for-d4ff610f",
      "target": "map-based-harmonic-space-5f227b0f"
    },
    {
      "source": "spt-3g-winter-lensing-ab712d17",
      "target": "wiener-filter-validation-46ee1c27"
    },
    {
      "source": "act-dr6-lensing-e4a3eae9",
      "target": "wiener-filter-validation-46ee1c27"
    },
    {
      "source": "cmb-lensing-maps-e7e9436c",
      "target": "wiener-filter-validation-46ee1c27"
    },
    {
      "source": "validation-null-tests-and-48ab3654",
      "target": "systematic-contamination-summary-e6c81e29"
    }
  ],
  "downstream": {
    "signal-overview-act-spt-theory-1ae2798f": [
      {
        "id": "act-vs-spt-cross-spectra-b4181199",
        "title": "ACT vs SPT: same galaxies, same spectrum",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "redshift-trend-signal-increases-bafce25b",
        "title": "Redshift trend: signal rises with lensing kernel overlap",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "lensmc-vs-metacal-method-7d4d724f",
        "title": "lensmc vs metacal: pipeline independence",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "theory-comparison-data-d5cc9678",
        "title": "Theory comparison: Planck 2018 predicts the ACT signal",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-null-test-heatmap-92dec7e5",
        "title": "Systematic null tests: galactic extinction correlates with shear",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "jackknife-null-test-random-sign-e86273e8",
        "title": "Jackknife: galaxy-side systematics are clean",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "signal-overview-race-condition-da325c16",
        "title": "Signal overview race condition: explicit NPZ inputs",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "b-mode-null-test-passes-galaxy-0f71087b",
        "title": "B-mode null test passes: galaxy-side shear systematics are clean",
        "status": "closed",
        "kind": "task"
      }
    ],
    "validation-null-tests-and-48ab3654": [
      {
        "id": "act-vs-spt-cross-spectra-b4181199",
        "title": "ACT vs SPT: same galaxies, same spectrum",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "lensmc-vs-metacal-method-7d4d724f",
        "title": "lensmc vs metacal: pipeline independence",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spt-estimator-comparison-gmv-vs-7f4cef00",
        "title": "SPT estimators: no foreground bias",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "jackknife-null-test-random-sign-e86273e8",
        "title": "Jackknife: galaxy-side systematics are clean",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "simulation-null-test-sim-kappa-6418a9f1",
        "title": "Simulation null: CMB-side systematics are clean",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "ℓ-range-robustness-amplitude-e86f1728",
        "title": "ℓ-range robustness: ACT stable, SPT scale-dependent",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "same-sky-same-galaxies-act-and-85397551",
        "title": "Same sky, same galaxies: ACT and SPT agree in the overlap",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "b-mode-null-test-passes-galaxy-0f71087b",
        "title": "B-mode null test passes: galaxy-side shear systematics are clean",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-detection-and-90f2ec1b",
        "title": "Results",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "systematic-contamination-summary-e6c81e29",
        "title": "Systematic contamination summary",
        "status": "closed",
        "kind": "task"
      }
    ],
    "act-dr6-lensing-e4a3eae9": [
      {
        "id": "act-vs-spt-cross-spectra-b4181199",
        "title": "ACT vs SPT: same galaxies, same spectrum",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "theory-comparison-data-d5cc9678",
        "title": "Theory comparison: Planck 2018 predicts the ACT signal",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "same-sky-same-galaxies-act-and-85397551",
        "title": "Same sky, same galaxies: ACT and SPT agree in the overlap",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "wiener-filter-validation-46ee1c27",
        "title": "Wiener filter validation",
        "status": "closed",
        "kind": "task"
      }
    ],
    "spt-3g-winter-lensing-ab712d17": [
      {
        "id": "act-vs-spt-cross-spectra-b4181199",
        "title": "ACT vs SPT: same galaxies, same spectrum",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "theory-comparison-data-d5cc9678",
        "title": "Theory comparison: Planck 2018 predicts the ACT signal",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spt-estimator-comparison-gmv-vs-7f4cef00",
        "title": "SPT estimators: no foreground bias",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spt-theory-comparison-fails-b14b26a4",
        "title": "SPT theory comparison fails while ACT passes: Knox covariance or calibration?",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "same-sky-same-galaxies-act-and-85397551",
        "title": "Same sky, same galaxies: ACT and SPT agree in the overlap",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spt-n0-estimation-do-sims-share-04e30f73",
        "title": "SPT N0 estimation: do sims share input kappa?",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "wiener-filter-validation-46ee1c27",
        "title": "Wiener filter validation",
        "status": "closed",
        "kind": "task"
      }
    ],
    "results-detection-and-90f2ec1b": [
      {
        "id": "theory-comparison-data-d5cc9678",
        "title": "Theory comparison: Planck 2018 predicts the ACT signal",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "theory-residual-analysis-6a66a995",
        "title": "Theory residuals: ACT passes, SPT fails in shape",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "fiducial-likelihood-evaluation-4c17b5d9",
        "title": "Likelihood: 15σ (ACT), 14σ (SPT) detection — ΛCDM consistent",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "signal-overview-act-spt-theory-1ae2798f",
        "title": "The signal: cross-spectra for 6 bins (γκ + δκ), ACT and SPT",
        "status": "closed",
        "kind": "task"
      }
    ],
    "systematic-null-test-heatmap-92dec7e5": [
      {
        "id": "contamination-metric-product-c-e55501f4",
        "title": "Contamination metric: small per bandpower, dangerous in aggregate",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-bias-budget-709ea507",
        "title": "Bias budget: stellar density is the dominant ACT contaminant",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-spectra-raw-c-fs-c-3d65264d",
        "title": "Systematic spectra: raw C^{fS}, C^{κS}, C^{SS} contamination ingredients",
        "status": "closed",
        "kind": "task"
      }
    ],
    "systematic-maps-on-the-sky-83122c03": [
      {
        "id": "contamination-metric-product-c-e55501f4",
        "title": "Contamination metric: small per bandpower, dangerous in aggregate",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-null-test-heatmap-92dec7e5",
        "title": "Systematic null tests: galactic extinction correlates with shear",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "vmpz-id-multi-file-systematic-3740c3f0",
        "title": "VMPZ-ID multi-file systematic maps: pick largest/latest for visualization",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "adding-sysmaps-to-config-e1b8b3f5",
        "title": "Adding sysmaps to config triggers null test cascade",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-spectra-raw-c-fs-c-3d65264d",
        "title": "Systematic spectra: raw C^{fS}, C^{κS}, C^{SS} contamination ingredients",
        "status": "closed",
        "kind": "task"
      }
    ],
    "systematic-contamination-summary-e6c81e29": [
      {
        "id": "contamination-metric-product-c-e55501f4",
        "title": "Contamination metric: small per bandpower, dangerous in aggregate",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-null-test-heatmap-92dec7e5",
        "title": "Systematic null tests: galactic extinction correlates with shear",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-bias-budget-709ea507",
        "title": "Bias budget: stellar density is the dominant ACT contaminant",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "template-deprojection-a1621797",
        "title": "Template deprojection: contamination boosts ACT signal",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-spectra-raw-c-fs-c-3d65264d",
        "title": "Systematic spectra: raw C^{fS}, C^{κS}, C^{SS} contamination ingredients",
        "status": "closed",
        "kind": "task"
      }
    ],
    "methods-pseudo-cℓ-cross-3eedb9dd": [
      {
        "id": "catalog-validation-summary-d0b856bd",
        "title": "Estimator comparison",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "apodization-masks-what-enters-f6b5a581",
        "title": "Apodization masks: what enters the cross-correlations",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-maps-on-the-sky-83122c03",
        "title": "Systematic maps: complete inventory and visualization of all VMPZ-ID maps",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "covariance-validation-namaster-4b3c85a4",
        "title": "Covariance validation: NaMaster agrees with Knox within 25%",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "validation-null-tests-and-48ab3654",
        "title": "Validation",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "scratch-utility-imports-04b7458d",
        "title": "Scratch utility imports",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "compute-scripts-remove-inline-748e8426",
        "title": "Compute scripts: remove inline NaMaster calls",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "shared-apodization-layer-for-d4ff610f",
        "title": "Apodization Layer",
        "status": "active",
        "kind": "task"
      },
      {
        "id": "catalog-based-harmonic-space-14a8b515",
        "title": "Catalog Harmonic Estimator",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "map-based-harmonic-space-5f227b0f",
        "title": "Map Harmonic Estimator",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "catalog-estimator-f3e211f9",
        "title": "Catalog estimator",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "map-estimator-e97a19ea",
        "title": "Map estimator",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "formal-mask-outputs-76171c0b",
        "title": "Formal mask outputs",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "act-filter-crossing-975b0af6",
        "title": "ACT filter crossing",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "theory-api-drift-cb72d714",
        "title": "Theory API drift",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "ia-config-not-propagated-to-2cf39a50",
        "title": "IA config propagation",
        "status": "open",
        "kind": "task"
      }
    ],
    "catalog-based-harmonic-space-14a8b515": [
      {
        "id": "catalog-validation-summary-d0b856bd",
        "title": "Estimator comparison",
        "status": "closed",
        "kind": "task"
      }
    ],
    "act-vs-spt-cross-spectra-b4181199": [
      {
        "id": "spt-estimator-comparison-gmv-vs-7f4cef00",
        "title": "SPT estimators: no foreground bias",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spt-theory-comparison-fails-b14b26a4",
        "title": "SPT theory comparison fails while ACT passes: Knox covariance or calibration?",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "same-sky-same-galaxies-act-and-85397551",
        "title": "Same sky, same galaxies: ACT and SPT agree in the overlap",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "act-vs-spt-composite-only-d6c1557e",
        "title": "ACT vs SPT composite-only reduction",
        "status": "open",
        "kind": "task"
      }
    ],
    "theory-comparison-data-d5cc9678": [
      {
        "id": "spt-theory-comparison-fails-b14b26a4",
        "title": "SPT theory comparison fails while ACT passes: Knox covariance or calibration?",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "theory-residual-analysis-6a66a995",
        "title": "Theory residuals: ACT passes, SPT fails in shape",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "fiducial-likelihood-evaluation-4c17b5d9",
        "title": "Likelihood: 15σ (ACT), 14σ (SPT) detection — ΛCDM consistent",
        "status": "closed",
        "kind": "task"
      }
    ],
    "jackknife-null-test-random-sign-e86273e8": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "simulation-null-test-sim-kappa-6418a9f1",
        "title": "Simulation null: CMB-side systematics are clean",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spatial-variation-test-north-vs-c9fdd8ed",
        "title": "Spatial variation: north and south agree",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      }
    ],
    "theory-residual-analysis-6a66a995": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spt-deficit-bin-level-structure-de2540dd",
        "title": "SPT deficit bin-level structure: shape fails at low-z, amplitude-only at high-z",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "ℓ-range-robustness-amplitude-e86f1728",
        "title": "ℓ-range robustness: ACT stable, SPT scale-dependent",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "theory-residual-ia-theory-as-663344d8",
        "title": "Theory residual: IA theory as denominator",
        "status": "closed",
        "kind": "task"
      }
    ],
    "spt-estimator-comparison-gmv-vs-7f4cef00": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      }
    ],
    "catalog-validation-summary-d0b856bd": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "signal-overview-act-spt-theory-1ae2798f",
        "title": "The signal: cross-spectra for 6 bins (γκ + δκ), ACT and SPT",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "covariance-validation-namaster-4b3c85a4",
        "title": "Covariance validation: NaMaster agrees with Knox within 25%",
        "status": "closed",
        "kind": "task"
      }
    ],
    "lensmc-vs-metacal-method-7d4d724f": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "method-chi2-calibration-95cd218e",
        "title": "Method chi2 calibration",
        "status": "open",
        "kind": "task"
      }
    ],
    "contamination-metric-product-c-e55501f4": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-bias-budget-709ea507",
        "title": "Bias budget: stellar density is the dominant ACT contaminant",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-contamination-five-f509e962",
        "title": "Systematic contamination: five-layer analysis methodology",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-spectra-raw-c-fs-c-3d65264d",
        "title": "Systematic spectra: raw C^{fS}, C^{κS}, C^{SS} contamination ingredients",
        "status": "closed",
        "kind": "task"
      }
    ],
    "simulation-null-test-sim-kappa-6418a9f1": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      }
    ],
    "fiducial-likelihood-evaluation-4c17b5d9": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "deprojected-likelihood-joint-26b1588e",
        "title": "Template marginalization: ACT consistent after joint fit",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      }
    ],
    "systematic-bias-budget-709ea507": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "act-systematic-bias-exceeds-1a76bb12",
        "title": "ACT systematic bias exceeds signal in low-z bins",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "template-deprojection-a1621797",
        "title": "Template deprojection: contamination boosts ACT signal",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "systematic-contamination-five-f509e962",
        "title": "Systematic contamination: five-layer analysis methodology",
        "status": "closed",
        "kind": "task"
      }
    ],
    "ℓ-range-robustness-amplitude-e86f1728": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "results-table-paper-ready-latex-2a507292",
        "title": "Results table: paper-ready LaTeX compilation of all key numbers",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "findings-synthesis-euclid-cmb-03354e57",
        "title": "Findings synthesis: Euclid × CMB-κ cross-correlation analysis",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "spt-deficit-bin-level-structure-de2540dd",
        "title": "SPT deficit bin-level structure: shape fails at low-z, amplitude-only at high-z",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "ℓ-range-robustness-for-spt-2ec181e2",
        "title": "ℓ-range robustness for SPT estimator variants (TT, PP, GMV)",
        "status": "closed",
        "kind": "task"
      }
    ],
    "same-sky-same-galaxies-act-and-85397551": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      }
    ],
    "b-mode-null-test-passes-galaxy-0f71087b": [
      {
        "id": "analysis-summary-one-page-c5170698",
        "title": "Analysis summary: one-page synthesis",
        "status": "closed",
        "kind": "task"
      }
    ],
    "covariance-validation-namaster-4b3c85a4": [
      {
        "id": "signal-overview-act-spt-theory-1ae2798f",
        "title": "The signal: cross-spectra for 6 bins (γκ + δκ), ACT and SPT",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "namaster-preferred-over-knox-c06c65ea",
        "title": "NaMaster preferred over Knox for plot error bars",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "map-based-namaster-covariance-884f2578",
        "title": "Map-based NaMaster covariance for catalog-based shear cross-spectra",
        "status": "closed",
        "kind": "task"
      }
    ],
    "data-euclid-act-spt-7d4e8847": [
      {
        "id": "signal-overview-act-spt-theory-1ae2798f",
        "title": "The signal: cross-spectra for 6 bins (γκ + δκ), ACT and SPT",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "wiener-filter-diagnostic-plot-w-14438464",
        "title": "Wiener filter diagnostic: plot W(ℓ) and power spectra for ACT/SPT κ",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "apodization-masks-what-enters-f6b5a581",
        "title": "Apodization masks: what enters the cross-correlations",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "maps-shared-conventions-and-c4fac8e3",
        "title": "Maps: shared conventions and standards",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "cmb-lensing-maps-e7e9436c",
        "title": "CMB lensing maps",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "methods-pseudo-cℓ-cross-3eedb9dd",
        "title": "Methods",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "euclid-n-z-d8d52b17",
        "title": "Euclid catalog",
        "status": "closed",
        "kind": "task"
      }
    ],
    "analysis-summary-one-page-c5170698": [
      {
        "id": "findings-synthesis-euclid-cmb-03354e57",
        "title": "Findings synthesis: Euclid × CMB-κ cross-correlation analysis",
        "status": "closed",
        "kind": "task"
      }
    ],
    "systematic-spectra-raw-c-fs-c-3d65264d": [
      {
        "id": "systematic-spectra-evidence-f060d0e7",
        "title": "Systematic spectra evidence pipeline: fix LaTeX bug, add aggregate rule",
        "status": "closed",
        "kind": "task"
      }
    ],
    "euclid-n-z-d8d52b17": [
      {
        "id": "euclid-rr2-maps-0d4db3db",
        "title": "Euclid RR2 maps",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "evidence-output-field-must-be-b272a7fa",
        "title": "Evidence output field",
        "status": "open",
        "kind": "task"
      }
    ],
    "cmb-lensing-maps-e7e9436c": [
      {
        "id": "act-dr6-lensing-e4a3eae9",
        "title": "ACT DR6 lensing",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "spt-3g-winter-lensing-ab712d17",
        "title": "SPT-3G winter lensing",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "cmb-mask-apodization-aeb0291a",
        "title": "CMB mask apodization",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "shared-apodization-layer-for-d4ff610f",
        "title": "Apodization Layer",
        "status": "active",
        "kind": "task"
      },
      {
        "id": "wiener-filter-validation-46ee1c27",
        "title": "Wiener filter validation",
        "status": "closed",
        "kind": "task"
      }
    ],
    "euclid-rr2-maps-0d4db3db": [
      {
        "id": "euclid-rr2-footprint-is-385-4f93faa4",
        "title": "Euclid RR2 footprint is 385 deg2 not 1300",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "mask-not-data-for-apodization-d511bd5d",
        "title": "Apodization plot convention",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "shared-apodization-layer-for-d4ff610f",
        "title": "Apodization Layer",
        "status": "active",
        "kind": "task"
      }
    ],
    "introduction-cmb-lensing-euclid-da9491ce": [
      {
        "id": "data-euclid-act-spt-7d4e8847",
        "title": "Data",
        "status": "open",
        "kind": "task"
      }
    ],
    "shared-apodization-layer-for-d4ff610f": [
      {
        "id": "map-based-harmonic-space-5f227b0f",
        "title": "Map Harmonic Estimator",
        "status": "open",
        "kind": "task"
      },
      {
        "id": "formal-mask-outputs-76171c0b",
        "title": "Formal mask outputs",
        "status": "closed",
        "kind": "task"
      },
      {
        "id": "apodization-memory-tuning-0eee27a3",
        "title": "Apodization memory tuning",
        "status": "closed",
        "kind": "task"
      }
    ],
    "wiener-filter-validation-46ee1c27": [
      {
        "id": "act-filter-crossing-975b0af6",
        "title": "ACT filter crossing",
        "status": "open",
        "kind": "task"
      }
    ]
  },
  "config": {
    "catalog_version": "rr2_v2_1_wl_031224",
    "pipeline_version": "v0.0",
    "nside": "2048",
    "tomography.n_bins": "6",
    "tomography.bin_ids": "[1,2,3,4,5,6]",
    "intrinsic_alignment.model": "NLA-z",
    "intrinsic_alignment.A_IA": "1.72",
    "intrinsic_alignment.eta_IA": "-0.41",
    "intrinsic_alignment.C_IA": "0.013",
    "intrinsic_alignment.beta_IA": "2.17",
    "gc_tom_bins": "[1,2,3,4,5,6]",
    "cross_correlation.estimator": "map",
    "cross_correlation.binning.lmin": "40",
    "cross_correlation.binning.lmax": "3000",
    "cross_correlation.binning.nells": "20",
    "cross_correlation.binning.log_spacing": "true",
    "cross_correlation.covariance.compute": "true",
    "cross_correlation.aposcale": "0.15",
    "cross_correlation.n_iter": "1",
    "spatial_patches.north.ra_min": "63.8",
    "spatial_patches.north.ra_max": "77.2",
    "spatial_patches.north.dec_min": "-37",
    "spatial_patches.north.dec_max": "-26.5",
    "spatial_patches.south.ra_min": "32",
    "spatial_patches.south.ra_max": "70",
    "spatial_patches.south.dec_min": "-63.5",
    "spatial_patches.south.dec_max": "-44",
    "quality_cuts.bad_tiles": "[102016422,102016856,102016857,102016423,102016424,102017297,102016858,102019131,102018674,102018672,102019596,102019132,102018673,102019133,102042322,102041693,102041070,102041069,102041695,102041694]"
  },
  "fibers": [
    {
      "id": "tr1-analysis-plan-for-wl-3x2pt-f64d4c0e",
      "title": "TR1 Analysis Plan for WL/3x2pt",
      "status": "open",
      "kind": "task",
      "tags": [
        "context"
      ],
      "body": "Source: https://euclid.roe.ac.uk/projects/wl-pipeline/wiki/TR1\nAuthors: 3x2pt Pipeline Group\nLast edit: 31 October 2025\n\n## Summary\n\nTR1 (~30% of DR1 area) defines the analysis setup for DR1. Goal: high standard avoiding systematics impact and confirmation bias. First cosmology papers target simultaneous submission with DR1 public date: **21 October 2026**.\n\n## Blinding Rules\n\n### Catalogue-level tests\n- Can be performed anytime\n- Maps of shears, positions, auxiliary products (n(z), mixing matrices)\n\n### Data-vector level tests\n- **Stage A**: Plot blinded DVs without theory; null tests (B-modes, COSEBIs) allowed\n- **Stage B**: Compare blinded DVs to synthetic at reference cosmology; no fitting\n- Amendment 20/01/2026: Non-tomographic EE Cl and COSEBI E_n can be plotted/shared\n\n### Inference-level tests\n- **Residual tests**: Compute DV shifts from systematics, propagate to S8 shifts — allowed\n- **Fixed cosmology**: Needs 3x2pt pipeline group approval\n- **Constraining power**: Relative loss (% FoM reduction) from trimming — allowed\n- **Full inference**: Do NOT look at Om, S8 posteriors even blinded — needs explicit approval\n\n## Timeline\n\n### Preparatory (by end Oct)\n- Define baseline source/lens samples from RR2\n- JC-1 provides shift vectors to LE3\n\n### Milestone 1 (start Nov)\n- LE3 and KPs ready for validation tests\n\n### Milestone 2 (mid Nov)\n- PHZ assigns tomo bin IDs\n- SHE computes c-bias, MetaCal responses\n- LE3 produces blinded data vectors\n\n### Milestone 3 (end Dec)\n- All catalogue-level and null tests performed\n- Calibrated n(z) produced\n- Baseline scale cuts, model, covariance ready\n\n### Milestone 4 (end Jan)\n- Assess systematics impact via residual tests\n- Decision: trimmed DV, new sample + iteration, or unblinding\n\n## Cross-SWG Coordination\n\nGC-SWG, TH-SWG, **CMBX-SWG**, and CG-SWG can potentially unblind WL-SWG. JC-1 provides forum for cross-SWG cosmology activities.\n\n## CMBX Implications\n\n- Must coordinate blinding with WL-SWG protocols\n- Cross-correlations (κ_CMB × γ, κ_CMB × δ) touch their blinding scheme\n- JC-1 is the coordination forum\n\n## Comments\n**2026-02-11 03:21** — WL-SWG telecon 2026-02-11: We're past Milestone 3 (end Dec) and into Milestone 4 territory (end Jan). B-modes remain unresolved — tiger team forming (Benjamin). First blinded end-to-end products (power spectra + covariances) available on PEAK. Blinding machinery largely in place; final iteration with JC-1 on shift vectors needed. DPS downtime blocking simulations.",
      "outcome": null,
      "createdAt": "2026-01-23T13:41:50.947580458+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "ou-l3-bologna-meeting-report-wl-1443df08",
      "title": "OU-L3 Bologna meeting report — WL summary",
      "status": "open",
      "kind": "task",
      "tags": [
        "telecon",
        "wl-swg",
        "tr1"
      ],
      "outcome": "Sam presented OU-L3 meeting report (Bologna, early Feb 2026). Key outcomes:\n\n## Pipeline decisions\n- **Photo-z rerun**: OU-PHZ will rerun north without U-band and I-band (cluster team found I-band issues). Impact on 3x2pt tomo bin assignment to be assessed.\n- **2D mass decoupled**: Mass mapping pipeline separated from 3x2pt — needs different magnitude cut for higher number density.\n- **Tile-level shear rerun**: Feasibility understood for rerunning part of shear pipeline at tile level to address B-modes. Not yet justified (source unknown).\n\n## Products\n- First end-to-end TR1 products complete: blinded power spectra + covariances on PEAK web dev server.\n- L3 organized into two tiger teams: (1) L2 products / B-modes, (2) L3 pipeline outputs / masks / catalogs / spectra.\n\n## DR2 planning\n- VMPZ becomes focal point for sample selection — guarantees consistent n(z), masks, catalogs.\n- Will Hartley exploring near H-band (instead of VIS) for sample selection — promising for redshift distributions.\n\n## Data quality\n- Casey Craig: cross-correlating BMPZ statistics with lensing signal, galactic extinction, visibility masks.\n- Juan (VMPZ): decontamination simulations for visibility masks — tools exist, flat distribution not yet achieved.",
      "createdAt": "2026-02-11T03:17:07.583835906+01:00",
      "closedAt": null,
      "dependsOn": [
        "tr1-analysis-plan-for-wl-3x2pt-f64d4c0e"
      ]
    },
    {
      "id": "tr1-b-mode-investigation-09cf4dca",
      "title": "TR1 B-mode investigation",
      "status": "open",
      "kind": "task",
      "tags": [
        "tr1",
        "b-modes",
        "wl-swg",
        "critical"
      ],
      "outcome": "## Status: No smoking gun — tiger team being formed\n\nB-modes are significant in TR1. Bologna meeting (Feb 2026) exhausted all obvious avenues without identifying source. Benjamin to captain a dedicated tiger team.\n\n## What was tried\n\n### Nicholas de Sore — Cl cuts\n- Split by faint/bright, large/small objects\n- \"Interesting things but nothing conclusive\"\n\n### 2D mass maps\n- Benjamin: \"might be a hint of structure\" but no smoking gun\n\n### Angus — 2PCF vs CosmoPipe comparison\n- Significant B-modes regardless of method (L3 2PCF or KiDS CosmoPipe)\n- **Discrepancy between L3 and CosmoPipe on some scales** — being investigated\n- Angus provided KiDS data to cross-check; expected to be a fixable issue\n- Masking tests: effective coverage mask (>0.8) removes ~couple orders of B-mode but still significant at ~1e-9. Cluster-based mask also doesn't eliminate.\n\n### Chris Duncan — PSF size residuals\n- Useful diagnostic but not clearly the source\n- PSF looks good on small scales — confusing why B-modes appear on large scales\n- PSF has been improved since R2 but large-scale B-modes haven't changed much\n\n### Sasha — rho/tau statistics\n- Various patches, faint/bright cuts\n- UCL team selected patches avoiding edge/overlap complications\n- **PSF appears to be behaving fairly well** — no obvious PSF-galaxy correlation\n\n### Lila — C-bias residual patterns on sky\n- Initially noticed funny patterns\n- Resolved as projection issue (detector → sky coordinates) with Gordon and Chris\n- Redmine issue open for documentation\n\n### Leonor (UCL) — Average ellipticity in clean patches\n- Some odd behavior in a few patches\n- Not clearly connected to B-modes\n\n### Angus — SOM correlations\n- Self-organizing maps looking for ellipticity correlations with survey parameters\n- Nothing clear; more detailed analysis planned\n\n## Key discussion points\n- **Simulations**: \"If only we had simulations\" — DPS downtime adds ~1 month delay. Nico clarified: never planned to do 100 sq deg sims, only 32 small patches across DR1. Full survey sims could be prioritized but pipeline is late.\n- **PSF propagation**: Would be useful to propagate PSF size biases to see if they produce large-scale B-modes, but no simulation infrastructure for this.\n- **Alan**: Offered to run data through ALMANAC (Bayesian B-mode power spectrum sampler) — to coordinate with Benjamin/Sam/Angus.\n- **Masking + C-bias recomputation**: Angus plans to recompute C-term after masking selections (now has Jacobians from CosmoHub catalog). Doubts it will change C-term significantly, but wants to test C-term vs brightness etc.\n\n## Assessment\nSource unknown. Could be PSF-related, could be something else entirely. \"They can hide very well and we have to dig deeper\" (Henry). Cannot categorically rule out going \"all the way back\" to fundamentals.",
      "createdAt": "2026-02-11T03:17:21.343644988+01:00",
      "closedAt": null,
      "dependsOn": [
        "tr1-analysis-plan-for-wl-3x2pt-f64d4c0e",
        "ou-l3-bologna-meeting-report-wl-1443df08"
      ]
    },
    {
      "id": "c-bias-fov-diagnostic-via-0ae47db3",
      "title": "C-bias FoV diagnostic via pseudo-Cls (Costas)",
      "status": "open",
      "kind": "task",
      "tags": [
        "tr1",
        "c-bias",
        "diagnostics",
        "wl-swg"
      ],
      "outcome": "## Method\nBased on Heymans & Schneider (2016) — adapted from real-space correlation functions to pseudo-Cl (flat sky).\n\n**Core idea**: For each tile, compute mean ellipticity in that tile and mean ellipticity of all *other* tiles (complementary stack). Cross-correlating these suppresses cosmic shear signal, isolating C-bias residuals.\n\n- Works in detector-plane coordinates (not HEALPix — flat 100x100 pixel grid per FoV)\n- Applies rotation from sky → detector plane, corrects for telescope distortion\n- Produces E-mode, B-mode, and EB cross-spectra per FoV\n- Multipole range: ~600 (FoV scale) to ~20,000 (0.01 deg within FoV)\n\n## Key results (RR2 data)\n\n### Raw vs C-corrected\n- Raw tiles show large C-bias power, especially at FoV scales\n- Gordon's C-bias correction significantly reduces power — but **residual power remains**\n- Residual power concentrated at ~1-2 points across FoV (larger scales)\n- LensMC residuals smaller than MetaCal (MetaCal noisier)\n\n### Statistical significance\n- 3-4 sigma detection of residual E and B mode power after C-correction\n- Null test (random rotation of ellipticities) → large p-values, consistent with no signal\n- EB cross-spectrum consistent with zero\n\n### Method refinement (ongoing)\n- **Changed from stacked to single-tile**: Originally stacked ~20 tiles + iterated one at a time. Now uses single tile vs complementary stack — avoids inter-tile correlations, tiles are independent.\n- **Bootstrap covariance**: Replaced sub-covariance (scatter across realizations) with bootstrap resampling of fields — measures coherent detector-plane C-bias pattern (survey-average).\n- Code speed-ups underway; computationally feasible for TR1/DR1.\n\n## Discussion\n- **Wada**: Masking applied per-object (inheriting HEALPix mask values) — didn't change tomography or lens weights.\n- **Alex**: C-bias recomputation after masking not yet done (Angus planned).\n- **Benjamin**: Advantage over real-space (Heymans & Schneider)? → Complementary, not fundamentally different. Costas has pseudo-Cl experience.\n- **Vini**: Can you rotate Cls back to sky coordinates to forward-propagate the systematic? → In principle yes, but limited by FoV scales. Low multipoles unreliable due to large mask.\n- **Interpretation**: Primarily a null test / diagnostic tool. Detects residual power but doesn't identify source (could be PSF, electronics, etc.).\n\n## Next steps\n- Apply to TR1, then DR1 (standard project for DR1)\n- Add tomographic analysis if tile count sufficient\n- Link to slides to be shared on WL-SWG common deck",
      "createdAt": "2026-02-11T03:17:55.8063625+01:00",
      "closedAt": null,
      "dependsOn": [
        "tr1-b-mode-investigation-09cf4dca"
      ]
    },
    {
      "id": "dps-downtime-simulation-delay-00b8f4de",
      "title": "DPS downtime — simulation delay",
      "status": "open",
      "kind": "task",
      "tags": [
        "infrastructure",
        "simulations"
      ],
      "outcome": "DPS down >1 month. ~1 month delay to sim production. ESA aware. Nico: 100 sq deg sims were never planned — only 32 small patches across DR1 for survey environment variability. Full-survey sims (needed for propagating PSF biases → large-scale B-modes) not in scope. Could be prioritized but pipeline already late. Simulation gap is a bottleneck for B-mode diagnosis.",
      "createdAt": "2026-02-11T03:20:42.818893292+01:00",
      "closedAt": null,
      "dependsOn": [
        "tr1-b-mode-investigation-09cf4dca"
      ]
    },
    {
      "id": "almanac-b-mode-sampler-offer-6b4d482c",
      "title": "ALMANAC B-mode sampler offer (Alan)",
      "status": "open",
      "kind": "task",
      "tags": [
        "b-modes",
        "tr1"
      ],
      "outcome": "Alan offered to run TR1 data through ALMANAC (Bayesian B-mode power spectrum sampler). To coordinate with Benjamin, Sam, Angus. Could provide complementary statistical characterization of B-mode power.",
      "createdAt": "2026-02-11T03:20:54.851068004+01:00",
      "closedAt": null,
      "dependsOn": [
        "tr1-b-mode-investigation-09cf4dca"
      ]
    },
    {
      "id": "galaxy-clustering-meeting-in-9b04deaa",
      "title": "Galaxy clustering meeting in Trieste — photometric GC + 3x2pt session",
      "status": "open",
      "kind": "task",
      "tags": [
        "gc-swg",
        "telecon"
      ],
      "outcome": "Ongoing GC meeting in Trieste with session on photometric galaxy clustering and 3x2pt, coordinated by Davide and Anna. Zoom link shared on WL-SWG slides.",
      "createdAt": "2026-02-11T03:21:01.367833191+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "cmbx-3x2pt-blinding-strategy-d2469de7",
      "title": "CMBX 3x2pt blinding strategy",
      "status": "closed",
      "kind": "task",
      "tags": [
        "blinding",
        "3x2pt",
        "tr1"
      ],
      "body": "CMBX 3x2pt blinded consistently with main Euclid 3x2pt blinding. Lets us compare results without unblinding and simplifies collaboration across working groups.\n\nDone with support from Sam Farrens but outside the official Euclid 3x2pt blinding framework. We match the JC1 scheme as closely as possible: a list of cosmologies generates corresponding data-vector shifts, and one shift is randomly picked by an external blinder (Sam Farrens or Chaitanya Chawak).\n\n## Consistency Requirements\n\nTo stay consistent with 3x2pt, we need:\n\n1. The same cosmology list used in JC1 to produce our shifts\n2. Verification that our shifts match CLOE's for the common data vectors:\n   - Galaxy clustering (dd)\n   - Weak lensing (gg)\n   - Galaxy-galaxy lensing (dg)\n\nThis verification is our responsibility.\n\n## Workflow\n\n1. Produce unblinded data vectors from catalogs on the SAS\n2. Run basic numerical checks for pathologies — never plot them\n3. Submit via Redmine to Sam Farrens and Chaitanya Chawak:\n   - Unblinded data vectors\n   - Our computed shifts\n   - Mixing matrices\n4. Receive blinded vectors back\n\nThe mixing matrix must be applied after blinding. Alternatively, we could pass pre-mixed blinded vectors instead of the unblinded vector, shifts, and matrix separately.\n\n## The Blinding Transformation\n\nFollowing the JC1 scheme, blinding applies a shift at the level of summary statistics:\n\nC_l^blind = C_l^obs + DC_l\n\nwhere DC_l = C_l(theta_ref + Dtheta) - C_l(theta_ref)\n\n- theta_ref: reference (fiducial) cosmology\n- Dtheta: blind parameter shift, drawn from a predefined list\n- The reference cosmology should describe the data well\n- The blinded result remains consistent with a realization of theta_ref + Dtheta\n\nOne shift is selected at random by the external blinder from the predefined list.\n\n## Data Format Specification\n\nFollowing the DPDD 2PCF format for Euclid's 3x2pt data products, extended for CMBX cross-correlations.\n\n### Data Vector Components\n\n| Component | DPDD Product | Spectra (6 bins) |\n|-----------|-------------|------------------|\n| dd | TwoPCFWLClPosPos2D | 21 (6 auto + 15 cross) |\n| gg | TwoPCFWLPEBShearShear2D | 21 (6 auto + 15 cross) |\n| dg | TwoPCFWLPEBPosShear2D | 36 (6x6) |\n| dk | (extension) | 6 |\n| gk | (extension) | 6 |\n| kk | (extension) | 1 |\n| **Total** | | **91 spectra** |\n\nWith ~20 l-bins per spectrum: ~1820 data points.\n\n### FITS Structure\n\nEach data product follows the DPDD 2PCF structure:\n- Primary HDU: Metadata keywords including BLINDING flag, SOFTNAME, SOFTVERS, angular binning parameters\n- Extension HDUs: One per bin combination, named {TYPE}_{n}\n- HDU headers: BIN_ID1, BIN_ID2 specify the tomographic bin pair\n\nStandard columns: ELL, ELL_LOWER, ELL_UPPER\n\n### CMBX Extensions\n\nFor CMB lensing cross-correlations (dk, gk, kk):\n- HDU naming: POSKAPPA_CL_{n}, SHEARKAPPA_PEB_{n}, KAPPAKAPPA_CL_1\n- CMB lensing has no tomography: use BIN_ID2=0 for k\n- Follow same column structure as corresponding Euclid products\n\n### Shift Vectors\n\nMatch the data vector structure exactly. Multiple shift files: shifts_001.fits, shifts_002.fits, etc.\n\n## Implementation Status\n\nA prototype shift-generation script exists. It computes DC_l = -C_l^bandpower(theta_ref) + C_l^bandpower(theta_shift) and saves to timestamped pickle files. Output format will be converted to DPDD-aligned FITS.\n\n## Open Items\n\n- Obtain cosmology parameter list from JC1 (Martin Crocce / Guadalupe)\n- Establish Redmine issue template for shift submission\n- Confirm timeline with Sam Farrens\n- Validate theory code agreement with CLOE on common vectors\n\n## References\n\n- Muir et al. 2019 (arXiv:1911.05929): Blinding multi-probe cosmological experiments\n- Euclid DPDD: http://st-dm.pages.euclid-sgs.uk/data-product-doc/dmdr1/\n- JC1 blinding slides",
      "outcome": "Settled: fixed-cosmology A_lens fitting only. No Omega_m, S_8, or richer parameter fits. Current analysis is internal — don't share broadly. The full 3x2pt blinding protocol (DPDD format, shift vectors, Redmine submission to Sam Farrens) remains documented here for when we move to parameter inference, but that's not TR1 scope.",
      "createdAt": "2026-02-11T03:58:14.864610579+01:00",
      "closedAt": "2026-02-15T23:25:22.364329755+01:00",
      "dependsOn": []
    },
    {
      "id": "cmbx-validation-test-proposals-149ba741",
      "title": "CMBX validation test proposals",
      "status": "closed",
      "kind": "task",
      "tags": [
        "validation",
        "tr1",
        "null-tests"
      ],
      "body": "# 2025-06-25: Validation Test Proposals\n\nWith work progressing RR2, we thought it would be a good time to start defining a set of consistency checks, null tests, conditional tests, etc. that will eventually be used for DR1. We have taken inspiration from the tests performed in the [DES x SPT](https://arxiv.org/abs/2203.12440) and Q1 cross-correlation analyses.\n\n## Q1 tests\n\n1. Building jackknives maps from random split of the RR2 sample (null galaxy clustering signal maps) and use them as signal to compute their auto-correlation and CMB lensing cross-correlation.\n2. Cross-correlation between RR2 sample and CMB lensing maps for which we expect to have no or detectable cosmological signal (ACT curl mode map or ACT diff 150GHz - 90 GHz)\n3. Cross-correlation of RR2 sample with CMB lensing maps derived with different type of lensing reconstruction estimators that have different sensitivity to Galactic and extragalactic foregrounds.\n\n[Slides from Giulio on Q1 validation tests](https://docs.google.com/presentation/d/1sxCQnp2zRyyd5Zz-Si0FJz7kpVjmUlOjq1iaQYkstO0/edit?slide=id.g36c87a7ff49_0_50#slide=id.g36c87a7ff49_0_50)\n\n## DES x SPT tests\n\n1. **Survey property (i.e. systematic) map cross-correlations.**\n   If we are worried about a given systematic affecting both tracers and thus contributing to the cross-correlation, can make a map that probes this systematic and cross correlate it with each tracer, and potentially deproject a systematics template if the contamination is significant. In the DES x SPT analysis, they do make survey property maps of stellar density, extinction, PSF ellipticity errors, and PSF size errors.\n\n2. **Cross-shear gamma_x.**\n   In the DES x SPT analysis the shear catalog is cross-correlated directly with the CMB lensing map without producing an intermediate shear map. This is done by taking the tangential component of each galaxy's ellipticity relative to each kappa_CMB pixel to form <gamma_t kappa_CMB>. If instead the component of the galaxy shear oriented 45º relative to each kappa_CMB pixel is taken one can form <gamma_x kappa_CMB> which should be consistent with zero. At least until lensing curl from post-Born effects is detectable.\n\n3. **Effect of delta_g weights on <delta_g kappa_CMB>.**\n   Application of galaxy position weights is intended to reduce systematics, so this isn't exactly a null test. But performing the cross-correlation with and without the weights can give a sense of how big the weight correction is, and can be propagated to cosmological parameters.\n\n4. **Point-source masking in kappa_CMB.**\n   To make sure the inpainting of point sources in the CMB temperature maps is not biasing the lensing reconstruction, they try simply masking these point sources instead. Not clear if they mask the original CMB maps, or just the lensing construction.\n\n5. **Spatial variations in kappa_CMB.**\n   They split their kappa_CMB maps into northern and southern patches, and then cross-correlate both with an external tracer (e.g. CIB). The two cross-correlations should be consistent. This is mostly a test of the lensing maps, but if you saw inconsistency between spatial splits of <gamma_t kappa_CMB> or <delta_g kappa_CMB>, this would help tease out whether the problem is on the CMB or galaxy side.\n\n## Other\n\n1. Sample selection cuts (magnitude, shear weights, etc.). Will require recalibration of shear?\n2. Consistency between tracers:\n   - kappa_CMB: ACT vs. SPT vs. Planck, MV vs Pol reconstruction, bias hardening...\n   - gamma: Metacal vs. Lensmc\n   - delta_g: only one tracer?\n3. Null shear & galaxy maps\n\n## RR2 validation tests proposal [16 July 2025]\n\nLinked to task #31817\n\nFollowing Q1 analysis, we can perform catalog based, spatial based, and CMB lensing null tests and validation. The tests we can do for RR2 depends on the availability of external data (for CMB lensing side), Euclid data and correlated simulations. We do not plan to have correlated simulations with foreground contaminations for RR2 but that is something we should aim for DR1 (eg Agora sims).\n\n1. Cross correlation with jackknives maps from random split of the RR2 sample, nulling galaxy clustering signal\n2. Cross correlation with CMB lensing maps with no signal (curl map, frequency difference maps)\n   - TODO: list available lensing maps for Planck, ACT and SPT\n3. Cross correlation with CMB lensing maps obtained with different estimators (tSZ cleaned leg in the quadratic estimator, different masking, T only versus Pol only versus MV)\n   - TODO: list available lensing maps for Planck, ACT and SPT\n4. Check consistency of cross-correlations with Planck vs ACT vs SPT\n5. Survey property (i.e. systematic) map cross-correlations, following DESxSPT analysis, needs:\n   - TODO: get extinction and stellar density maps (from Gaia data, or Euclid internal)\n   - TODO: PSF error map\n6. Cross-shear gamma_x\n   - TODO: this test is designed in real space, check if correspondence in multipole space is to use mode B lensing maps\n7. Spatial variation: In RR2 we have two patches in the south only. We can further divide the large one into two smaller patches",
      "outcome": "Implementation status of proposed validation tests: (1) Jackknife random split — DONE, 24/24 pass (iteration 8). (2) Curl/frequency-diff CMB maps — BLOCKED, ACT has only baseline ILC kappa, SPT has estimator variants but no curl. Would need ACT collaboration request. (3) Different CMB estimators — DONE, SPT TT/PP/MV all consistent with GMV (iteration 6). (4) ACT vs SPT consistency — DONE, 14/14 pass at 5% (iteration 4). (5) Systematic map cross-correlations — DONE, 70 tests + contamination metric X + bias budget (iterations 1-20). Galactic extinction and stellar density contaminate ACT. (6) Cross-shear gamma_x — NOT DONE, E→B leakage at fsky~0.1 makes B-mode cross-spectrum unreliable as null test. (7) Spatial variation — DONE, north/south 2-patch split, 6/6 pass at ell>100 (iteration 18). (8) Simulation null — DONE (bonus), 11 SPT sims × 6 bins, 1/66 false alarm (iteration 17). Additionally: theory comparison with NLA IA, template marginalization, fiducial likelihood evaluation, results tables all completed. Remaining gaps: curl maps (blocked on data), cross-shear (blocked on E/B leakage physics), Planck kappa (not prioritized).",
      "createdAt": "2026-02-11T03:59:24.790984938+01:00",
      "closedAt": "2026-02-15T12:12:36.277142395+01:00",
      "dependsOn": []
    },
    {
      "id": "rr2-v2-1-catalog-and-shape-f53318bc",
      "title": "RR2 v2.1 catalog and shape noise tracking",
      "status": "open",
      "kind": "task",
      "tags": [
        "data",
        "rr2"
      ],
      "body": "# 2025-12-04: RR2 v2.1 Catalog and Shape Noise Tracking\n\nDownloaded and processed RR2 v2.1 with re-calibrated shears for 2.0 sample selection ([selection history](https://euclid.roe.ac.uk/projects/dr1-kp-jc-2/wiki/Selection_history)). Also updated map-binning step to save shape noise statistics for e.g. NaMaster noise bias subtraction.\n\n## RR2 v2.1 Catalog\n\n**Catalog**: `/leonardo_work/EUHPC_E05_083/cmbx/inputs/euclid/catalogs/rr2_v2_1_wl_031224/rr2_v2_1_wl_031224.parquet` (4.5 GB)\n\n**Maps**: `/leonardo_work/EUHPC_E05_083/cmbx/inputs/euclid/maps/rr2_v2_1_wl_031224/wl_{lensmc,metacal}/`\n\n**Query**: `catalogRR2_v2.1_WL_031224.sql`\n\n**Contents**: Full LensMC and Metacal columns (`she_{method}_e{1,2}_corrected`, `she_{method}_weight`, calibration matrices)\n\n## Workflow Updates\n\n### Outputs Renamed\n\n- `weights_map` → `sum_weights_map` (Σw per pixel)\n- `weighted_counts_map` → `neff_map` ((Σw)²/Σw² per pixel)\n\n### Shape Noise Metadata\n\nAll maps now include FITS header keywords with shape noise statistics:\n\n| Keyword | Description |\n|---------|-------------|\n| `N_GAL`, `N_EFF` | Total and effective galaxy counts |\n| `NEFF_SR` | Effective density (gal/sr) |\n| `SIG_EPS` | Shape noise: σ_ε = sqrt(<e1² + e2²>) after bias subtraction |\n| `SIG_COMP` | Per-component: σ_ε / sqrt(2) (assuming isotropy) |\n| `NOISE_CL` | N_ℓ = σ_ε² / (2 × n_eff/sr) for NaMaster noise bias |\n| `C1_SUB`, `C2_SUB` | Removed additive biases |\n\n### Example Statistics (lensmc_bin1)\n\n```\ngalaxies: 4,768,723\nn_eff / sr: 4.093e+07\nsigma_eps: 3.86e-01\nexpected noise C_ell: 1.82e-09\n```\n\nShape noise per component `SIG_COMP` ~0.27.\n\n### Reading Metadata\n\n```python\nimport fitsio\nf = fitsio.FITS('path/to/shear_maps.fits')\nhdr = f[1].read_header()\nprint(hdr['N_GAL'], hdr['SIG_EPS'], hdr['NOISE_CL'])\n```",
      "outcome": "Downloaded RR2 v2.1 with re-calibrated shears. Updated map-binning to save shape noise stats (SIG_EPS, NOISE_CL, NEFF_SR) for NaMaster noise bias subtraction. Renamed weights_map→sum_weights_map, weighted_counts_map→neff_map.",
      "createdAt": "2026-02-11T03:59:34.49231323+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "spt-euclid-mou-collaboration-6de6bc54",
      "title": "SPT-Euclid MoU collaboration proposal (DR1-KP-CMBX-3/2)",
      "status": "open",
      "kind": "task",
      "tags": [
        "context",
        "reference"
      ],
      "body": "# Cross-correlations between Galaxy Density, Shear, and CMB Lensing with Euclid & SPT-3G\n\nEuclid-SPT MoU Project proposal\nJune 3, 2025\n\n**SPT Contact Person**: Cail Daley (cail.daley@cea.fr)\n**Euclid Contact Person:** Margherita Lembo (lembo@iap.fr)\n**Participants that require data access**: (alphabetical, mention if Euclid or SPT)\nCail Daley (Euclid & SPT), Marco Gatti (Euclid & SPT), Louis Legrand (Euclid), Margherita Lembo (Euclid)\n**Other participants (initial list):** Marina Migliaccio (Euclid), Abhi Maniyar (SPT), Yuuki Omori (SPT), Aaron Ouellette (SPT), Srini Raghunathan (SPT), Kimmy Wu (SPT)\n**Working Groups**: Euclid CMBX, Euclid WL, SPT Lensing, SPT Secondaries & Cross-Correlation\n**Associated Euclid Project:** DR1-KP-CMBX-3/2\n\n**Context:**\nThis project will build upon previous/ongoing CMB lensing cross-correlation analyses in both collaborations. These include cross-correlations of Euclid Q1 EDF-S galaxy density with Planck/ACT (led by Giulio Fabbian) and SPT-3G (led by Cail Daley), and DES shear cross-correlation with SPT-3G (led by Aaron Ouellette). Lessons learned from these analyses as well as preparatory work on likelihoods and parameter inference will allow us to make quick progress on this once the data is shared.\n\n**Datasets**:\n\n* Euclid:\n  1. DR1 position and shear catalogs, maps, and official 3x2pt data products\n  2. RR2 position and shear catalogs (only to validate pipeline before DR1 arrives)\n  3. Flagship simulation products\n* SPT:\n  1. SPT-3G lensing maps for Main, Summer A/B, and EDF-S fields\n     (MV, Pol-only, T-only, bias-hardened, etc.)\n  2. Lensing biases/normalizations: Response, N0, N1, MC corrections, etc.\n  3. SPT-3G Gaussian lensing map simulations for pipeline validation & covariance:\n     both input convergence fields and reconstructions.\n  4. SPT-3G non-Gaussian Agora simulations for foreground bias characterization:\n     TQU maps, input convergence, and reconstructions.\n\n**Tentative Duration**: Targeting release alongside or soon after the Flagship Euclid 3𝗑2𝗉𝗍 results (planned to be one year after internal DR1 release, as required by the ESA deadline).\n.\n\n\n**Deliverables:**\nThis project will deliver validated harmonic-space data vectors and covariances for galaxy density x CMB lensing and shear x CMB lensing. Likelihoods and cosmological parameter constraints including CMB lensing autospectra will also be delivered.\n\n**Overview**:\nCMB lensing (κ) cross-correlated with galaxy positions (δ) and shear (γ) is a powerful cosmological probe that can also be used to calibrate shear and galaxy clustering measurements. For example the DES-SPT-Planck 6x2pt analysis (Abbott et al. 2023\\) using all 6 combinations of δ, γ, and κ tightened constraints on Ωm by 30% and S8 by 50% compared to the DES δ and γ-only 3x2pt, placed 5-10% independent constraints on the shear multiplicative bias, and shed light on potential systematics in DES galaxy samples. Similar analyses performed with Euclid will be critical for maximizing the cosmological return from the data, both in terms of directly tightening parameter constraints and identifying/mitigating potential systematics in Euclid data. DR1 κγ cross-correlations with SPT and Planck are expected to improve the (Ωm, σ8) figure of merit (FoM) by \\~25% compared to γγ-only constraints (M. Gatti forecast).\n\nSPT provides the deepest CMB lensing maps per-pixel currently available, and SPT's Main and Summer fields have excellent overlap with Euclid RR2 and DR1 (see Figure 1 on following page). The overlapping sky fractions for SPT-3G Main and Summer are 1.56% (\\~650 deg²) and 2.53% (\\~1000 deg²) respectively, giving a total overlapping area of 3.91% (1600 deg²) compared to 4.32% (1800 deg²) for all of DR1. SPT-3G x DR1 South κγ measurements are expected to improve the (Ωm, σ8) FoM by 14% compared to Euclid γγ; the corresponding improvement from Planck x DR1 North is expected to be 8% (M. Gatti forecast; Figure 2 on following page). For κδ, extrapolating the preliminary single-tomographic-bin SPT-3G x EDF-S κδ SNR of \\~9 to the DR1 footprint gives SNRs of \\~43 for each of the SPT-3G Main and Summer fields, and a combined SNR of \\~60.\n\nWe propose a cross-correlation analysis between SPT-3G Main and Summer κ with Euclid DR1 δ and γ, specifically targeting the CMB lensing block of the 6𝗑2𝗉𝗍 data vector (δκ, γκ, and κκ). We will hereafter refer to this combination as 3𝗑2𝗉𝗍, in contrast to the standard position-shear 3𝗑2𝗉𝗍 of δδ, γγ, and δγ. Constraints from 3𝗑2𝗉𝗍 and 3𝗑2𝗉𝗍 were found to be approximately equally constraining in Abbott et al. (2023), so the cosmological results from this combination alone are expected to be powerful. The data vectors and likelihoods produced within this project will be used to constraint ΛCDM model parameters and extensions. While both the SPT-3G Main and Summer lensing spectra have been unblinded, the Summer analysis is less mature compared to Winter; if the Summer maps are not sufficiently robust in time we can descope to a Winter-only cross-correlation. If time allows, the project scope can be expanded into a full 6𝗑2𝗉𝗍 by including the Euclid 3𝗑2𝗉𝗍 data vector. We are targeting release of these results alongside or soon after the Flagship Euclid 3𝗑2𝗉𝗍 results. We propose using Euclid RR2 data (available now) as an intermediate step for pipeline validation. These data will not be used for publication.\n\nFigure 1: Overlap of Euclid RR2 and DR1 with the SPT Main and Summer fields, as well as noise levels for the SPT fields.\n\nFigure 2: Figure of merit (FoM) improvements for (Ωm, σ8) when adding Planck and SPT CMB lensing cross-correlation constraints to Euclid weak lensing.",
      "outcome": null,
      "createdAt": "2026-02-11T03:59:39.36315668+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "nx2pt-library-reference-c9524b1d",
      "title": "nx2pt library reference",
      "status": "open",
      "kind": "task",
      "tags": [
        "reference",
        "nx2pt",
        "pipeline"
      ],
      "body": "**Nx2pt Library Guide**\n\nNx2pt provides a light wrapper around NaMaster and SACC so large sets of angular power spectra can be generated from heterogeneous sky tracers and written into standard data products; it is installed as the `run_nx2pt` CLI via the package configuration in `pyproject.toml` (`project.scripts`).\n\n**Package Structure**\n- `tracer.py` defines the data-model layer for all sky tracers, backed by `pymaster.NmtField` objects for maps and catalog samples (`MapTracer`, `CatalogTracer`).\n- `namaster_tools.py` hosts the numerical kernels that build NaMaster workspaces, bin multipoles, and compute coupled/decoupled spectra and covariances.\n- `data.py` packages the outputs (`ClData`) and utilities to bin theory curves and export spectra/covariance information to SACC.\n- `run_nx2pt.py` is the command entry point that loads YAML configuration, instantiates tracers, executes all requested spectra via `compute_cls_cov`, and writes results.\n- `utils.py` supplies lightweight helpers (timed logging, YAML preprocessing, case-insensitive column access) that support the workflow.\n- `maps.py` collects standalone HEALPix helpers for building pixelized map products from catalog positions.\n\n**Tracer Implementations**\n- `Tracer` serves as a non-instantiable base, storing display metadata, optional beams, and spins common to all tracers (`cmbx/files/code_nx2pt_src_nx2pt_tracer.py:8`).\n- `MapTracer` turns one or two HEALPix maps plus a mask into a NaMaster field, inferring spin from the number of maps and defaulting to a pixel window beam when none is given (`cmbx/files/code_nx2pt_src_nx2pt_tracer.py:21`).\n- `CatalogTracer` wraps `NmtFieldCatalog` / `NmtFieldCatalogClustering`, handling both sampled shear/field measurements and clustering with random catalogs up to a user-specified `lmax` (`cmbx/files/code_nx2pt_src_nx2pt_tracer.py:68`).\n- Both tracer types cache the NaMaster field so repeated spectra reuse the expensive object construction, and expose helper attributes such as `noise_est` that the pipeline can read (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:93`).\n\n**Spectra and Covariance Workflow**\n- `compute_cls_cov` loops over requested cross-spectra, pulls cached NaMaster workspaces (hashing masks and spins when a cache directory is provided), computes coupled spectra, and decouples them into bandpowers (`cmbx/files/code_nx2pt_src_nx2pt_namaster_tools.py:202`).\n- Optional shot-noise subtraction applies only to same-tracer auto spectra, with spin-aware handling so E and B components are treated correctly (`cmbx/files/code_nx2pt_src_nx2pt_namaster_tools.py:212`).\n- Gaussian covariances are built via `nmt.gaussian_covariance`, but catalog-based tracers are currently skipped because the covariance path is not implemented for them (`cmbx/files/code_nx2pt_src_nx2pt_namaster_tools.py:247`).\n- Bandpower windows and effective multipoles originate from a configurable binning scheme (`get_ell_bins`) that supports linear, logarithmic, square-root spacing, or explicit edges (`cmbx/files/code_nx2pt_src_nx2pt_namaster_tools.py:12`).\n\n**Data Container**\n- `ClData` stores per-pair spectra, bandpower windows, covariances, and optional noise templates and tracer metadata so downstream exporters can populate SACC metadata blocks (`cmbx/files/code_nx2pt_src_nx2pt_data.py:59`).\n- Utility accessors (`get_cl`, `get_cov`) understand NaMaster spin conventions and expose individual SACC data types such as `cl_ee` or `cl_0e` (`cmbx/files/code_nx2pt_src_nx2pt_data.py:118`).\n- `write_to_sacc` creates a complete SACC file with tracer metadata, spectra, bandpower windows, noise tags, and either block-diagonal or full covariances depending on what was computed (`cmbx/files/code_nx2pt_src_nx2pt_data.py:189`).\n- Interpolation helpers allow binning of theory curves into the measured bandpower basis, with options to reset monopole or dipole terms before binning (`cmbx/files/code_nx2pt_src_nx2pt_data.py:10`).\n\n**Utility Layer**\n- The `Timer` context manager prints start/stop messages with wall-clock durations—`compute_cls_cov` uses this liberally to make long NaMaster calls transparent (`cmbx/files/code_nx2pt_src_nx2pt_utils.py:7`).\n- `preprocess_yaml` lets configuration files include external YAML fragments using `#!include path`, a pattern used extensively in the shearXlensing templates to compose tracer libraries and shared binning blocks (`cmbx/files/code_nx2pt_src_nx2pt_utils.py:24`; `cmbx/files/code_shearXlensing_nx2pt_files_shear-cmbk-2x2.yaml:1`).\n- `get_ul_key` provides case-insensitive access to Astropy table columns when reading catalogs, avoiding fragile casing assumptions (`cmbx/files/code_nx2pt_src_nx2pt_utils.py:48`).\n\n**Command-Line Interface**\n- `run_nx2pt` exposes `--nside` to override the configuration value globally and `--no-cache` to disable workspace caching, otherwise it expects a YAML file defining tracers and requested spectra (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:104`).\n- Workspace caching defaults to the `workspace_dir` path from the YAML and uses `joblib.hash` signatures of mask alm content and spins so repeated jobs can reuse NaMaster coupling matrices (`cmbx/files/code_nx2pt_src_nx2pt_namaster_tools.py:51`).\n- The CLI warns when a cross-spectra block has no outputs configured, encouraging users to set either `save_sacc` or (commented) NPZ exports (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:130`).\n\n**Configuration Reference**\n- Top-level keys include `nside`, a default `binning` scheme, and `workspace_dir`; the default binning can point to a named shape or to explicit edges, as shown by the shared `binning.yaml` templates in shearXlensing (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:116`; `cmbx/files/code_shearXlensing_nx2pt_files_binning.yaml:1`).\n- Each tracer entry supplies a human-readable `name`, `data_dir`, optional `bins` and `bins_one_indexed`, and either a `healpix` block (with `map`, `mask`, optional `is_masked`) or a `catalog` block (with `file` plus `fields` or `randoms`) (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:50`; `cmbx/files/code_shearXlensing_nx2pt_files_tracers.yaml:2`).\n- Map tracers accept `beam: pixwin` (auto-computed beam), `use_mask_squared` to square the HEALPix mask before building the NaMaster field, `correct_qu_sign` to flip the Q map, and optional per-bin `noise_est` lists (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:31`; `cmbx/files/code_shearXlensing_nx2pt_files_tracers.yaml:43`).\n- Catalog tracers can provide `fields` for sampled values or `randoms` for clustering plus optional `field_is_weighted`; column names are matched case-insensitively, simplifying reuse across releases (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:70`).\n- Cross-spectra blocks list tracer pairs and allow per-pair overrides such as `binning`, `subtract_noise`, `autos_only`, and `save_nl`; block-level `covariance` toggles Gaussian covariance calculation and `interbin_cov` adds off-diagonal terms, while `save_sacc` controls FITS output and metadata (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:137`; `cmbx/files/code_shearXlensing_nx2pt_files_shear-cmbk-2x2.yaml:21`).\n\n**Example Workflow Pattern**\n- The shearXlensing project demonstrates composing a configuration by including shared tracer definitions, pointing individual tracer keys (e.g., `wl`, `ck`) at YAML anchors, and running multiple `cross_spectra*` blocks from a single pipeline file (`cmbx/files/code_shearXlensing_nx2pt_files_shear-cmbk-2x2.yaml:13`).\n- Those templates also show how to attach descriptive metadata to SACC outputs so downstream likelihood pipelines can distinguish runs (`cmbx/files/code_shearXlensing_nx2pt_files_shear-cmbk-2x2.yaml:33`).\n\n**Notable Limitations**\n- `ClData.from_sacc` and `ClData.from_theory_cls` are placeholders, so ingesting external SACC files still requires manual glue (`cmbx/files/code_nx2pt_src_nx2pt_data.py:110`).\n- Covariance calculations skip catalog-based tracers entirely, which is important for mixed map–catalog workflows until the missing logic is implemented (`cmbx/files/code_nx2pt_src_nx2pt_namaster_tools.py:247`).\n- The tracer loader references configuration keys via an undefined variable (`config[key]`) when reading beams; this bug needs correction before non-pixwin beams can be loaded reliably (`cmbx/files/code_nx2pt_src_nx2pt_run_nx2pt.py:45`).",
      "outcome": null,
      "createdAt": "2026-02-11T03:59:42.326650899+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "rr2-v1-4-dataset-creation-337aada8",
      "title": "RR2 v1.4 dataset creation",
      "status": "closed",
      "kind": "task",
      "tags": [
        "research",
        "rr2",
        "data"
      ],
      "body": "## Date\n\n2025-09-18\n\n## Dataset Location\n\n`/leonardo_work/EUHPC_E05_083/inputs/euclid/rr2/catalogs/rr2_v1_4_250918/`\n\n## Catalog Updates\n\nEnhanced sample selection criteria implemented via cosmohub query on `euclid_rr2_r1_v1_4` table (7.3GB parquet):\n\n### Core Quality Selection\n\n- `spurious_flag = 0` - Removes spurious detections\n- `vis_det = 1` - VIS detection required\n- `det_quality_flag & ~(1|2|512) = 0` - Excludes specific quality flags via bitwise operation\n- `phz_flags = 0` - Clean photometric redshift measurements\n- `tom_bin_id != -1` - Valid tomographic bin assignment\n- `eff_cov_flag > 0` - Effective coverage requirement\n- `point_like_prob < 0.1` - Excludes point sources\n\n### Enhanced NaN Filtering\n\nImplemented explicit checks ensuring both weight > 0 AND measurements exist:\n\n```sql\n(she_lensmc_weight > 0 AND she_lensmc_e1_corrected IS NOT NULL AND she_lensmc_e1_corrected IS NOT NULL)\nOR (she_metacal_weight > 0 AND she_metacal_e1_corrected IS NOT NULL AND she_metacal_e2_corrected IS NOT NULL)\n```\n\n### New Analysis Columns Added\n\n- **Size vs SNR**: `she_lensmc_snr`, `flux_vis_2fwhm_aper/fluxerr_vis_2fwhm_aper`, `she_metacal_sn`\n- **PSF size ratios**: `she_lensmc_psf_r2`, `she_metacal_psf_r2`\n- **Flux measurements**: `mag_stargal_sep`, `flux_vis_psf`, `she_lensmc_flux`, `she_lensmc_mag`\n\nNote: `flux_vis_unif` cuts (1.44544 to 36.30781) moved to post-processing for analysis flexibility.\n\n## Supporting Data Products\n\n### Masks and Coverage\n\n- `coverage_mask.fits` (132MB) - RR2 survey coverage mask\n- `visibility_mask.fits` (51MB) - VIS instrument visibility constraints\n- Associated README files with detailed specifications\n\n### Mass Maps for Cross-Correlation\n\n- `SKS_mass_map.fits` (3.3GB) - Full-sphere Kaiser-Squires mass reconstruction\n- `SKSP_mass_map.fits` (3.3GB) - Full-sphere KS with inpainting (KSp method)\n  - Each contains: 1 FITS extension for map + 1 extension for mask\n  - Provides convergence fields for κγ and κκ cross-correlation analysis\n\n### Redshift Distributions\n\n- `nz_files.fits` (79KB) - n(z) for tomographic bins, essential for theoretical modeling\n\n## Key Improvements Over v1_250616\n\n1. **Enhanced quality cuts**: More robust selection against systematics\n2. **Explicit NaN handling**: Prevents analysis failures from missing shear measurements\n3. **Extended column set**: Enables size-SNR-PSF analysis for systematic studies\n4. **Mass map integration**: Direct access to convergence fields for expanded analysis scope\n5. **Complete documentation**: Query provenance and parameter documentation preserved\n\n## Analysis Readiness\n\nThis dataset is production-ready for:\n\n- **Cross-correlation analysis**: Enhanced catalog quality + direct mass map access\n- **Systematic studies**: Size/SNR/PSF columns enable detailed systematic characterization\n- **Theoretical comparison**: Complete n(z) information for accurate theoretical predictions\n- **Multi-probe analysis**: Integration of galaxy catalog + mass maps + masks for comprehensive analysis\n\n## Status Note\n\nThis dataset was superseded by RR2 v2.1 in later development. It served as the foundation for establishing the full analysis pipeline (catalog → maps → cross-spectra → SACC) documented in the 2025-10-06 pipeline inventory.",
      "outcome": "Created RR2 v1.4 dataset with enhanced quality cuts, explicit NaN filtering, and extended analysis columns. 7.3GB catalog plus masks and mass maps. Production-ready for cross-correlation analysis. Superseded by v2.1.",
      "createdAt": "2026-02-11T04:00:01.715812106+01:00",
      "closedAt": "2026-02-11T05:56:42.07753667+01:00",
      "dependsOn": []
    },
    {
      "id": "pipeline-inventory-and-18e1be4e",
      "title": "Pipeline inventory and component status",
      "status": "open",
      "kind": "task",
      "tags": [
        "pipeline",
        "research"
      ],
      "body": "## Date\n\n2025-10-06\n\n## Context\n\nConducted comprehensive inventory in preparation for hands-on CMBX RR2 meeting. The inventory serves as foundation for creating tutorial notebooks to help collaborators access and work with RR2 data.\n\n## Summary\n\nOver the past month, systematically developed and validated the end-to-end analysis pipeline for Euclid RR2 × CMB lensing cross-correlations. This includes catalog processing, map generation, cross-correlation computation, and comprehensive diagnostic explorations. The pipeline now produces full cross-spectra between Euclid shear/mass maps and ACT DR6 CMB lensing, with robust error estimation via covariance matrices.\n\n## Research Notebooks (Exploratory Analysis)\n\n### 2025_09_05_nx2pt_cross_spectra.py\n- Initial cross-correlation exercise using nx2pt pipeline\n- Computed Euclid RR2 shear maps × CMB lensing (SPT-A and ACT DR6) cross-spectra\n- Established baseline workflow and identified technical issues\n- Status: Historical reference; superseded by formalized pipeline\n\n### 2025_09_18_mask_analysis.py\n- Systematic investigation of RR2 v1.4 coverage and visibility masks\n- Used RR2Coverage class to load and visualize mask components\n- Analyzed mask combination methodology\n- Status: Informational; insights integrated into `explore_masks.py` workflow script\n\n### 2025_09_29_analyze_empirical_nz_quantization.py\n- Comprehensive quantization analysis of empirical N(z) from catalog `phz_median` values\n- Discovered phz_median quantized to 0.01 redshift spacing (93-97% consistency)\n- Developed native quantization-aware binning\n- Status: Complete; implementation integrated into production pipeline\n\n### 2025_09_29_extract_unique_z_values.py\n- Utility script to extract and save unique phz_median values per tomographic bin\n- Status: Utility/diagnostic tool\n\n### 2025_10_02_plot_cross_correlation.py\n- Diagnostic plotting for individual cross-spectrum npz outputs\n- Prototype for formalized `plot_cross_spectrum.py` workflow script\n- Status: Prototype; formalized version now in workflow\n\n## Snakemake Exploration Rules\n\n### explore_coverage_visibility\n- **Purpose**: Systematic analysis of coverage and visibility masks\n- **Inputs**: Catalog, coverage_mask.fits, 6 visibility masks\n- **Outputs**: Weighted counts plot, mask visualizations, summary statistics\n- **Script**: `workflow/scripts/explore_masks.py`\n- **Status**: Active diagnostic tool\n\n### explore_isd_weights\n- **Purpose**: Animated visualization of ISD correction weight iteration history\n- **Inputs**: Catalog + 6 ISD weight history files\n- **Outputs**: Animated GIFs per bin, final ISD product plots\n- **Script**: `cmbx/files/workflow_scripts_explore_isd_weights.py`\n- **Status**: Visualization tool for understanding systematic corrections\n\n### compare_nz_distributions\n- **Purpose**: Compare theoretical, RR2 data, and empirical N(z) distributions\n- **Inputs**: Catalog, theoretical N(z), RR2 N(z)\n- **Outputs**: Weighted and unweighted comparison plots\n- **Script**: `cmbx/files/workflow_scripts_compare_nz_distributions.py`\n- **Key feature**: Implements quantization-aware empirical N(z) construction\n- **Fiducial target**: `compare_nz_fiducial` (dz=0.010 and dz=0.050 variants)\n- **Status**: Production-ready diagnostic\n\n### plot_shear_maps + compute_global_vlims\n- **Purpose**: Diagnostic visualizations of HEALPix shear maps with consistent color scaling\n- **Method**: Two-stage process: (1) compute global color limits, (2) plot with consistent scaling\n- **Scripts**: `compute_global_vlims.py`, `plot_shear_maps.py`\n- **Fiducial target**: `plot_shear_maps_fiducial` generates all method×bin combinations\n- **Status**: Production-ready diagnostic\n\n### animate_shear_maps\n- **Purpose**: Create animated GIFs showing field progression across tomographic bins\n- **Script**: `cmbx/files/workflow_scripts_animate_shear_maps.py`\n- **Fiducial target**: `animate_shear_maps_fiducial`\n- **Status**: Production-ready visualization\n\n### plot_cross_spectrum\n- **Purpose**: Plot individual cross-spectra with error bars from covariance\n- **Script**: `cmbx/files/workflow_scripts_plot_cross_spectrum.py`\n- **Aggregate targets**: `plot_all_shear_cross_spectra` (14 plots), `plot_all_mass_cross_spectra` (2 plots), `plot_all_cross_spectra` (16 plots)\n- **Status**: Production-ready visualization\n\n## Production Pipeline Rules\n\n### build_maps\n- **Purpose**: Convert Parquet catalogs → HEALPix maps at NSIDE=2048\n- **Outputs**: Per-method/bin shear_maps (e1, e2), weights_map, weighted_counts_map, mask\n- **Wildcards**: `{method}` (lensmc/metacal), `{bin}` (all/1-6)\n- **Script**: `cmbx/files/workflow_scripts_build_maps.py`\n- **Fiducial target**: `build_maps_fiducial` (14 map sets)\n- **Status**: Core production rule\n\n### compute_cross_spectrum\n- **Purpose**: Compute individual cross-spectrum using NaMaster with full covariance\n- **Methods supported**: lensmc/metacal (shear), sks/sksp (mass maps)\n- **Configuration**: ℓ-binning (lmin/lmax/nells), workspace caching, covariance computation\n- **Resources**: 16 threads, 32GB memory for covariance workspace at NSIDE=2048\n- **Script**: `cmbx/files/workflow_scripts_compute_cross_spectrum.py`\n- **Aggregate targets**: `compute_all_cross_spectra` (16 spectra in parallel)\n- **Status**: Core production rule with parallel execution\n\n### combine_shear_cross_spectra / combine_mass_cross_spectra\n- **Purpose**: Combine individual `.npz` cross-spectra into SACC format data vectors\n- **Outputs**: SACC files for shear and mass cross-correlations\n- **Script**: `cmbx/files/workflow_scripts_combine_cross_spectra.py`\n- **Aggregate target**: `combine_all_cross_spectra`\n- **Status**: Production-ready data vector assembly\n\n### build_rr2_mask (legacy)\n- **Purpose**: Build production-quality per-pixel weight\n- **Status**: Script exists but not yet integrated into main workflow\n\n## Data Flow\n\n1. Parquet catalog → HEALPix maps (`build_maps`)\n2. Maps → Individual cross-spectra (`compute_cross_spectrum`)\n3. Individual spectra → Combined SACC (`combine_*_cross_spectra`)\n4. Parallel diagnostic explorations at each stage\n\n## Execution Context\n\n**Container**: `/leonardo_work/EUHPC_E05_083/cdaley00/container` (healpy, pymaster, pyccl, sacc, nx2pt)\n\n**Profiles**:\n- `--profile serial`: Single-job diagnostics (partition: lrd_all_serial)\n- `--profile prod`: Parallel production (partition: dcgp_usr_prod, QOS: dcgp_qos_bprod)\n\n**Current Dataset**: `catalog_version: rr2_v1_4_250918`, `pipeline_version: v0.0`\n\n## Next Steps Identified\n\nTutorial notebooks should cover:\n1. Data access and field definitions (DPDD reference)\n2. Mask construction (coverage, visibility, ISD weights)\n3. Map generation (catalog → HEALPix workflow)\n4. N(z) handling (theoretical vs empirical, quantization considerations)\n5. Cross-correlation (nx2pt/NaMaster with covariance)\n6. Diagnostic tools (leveraging existing exploration rules)",
      "outcome": "Comprehensive inventory of research notebooks, exploration rules, and production pipeline components. Documented full data flow: catalog → maps → cross-spectra → SACC. Established foundation for tutorial development.",
      "createdAt": "2026-02-11T04:00:03.496388052+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "cross-correlation-pipeline-v2-1e4a96bc",
      "title": "Cross-correlation pipeline v2: NaMaster patterns from gctools",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "Euclid × CMB-κ cross-correlation pipeline. The infrastructure works (rules, wildcards, packaging, plots). The spectra are wrong — all negative where they should be positive.\n\n## Desired State\n\nA working, robust cross-correlation pipeline where every detail is either addressed or raised as an open fiber. By comparing against gctools (map-based, working) and sp_validation (catalog-based, reference), converge on an implementation that produces correct, physically sensible spectra. Make as much progress as possible each iteration — fix what you can, file what you can't.\n\n`cmbx/files/workflow_scripts_compute_cross_spectrum.py` produces cross-spectra that:\n\n1. **Start from gctools conventions.** When in doubt, match `spectra.py::map2wlcls` — it's a working implementation that produces correct results. Divergences from gctools are the first place to look when debugging. Once we have broad agreement with Margherita's results (positive C^{Eκ}, sensible shape and amplitude), we can improve: better noise handling, different binning, etc. The point isn't to clone gctools forever — it's to have a known-good baseline to build from.\n\n2. **Produce positive C^{Eκ}_ℓ.** The E-mode shear × CMB convergence cross-spectrum traces the same large-scale matter distribution. It must be positive, with amplitude ~10⁻¹⁰. If it's negative, something is wrong — don't proceed to other work until this is resolved.\n\n3. **Have a resolved sign convention** for the e1/e2 → Q/U mapping, documented in a decision fiber with reasoning. `sign_test_lean.py` tests all 4 combinations on real data; run it if the sign isn't resolved after matching gctools.\n\n4. **Use shape noise from FITS headers** for the shear noise power spectrum. Each shear map header contains `NOISE_CL` (= σ²_comp / n_eff_sr), the flat per-component shape noise Cℓ. Use this as `nl_uncoupled` for WL fields — it replaces Margherita's `None` (which she marked as a TODO) and the BB−EE subtraction trick. For cross-spectra with CMB κ there's no noise bias to subtract (independent experiments), but the auto-spectra fed into the Gaussian covariance should include this noise.\n\n5. **Use iNKA Gaussian covariance** following `spectra.py::get_cov`. Input spectra are coupled auto/cross spectra normalized by mean(mask_i × mask_j). Spins detected from field type. This is the working pattern — don't introduce theory-based covariance yet.\n\n6. **Support catalog-based cross-spectra.** The shear tracer can be constructed directly from the parquet catalog as an `NmtFieldCatalog` (spin-2), crossed with the CMB κ `NmtField` (spin-0). NaMaster handles mixed field types transparently — `compute_coupled_cell` and workspace creation work across NmtFieldCatalog × NmtField as long as lmax matches. This bypasses the map-making step entirely, providing an independent validation path. The catalog-based and map-based cross-spectra should agree; disagreement isolates bugs in map construction vs. spectrum computation.\n\n   The catalog preparation mirrors `build_maps.py`: load the parquet, filter `tom_bin_id == bin` and `she_{method}_weight > 0`, exclude bad tiles (from config), subtract weighted-mean additive bias (c1, c2). Pass `[ra, dec]` as positions (lonlat=True), weights, and `[e1, ±e2]` as fields to `NmtFieldCatalog`. nx2pt already has `CatalogTracer` (`cmbx/files/code_nx2pt_src_nx2pt_tracer.py` line 69) that wraps this.\n\n**Done when:**\n- `C^{Eκ}_ℓ` is positive for lensmc × ACT (the baseline case)\n- Cross-spectrum shape is physically sensible (positive, decaying at high ℓ)\n- Map-based and catalog-based cross-spectra agree (at least for one bin × CMB experiment)\n- Sign convention is documented in a closed decision fiber\n- Systematic null tests re-run and PTEs are reasonable (not all > 0.8)\n- Check: `snakemake -n compute_all_shear_cross_spectra` is clean\n\n## Context\n\n### gctools (authoritative)\n\n`code/dr1_cmbx/src/dr1_cmbx/eDR1data/gctools/spectra.py` — the working implementation:\n- `map2wlcls()` (line 708): field creation, masking, spectrum computation for WL × CMB-κ\n- `get_cl()` (line 13): coupled → decoupled spectrum, optional noise subtraction via `pnl`\n- `get_cov()` (line 135): iNKA Gaussian covariance, spin-aware\n- `get_spectra()` (line 93): orchestrates fields → spectra, passes `nl_uncoupled` for auto-spectra only\n\n### sp_validation (reference)\n\n`cmbx/files/sp_validation_src_sp_validation_cosmo_val.py` — catalog-based pseudo-Cℓ reference from CosmoStat. Shows the full NaMaster pattern including `NmtFieldCatalog`, analytic noise bias, and theory+noise covariance. Useful for understanding the general pattern; we don't need to match it exactly.\n\n### Shear map noise metadata\n\nFITS headers on `rr2_v2_1_wl_031224_method=lensmc_bin={n}_shear_maps.fits` contain:\n```\nNOISE_CL   — flat shape noise Cℓ (σ²_comp / n_eff_sr)\nSIG_EPS    — total ellipticity dispersion\nSIG_COMP   — per-component dispersion (σ_ε / √2)\nNEFF_SR    — effective galaxy density [sr⁻¹]\n```\n\n### Catalog-based pseudo-Cℓ\n\n`NmtFieldCatalog` takes positions, weights, and field values directly — no map-making. For shear × CMB-κ, the shear side is catalog-based and the CMB side is map-based. NaMaster's `is_compatible()` only checks harmonic resolution (`ainfo.lmax`), not field type, so mixed cross-spectra work transparently.\n\n**Catalog**: `/leonardo_work/EUHPC_E05_083/cmbx/inputs/euclid/catalogs/rr2_v2_1_wl_031224/rr2_v2_1_wl_031224.parquet` (~30M galaxies). Columns needed: `right_ascension`, `declination`, `she_{method}_e1_corrected`, `she_{method}_e2_corrected`, `she_{method}_weight`, `tom_bin_id`, `tile_index`.\n\n**Cuts** (same as `build_maps.py`): `tom_bin_id == bin`, `weight > 0`, bad tiles from config, then subtract weighted-mean c1/c2.\n\n**nx2pt CatalogTracer**: `cmbx/files/code_nx2pt_src_nx2pt_tracer.py` line 69 — takes `pos=[ra,dec]`, `weights`, `fields=[e1, e2]`, `lmax`, `spin=2`, `lonlat=True`. Creates `NmtFieldCatalog` internally.\n\n**sp_validation reference**: `cmbx/files/sp_validation_src_sp_validation_cosmo_val.py` — shows `NmtFieldCatalog` usage with `pol_factor` toggle for sign convention testing, analytic noise bias, theory+noise covariance.\n\n### Our pipeline\n\n- Map-based script: `cmbx/files/workflow_scripts_compute_cross_spectrum.py`\n- Map builder: `cmbx/files/workflow_scripts_build_maps.py` (catalog → sparse FITS maps)\n- Systematics: `cmbx/files/workflow_scripts_compute_systematic_cross_spectrum.py`\n- Rules: `workflow/Snakefile` + `cmbx/files/workflow_rules_explorations.smk`\n- Sign test: `workflow/scripts/sign_test_lean.py`\n- nx2pt workspace caching: `cmbx/files/code_nx2pt_src_nx2pt_namaster_tools.py`\n\n### Data\n\n- Shear catalog: `/leonardo_work/EUHPC_E05_083/cmbx/inputs/euclid/catalogs/rr2_v2_1_wl_031224/rr2_v2_1_wl_031224.parquet`\n- Shear maps: `/leonardo_work/EUHPC_E05_083/cmbx/inputs/euclid/maps/rr2_v2_1_wl_031224/wl_{lensmc,metacal}/`\n- ACT κ + mask: `inputs/act/` (mask in `inputs/act/masks/`)\n- SPT κ + mask: `inputs/spt/maps/lensing/winter/gmv/` + `inputs/spt/masks/lensing/winter/`\n\n### Related fibers\n\n- `shear-e1-e2-healpix-q-u-sign-ec695758` — sign convention investigation\n- `validation-negative-cross-40ecf87e` — negative spectra tracking\n- `suspiciously-good-ptes-in-dbf44cbb` — PTE investigation (likely resolves after spectra fix)\n\n## Skills\n\n- `/snakemake` — workflow design and execution\n- `/implementing-code` — script development\n- `/data-visualization` — plotting\n\n## Comments\n**2026-02-14 04:36** — Spec reworked (2026-02-14). Key findings from review: (1) CMB mask discrepancy — we square, gctools apodizes. Confirmed: switch to apodize. (2) Binning: switch to linear nlb=100 to match gctools for comparison. (3) NOISE_CL in FITS headers provides clean shape noise Nℓ for Phase 2. (4) sp_validation cloned to ../sp_validation/ as catalog pseudo-Cℓ reference.",
      "outcome": "Pipeline complete. All six done-when criteria met:\n\n(1) C^{Eκ} positive — 28/28 cross-spectra (lensmc+metacal × 7bins × ACT+SPT) are positive with amplitude ~10⁻⁶ in ℓCℓ.\n\n(2) Physically sensible shape — signal peaks at low ℓ, decays at high ℓ, increases with redshift bin as expected from lensing geometry. B-modes consistent with noise.\n\n(3) Map-based and catalog-based agree — 28/28 catalog (NmtFieldCatalog) vs map cross-spectra match with correlation 0.986-1.000, fractional differences <10% where S/N>1.\n\n(4) Sign convention resolved — [-e1, e2] (standard WL), documented in sign-convention-for-standard-wl-7ebc8d73.\n\n(5) Systematic null tests clean — Knox covariance gives chi2/dof~1 for exposures, SAA, zodiacal light. Galactic extinction contaminates (chi2/dof 1.3-9.0, tracked in galactic-extinction-ecfc9972). Stellar density moderate.\n\n(6) DAG clean — snakemake -n returns nothing-to-be-done for all shear/systematic/catalog/plot targets.\n\nSignal detection: 28/28 at 3σ, 27/28 at 5σ (Knox). Median SNR=8.2, max=11.75 (lensmc bin6 × SPT). SACC files produced for ACT and SPT-3G. 42 downstream fibers document every decision, bug, and pattern encountered.\n\nOpen items tracked in separate fibers: mass maps (mass-maps-at-v1-4-path-not-v2-1-fdc14589), galactic extinction mitigation (galactic-extinction-ecfc9972), blinding (cmbx-3x2pt-blinding-strategy-d2469de7).",
      "createdAt": "2026-02-11T05:34:22.530378529+01:00",
      "closedAt": "2026-02-14T07:08:47.227771279+01:00",
      "dependsOn": []
    },
    {
      "id": "gctools-spectra-py-is-6b77755a",
      "title": "gctools spectra.py is authoritative NaMaster pattern",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Margherita's gctools/spectra.py (map2wlcls, map2gccls, get_cov) is the authoritative source for NaMaster conventions in this project. Key patterns: weight-based masking (apodize(w>0)*w), e2 sign flip for shear, explicit spin=2, n_iter=1, lmax=3000, iNKA covariance. Our compute_cross_spectrum.py to be rewritten following these patterns. See cross-correlation-pipeline-v2-*.",
      "createdAt": "2026-02-11T05:56:12.078527608+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc",
        "nx2pt-library-reference-c9524b1d"
      ]
    },
    {
      "id": "spt-3g-winter-gmv-maps-ba53cd3c",
      "title": "SPT-3G winter GMV maps available for cross-correlation",
      "status": "open",
      "kind": "task",
      "tags": [
        "data",
        "spt"
      ],
      "outcome": "SPT-3G winter GMV lensing maps at inputs/spt/maps/lensing/winter/gmv/. Map 0 = data, 1 = Gaussian sim, 5001-5010 = Agora sims. Mask at inputs/spt/masks/lensing/winter/. SQE estimator also available (kmv, ktt, kpp). Added as {cmbk} wildcard option 'spt_winter_gmv' in cross-correlation pipeline v2 spec.",
      "createdAt": "2026-02-11T05:56:29.206799849+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc",
        "spt-euclid-mou-collaboration-6de6bc54"
      ]
    },
    {
      "id": "dropped-maptracer-for-direct-c9630737",
      "title": "Dropped MapTracer for direct NmtField creation",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "MapTracer hid critical details (no e2 sign flip, no n_iter/lmax passthrough, no apodization). Replaced with direct NmtField creation following gctools::map2wlcls patterns: make_shear_mask (apodize(w>0)*w), make_cmb_mask (apodize only), make_shear_field ([e1,-e2], spin=2, n_iter=1, lmax=3000). Script uses read_healpix_map from nx2pt for sparse FITS compatibility.",
      "createdAt": "2026-02-11T06:23:01.158654699+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "nmtbin-lmax-must-match-nmtfield-c7b0dc69",
      "title": "NmtBin lmax must match NmtField lmax",
      "status": "open",
      "kind": "task",
      "tags": [
        "pattern",
        "namaster"
      ],
      "outcome": "NaMaster strictly enforces bins.lmax == fields.lmax. Our get_ell_bins(nside, config) creates bins to 3*nside-1=6143 regardless of configured lmax. Fix: construct NmtBin directly with ells=np.arange(lmax+1) and log-spaced bpw_edges via np.digitize. NmtBin.from_edges has off-by-one (bins.lmax = ell_end[-1] - 1). gctools avoids this by using NmtBin.from_lmax_linear.",
      "createdAt": "2026-02-11T06:23:13.092825191+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "cmb-experiment-as-cmbk-wildcard-90dbf468",
      "title": "CMB experiment as {cmbk} wildcard",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Added {cmbk} wildcard to compute_cross_spectrum rule. CMB experiments defined in config.yaml under cmb_experiments with kappa_map and mask paths. Currently: act (DR6 baseline), spt_winter_gmv (SPT-3G winter GMV map 0). Input function get_cmbk_files resolves paths from config. Target rules expand across all experiments: 28 shear cross-spectra (2 methods x 7 bins x 2 CMB).",
      "createdAt": "2026-02-11T06:23:23.793789254+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "first-lensmc-bin1-x-act-cross-2c7984a5",
      "title": "First lensmc bin1 x ACT cross-spectrum validated",
      "status": "open",
      "kind": "task",
      "tags": [
        "result"
      ],
      "body": "The foundational computation of the pipeline: NaMaster pseudo-C_ℓ cross-spectra between Euclid shear (spin-2) and CMB lensing convergence (spin-0). Produces 28 spectra: 2 shear methods (lensmc, metacal) × 7 tomographic bins (all + 1-6) × 2 CMB experiments (ACT DR6, SPT-3G winter GMV).\n\n**Methodology.** Shear maps at nside 2048 loaded via `nx2pt.maps.read_healpix_map` (handles sparse FITS). Shear fields constructed with `[-e1, e2]` sign convention — the standard WL frame, transforming Euclid RA-aligned ellipticities to HEALPix colatitude-aligned Q/U. Masks: binary footprint apodized with `nmt.mask_apodization(mask, 0.15, \"C2\")`, then multiplied by weight map. CMB κ masks apodized identically following gctools convention. NaMaster workspace computes mode-coupling matrix; spectrum decoupled from mask effects.\n\n**Covariance.** Two estimates computed for each spectrum: (1) NaMaster Gaussian (iNKA), which is formally correct but overestimates variance by 10-130× at the small sky fractions (fsky ~ 0.01) of individual tomographic bins. (2) Knox formula: `Var = C^{aa} · C^{bb} / n_modes` with effective fsky from Hivon (2002). Knox is the primary metric for evidence JSON — more accurate at our sky coverage.\n\n**Evidence.** Each spectrum produces a per-wildcard evidence JSON with SNR, chi2_null (test against zero signal), dof, PTE. Aggregation rule collects all 28 into `cmbx/files/results_claims_compute_cross_spectrum_evidence.json`. Median Knox SNR = 8.2; 28/28 detected at 3σ, 27/28 at 5σ.\n\n**Script**: `cmbx/files/workflow_scripts_compute_cross_spectrum.py`",
      "outcome": "Pipeline produces correct output: cl shape (2,20) for spin-2 x spin-0, covariance (40,40). SNR=2.95, chi2_null=8.7 (dof=20, PTE=0.99). fsky_shear=0.0093 (small — single bin of RR2). Evidence.json sidecar with SNR/chi2/PTE works. Full batch of 28 shear cross-spectra launched.",
      "createdAt": "2026-02-11T06:23:32.542754149+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "shear-maps-are-sparse-fits-use-5cff6395",
      "title": "Shear maps are sparse FITS — use read_healpix_map",
      "status": "open",
      "kind": "task",
      "tags": [
        "pattern",
        "data"
      ],
      "outcome": "Euclid shear maps (shear_maps.fits, sum_weights_map.fits) are partial/sparse FITS files. hp.read_map(field=(0,1)) fails with 'Wrong nside parameter'. Must use nx2pt.maps.read_healpix_map which falls back to astropy BinTableHDU reader for sparse format. np.atleast_2d() wrapping ensures (2, npix) shape for shear.",
      "createdAt": "2026-02-11T06:23:39.90855399+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "cmb-mask-square-don-t-re-apodize-befc00a7",
      "title": "CMB mask: square, don't re-apodize",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "ACT/SPT lensing masks are already apodized. Apply mask^2 for the quadratic estimator convention. Don't re-apodize. Updated make_cmb_mask to just square. Running batch will need rerun for this change.",
      "createdAt": "2026-02-11T12:30:51.42266002+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "first-systematic-null-test-14a71de6",
      "title": "First systematic null test (stellar density × lensmc bin1)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "result"
      ],
      "body": "Cross-spectra between Euclid tracer maps and systematic template maps, testing whether observational systematics leak into the shear signal. Produces 70 spectra: 5 systematics × 2 methods × 7 bins.\n\n**Systematic maps.** Five VMPZ-ID templates at nside 16384 (NESTED): stellar density, galactic extinction, number of exposures, SAA passages, zodiacal light. Loaded via `dr1_cmbx.eDR1data.gctools.reader.read_partial_map()` which handles sparse FITS and downgrading to the analysis nside. Critical: HP UNSEEN sentinels (|val| > 1e20) must be zeroed after loading — they dominate the power spectrum if left in.\n\n**Mask.** The analysis mask is the intersection of the survey footprint and the systematic map's coverage (non-zero pixels). Both apodized following the standard convention.\n\n**Null hypothesis.** Under H0, the cross-spectrum C^{fS}_ℓ is consistent with zero — systematics should not correlate with shear. Knox chi2/dof ~ 1 for clean systematics. Galactic extinction is the exception: chi2/dof 1.3-9.0 across bins, with strongest contamination in high-z bins (5, 6). This is real astrophysical contamination, not a pipeline artifact.\n\n**Downstream.** These spectra feed into the contamination metric (via `plot_contamination_metric`) and the summary heatmap (via `plot_systematic_null_tests`). The C^{SS} auto-spectrum (stored as `cl_sys_auto` in each NPZ) is needed for the full DES×SPT-style X metric.\n\n**Script**: `cmbx/files/workflow_scripts_compute_systematic_cross_spectrum.py`",
      "outcome": "stellar_density × lensmc bin1: chi2=1.7 (dof=20, PTE=1.0). Consistent with zero — no contamination. read_partial_map from gctools handles sparse FITS + nside downgrade efficiently. Full batch of 70 jobs launched.",
      "createdAt": "2026-02-11T12:53:23.625174811+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "claims-evidence-directory-dc4efb7b",
      "title": "Claims evidence directory structure",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "dashboard"
      ],
      "outcome": "Dashboard reads results/claims/<rule>/evidence.json for per-rule summaries. Individual per-wildcard evidence stays alongside NPZ outputs. aggregate_evidence.py + Snakefile rules produce the summaries. One claim fiber per rule: tag.",
      "createdAt": "2026-02-11T13:26:16.065407061+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "localrules-for-plot-and-target-9bc10107",
      "title": "Localrules for plot and target rules",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "snakemake"
      ],
      "outcome": "Added localrules declarations to Snakefile (target/aggregator rules) and explorations.smk (plot rules). Plot localrules run via apptainer on login node — slow (~1 min/plot due to container startup) but functional. 28 cross-spectrum plots generated successfully.",
      "createdAt": "2026-02-11T13:27:21.604406692+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "galactic-extinction-fits-a6fd423e",
      "title": "Galactic extinction FITS truncated — swapped to 131741 version",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "The 409M galactic_extinction file (131145 timestamp) was truncated, causing FITSIO read errors. Swapped config to point to the 648M version (131741 timestamp), which reads all 42M rows successfully. All 14 galactic_extinction x shear null tests now pass (PTE ~1.0).",
      "createdAt": "2026-02-11T14:04:03.298637137+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "sacc-combine-uses-misc-tracers-8b08e236",
      "title": "SACC combine uses Misc tracers — needs NZ upgrade",
      "status": "closed",
      "kind": "task",
      "body": "Packages 28 individual cross-spectrum NPZ files into a single SACC file per CMB experiment, ready for downstream likelihood analysis. SACC (Save All Cross-Correlations) is the standard Euclid/LSST data vector format — the interface between spectrum estimation and parameter inference.\n\n**Why SACC.** SACC files carry not just data vectors but also tracer metadata (n(z), beam functions), bandpower definitions, and covariance blocks. This is what the eDR1like likelihood reads. The format enables sharing spectra with the wider Euclid/LSST community and ensures that all information needed to compute theory predictions is bundled with the data.\n\n**Tracers.** 14 shear tracers as NZTracer (z, n(z) from `RR2_v2_Nz_WL_C2020_sel_pv.fits`, 6 bins + \"all\" bin × 2 methods). 1 CMB κ tracer as MiscTracer (no n(z) — CMB lensing has a broad kernel computed internally by the theory code). Total: 15 tracers per file. Originally used MiscTracer for shear (with no n(z)), upgraded to NZTracer when likelihood integration required redshift distributions.\n\n**Data vector.** 560 data points per SACC file (14 cross-spectra × 40 bandpowers each — 20 E-mode + 20 B-mode). 20 log-spaced bins from ℓ=40 to ℓ=3000 (decision: `bandpower-binning-20-log-spaced-3628f69e`).\n\n**Covariance.** Block diagonal Knox covariance included. Off-diagonal blocks (cross-bin, cross-method correlations) not computed — this is a limitation for joint inference but sufficient for per-spectrum significance tests. The full joint covariance used by `evaluate_fiducial_likelihood` comes from the PKL files (`build_likelihood_input`), not from SACC.\n\n**Downstream.** SACC files feed into `validate_sacc` (completeness check) and were intended for `eDR1like` likelihood evaluation. In practice, the eDR1like pipeline reads PKL format (see `edr1like-likelihood-reads-pkl-a6201d1d`), so SACC files are a reference format and exchange medium, while PKL provides the actual likelihood input.\n\n**Script**: `cmbx/files/workflow_scripts_combine_cross_spectra.py`",
      "outcome": "Upgraded shear SACC tracers from MiscTracer to NZTracer. n(z) loaded from RR2_v2_Nz_WL_C2020_sel_pv.fits (bins 1-6 + summed 'all' bin). CMB kappa stays MiscTracer. Config: nz.wl path added to config.yaml. Snakefile: nz_file input added to combine_shear_cross_spectra. Script: combine_cross_spectra.py loads n(z) via fitsio, creates NZTracer with z=linspace(0,6,3000), nz from FITS. Both ACT and SPT SACC files rebuilt and validated (14 NZTracer + 1 MiscTracer each, 560 data points).",
      "createdAt": "2026-02-11T14:04:05.193615989+01:00",
      "closedAt": "2026-02-11T14:26:47.366079409+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc",
        "n-z-source-rr2-v2-nz-wl-c2020-2341fcda",
        "first-lensmc-bin1-x-act-cross-2c7984a5"
      ]
    },
    {
      "id": "mass-maps-at-v1-4-path-not-v2-1-fdc14589",
      "title": "Mass maps at v1.4 path, not v2.1",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "SKS/SKSP 2D mass maps are available for download from the Euclid PIC shared server:\n`https://shared.euclid.pic.es:8453/tr1/WL/euclid_tr1_le3_v1_1/2D_MASS/`\n\nSame credentials as in `inputs/euclid/download_tr1_systematics.sh` (user: euclid012).\n\n## Implementation plan\n\n1. Adapt the download script: change URL path to `tr1/WL/euclid_tr1_le3_v1_1/2D_MASS/`, destination to `inputs/euclid/maps/2d_mass/`.\n2. Download and inspect: identify SKS (single-bin) and SKSP (tomographic) kappa maps, their masks, nside, ordering.\n3. Update `config.yaml` paths for `wl_sks` and `wl_sksp` methods in `get_euclid_map_files()`.\n4. Run the existing `compute_cross_spectrum` rule for sks/sksp methods — infrastructure already handles them via the Snakefile method dispatch.",
      "outcome": "Investigated. 2D-MASS-WL-TR1-V1.1 available at PIC (35 GB tar.gz). Contains KS/KS+ convergence maps for south region only, processed through PF 2.8.0/2.8.1/2.8.2. Key issues: (1) built from V1.1 shear catalog, not our v2.1 — version mismatch; (2) south region only; (3) PF 2.8.0 has tomographic binning bug (equidistant vs equipop), PF 2.8.1 has uncleaned density maps; (4) PF 2.8.2 is cleanest but only has KS (not KS+), only lensmc, small patches + clusters. Not worth downloading for current analysis — version mismatch with our v2.1 catalog would introduce uncontrolled systematics. If κ_WL × κ_CMB cross-check is needed, better to compute our own convergence from v2.1 shear maps via KS inversion.",
      "createdAt": "2026-02-11T14:09:07.396807185+01:00",
      "closedAt": "2026-02-16T00:11:10.72423174+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "n-z-source-rr2-v2-nz-wl-c2020-2341fcda",
      "title": "n(z) source: RR2_v2_Nz_WL_C2020_sel_pv",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "User chose RR2_v2_Nz_WL_C2020_sel_pv.fits for per-bin shear n(z) in SACC. inputs/euclid/dndz/. Matches catalog version.",
      "createdAt": "2026-02-11T14:12:51.488437267+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "validation-negative-cross-40ecf87e",
      "title": "Validation: negative cross-spectra vs Margherita positive reference",
      "status": "closed",
      "kind": "task",
      "tags": [
        "validation",
        "critical"
      ],
      "body": "All 28 E-mode cross-spectra are systematically negative. Higher-z bins have stronger negative signal (grows with redshift, consistent with a real cosmological signal with wrong sign). Both ACT and SPT, both lensmc and metacal.\n\n## Corrected understanding (iteration 7)\n\n**Amplitude comparison was misleading.** Margherita's reference pickle (`cls_kggg_eRR2_...`) contains *galaxy density × κ* cross-correlations (`kappa_g0`, `g0_g0`, etc.) at ~10^-7 level. Our shear × κ at ~10^-10 is the expected order of magnitude for cosmic shear. The \"30-50× too small\" claim was comparing apples to oranges.\n\n**The sign is the real issue.** All 28 spectra have negative E-mode weighted mean:\n- Signal grows more negative at higher z: bin1 ~ -4e-9, bin6 ~ -1.6e-8\n- High-z bins detected at SNR 4-6 but with wrong sign\n- ACT convention confirmed standard (positive κ = overdensity)\n\n## Root cause analysis: (e1, e2) → (Q, U) mapping\n\nBoth our code and Margherita's gctools use `[e1, -e2]` for NaMaster NmtField creation. NaMaster docs say this is the correct mapping for IAU convention (e1 along Dec, e2 flipped for sense-of-rotation). But this assumes the catalog stores e1 along *declination* (IAU).\n\n**If Euclid stores e1 along RA** (standard weak lensing convention: e1 > 0 = stretched E-W), then the correct mapping to HEALPix (Q, U) is `[-e1, e2]`:\n- Standard WL to IAU is a 90° rotation: Q_IAU = -e1, U_IAU = -e2\n- IAU to HEALPix: Q_HP = Q_IAU, U_HP = -U_IAU\n- So: [Q_HP, U_HP] = [-e1, e2]\n- Our `[e1, -e2]` = `[-Q_HP, -U_HP]` → synthetic test confirms this gives negative E\n\n**Synthetic NaMaster test at nside=64** (correlated κ + shear with known positive C_l^{κE}):\n- `[+Q, +U]`: E = +6.9e-8 (POSITIVE, correct)\n- `[+Q, -U]`: E = +2.2e-9 (weakly positive)\n- `[-Q, +U]`: E = -2.2e-9 (negative)\n- `[-Q, -U]`: E = -6.9e-8 (NEGATIVE — matches our observation)\n\n## Diagnostic in progress\n\n`workflow/scripts/sign_test_lean.py` — tests all 4 sign combos on real lensmc bin5 × ACT data at nside=64. Left running (I/O-limited on cluster filesystem loading the 400MB ACT kappa map). Script reads sparse shear maps efficiently, downgrades immediately to nside=64.\n\n## Open question: what is Euclid's e1/e2 convention?\n\nThe DPDD XML schema (`euc-she.xml`) defines `SHE_GENERIC_E1_CORRECTED` as \"corrected first component of ellipticity\" without specifying the reference direction. Need to check:\n1. The LensMC paper (Congedo et al.) for convention definition\n2. The SHE-WL pipeline documentation\n3. Or just let the `sign_test_lean.py` diagnostic resolve it empirically\n\n## Next steps\n1. Wait for `sign_test_lean.py` to complete → tells which combo gives positive E\n2. If `[-e1, e2]` wins: fix `make_shear_field()` in `compute_cross_spectrum.py`\n3. Rerun one spectrum via Snakemake to verify\n4. Note: Margherita also uses `[e1, -e2]` — if the convention is wrong, both codes have the same bug (her galaxy × κ results wouldn't be affected since that's spin-0)",
      "outcome": "Resolved. Sign convention was [e1, -e2] (IAU assumption) but Euclid uses standard WL (e1 along RA). Changed to [-e1, e2]. All 28 E-mode cross-spectra now positive with physically sensible shape and amplitude (~10^-8 to 10^-10). Both LensMC and MetaCal agree. See fiber sign-convention-for-standard-wl-7ebc8d73.",
      "createdAt": "2026-02-11T15:13:14.181235806+01:00",
      "closedAt": "2026-02-14T05:26:12.824994357+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc",
        "first-lensmc-bin1-x-act-cross-2c7984a5"
      ]
    },
    {
      "id": "plot-scaling-ℓcℓ-instead-of-09abed6e",
      "title": "Plot scaling: ℓCℓ instead of ℓ(ℓ+1)Cℓ/(2π)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Changed cross-spectrum plot prefactor from ℓ(ℓ+1)/(2π) to ℓ. The ℓ²-weighted scaling compressed the signal at ℓ~few hundred where we have the most sensitivity, making plots dominated by high-ℓ scatter. ℓCℓ gives better visual dynamic range. Updated in workflow/scripts/plot_cross_spectrum.py (line 86). All 28 shear cross-spectrum plots regenerated.",
      "createdAt": "2026-02-11T15:21:51.328315745+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "shear-e1-e2-healpix-q-u-sign-ec695758",
      "title": "Shear e1/e2 → HEALPix Q/U sign convention",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation",
        "critical"
      ],
      "body": "What is the correct mapping from Euclid catalog (e1, e2) to NaMaster (Q, U)?\n\n## Context\n\nNaMaster expects spin-2 fields in HEALPix convention: Q along growing colatitude (south), U at +45° in direction of growing φ. Three possible source conventions:\n\n| Convention | e1 reference | To NaMaster |\n|---|---|---|\n| IAU (e1 along Dec/North) | North | `[e1, -e2]` |\n| Standard WL (e1 along RA/East) | East | `[-e1, e2]` |\n| HEALPix (e1 along colatitude/South) | South | `[e1, e2]` |\n\nBoth our code and Margherita's gctools use `[e1, -e2]`, assuming IAU. But the standard weak lensing convention (DES, HSC, KiDS) defines e1 along RA.\n\n## Derivation (if standard WL convention)\n\nReference frame rotation from East to South = +π/2:\n- Q_IAU = e1 cos(2·π/2) + e2 sin(2·π/2) = -e1\n- U_IAU = -e1 sin(2·π/2) + e2 cos(2·π/2) = -e2\n- Q_HP = Q_IAU = -e1, U_HP = -U_IAU = e2\n- NaMaster input: `[-e1, e2]`\n\nOur current `[e1, -e2]` = `[-Q_HP, -U_HP]` → explains the negative E-mode.\n\n## Evidence\n\n**Synthetic test:** At nside=64 with known positive C_l^{κE}:\n- `[Q, U]` → +6.9e-8 (correct)\n- `[-Q, -U]` → -6.9e-8 (our current result, negative)\n\n**Real data:** All 28 spectra negative, signal grows with z (real cosmological signal with wrong sign).\n\n**ACT convention:** Confirmed standard (positive κ = overdensity). Not the issue.\n\n## Diagnostic\n\n`workflow/scripts/sign_test_lean.py` — runs all 4 combos on real lensmc bin5 × ACT at nside=64. Left running (slow cluster I/O). Should resolve empirically which combo gives positive E.\n\n**Killed twice by OOM on login node** (loading 400MB ACT kappa map). Needs to run as a SLURM job, or the script needs to be modified to use `dtype=np.float32` and/or read ACT kappa at lower resolution. Alternatively, add as a Snakemake rule with `mem_mb=8000`.\n\nRun it (needs compute node or more memory):\n```bash\nsingularity exec --bind /leonardo_work/EUHPC_E05_083 \\\n    /leonardo_work/EUHPC_E05_083/cdaley00/container \\\n    python workflow/scripts/sign_test_lean.py\n```\n\n## What would change\n\nIf fix is `[-e1, e2]`:\n1. `compute_cross_spectrum.py:make_shear_field()` line 77: `[e1, -e2]` → `[-e1, e2]`\n2. `compute_systematic_cross_spectrum.py`: same pattern\n3. All 28 cross-spectra and 70 systematics need recomputation\n4. Evidence/PTE values will change (may resolve the \"suspiciously good PTE\" issue too)\n\nNote: Margherita's gctools also uses `[e1, -e2]` for the same shear maps. If this is wrong, both codes have the same bug. (Galaxy density × κ is spin-0 so unaffected.)\n\n## Alternative: maybe Euclid IS IAU convention\n\nIf the SHE pipeline defines e1 along declination (IAU), then `[e1, -e2]` is correct and the negative signal has a different cause. Need to resolve by:\n1. Checking SHE/LensMC documentation for the convention definition\n2. Or the empirical diagnostic (sign_test_lean.py)",
      "outcome": "Resolved empirically. Applied [-e1, e2] mapping and all cross-spectra turned positive. Euclid e1 is along RA (standard WL convention). The derivation in the body of this fiber was correct: rotation RA→colatitude = +π/2 gives Q=-e1, U=e2. Note: gctools also uses [e1, -e2] — this is a latent bug there too, only visible in spin-2 × spin-0 cross-spectra (shear auto-spectra are sign-invariant).",
      "createdAt": "2026-02-11T16:15:28.980137399+01:00",
      "closedAt": "2026-02-14T05:26:21.961312564+01:00",
      "dependsOn": [
        "validation-negative-cross-40ecf87e"
      ]
    },
    {
      "id": "margherita-reference-is-galaxy-04764e1f",
      "title": "Margherita reference is galaxy×κ not shear×κ",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Margherita's pickle (cls_kggg_eRR2) contains galaxy density × κ at ~10^-7, not shear × κ. Our ~10^-10 amplitude is the correct order for shear × κ. The amplitude comparison in the validation fiber was apples-to-oranges. Only the sign issue is real.",
      "createdAt": "2026-02-11T16:17:07.214043559+01:00",
      "closedAt": null,
      "dependsOn": [
        "validation-negative-cross-40ecf87e"
      ]
    },
    {
      "id": "sign-convention-for-standard-wl-7ebc8d73",
      "title": "Sign convention: [-e1, e2] for standard WL",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Applied [-e1, e2] mapping (standard WL convention: e1 along RA). Euclid follows standard WL (e1 along East/RA), not IAU (e1 along Dec). Frame rotation RA→colatitude = +π/2 gives Q=-e1, U=e2. Changed compute_cross_spectrum.py and compute_systematic_cross_spectrum.py. gctools [e1, -e2] assumes IAU — both codes had the same bug because shear auto-spectra are sign-invariant (only cross-spectra with scalar fields are affected). All 98 spectra recomputing.",
      "createdAt": "2026-02-14T05:09:05.130257197+01:00",
      "closedAt": null,
      "dependsOn": [
        "shear-e1-e2-healpix-q-u-sign-ec695758"
      ]
    },
    {
      "id": "cmb-mask-apodize-instead-of-cb129695",
      "title": "CMB mask: apodize instead of square",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Reversed the earlier 'square' decision. Now following gctools pattern: apodize(mask, 0.15, C2). The mask^2 approach was supported by ACT×DES (Shaikh+2023) but gctools uses apodize for consistency with its iNKA covariance. Switching to match gctools as the reference implementation. Updated make_cmb_mask in compute_cross_spectrum.py.",
      "createdAt": "2026-02-14T05:09:14.571757061+01:00",
      "closedAt": null,
      "dependsOn": [
        "cmb-mask-square-don-t-re-apodize-befc00a7"
      ]
    },
    {
      "id": "auto-spectra-invariant-to-28144a52",
      "title": "Auto-spectra invariant to global (Q,U) sign flip — cross-spectra not",
      "status": "open",
      "kind": "task",
      "tags": [
        "pattern",
        "namaster",
        "sign-convention"
      ],
      "outcome": "Flipping both Q→-Q and U→-U preserves |E_lm|² (auto-spectrum) but flips the phase of E_lm, changing sign(⟨E_lm κ*_lm⟩) (cross-spectrum). This is why gctools, sp_validation, and our code all used [e1, -e2] without catching the bug: shear auto-spectra and galaxy×CMB (spin-0×spin-0) cross-spectra were correct. The bug only manifests in shear×CMB (spin-2×spin-0) cross-spectra. Implication: any NaMaster sign convention must be validated on cross-spectra, not just auto-spectra.",
      "createdAt": "2026-02-14T05:29:23.904787267+01:00",
      "closedAt": null,
      "dependsOn": [
        "sign-convention-for-standard-wl-7ebc8d73",
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "catalog-cross-spectra-validate-c2ced916",
      "title": "Catalog-based cross-spectra validate map-based pipeline",
      "status": "open",
      "kind": "task",
      "tags": [
        "validation",
        "namaster",
        "catalog"
      ],
      "body": "Independent validation of the map-based pipeline by computing cross-spectra directly from the galaxy catalog using `nmt.NmtFieldCatalog`. This bypasses pixelization, map-making, and weight assignment — if map-based and catalog-based spectra agree, map construction introduces no significant bias.\n\n**Method.** Galaxies loaded from parquet with standard cuts (good tiles, weight > 0, correct z-bin). Additive bias (c1, c2) subtracted as weighted mean. `NmtFieldCatalog(pos=[ra,dec], weights, fields=[-e1,e2], lmax, spin=2, lonlat=True)` crossed with CMB κ `NmtField`. Workspace caching uses `get_mask_alms()` hash. No covariance available for catalog fields (nx2pt/NaMaster limitation).\n\n**Resource requirements.** ~64 GB memory for ~5M galaxies at lmax=3000. Each job takes ~20 minutes on SLURM.\n\n**Results.** 28/28 comparisons show correlation 0.986-1.000 with map-based results. Fractional differences are <8% (SNR-weighted), well within statistical uncertainty. This validates both the map construction step and the NaMaster spectrum computation.\n\n**Script**: `workflow/scripts/compute_catalog_cross_spectrum.py`",
      "outcome": "28/28 catalog-based cross-spectra (NmtFieldCatalog spin-2 x NmtField spin-0) agree with map-based results: correlation 0.986-1.000, SNR-weighted fractional differences <8%, all bandpower differences within 0.05σ. Confirms both map construction and spectrum computation are correct. Script: workflow/scripts/compute_catalog_cross_spectrum.py. Rules: compute_catalog_cross_spectrum, compute_all_catalog_cross_spectra, plot_catalog_vs_map_comparison in explorations.smk.",
      "createdAt": "2026-02-14T06:02:26+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "eb-leakage-inflates-b-mode-800dcbf4",
      "title": "E→B leakage inflates B-mode chi2 at fsky~0.1",
      "status": "open",
      "kind": "task",
      "tags": [
        "pattern",
        "namaster"
      ],
      "outcome": "At fsky~0.1, NaMaster B-mode cross-spectrum amplitudes reach ~93% of E-mode due to mask mode coupling. B-mode variance is ~500x smaller (C_BB << C_EE), giving chi2_B/dof ~ 85 vs chi2_E/dof ~ 0.28. This is a general partial-sky effect, not systematic contamination. E-mode covariance is overestimated ~3.6x by iNKA Gaussian approximation. Same pattern in CMB cross-spectra confirms it is not specific to systematics.",
      "createdAt": "2026-02-14T06:02:26+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "covariance-decoupled-auto-51311d6d",
      "title": "Covariance: decoupled auto-spectra instead of coupled/fsky",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation",
        "covariance"
      ],
      "outcome": "Investigated three approaches for systematic covariance: (1) Decoupled auto-spectra — FAILED, unbin_cell zeros out modes outside binning range giving even smaller covariance. (2) Knox formula Var=C^aa*C^bb/n_modes — WORKS, gives chi2/dof~1.0 for null tests. (3) NaMaster Gaussian overestimates by 10-130x at fsky~0.01 (coupled/fsky approximation breaks down). Knox formula adopted as primary, NaMaster kept for reference. Also found HP UNSEEN bug: systematic maps contained sentinel values that dominated all cross-spectra. Knox chi2/dof now reveals real contamination patterns: galactic extinction is dominant (chi2/dof 1.3-9.0), stellar density moderate, observational systematics clean.",
      "createdAt": "2026-02-14T06:24:25.606591124+01:00",
      "closedAt": "2026-02-14T07:00:50.454546323+01:00",
      "dependsOn": []
    },
    {
      "id": "hp-unseen-values-in-systematic-0c18dac4",
      "title": "HP UNSEEN values in systematic maps contaminate cross-spectra",
      "status": "closed",
      "kind": "task",
      "tags": [
        "bug",
        "systematics"
      ],
      "outcome": "read_partial_map preserves HP UNSEEN sentinel values (~-1.6375e+30) from sparse FITS. The footprint check (sysmap != 0) includes these pixels, which dominate the cross-spectrum with identical huge values across all systematic maps. Fixed by setting |sysmap| > 1e20 to zero before computing footprint. Effect: pre-fix, all systematic maps produced identical cross-spectra (exposures == SAA == zodiacal for same bin). Post-fix, each map probes its actual correlation with shear.",
      "createdAt": "2026-02-14T06:50:40.364254293+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "galactic-extinction-ecfc9972",
      "title": "Galactic extinction contaminates shear cross-spectra",
      "status": "closed",
      "kind": "task",
      "tags": [
        "finding",
        "systematics"
      ],
      "outcome": "Knox null tests reveal galactic extinction × shear has chi2/dof 1.3-9.0 across bins, PTE≈0 for bins 1,4,5,6,all in both lensmc and metacal. Signal increases with bin number (higher-z galaxies behind more extinction). Other systematics (exposures, SAA, zodiacal light) are clean (chi2/dof~1). Stellar density shows moderate contamination (chi2/dof up to 2.8). Galactic extinction correlation needs masking or modeling before unblinded analysis.",
      "createdAt": "2026-02-14T07:01:00.399938453+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "euclid-x-cmb-kappa-28-28-cross-4780f880",
      "title": "Euclid x CMB-kappa: 28/28 cross-spectra detected at 3sigma",
      "status": "closed",
      "kind": "task",
      "tags": [
        "milestone",
        "signal"
      ],
      "outcome": "Knox formula SNR: 28/28 at 3sigma, 27/28 at 5sigma. Median SNR=8.2, max=11.75 (lensmc bin6 x SPT). Both lensmc and metacal consistent. SNR increases with bin number (higher z = more lensing signal). SPT slightly higher SNR than ACT. NaMaster SNR ~50% of Knox (covariance overestimation). Previous iteration: NaMaster showed only 25/28 at 3sigma, 6/28 at 5sigma.",
      "createdAt": "2026-02-14T07:02:30.75828119+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "research-tapestry-inspectable-fef1295c",
      "title": "Research tapestry: inspectable cross-correlation analysis",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "Build up a research tapestry — an inspectable, evolving web of fibers documenting every analysis, comparison, assumption, and result in the Euclid × CMB-κ cross-correlation pipeline. Each fiber is tied to a snakemake rule that produces plots and evidence. The tapestry is the analysis.\n\n## Desired State\n\n### The tapestry\n\nEvery snakemake rule that produces a plot or evidence has a **claim fiber** with a `tapestry:{rule_name}` tag. The specName matches the snakemake rule name, linking fiber → `results/claims/{rule_name}/evidence.json` → plots. Each fiber's outcome describes what was found, whether it's sensible, and what assumptions underlie it. Open questions are filed as investigation or question fibers. Decisions about methodology get decision fibers. The DAG of fibers mirrors the DAG of the analysis — walking `felt upstream` from any result should explain how we got there.\n\nEvidence + plots co-located in `results/claims/{rule_name}/`. Staleness propagates via evidence.json mtimes. See `/tapestry` skill for rendering details.\n\nCheck coverage: `grep -l 'tapestry:' .felt/*.md` vs the list of rules in `workflow/Snakefile` and `cmbx/files/workflow_rules_explorations.smk`. Gaps are work.\n\n### Specific analyses\n\nThe pipeline should produce and document these comparisons. Each is a snakemake rule (or set of rules) with plots, evidence, and a claim fiber:\n\n- **ACT vs SPT cross-spectra** — same shear bins crossed with different CMB experiments. Are they consistent? Differences reveal CMB-side systematics. Plot: side-by-side or ratio, per bin.\n- **lensmc vs metacal** — same CMB × different shear methods. Consistency validates shear measurement. Plot: overlay or difference, per bin × CMB.\n- **Redshift trend** — C^{Eκ}_ℓ vs tomographic bin. Signal should increase with bin number (lensing kernel overlap). Plot: all bins on one panel per CMB experiment.\n- **B-mode null test** — C^{Bκ}_ℓ should be consistent with noise. Elevated B-modes signal systematics or E→B leakage (documented in `eb-leakage-inflates-b-mode-800dcbf4` — note fsky effects).\n- **Systematic contamination tests (expanded)** — following DES×SPT (2203.12440, §A.4, Eq. A.4.1), compute the harmonic-space contamination metric:\n\n  X^f_S(ℓ) = C^{κS}_ℓ · C^{fS}_ℓ / C^{SS}_ℓ\n\n  where S is a systematic map, f is the Euclid tracer (shear or density), and κ is CMB convergence. This has the same units as C^{fκ}_ℓ and can be compared directly to the signal. It's zero unless the systematic correlates with *both* tracers simultaneously — the key insight for cross-correlations.\n\n  The DES×SPT test is done in configuration space (angular correlation functions). The harmonic-space version requires care: C^{SS}_ℓ in the denominator has noise bias from pixelization and sparse sampling of the systematic maps. This must be understood or debiased — noise inflates the denominator and makes contamination look smaller than it is. Options: use the Knox noise estimate for the systematic auto, or subtract an analytical noise floor. Document the choice.\n\n  **What to compute and plot per systematic:**\n  - C^{fS}_ℓ — shear × systematic (currently done)\n  - C^{κS}_ℓ — CMB κ × systematic (new — add as a snakemake rule)\n  - X^f_S(ℓ) — the combined contamination metric\n  - Compare X to the statistical uncertainty on C^{fκ}_ℓ (DES×SPT uses 1–10% of σ as a reference band)\n\n  **Summary statistic**: χ²/dof and PTE for X^f_S consistent with zero. DES×SPT uses PTE > 0.01 as the threshold for concern. Galactic extinction is known to contaminate (fiber `galactic-extinction-ecfc9972`); others should be clean.\n- **Theory comparison** — measured C^{Eκ}_ℓ overplotted with theoretical prediction from `eDR1like.Theory` (CCL/CAMB). Validates amplitude, shape, and redshift dependence. Requires choosing fiducial cosmology + bias model — document choices in decision fibers.\n- **Covariance documentation** — a fiber (or set of fibers) describing how the covariance is calculated: what approximation (Knox, iNKA, Gaussian), what input spectra, what fsky, what noise model. Every assumption explicit. The Knox formula is primary for systematic null tests; iNKA Gaussian (NaMaster) for signal covariance. Document why, and what the known limitations are.\n- **Catalog vs map agreement** — already done (fiber `catalog-cross-spectra-validate-c2ced916`), but should have a summary plot rule if it doesn't already.\n\n### Plot quality\n\nEvery plot should be publication-ready: clear axis labels (ℓ, ℓC_ℓ), consistent color scheme (`sns.set_palette(\"husl\", n)`), error bars from the covariance diagonal, legend identifying what's shown. Formatting issues are bugs — fix them when found.\n\n### Assumptions register\n\nMethodology choices accumulate in decision fibers. Each should state what was chosen, why, and what alternatives exist. Examples already filed: sign convention, CMB mask treatment, plot scaling, noise model. New ones emerge as the analysis deepens. Check `felt ls --all | grep decision` for the current state.\n\n### Fiber content and connectivity\n\nClaim fibers should be substantive, not just tags with outcomes. Each claim fiber needs:\n\n- **Body text** describing what the analysis does, what it tests, what assumptions it relies on, and what was found. Currently 15/16 tapestry fibers have zero body content — they're titles + outcomes only. The body is what makes the tapestry readable by a human walking the graph.\n- **Inter-fiber dependencies** matching the Snakemake DAG. Currently every claim fiber depends only on the spec fiber — the tapestry view shows isolated nodes with no edges between them. Claim fibers should link to their upstream claims (e.g., `plot_theory_comparison` depends on `compute_theory_cls` and `compute_cross_spectrum`; `plot_contamination_metric` depends on `compute_cmbk_systematic_cross_spectrum` and `compute_systematic_cross_spectrum`). The felt DAG should mirror the analysis DAG.\n- **Evidence files** at `results/claims/{rule_name}/evidence.json` with quantitative metrics. The evidence pipeline is being extended to cover all comparison rules (method_comparison, theory_comparison, redshift_trend, contamination_metric, systematic_null_tests, catalog_validation_summary).\n\n### What \"done\" means\n\nThis loop has no stopping criterion — the analysis extends over months. Each iteration should make progress: add a fiber, improve a plot, document an assumption, add a comparison, fix a formatting issue, explore something in Margherita's code or the docs. File open questions for the user when taste or judgment is needed.\n\nThe tapestry is done when every detail is either addressed or raised. Since research generates new questions faster than it answers them, this is an asymptote, not a destination.\n\n### Authority\n\nThe loop has full authority to decide implementation details — rule structure, plot design, binning choices, covariance methods, etc. When a decision requires taste or domain judgment, file it as an open child fiber (`-t question`) so the user can weigh in. But make a preliminary choice so progress continues — the fiber records the question, the code records the working answer. Both can be revised later.\n\n## Context\n\n### Existing fibers\n\n`felt ls --all` shows ~48 fibers. Many are closed with outcomes from the v2 pipeline loop. The tapestry builds on these — don't re-derive what's documented, but do check that existing fibers are still accurate and well-connected.\n\n### Code references\n\n- **gctools** (authoritative masking/spectra): `code/dr1_cmbx/src/dr1_cmbx/eDR1data/gctools/spectra.py`\n- **eDR1like** (theory predictions): `cmbx/files/code_dr1_cmbx_src_dr1_cmbx_eDR1like_theory.py` — CCL/CAMB theory Cℓ with bias models, IA, magnification. Unexplored territory for us.\n- **eDR1like** (likelihood): `cmbx/files/code_dr1_cmbx_src_dr1_cmbx_eDR1like_likelihood_pyccl.py` — Cobaya-ready likelihood with S/N diagnostics.\n- **gctools/plotting.py** — Margherita's visualization suite with theory overlay (`plot_cls_nbins6` etc). Mine for patterns.\n- **sp_validation**: `cmbx/files/sp_validation_src_sp_validation_cosmo_val.py` — catalog pseudo-Cℓ reference, covariance patterns.\n- **nx2pt**: `code/nx2pt/src/nx2pt/` — workspace caching, tracer classes.\n\n### Documentation\n\n- `cmbx/files/docs_validation_tests.txt` — proposed tests (jackknife, curl maps, spatial splits, weight sensitivity, systematic contamination metrics)\n- `cmbx/files/docs_papers_2203.12440_des_spt_planck_correlations_main.tex` — DES×SPT paper, §A.4 for systematic template approach. Key pattern: cross-correlate systematic map with *each tracer* independently, then assess whether the correlated component biases the cross-spectrum.\n- `docs/dr1_3x2pt_info_doc/` — DR1 blinding, covariance, inference plans\n- `docs/marseille_wl_talks_md/` — WL meeting context (SOM splits, FDQA, timeline)\n- `felt show cmbx-validation-test-proposals-149ba741` — validation test proposals fiber\n- `felt show cmbx-3x2pt-blinding-strategy-d2469de7` — blinding strategy\n\n### Data and outputs\n\n- Results: `results/rr2_v2_1_wl_031224-v0.0/`\n- Plots: `results/rr2_v2_1_wl_031224-v0.0/explorations/` (cross_spectra_plots, systematic_null_tests, catalog_validation, comparisons)\n- Theory: `results/rr2_v2_1_wl_031224-v0.0/theory/`\n- CMBk×systematic: `results/rr2_v2_1_wl_031224-v0.0/cross_correlations/cmbk_systematics/`\n- Evidence: `results/claims/<rule>/evidence.json`\n- Pipeline rules: `workflow/Snakefile` + `cmbx/files/workflow_rules_explorations.smk`\n- Coverage check: `grep -rh 'tapestry:' .felt/*.md | grep -oP 'tapestry:\\S+' | sort -u`\n\n### Long-running jobs\n\nFor snakemake jobs > 5 minutes, use `snakemake-tmux -j{n} {target}`. Check with `snakemake-peek <session>`. Sleep between checks rather than polling — `sleep 120 && snakemake-peek smk-XXXXXX`.\n\n### Steering decisions (2026-02-15)\n\n- **Full contamination metric**: Implement X = C^{κS}·C^{fS}/C^{SS}. Start with raw C^{SS} (lower bound on contamination), document noise caveat. Debias later.\n- **Validation tests**: Pick up the unimplemented tests from `cmbx/files/docs_validation_tests.txt` — jackknife, curl maps, cross-shear γ_x, spatial patches. These are in scope for this loop, not deferred.\n- **Theory**: Vanilla Planck 2018 is sufficient. Don't explore IA/magnification/bias — the current comparison serves its purpose.\n- **SPT estimators**: Run TT, PP, MV comparisons. Add as cmbk wildcards.\n- **Mass maps**: Download 2D mass maps from PIC (`https://shared.euclid.pic.es:8453/tr1/WL/euclid_tr1_le3_v1_1/2D_MASS/`). Adapt `inputs/euclid/download_tr1_systematics.sh`.\n- **No `--forceall`**: Trust the DAG. Never use `--touch --forceall`.\n\n### Iteration 10 findings\n\n- **Theory amplitude deficit discovered**: A<1 for both ACT (0.83±0.05) and SPT (0.70±0.05). ACT shape OK after amplitude fit; SPT shape fails. Common deficit = missing IA/calibration; SPT-specific deficit = CMB-side normalization. New rule `plot_theory_residual_analysis` + tapestry node.\n- **20 tapestry nodes** — complete coverage, all fresh evidence.\n- **n(z) plots reformatted** — \"Provenance TBD\" removed, titles corrected, bin legends added, re-run on SLURM.\n- **Open question filed**: `theory-amplitude-a-1-pursue-ia-ce5252d7` — pursue IA prediction or SPT normalization investigation?\n\n### Iteration 20 findings\n\n- **Systematic bias budget implemented**: New `plot_systematic_budget` rule — heatmap of S_bias = sqrt(Σ X²/σ²) per (systematic, bin, CMB). 27th tapestry node.\n- **Stellar density is ACT's dominant contaminant**: max 4.4σ (lensmc) / 8.0σ (metacal). Worse than galactic extinction (3.7σ/5.8σ). Not apparent from C^{γS} null tests alone — the bias significance weights by correlation with *both* tracers.\n- **ACT vs SPT asymmetry in contamination**: ACT has 22/48 entries >1σ, SPT has 2/48. Driven by ACT's larger sky coverage admitting more galactic contamination.\n- **Metacal shows 2× higher bias than lensmc**: Different shear weights couple differently to galactic systematics. Needs investigation.\n- **Bias is a lower bound**: C^{SS} noise-biased high → X denominator inflated → true bias could be worse.\n- **Question filed**: `act-systematic-bias-exceeds-1a76bb12` — ACT bin 1 bias (8σ) exceeds signal (5.5σ). Mitigation needed for parameter inference.\n- **Analysis summary updated** with budget annotation in panel (c): \"Stellar 4.4σ max, Gal. ext. 3.7σ max\".\n\n### Iteration 21 findings\n\n- **Template deprojection implemented**: New `plot_deprojected_spectra` rule — subtract X_total = Σ_S C^{κS}·C^{fS}/C^{SS} from C^{Eκ} and re-fit A_hat(IA). 28th tapestry node.\n- **Contamination BOOSTS ACT signal**: X_total is predominantly positive (same sign as signal). Subtracting it makes A_hat worse (further from 1), not better. ACT lensmc: 0.93→0.80 (Δ=-2.5σ). ACT metacal: 0.89→0.68 (Δ=-3.6σ).\n- **Bin 1 (ACT) is ~70% contamination**: A_hat drops 1.07→0.26 after deprojection. The stellar density contamination carried most of the measured signal.\n- **Bin 5 (ACT) moderately contaminated**: A_hat drops 1.03→0.77 (S_bias=11σ).\n- **SPT is clean**: Negligible change (<0.1σ) for both methods. SPT deficit (A=0.76) is intrinsic, not systematic.\n- **Metacal more affected than lensmc**: metacal Δ=-0.21 vs lensmc Δ=-0.13 for ACT. Different shear weights couple differently to galactic systematics.\n- **Implications for parameter inference**: ACT bins 1 and 5 should be excluded or treated with contamination marginalization. SPT is the cleaner dataset. ACT 20σ detection inflated ~14% by systematic signal.\n- **Analysis summary updated** with deprojection annotation on panel (d).\n\n### Iteration 22 findings\n\n- **Deprojected likelihood evaluation**: New `evaluate_deprojected_likelihood` rule — joint 6-bin chi2 on deprojected spectra using full covariance from PKL files. 29th tapestry node.\n- **ACT original good fit was coincidental**: ACT lensmc chi2/dof worsens from 0.88 (PTE 0.82) → 2.44 (PTE 0.00) after deprojection. ACT metacal even worse: 0.96 → 5.51. The systematic contamination was making ACT spectra look MORE like Planck 2018 + NLA IA theory.\n- **S/N counterintuitively increases**: ACT lensmc S/N goes 20→22σ, metacal 19→28σ after deprojection. This arises from non-diagonal covariance structure — worth further investigation but doesn't affect qualitative conclusions.\n- **SPT confirms cleanliness**: SPT chi2/dof unchanged (1.88→1.85 lensmc, 1.67→1.69 metacal). SPT deficit is CMB-side, not contamination.\n- **ACT bias question closed**: Recommendation: bins 1+5 unreliable, SPT preferred for parameter inference, lensmc preferred over metacal for ACT. Original ACT 20σ detection ~14% inflated.\n- **Analysis summary updated** with deprojected likelihood chi2 + Â on panel (d).\n\n### Iteration 23 findings\n\n- **Template marginalization resolves S/N paradox**: Naive template subtraction injected template noise into chi2 (X^T C^{-1} X >> 2·d^T C^{-1} X for noisy templates from C^{SS} denominator). Replaced with joint Fisher matrix fit: d = A*theory + Σ α_S*X_S. Marginalized S/N properly decreases: ACT 20→15σ, SPT 21→14σ.\n- **\"Coincidental good fit\" was an artifact**: Naive chi2 worsening (0.88→2.44) was dominated by template noise injection. Marginalized profile chi2/dof=0.75 (PTE 0.98) — ACT signal IS consistent with Planck 2018 + NLA IA after proper contamination handling. This is a significant qualitative revision from iteration 22.\n- **ACT contamination modest**: Â(IA) moves 0.93→0.86±0.06 (marginalized, 1.2σ from unity), not 0.93→0.80 (naive, 2.5σ). ACT metacal: 0.89→0.82±0.06 (1.2σ). Both methods now consistent with theory.\n- **SPT deficit confirmed intrinsic**: Profile chi2/dof=1.6 persists after marginalization. SPT normalization issue is CMB-side.\n- **Template amplitudes diagnostic**: ACT α_stellar~0.4, α_gal_ext~0.5. SPT α values poorly constrained (low contamination signal → unconstrained Fisher directions).\n- **S/N question fiber closed**: `deprojection-s-n-increase-dc7a64b4` resolved with analytical decomposition + numerical verification.\n- **Analysis summary updated**: Panel (d) now shows \"After marginalized\" annotation with corrected Â and chi2 values.\n\n## Skills\n\n- `/tapestry` — **always run this skill** to understand how fibers, evidence, and plots connect in the DAG visualization. Fibers use `tapestry:{specName}` tags; evidence + plots co-located in `results/claims/{specName}/`; staleness propagates via mtime. Every iteration should enrich the tapestry — add evidence, fill gaps, connect fibers.\n- `/snakemake` — workflow design and execution. Trust the DAG.\n- `/implementing-code` — script development\n- `/data-visualization` — plotting and figure design\n- `/felt` — fiber management at session boundaries",
      "outcome": "31 iterations, 31 tapestry nodes, 175 plots, all evidence fresh. Achieved: every snakemake rule inspectable with evidence + claim fibers, DAG wired, fiber bodies substantive, plot quality publication-ready. Superseded by narrative-tapestry-compress-31-6c42a4d6 which shapes the same tapestry for comprehensibility and narrative flow.",
      "createdAt": "2026-02-14T17:40:52.573667278+01:00",
      "closedAt": "2026-02-15T16:26:48.098557682+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "act-vs-spt-cross-spectra-b4181199",
      "title": "ACT vs SPT: same galaxies, same spectrum",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_act_vs_spt",
        "region:validation:consistency"
      ],
      "body": "The same Euclid shear field crossed with two independent CMB lensing reconstructions — ACT DR6 and SPT-3G GMV — should yield the same cross-spectrum. Differences would indicate CMB-side systematics.\n\nThe 6-panel spectral overlay (lensmc baseline) shows ACT and SPT tracking each other across all bins and multipoles. SPT error bars widen at low ℓ where its smaller sky area limits the mode count; at high ℓ the two converge. All 6 bins pass the shape consistency test (median chi2/dof = 0.86, median PTE = 0.63, 0 failures at 5%).\n\nThe agreement holds despite different *amplitudes* relative to theory (A_lens = 0.93 vs 0.76). The chi2 test compares shape, not normalization — it cannot detect a uniform multiplicative offset. The SPT deficit is a ~24% suppression, consistent with a CMB-side calibration factor rather than ℓ-dependent systematics.\n\nA subtlety: ACT is contaminated by stellar density and galactic extinction ([bias budget](.felt/systematic-bias-budget-709ea507.md): significance up to 8σ), while SPT is clean (<0.1σ after marginalization). The contamination has the same sign as the signal, inflating ACT's normalization while preserving shape consistency with SPT.\n\nMethod-independence test (lensmc vs metacal): [method comparison](.felt/lensmc-vs-metacal-method-7d4d724f.md). SPT estimator variants: [SPT estimators](.felt/spt-estimator-comparison-gmv-vs-7f4cef00.md).\n\n## Comments\n**2026-02-16 00:39** — ACT vs SPT comparison plot needs proper xlims — current axis range doesn't show the data well.",
      "outcome": "ACT and SPT cross-spectra are fully consistent: 14/14 pass at 5% level, median PTE=0.639, median chi2/dof=0.86. No evidence of CMB-side systematics. Evidence + plots co-located at results/claims/plot_act_vs_spt/.",
      "createdAt": "2026-02-14T17:53:30.673248363+01:00",
      "closedAt": "2026-02-16T01:51:07.325300787+01:00",
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654",
        "act-dr6-lensing-e4a3eae9",
        "spt-3g-winter-lensing-ab712d17"
      ]
    },
    {
      "id": "redshift-trend-signal-increases-bafce25b",
      "title": "Redshift trend: signal rises with lensing kernel overlap",
      "status": "closed",
      "kind": "task",
      "body": "All 6 tomographic bins on a single panel, testing the basic lensing prediction: the cross-correlation amplitude should increase with source redshift, because the CMB κ lensing kernel (peaking at z ~ 2) has more overlap with higher-redshift galaxies.\n\nS/N ranges from ~5σ (bin 1–2, low lensing kernel overlap) to ~12σ (bin 6, maximum overlap). The ordering matches ΛCDM predictions. Theory overlays (Planck 2018 with standard NLA IA) track the measured redshift dependence.\n\n**Low-z complication.** Bins 1–2 are where two effects compete. Systematic contamination from stellar density boosts the ACT signal ([bias budget](.felt/systematic-bias-budget-709ea507.md)), while intrinsic alignments suppress the theory prediction ([NLA model](.felt/nla-intrinsic-alignment-theory-57e37bd1.md)). In raw data, these partially cancel — the fit is good but for the wrong reasons. After template marginalization ([deprojection](.felt/template-deprojection-a1621797.md)), the low-z ACT amplitude drops.\n\n**High-z clean.** Bins 4–6 are clean on both sides: contamination is negligible, IA suppression is small (<10%), and the ACT data matches theory well. These bins carry the bulk of the cosmological constraining power.\n\n**Script**: `cmbx/files/workflow_scripts_plot_redshift_trend.py`",
      "outcome": "Signal increases with redshift bin as expected from lensing kernel overlap. S/N 5-12, highest in bin 6. Low-z bins (1-2) complicated by contamination + IA degeneracy.",
      "createdAt": "2026-02-14T17:53:34.545890359+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f"
      ]
    },
    {
      "id": "lensmc-vs-metacal-method-7d4d724f",
      "title": "lensmc vs metacal: pipeline independence",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_method_comparison",
        "region:validation:consistency"
      ],
      "body": "Two independent shear measurement pipelines — lensmc (forward-model PSF fitting) and metacal (metacalibration with sheared images) — process the same galaxies in different ways. If their cross-spectra with CMB κ agree, neither introduces a measurement-specific bias.\n\nThe 6-panel spectral overlay (ACT baseline) makes the agreement visible: blue lensmc and orange metacal data points sit on top of each other in every bin, with fractional differences scattering around zero in the sub-panels. The residuals are mostly within ±10% even at noisy bandpowers. Median chi2/dof = 0.14 — suspiciously tight, but expected. The two methods share the *same galaxies* and the *same CMB map*, so their noise is highly correlated. The Knox formula assumes independent noise realizations; applied to the difference of correlated measurements it dramatically overestimates the variance, deflating chi2. This test confirms consistency but has limited discriminating power. A proper test would need a covariance for the difference spectrum accounting for shared noise.\n\nDespite producing consistent cross-spectra, the two methods couple differently to systematic contamination. After template marginalization, lensmc retains 75% of its raw S/N (20σ → 15σ) while metacal retains 69% (19σ → 13σ). The different shear weight maps couple differently to spatially-varying systematics. Both methods give consistent final results, but lensmc is preferable for contamination-sensitive analyses.",
      "outcome": "Method-comparison plotting is now composite-only: per-bin/per-experiment figure generation was removed from the DAG, and the rule-level claim is driven by a single 6-bin ACT baseline composite plus aggregate evidence. On February 23, 2026 this rerun gave 6 comparisons, median chi2/dof = 1.761, median PTE = 0.139, with 3/6 bins passing PTE >= 0.05 (results/claims/plot_method_comparison/evidence.json). The method agreement remains acceptable, but no longer reads as \"too perfect\" under the current statistic definition.\n\nThe composite still shows tight tracking between lensmc and metacal in each tomographic bin. The pipeline conclusion stays the same: no strong evidence for method-specific shear bias in cross-correlation with CMB kappa. What changed is presentation and statistical calibration: the pipeline now reports one legible figure and one rule-level evidence file, rather than a wildcard gallery and dozens of sidecar evidence files that collaborators do not consume.\n\nThis formalization reduces exploration clutter and aligns the rule with the constitution principle that plot outputs should be compressed into collaborator-readable composites. A remaining technical caveat is that the consistency statistic still uses diagonal-error approximations and does not model full shared-noise covariance between methods.",
      "createdAt": "2026-02-14T17:56:14.761701369+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654"
      ]
    },
    {
      "id": "cmb-kappa-x-systematic-null-cc19743b",
      "title": "CMB kappa x systematic null tests: galactic extinction contaminates both sides",
      "status": "closed",
      "kind": "task",
      "body": "The CMB-side leg of the contamination diagnostic: cross-spectra between CMB κ maps and systematic templates. Required to compute the full DES×SPT contamination metric X^f_S(ℓ) = C^{κS}_ℓ · C^{fS}_ℓ / C^{SS}_ℓ.\n\n**What it tests.** Cross-correlations are immune to systematics that contaminate only one tracer — the key advantage over auto-spectra. The contamination metric is non-zero only if a systematic correlates with *both* κ and the Euclid tracer simultaneously. C^{κS} measures whether the systematic leaks into the CMB lensing reconstruction (e.g. dust biasing the CMB gradient estimator).\n\n**Results.** 25 spectra (5 sysmaps × 5 CMB experiments). Galactic extinction strongly contaminates all CMB κ reconstructions: ACT (chi2=68.6/20, PTE=0), SPT GMV (chi2=65.3/20, PTE=0), SPT TT (chi2=48.9/20, PTE=0.0003), SPT PP and MV similar. All other systematics (stellar density, exposures, SAA, zodiacal) are clean across all estimators. This parallels DES×SPT findings (2203.12440) where dust was the dominant contaminant.\n\nImportantly, galactic extinction contamination is **CMB-estimator-independent** — all 4 SPT estimators (GMV, TT, PP, MV) plus ACT show comparable contamination. This confirms the dust signal is in the CMB sky, not an estimator artifact.\n\n**C^{SS} resolved.** The full X metric now uses C^{SS} from systematic auto-spectra (stored as `cl_sys_auto` in NPZ files). See fiber `contamination-metric-needs-c-ss-6e451610`.\n\n**Script**: `cmbx/files/workflow_scripts_compute_cmbk_systematic_cross_spectrum.py`",
      "outcome": "25 cross-spectra (5 sysmaps x 5 CMB). Galactic extinction contaminates all CMB κ reconstructions: ACT chi2=68.6/20, SPT GMV chi2=65.3/20, SPT TT/PP/MV similar. 4/25 fail at 5%. Median chi2/dof=0.96 overall. All non-extinction systematics clean. Confirms dust contamination is CMB-estimator-independent.",
      "createdAt": "2026-02-14T18:03:55.477279413+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "first-lensmc-bin1-x-act-cross-2c7984a5"
      ]
    },
    {
      "id": "covariance-methodology-b17f19da",
      "title": "Covariance methodology",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc",
        "covariance"
      ],
      "body": "Two covariance estimators used in the pipeline, with different regimes of validity.\n\n## Knox formula (primary for null tests)\n\n`Var(C^{ab}_b) = C^{aa}_b · C^{bb}_b / n_modes_b`\n\nwhere `n_modes_b = Σ_ℓ∈b (2ℓ+1) · fsky_eff` and `fsky_eff = ⟨w₁·w₂⟩² / ⟨w₁²·w₂²⟩` (Hivon et al. 2002). This is diagonal — no bandpower-to-bandpower correlations.\n\n**Inputs.** C^{aa} and C^{bb} are the auto-spectra of the two fields. For shear × CMB κ: C^{γγ} includes shape noise (`NOISE_CL` from FITS headers), C^{κκ} includes reconstruction noise. fsky_eff computed from the apodized product of both masks.\n\n**When it works.** Accurate at all fsky when the Gaussian approximation holds (random Gaussian fields, no survey geometry effects). Primary for systematic null tests where the signal is zero by construction — the Knox formula with actual auto-spectra gives properly calibrated chi2/dof ~ 1 under H0.\n\n**Known limitation.** Missing off-diagonal terms (bandpower-to-bandpower coupling from the mask), super-sample variance. These matter for parameter inference but not for null tests.\n\n## NaMaster Gaussian (iNKA)\n\nNaMaster's `gaussian_covariance()` computes the full Gaussian covariance including mode-coupling from the survey mask. In principle more accurate than Knox for structured masks.\n\n**The problem at fsky ~ 0.01.** NaMaster overestimates variance by 10-130× for our individual tomographic bins. The cause is documented in fibers `suspiciously-good-ptes-in-dbf44cbb` and `systematic-pte-overestimation-89f57308`: at very small sky fractions, the iNKA approximation breaks down or the mode-coupling kernel overwhelms the diagonal terms. This manifests as all PTEs being ~ 1.0 (variance so large that any signal is within \"noise\").\n\n**Use case.** Retained as a secondary diagnostic and for SACC file packaging. Not used for chi2/PTE in evidence JSON — Knox is authoritative there.\n\n## Choice rationale\n\nKnox is the right tool for the current analysis stage (signal detection, null tests). For parameter inference with the full eDR1like likelihood, a proper covariance (potentially from simulations or the analytic Gaussian with correct coupling) would be needed. This is downstream work, not blocking current validation.",
      "outcome": "Knox analytic (primary for null tests): Var=C^aa*C^bb/n_modes with fsky_eff from Hivon 2002. NaMaster Gaussian (iNKA): overestimates 10-130x at fsky~0.01. Knox authoritative for chi2/PTE. See fibers systematic-pte-overestimation-89f57308, suspiciously-good-ptes-in-dbf44cbb for details.",
      "createdAt": "2026-02-14T18:10:37.365703691+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c"
      ]
    },
    {
      "id": "fiducial-cosmology-planck-2018-f1a59f23",
      "title": "Fiducial cosmology: Planck 2018 best-fit",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Theory predictions use Planck 2018 best-fit (As=2.105e-9, ns=0.9665, H0=67.66, Omb=0.049, Omc=0.261, mnu=0.06). Default from eDR1like. Bias set to constant b=1 (irrelevant for shear cross-spectra). IA, magnification bias, RSD off. CCL provider with Limber approximation.",
      "createdAt": "2026-02-14T18:10:47.998589378+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c"
      ]
    },
    {
      "id": "theory-comparison-data-d5cc9678",
      "title": "Theory comparison: Planck 2018 predicts the ACT signal",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_theory_comparison",
        "region:validation:theory"
      ],
      "body": "The [signal overview](.felt/signal-overview-act-spt-theory-1ae2798f.md) shows data against vanilla Planck ΛCDM. Here we add the full theory: ΛCDM + NLA intrinsic alignment (A_IA=1.72, η=-0.41 from Euclid pipeline defaults — [NLA model](.felt/nla-intrinsic-alignment-theory-57e37bd1.md)). Both curves are predictions, not fits: cosmology from Planck, IA from Euclid, binned through NaMaster bandpower windows.\n\nThe plot shows two theory lines per bin: vanilla Planck 2018 (black) and NLA IA (crimson dashed). The IA correction suppresses the prediction by 4-36% depending on redshift — largest at low-z where the GI term geometry is most favorable.\n\n**ACT is consistent with standard theory.** Joint chi2 = 106/120 (PTE 0.82) against the NLA prediction. The vanilla prediction slightly overshoots — adding standard IA brings it into line. This isn't a fit; it's a prediction matching data.\n\n**SPT shows a 24% deficit.** Joint chi2 = 226/120 (PTE ≈ 0). Data sits below both theory curves. The deficit is method-independent (lensmc ≈ metacal), scale-dependent (worse at high ℓ — [ℓ-range robustness](.felt/ℓ-range-robustness-amplitude-e86f1728.md)), and absent from ACT. CMB-side normalization issue, characterized in [theory residuals](.felt/theory-residual-analysis-6a66a995.md).\n\n**Script**: `cmbx/files/workflow_scripts_plot_theory_comparison.py`",
      "outcome": "ACT consistent with Planck 2018 ΛCDM + standard NLA IA (PTE 0.82). SPT shows 24% normalization deficit (PTE≈0), method-independent, CMB-side. Shown: lensmc × {ACT, SPT GMV} — metacal and SPT variants covered by method_comparison and spt_estimator nodes.",
      "createdAt": "2026-02-14T18:12:56.825270269+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "nla-intrinsic-alignment-theory-57e37bd1",
        "results-detection-and-90f2ec1b",
        "act-dr6-lensing-e4a3eae9",
        "spt-3g-winter-lensing-ab712d17"
      ]
    },
    {
      "id": "contamination-metric-product-c-e55501f4",
      "title": "Contamination metric: small per bandpower, dangerous in aggregate",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_contamination_metric",
        "region:validation:contamination"
      ],
      "body": "The contamination metric X^f_S(ℓ) = C^{κS} · C^{fS} / C^{SS} (DES×SPT, 2203.12440 §A.4) quantifies the bias from a systematic that correlates with both tracers simultaneously. X has the same units as the signal C^{fκ} and can be compared directly to the measurement uncertainty.\n\nThe composite figure shows X(ℓ) for all five systematics crossed with the two baseline CMB reconstructions (ACT and SPT-GMV). Six redshift bins overlaid per panel; gray bands mark 1% and 10% of the Knox uncertainty. Per bandpower, all contamination metrics sit within or below the 1% band. Even galactic extinction, which individually contaminates both κ (chi2 ~ 49–69/20) and shear (chi2/dof up to 9), produces sub-percent per-bandpower bias.\n\nHowever, per-bandpower smallness does not guarantee negligible integrated bias. Twenty bandpowers each contributing <1% can integrate to a multi-σ shift. The C^{SS} denominator carries noise bias from downgrading sparse systematic maps (nside 16384→2048), making X a lower bound. The [bias budget](.felt/systematic-bias-budget-709ea507.md) integrates over multipoles: stellar density reaches 4.4σ and galactic extinction 3.7σ for ACT. Where the budget flags significant bias, [template marginalization](.felt/template-deprojection-a1621797.md) handles it.",
      "outcome": "Per-bandpower contamination metric X = C^{κS}·C^{fS}/C^{SS} sits below 1% of signal uncertainty for all five systematics across all CMB estimators. However, the integrated bias significance (tapestry:plot_systematic_budget) reaches multi-σ levels for stellar density and galactic extinction — per-bandpower smallness does not guarantee negligible integrated bias.",
      "createdAt": "2026-02-14T18:13:15.758141608+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-null-test-heatmap-92dec7e5",
        "systematic-maps-on-the-sky-83122c03",
        "systematic-contamination-summary-e6c81e29"
      ]
    },
    {
      "id": "individual-cross-spectrum-plots-2c81b255",
      "title": "Individual cross-spectrum plots: 28 positive spectra visualized",
      "status": "closed",
      "kind": "task",
      "body": "Visual inspection of every individual cross-spectrum. The first-order check before any comparison or combination: does each spectrum look physical?\n\n**Layout.** Two-panel figure per spectrum. Top: E-mode (signal) with Knox error bars, ℓ·C_ℓ scaling. Bottom: B-mode (null check) — should be consistent with zero for a real lensing signal. Annotation box shows SNR and PTE.\n\n**B-mode caveat.** At the partial sky coverage of individual tomographic bins (fsky ~ 0.01), NaMaster E→B leakage can produce B-mode amplitudes up to ~93% of E-mode. The B-mode variance is ~500× smaller than E-mode (since C_BB << C_EE), so elevated B-mode chi2 is expected from leakage, not from systematics. B-mode is diagnostic, not a reliable null test at this fsky.\n\n**28 spectra.** All show positive E-mode signal. S/N ranges from ~3 (bin1, small lensing kernel overlap) to ~12 (bin6, maximum overlap). The visual impression is the starting point for every downstream comparison — method differences, CMB experiment consistency, and redshift trends all build on these individual measurements.\n\n**Script**: `cmbx/files/workflow_scripts_plot_cross_spectrum.py`",
      "outcome": "28 plots (2 methods x 7 bins x 2 CMB). Two-panel layout: E-mode signal (top), B-mode null check (bottom). ell*Cl scaling. Knox error bars when available. SNR/PTE annotation. All spectra show positive E-mode signal.",
      "createdAt": "2026-02-14T18:14:04.822998934+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "first-lensmc-bin1-x-act-cross-2c7984a5"
      ]
    },
    {
      "id": "systematic-null-test-heatmap-92dec7e5",
      "title": "Systematic null tests: galactic extinction correlates with shear",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_systematic_null_tests",
        "region:validation:contamination"
      ],
      "body": "Cross-correlate each systematic map (stellar density, galactic extinction, exposures, zodiacal light, SAA) with the Euclid shear field and test consistency with zero.\n\nThe 2×3 panel shows per-bandpower pulls (C^{fS}_ℓ / σ_Knox) for all five systematics across six tomographic bins. Under the null hypothesis, pulls scatter around zero with unit variance. Coherent excursions beyond ±2σ indicate contamination; their multipole structure reveals where in harmonic space the systematic leaks in.\n\n**Galactic extinction stands out.** In bins 5 and 6 (highest redshift), the pink pulls reach ±3-5σ across a broad range of multipoles — this is broadband contamination, not a feature at a specific angular scale. The chi2/dof climbs to 7.9 in bin 6. Lower bins show milder excursions (chi2/dof 1.5-2.3). The physical mechanism: Galactic dust affects PSF modeling and photometric calibration, imprinting a large-scale pattern on the shear maps.\n\n**Other systematics are clean.** Stellar density, exposures, SAA, and zodiacal light all scatter within the ±1σ band in most bins. Stellar density shows occasional 2σ excursions but no coherent spectral pattern — its null test looks benign. This is misleading: the bias budget analysis (`plot_systematic_budget`) reveals stellar density is actually the *dominant* ACT contaminant, because its correlation with CMB κ is stronger than galactic extinction's. The null test only measures C^{fS} (shear × systematic); the full contamination diagnostic requires C^{κS} as well.\n\n**What this test cannot see.** A systematic that correlates with CMB κ but not with shear does not appear here. The [contamination metric](.felt/contamination-metric-product-c-e55501f4.md) captures the joint effect — even galactic extinction's alarming null test failures translate to sub-percent per-bandpower bias, because the triple coincidence required for cross-correlation contamination is rarer than pairwise correlations suggest. But sub-percent per bandpower integrates to multi-σ bias over 20 bandpowers — the [bias budget](.felt/systematic-bias-budget-709ea507.md) and [template marginalization](.felt/deprojected-likelihood-joint-26b1588e.md) complete the picture.",
      "outcome": "Spectral pull plot: 5 systematics × 6 bins showing C^{fS}/σ_Knox per bandpower. Galactic extinction shows coherent ±3-5σ pulls at low ℓ in bins 5-6 (chi2/dof up to 7.9). Clean systematics scatter within ±1σ. 7/30 lensmc tests fail at 5%. The spectral structure is now visible — contamination is broadband, not confined to specific multipoles.",
      "createdAt": "2026-02-14T18:14:07.516956859+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "systematic-maps-on-the-sky-83122c03",
        "systematic-contamination-summary-e6c81e29"
      ]
    },
    {
      "id": "sacc-file-validation-tracers-n-84f31c2b",
      "title": "SACC file validation: tracers, n(z), covariance complete",
      "status": "closed",
      "kind": "task",
      "body": "Automated validation of the combined SACC file, run after `combine_shear_cross_spectra` packages 28 individual NPZ files into a single data product. Catches packaging errors before the SACC file is used downstream — missing tracers, unnormalized n(z), dimension mismatches between data vector and covariance.\n\n**What it checks.** (1) All 15 tracers defined: 14 NZTracer (7 bins × 2 methods, each with z and n(z) arrays) + 1 MiscTracer (CMB κ). (2) n(z) physically sensible: non-negative, integrates to ~1 for each bin. (3) Data vector complete: 560 data points (14 spectra × 40 bandpowers — 20 E-mode + 20 B-mode). (4) Covariance matrix shape (560 × 560) matches data vector. (5) Covariance positive semi-definite (eigenvalue check). Run independently per CMB experiment (ACT, SPT).\n\n**Why this matters.** Dimension mismatches between the data vector and covariance cause silent errors in likelihood evaluation — wrong chi2 values with no error message. The tracer check ensures n(z) curves are properly associated with each cross-spectrum, which is critical for theory prediction. A missing or swapped n(z) would bias the theory C_ℓ comparison.\n\n**Evidence.** Validation results stored at `cmbx/files/results_claims_validate_sacc_evidence.json` with pass/fail per check.\n\n**Script**: `cmbx/files/workflow_scripts_validate_sacc.py`",
      "outcome": "Validates SACC file completeness: tracer definitions, n(z) curves, data vectors, covariance blocks. Run per CMB experiment. SACC files contain NZTracer for shear bins, MiscTracer for CMB kappa.",
      "createdAt": "2026-02-14T18:14:31.242357337+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "sacc-combine-uses-misc-tracers-8b08e236"
      ]
    },
    {
      "id": "weight-masking-apodize-binary-4d110db1",
      "title": "Weight masking: apodize(binary) * weight following gctools",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Shear mask = apodize(weight > 0, 0.15, C2) * weight. Binary threshold at weight > 0, C2 apodization at 0.15 rad, then multiply by the weight map. This follows gctools spectra.py::map2wlcls. The apodization smooths the mask boundary to reduce mode coupling artefacts. CMB mask = apodize(cmb_mask, 0.15, C2) directly. Systematic maps use apodize(common_footprint, 0.15, C2) over the intersection of shear+CMB coverage. All compute scripts use the same pattern.",
      "createdAt": "2026-02-14T18:31:23.339619191+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "catalog-validation-summary-d0b856bd",
      "title": "Estimator comparison",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_catalog_validation_summary",
        "region:methodology"
      ],
      "body": "NmtFieldCatalog works directly from galaxy catalogs, bypassing pixelization. NmtField works from maps built by binning galaxies into HEALPix pixels. If the two give the same cross-spectrum, map construction introduces no bias. Same galaxies, same CMB κ, different computational paths.\n\nThe 6-panel spectral overlay (lensmc × ACT) shows them side by side: blue map-based with error bars, orange catalog-based without. They track each other across all bins and multipoles — Pearson correlation 0.995-0.999, with the closest agreement at high ℓ where signal dominates. The RMS fractional differences (7-33%, S/N-weighted) reflect noise scatter in low-S/N bandpowers, not systematic bias. No trend with redshift bin.\n\nThis validates the map-based pipeline as the production measurement. The catalog approach serves as an independent check, not a competing estimator — it's computationally heavier (64GB for ~5M galaxies at lmax=3000) and provides no covariance estimate.",
      "outcome": "Catalog-vs-map validation summary now includes both matrix diagnostics and concrete representative spectra. On February 23, 2026, plot_catalog_validation_summary was rerun after script formalization to add two direct cross-spectrum overlays selected from the full comparison set: best-agreeing and worst-agreeing method×bin×CMB combinations (ranked by signal-selected fractional RMS, fallback total RMS). This preserves compressed, collaborator-readable reporting while anchoring interpretation in actual C_ell curves rather than heatmap statistics alone. Outputs updated at results/claims/plot_catalog_validation_summary/{catalog_validation_summary.png,evidence.json}.",
      "createdAt": "2026-02-15T01:34:46.048361777+01:00",
      "closedAt": null,
      "dependsOn": [
        "apodization-masks-what-enters-f6b5a581",
        "methods-pseudo-cℓ-cross-3eedb9dd",
        "catalog-based-harmonic-space-14a8b515"
      ]
    },
    {
      "id": "ralph-spec-rework-constitution-87658e3d",
      "title": "Ralph spec rework: constitution not checklist",
      "status": "open",
      "kind": "task",
      "outcome": "Reworked cross-correlation-pipeline-v2 spec after reviewing crafting-fibers.md. Original spec was implementation plan with anti-patterns: checklists, snapshots, over-specification. Rewrote as constitution — five invariants describing what correct looks like, with pointers to gctools and sp_validation. Iterations figure out how to get there. Key principle: 'Constitution, not implementation plan. The spec says what the system looks like when it's right.'",
      "createdAt": "2026-02-15T02:16:24.418426074+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "sp-validation-cloned-as-catalog-ab6aed69",
      "title": "sp_validation cloned as catalog pseudo-Cl reference",
      "status": "open",
      "kind": "task",
      "outcome": "Cloned CosmoStat/sp_validation to ../sp_validation/. Contains NmtFieldCatalog patterns, theory+noise covariance, analytic noise bias, pol_factor toggle for sign convention testing. Key file: src/sp_validation/cosmo_val.py. Used as reference for catalog-based cross-spectra and covariance methodology.",
      "createdAt": "2026-02-15T02:16:28.756080725+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "noise-cl-in-shear-fits-headers-1172178e",
      "title": "NOISE_CL in shear FITS headers",
      "status": "open",
      "kind": "task",
      "tags": [
        "pattern"
      ],
      "outcome": "Shear map FITS headers contain pre-computed noise metadata: NOISE_CL (σ²_comp/n_eff_sr = flat shape noise Cℓ per component), SIG_EPS (total ellipticity dispersion), SIG_COMP (per-component = σ_ε/√2), NEFF_SR (effective n_gal per steradian), AREA_SR (survey area). Verified: NOISE_CL = SIG_COMP² / NEFF_SR. Replaces Margherita's nl_uncoupled=None TODO and the BB-EE subtraction trick for noise estimation.",
      "createdAt": "2026-02-15T02:16:33.924594981+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "evidence-pipelines-for-all-d6ecf4b0",
      "title": "Evidence pipelines for all comparison rules",
      "status": "closed",
      "kind": "task",
      "outcome": "Added evidence JSON output to 5 comparison scripts (method_comparison, theory_comparison, redshift_trend, contamination_metric, systematic_null_tests, catalog_validation_summary). Each writes per-wildcard evidence with chi2/PTE/RMS metrics. Snakemake rules updated to output to results/claims/{rule_name}/. Four new aggregation rules added (aggregate_{method,theory,redshift,contamination}_evidence). Variable name collision (evidence_path reused in loops) found and fixed. 7/9 evidence directories now populated; systematic_null_tests and contamination_metric waiting on SLURM reruns of compute_systematic (code changed to add cl_sys_auto).",
      "createdAt": "2026-02-15T03:31:21.664947013+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c"
      ]
    },
    {
      "id": "theory-c-ℓ-computation-d5415ff5",
      "title": "Theory C_ℓ computation: eDR1like with Planck 2018 fiducial",
      "status": "closed",
      "kind": "task",
      "body": "Generates fiducial theory C^{Eκ}_ℓ predictions for each tomographic bin using `eDR1like.Theory` backed by CCL (Core Cosmology Library) with CAMB as the Boltzmann solver.\n\n**Cosmology.** Planck 2018 best-fit (TT,TE,EE+lowE+lensing): A_s=2.105×10^{-9}, n_s=0.9665, H_0=67.66, Ω_b=0.04897, Ω_c=0.2607. Galaxy bias b=1 (constant), no magnification.\n\n**Two theory models computed per bin:**\n\n1. **Vanilla** (lensing only) — galaxy-galaxy lensing with no intrinsic alignment. This provides the baseline for comparing data amplitude and shape. When A_hat < 1, the deficit flags missing physics (IA, calibration) or CMB-side normalization issues.\n\n2. **NLA intrinsic alignment** — nonlinear alignment model with A_IA=1.72, eta_IA=-0.41 (eDR1like defaults, NLA-z parameterization). CCL handles the physics internally: `WeakLensingTracer` with `use_A_ia=True` computes C_1 * rho_cr * Omega_m / D(z) * A_IA * (1+z)^eta_IA. IA suppresses the cross-spectrum at low redshift (36% in bin 1, 4% in bin 6), resolving the ACT amplitude deficit from 3σ to 1.3σ. See fiber `nla-intrinsic-alignment-cb1dea0b`.\n\n**Binning.** Unbinned theory C_ℓ computed at every multipole, then binned through NaMaster's bandpower window functions (Bbl) to match the data resolution. This ensures fair comparison — binned theory accounts for the mode-coupling matrix and bandpower averaging. Bbl was already stored in the cross-spectrum NPZ files (`bpws` key, shape (2,20,2,3001)); E-mode extraction: `bpws[0,:,0,:]`.\n\n**n(z).** Source redshift distributions from `RR2_v2_Nz_WL_C2020_sel_pv.fits` (6 bins, 3000 z-points on linspace(0,6), sum-normalized). Method-specific (lensmc vs metacal have different selection functions).\n\n**Output.** NPZ with keys: `cl_theory_bin{1-6}` (vanilla unbinned), `cl_binned_bin{1-6}` (vanilla binned), `cl_ia_theory_bin{1-6}` (IA unbinned), `cl_ia_binned_bin{1-6}` (IA binned), plus `ell_theory` and metadata. Downstream consumers: theory comparison, residual analysis, likelihood evaluation, signal overview, deprojected likelihood.\n\n**Script**: `cmbx/files/workflow_scripts_compute_theory_cls.py`",
      "outcome": "Computes C^{Eκ}_ℓ theory predictions using eDR1like.Theory (CCL/CAMB) at Planck 2018 best-fit. Two models: (1) vanilla lensing-only, (2) NLA IA (A_IA=1.72, eta=-0.41). Both binned through NaMaster bandpower windows. 4 NPZ outputs: 2 methods × 2 CMB experiments, each containing vanilla and IA predictions for all 6 bins.",
      "createdAt": "2026-02-15T03:36:40.160658516+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "first-lensmc-bin1-x-act-cross-2c7984a5",
        "nla-intrinsic-alignment-cb1dea0b"
      ]
    },
    {
      "id": "catalog-vs-map-comparison-28-71f8c27e",
      "title": "Catalog vs map comparison: 28 overlay plots",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry-archived"
      ],
      "body": "Per-wildcard overlay of catalog-based and map-based cross-spectra for visual inspection. The complement to the summary heatmap in `plot_catalog_validation_summary` — here you see the full ℓ-dependence, not just summary statistics.\n\n**Why this matters.** The map-based pipeline converts catalogs to pixelized maps (nside 2048) before computing spectra via NaMaster. This introduces potential biases: sub-pixel averaging, weight map artifacts, and pixelization window function effects. The catalog-based pipeline (`NmtFieldCatalog`) bypasses all of this — it works directly from galaxy positions and ellipticities. Agreement between the two confirms that map-making is not introducing artifacts. This is especially important for the low-number-density high-z bins where pixel occupancy is sparse.\n\n**Layout.** Single panel per comparison. Both spectra overlaid with shared x-axis (ℓ) and ℓ·C_ℓ scaling. Error bars from map-based Knox covariance (no covariance available for catalog-based, since NaMaster doesn't support covariance for NmtFieldCatalog). The visual comparison is the primary diagnostic — differences should be invisible compared to error bars.\n\n**28 comparisons.** Differences are sub-percent in well-measured bandpowers. Any visible discrepancy at high ℓ is consistent with noise — catalog-based and map-based spectra use different internal representations of the same underlying field. S/N-weighted RMS fractional differences range 3-46% (SNR weighting from `plot_catalog_validation_summary` downweights noise-dominated high-ℓ bins).\n\n**Script**: `cmbx/files/workflow_scripts_plot_catalog_vs_map_comparison.py`",
      "outcome": "28 overlay plots (2 methods × 7 bins × 2 CMB) comparing catalog-based (NmtFieldCatalog) and map-based (NmtField) cross-spectra. Visual confirmation that map-making doesn't introduce bias. Each panel shows both spectra with shared error bars.",
      "createdAt": "2026-02-15T03:36:43.678101971+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "first-lensmc-bin1-x-act-cross-2c7984a5",
        "catalog-cross-spectra-validate-c2ced916"
      ]
    },
    {
      "id": "spt-estimator-comparison-gmv-vs-7f4cef00",
      "title": "SPT estimators: no foreground bias",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_spt_estimator_comparison",
        "region:validation:consistency"
      ],
      "body": "SPT-3G provides four CMB lensing estimator variants with genuinely different foreground sensitivity. GMV (baseline) uses all quadratic pairs — highest SNR but most foreground-exposed. TT (temperature-only) is maximally sensitive to tSZ from galaxy clusters. PP (polarization-only) is the cleanest but noisiest. MV (SQE) tests pipeline-level consistency. All share the same survey mask, so differences in their cross-spectra with Euclid shear isolate foreground contamination in the lensing reconstruction.\n\nThe 6-panel ratio plot (lensmc baseline) shows each variant divided by GMV as a function of multipole. The ratios scatter around unity in every bin — TT (salmon), PP (teal), MV (purple) all consistent with the 10% shaded band, with noise increasing at low ℓ where each variant's individual S/N is lowest. PP shows the widest scatter (noisiest estimator), but no systematic offset. TT — the critical test for tSZ bias — tracks GMV tightly. The large error bars at individual bandpowers correctly show that this is a noisy test: the power comes from the aggregate (18 comparisons, median chi2/dof = 0.19), not any single ℓ bin.\n\nThis means tSZ contamination of the SPT lensing reconstruction does not bias the shear × κ cross-correlation at current noise levels. The SPT normalization deficit (A_lens = 0.76) cannot be explained by foreground leakage — it persists identically across all four estimators, including the foreground-immune PP channel. This disfavors foreground-related hypotheses for the deficit (see `spt-deficit-characterization-6b724e41`).\n\n## Comments\n**2026-02-15 23:56** — Plot rework: drop the ratio plot (noise/noise ratios scatter too much at low ℓ). Instead plot differences relative to best-fit Planck amplitude: (C_variant - C_GMV) / C_theory(A_lens). Clean residual in interpretable units.",
      "outcome": "All 14 comparisons (2 methods x 7 bins) show complete consistency across all 4 SPT estimator variants. Chi2/dof: MV~0.03, TT~0.2, PP~0.3 (all vs GMV, dof=20). Min PTE=0.981 (metacal bin3 PP). No foreground contamination detected — tSZ bias in TT estimator does not affect shear x kappa cross-spectra at current noise levels. 42 cross-spectra computed, 14 comparison plots + evidence at results/claims/plot_spt_estimator_comparison/.",
      "createdAt": "2026-02-15T04:05:05.21428304+01:00",
      "closedAt": "2026-02-16T00:28:19.927753312+01:00",
      "dependsOn": [
        "act-vs-spt-cross-spectra-b4181199",
        "validation-null-tests-and-48ab3654",
        "spt-3g-winter-lensing-ab712d17"
      ]
    },
    {
      "id": "jackknife-null-test-random-sign-e86273e8",
      "title": "Jackknife: galaxy-side systematics are clean",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_jackknife_null_test",
        "region:validation:null"
      ],
      "body": "Multiply each galaxy's ellipticity by a random sign (±1), destroying the coherent cosmological signal while preserving noise structure, pixel coverage, and weight maps. Cross-correlating these randomized shear maps with CMB κ should yield spectra consistent with zero. Any excess reveals galaxy-side additive systematics — PSF leakage, selection effects, calibration errors correlated with sky position.\n\nAll 24 null spectra (2 methods × 6 bins × 2 CMB experiments, 20 bandpowers each) are consistent with zero: median chi2/dof = 0.88, median PTE = 0.62, zero failures at 5%. The galaxy side is clean.\n\nThis test is sensitive to additive systematics but blind to multiplicative biases (shear calibration), which are sign-invariant. A single random realization (seed=42) suffices to rule out large additive contamination. CMB-side null test: [simulation null](.felt/simulation-null-test-sim-kappa-6418a9f1.md). Spatial structure: [spatial variation](.felt/spatial-variation-test-north-vs-c9fdd8ed.md).",
      "outcome": "24/24 null cross-spectra (2 methods x 6 bins x 2 CMB) consistent with zero. Median Knox chi2/dof=0.88, median PTE=0.617, 0 failures at 5% threshold. No galaxy-side systematics detected.",
      "createdAt": "2026-02-15T05:05:55.719926292+01:00",
      "closedAt": "2026-02-15T05:13:46.742266978+01:00",
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654"
      ]
    },
    {
      "id": "spt-theory-comparison-fails-b14b26a4",
      "title": "SPT theory comparison fails while ACT passes: Knox covariance or calibration?",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation",
        "covariance",
        "spt"
      ],
      "body": "## Observation\n\nAll SPT × shear theory comparisons fail at 5% significance (total PTE ≈ 0), while ACT × shear theory comparisons pass (PTE = 0.63 for lensmc, 0.45 for metacal). Yet ACT and SPT cross-spectra agree with each other: 14/14 consistent at 5%, median PTE = 0.64.\n\n**Evidence:**\n- lensmc × ACT: total chi2/dof = 114.1/120 = 0.95, PTE = 0.63\n- lensmc × SPT-GMV: total chi2/dof = 249.0/120 = 2.08, PTE ≈ 0\n- Per-bin SPT chi2 inflated across all bins (37.5, 56.0, 42.5, 30.3, 33.5, 49.2 for dof=20)\n- Also fails for SPT TT/PP/MV variants — not estimator-specific\n\n## Hypotheses\n\n1. **Knox error bars too tight for SPT.** The Knox formula uses `Var = |C^{EE}| × |C^{κκ}| / n_modes`. If SPT has lower reconstruction noise (smaller `C^{κκ}_auto`), the Knox error bars shrink, inflating chi2 for the same theory-data residuals. Need to compare `C^{κκ}_auto` for ACT vs SPT.\n\n2. **fsky_cross difference.** SPT winter field has different sky overlap with Euclid than ACT DR6. Smaller overlap → fewer modes → larger Knox variance (which would REDUCE chi2). This goes the wrong direction — so noise properties dominate if this hypothesis is wrong.\n\n3. **SPT lensing calibration offset.** The SPT maps may have a different lensing response normalization. A multiplicative bias would shift all cross-spectra systematically relative to theory while leaving ACT-SPT ratios consistent (if both are miscalibrated similarly). But ACT-SPT agreement at the difference level argues against this.\n\n4. **Binning mismatch.** The theory curves are computed and binned identically for both CMB experiments. No mechanism for binning to differ.\n\n## Findings\n\n**Knox variance ratio (lensmc bin4):** SPT/ACT = 0.70 (median across bandpowers). SPT error bars are ~84% the size of ACT's. This explains part of the chi2 inflation: for identical residuals, SPT chi2 would be ~1.42× ACT's. Actual ratio is ~2.2×, so the residuals also differ (noise realization + possible systematic).\n\n**Interpretation:** SPT has tighter statistical constraints on the cross-spectrum. A vanilla Planck 2018 theory (no IA, no magnification bias, no multiplicative shear calibration) is \"good enough\" for ACT's noise level but fails when tested against SPT's tighter constraints. This may not indicate a problem with SPT — rather, it reveals that the theory model is insufficient at SPT's statistical power. The ACT comparison passes because it has less power to detect the discrepancy.\n\n## Amplitude fit analysis (iteration 10)\n\nImplemented `plot_theory_residual_analysis` rule. Fits A_hat per bin×cmbk. See fiber `theory-residual-analysis-6a66a995` for full results.\n\n**Key finding: it's both calibration AND shape.**\n\n- ACT mean A = 0.83 ± 0.05 (3.3σ low); shape chi2 good after fit (PTE 0.73-0.83)\n- SPT mean A = 0.70 ± 0.05 (6.5σ low); shape chi2 still fails (PTE < 0.001)\n- Method-independent: lensmc ≈ metacal for both CMB experiments\n\nThe ~17% common deficit (A < 1 for both ACT and SPT) is consistent with missing IA in the theory. The additional ~15% SPT deficit is CMB-side — possibilities: (1) lensing response normalization, (2) noise debiasing, (3) effective ℓ weighting from noise/mask differences.\n\nSPT shape failure concentrated in low-z bins (1-3), improving at high-z (5-6). Consistent with scale-dependent modeling deficiency (IA, baryonic feedback) that ACT's larger errors can't detect.\n\n## Resolution\n\nAll hypotheses have been pursued through subsequent analysis:\n\n- ~~Check if SPT residuals are systematically biased vs scattered~~ → **Done** (iteration 10). Both: multiplicative offset + shape failure.\n- ~~Add IA to theory and see if SPT chi2 improves~~ → **Done** (iteration 13). NLA IA (A_IA=1.72, eta=-0.41) resolves ACT (A=0.93, 1.3σ from 1). SPT improves 0.69→0.76 but 4.9σ deficit persists. See `nla-intrinsic-alignment-cb1dea0b`.\n- ~~Template marginalization~~ → **Done** (iteration 23). Systematic contamination is negligible for SPT (<0.1σ shift). Deficit is intrinsic. See `template-deprojection-a1621797`.\n- ~~Per-bin structure~~ → **Done** (iteration 27). Bins 1–3 fail shape (chi2_shape/dof=1.7–2.7), bins 4–6 pass shape (1.2–1.6). Low-z shape failure consistent with SPT lmin=500 filtering. See `spt-deficit-bin-level-structure-de2540dd`.\n- Check SPT lensing response normalization documentation → **Not pursued** (requires SPT team).\n- Compare ACT vs SPT C^{κκ}_auto → **Partially done**: Knox variance ratio SPT/ACT=0.70 confirmed.\n\n**Conclusion:** The original observation decomposed into (1) common IA suppression (~10%, resolved by NLA IA) + (2) SPT-specific normalization (~24%, CMB-side, not addressable from Euclid side). Low-z shape failure points to SPT reconstruction filtering at lmin=500. Investigation is as complete as possible without SPT team input.",
      "outcome": "Decomposed into two effects: (1) common IA suppression (~10%), fully explained by NLA IA (A_IA=1.72, eta=-0.41) — ACT resolved to A=0.93 (1.3σ from unity); (2) SPT-specific normalization deficit (~24%), method-independent, contamination-independent, with low-z shape failure from lmin=500 filtering. Not addressable from Euclid side. See downstream fibers: nla-intrinsic-alignment, spt-normalization-deficit, spt-deficit-bin-level-structure.",
      "createdAt": "2026-02-15T05:29:59.992721406+01:00",
      "closedAt": "2026-02-15T15:02:25.612467618+01:00",
      "dependsOn": [
        "theory-comparison-data-d5cc9678",
        "act-vs-spt-cross-spectra-b4181199",
        "spt-3g-winter-lensing-ab712d17"
      ]
    },
    {
      "id": "theory-residual-analysis-6a66a995",
      "title": "Theory residuals: ACT passes, SPT fails in shape",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_theory_residual_analysis",
        "region:validation:theory"
      ],
      "body": "The [theory comparison](.felt/theory-comparison-data-d5cc9678.md) shows ACT matching and SPT low. Decomposing the deficit: a single lensing amplitude A_lens is fitted per bin, and the residual shape — data/(A_lens·theory) — is tested for consistency with noise.\n\nTheory here is NLA IA (see `nla-intrinsic-alignment-theory-57e37bd1`), the same prediction shown in the theory comparison. Amplitude fits use diagonal covariance (NaMaster Gaussian for density, Knox proxy for catalog shear).\n\n| CMB | A_lens | σ from 1 | shape PTE |\n|-----|-------|----------|-----------|\n| ACT lensmc | 0.93 ± 0.06 | 1.3σ | 0.83 |\n| SPT-GMV lensmc | 0.76 ± 0.05 | 4.9σ | ~0 |\n\n**ACT passes both tests.** A_lens = 0.93 — within 1.3σ of unity. Shape is excellent. The ~7% residual is consistent with known missing model ingredients (`theory-model-completeness-for-526d66a5`): shear calibration ~2%, baryonic feedback ~3-5%, n(z) shifts ~1-3%.\n\n**SPT fails in both amplitude and shape.** The deficit has bin-level structure: low-z bins (1-3) fail the shape test (chi2/dof 1.7-2.7) while high-z bins (4-6) pass (chi2/dof 1.2-1.6). The [ℓ-range robustness test](.felt/ℓ-range-robustness-amplitude-e86f1728.md) reveals scale dependence: high-ℓ bandpowers actively suppress the amplitude, disfavoring a uniform calibration offset. Full characterization in `spt-deficit-characterization-6b724e41`.",
      "outcome": "Per-bin amplitude fits: ACT A_lens=0.93±0.06 (1.3σ from unity, shape PTE 0.83), SPT A_lens=0.76±0.05 (4.9σ, shape fails). ACT consistent with ΛCDM; SPT deficit is scale-dependent and method-independent.",
      "createdAt": "2026-02-15T05:42:10.839168569+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-comparison-data-d5cc9678",
        "nla-intrinsic-alignment-theory-57e37bd1",
        "results-detection-and-90f2ec1b"
      ]
    },
    {
      "id": "analysis-summary-one-page-c5170698",
      "title": "Analysis summary: one-page synthesis",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_analysis_summary",
        "region:synthesis"
      ],
      "body": "Four-panel synthesis of the full analysis — detection, consistency, null tests, theory — reading aggregate evidence from all upstream nodes. For the spectra, see [signal overview](.felt/signal-overview-act-spt-theory-1ae2798f.md).\n\n## (a) Detection\n\nS/N per tomographic bin. All 12 baseline spectra detected at >3σ (11/12 at >5σ). S/N rises with bin number (increasing lensing kernel overlap). **15σ (ACT) and 14σ (SPT)** after joint Fisher marginalization of stellar density, galactic extinction, and other survey systematics alongside the signal amplitude. Pre-marginalization: 20σ (ACT), 21σ (SPT).\n\n## (b) Consistency\n\nFour cross-checks, all passing. [ACT vs SPT](.felt/act-vs-spt-cross-spectra-b4181199.md): 14/14 at 5%, PTE 0.64. [Lensmc vs metacal](.felt/lensmc-vs-metacal-method-7d4d724f.md): 35/35, PTE 1.0. [SPT estimators](.felt/spt-estimator-comparison-gmv-vs-7f4cef00.md): 14/14, PTE 1.0. [Catalog vs map](.felt/catalog-validation-summary-d0b856bd.md): 28/28, correlation 0.998.\n\n## (c) Null tests\n\n[Jackknife](.felt/jackknife-null-test-random-sign-e86273e8.md): 0/24 fail, chi2/dof 0.88. [Simulation null](.felt/simulation-null-test-sim-kappa-6418a9f1.md): 1/66 false alarm, chi2/dof 0.92. [Spatial split](.felt/spatial-variation-test-north-vs-c9fdd8ed.md): 0/6 fail at ℓ>100. [ℓ-range robustness](.felt/ℓ-range-robustness-amplitude-e86f1728.md): ACT stable, SPT scale-dependent. [Systematic null tests](.felt/systematic-null-test-heatmap-92dec7e5.md): galactic extinction fails 10/14, others clean.\n\n## (d) ΛCDM consistency\n\nAmplitudes against Planck 2018 ΛCDM + NLA IA ([NLA model](.felt/nla-intrinsic-alignment-theory-57e37bd1.md)). **ACT A_lens=0.86±0.06, chi2/dof=0.75 (PTE 0.98) — ΛCDM consistent.** Theory comparison before marginalization ([theory residuals](.felt/theory-residual-analysis-6a66a995.md)): A_lens=0.93±0.06 (1.3σ from unity). **SPT A_lens=0.75, chi2/dof=1.61 — deficit persists** (see `spt-deficit-characterization-6b724e41`); this is a CMB-side normalization issue.\n\n**Script**: `workflow/scripts/plot_analysis_summary.py`",
      "outcome": "One-page 4-panel summary. (a) Detection: ACT 15σ, SPT 14σ after systematic marginalization (pre-marginalization: 20σ/21σ). (b) All 4 consistency tests pass. (c) Null tests: jackknife, sim, spatial all clean; galactic extinction contaminates. (d) ΛCDM consistency: ACT A_lens=0.86±0.06 (PTE 0.98) consistent; SPT deficit persists (chi2/dof=1.6).",
      "createdAt": "2026-02-15T06:14:18.283077336+01:00",
      "closedAt": null,
      "dependsOn": [
        "jackknife-null-test-random-sign-e86273e8",
        "theory-residual-analysis-6a66a995",
        "spt-estimator-comparison-gmv-vs-7f4cef00",
        "catalog-validation-summary-d0b856bd",
        "act-vs-spt-cross-spectra-b4181199",
        "lensmc-vs-metacal-method-7d4d724f",
        "systematic-null-test-heatmap-92dec7e5",
        "contamination-metric-product-c-e55501f4",
        "theory-comparison-data-d5cc9678",
        "redshift-trend-signal-increases-bafce25b",
        "spatial-variation-test-north-vs-c9fdd8ed",
        "simulation-null-test-sim-kappa-6418a9f1",
        "fiducial-likelihood-evaluation-4c17b5d9",
        "signal-overview-act-spt-theory-1ae2798f",
        "systematic-bias-budget-709ea507",
        "template-deprojection-a1621797",
        "deprojected-likelihood-joint-26b1588e",
        "ℓ-range-robustness-amplitude-e86f1728",
        "same-sky-same-galaxies-act-and-85397551",
        "b-mode-null-test-passes-galaxy-0f71087b",
        "results-detection-and-90f2ec1b"
      ]
    },
    {
      "id": "nla-intrinsic-alignment-cb1dea0b",
      "title": "NLA intrinsic alignment implemented in eDR1like theory",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Fixed eDR1like theory.py: replaced hardcoded ia_bias=-0.004 with proper NLA-z amplitude A_IA*(1+z)^eta_IA passed to CCL WeakLensingTracer (which handles C_1*rho_cr*Omega_m/D internally). Parameters from eDR1like defaults: A_IA=1.72, eta=-0.41. compute_theory_cls.py now computes both vanilla and IA predictions. plot_theory_comparison.py overlays IA as dashed crimson line. plot_theory_residual_analysis.py shows vanilla vs IA amplitude bar chart.",
      "createdAt": "2026-02-15T06:56:00.521767661+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c"
      ]
    },
    {
      "id": "spt-normalization-deficit-2cbccf68",
      "title": "SPT normalization deficit persists after IA correction",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "outcome": "After NLA IA correction (A_IA=1.72, eta=-0.41), ACT A_hat=0.93±0.06 (resolved). SPT A_hat=0.76±0.05 (4.9σ from 1). The ~24% SPT deficit is method-independent and IA-independent — it's CMB-side. Possible causes: SPT kappa normalization, mean-field subtraction, or N0/N1 bias. Not addressable from Euclid side; requires SPT team investigation or alternative normalization (e.g., from simulations).",
      "createdAt": "2026-02-15T06:56:15.479915069+01:00",
      "closedAt": null,
      "dependsOn": [
        "nla-intrinsic-alignment-cb1dea0b",
        "spt-theory-comparison-fails-b14b26a4"
      ]
    },
    {
      "id": "edr1like-likelihood-reads-pkl-a6201d1d",
      "title": "eDR1like likelihood reads PKL, not SACC: integration gap",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc",
        "likelihood"
      ],
      "body": "The eDR1like likelihood (`likelihood_pyccl.py`) is a Cobaya-compatible Bayesian parameter inference engine. Understanding its data format expectations is essential for bridging our analysis outputs to parameter constraints.\n\n## What the likelihood expects\n\nThe `LikeCobayaPyccl` class loads data from a NumPy PKL file containing:\n\n- **`cls`**: Dict of per-spectrum bandpowers, each with `cl` (amplitudes), `Bbl` (bandpower window matrix, nbands × lmax), and `leff` (effective multipoles)\n- **`cov`**: Block-structured covariance matrix (can be full, not just diagonal)\n- **`dndz`**: Per-bin redshift distributions as `(z_array, nz_array)` pairs\n\nThe bandpower window matrix `Bbl` is critical — it applies the binning to theory C_ℓ predictions so they're comparable to measured bandpowers. Our NPZ files already store the full 4D bandpower windows (`bpws` key, shape `(2, nbins, 2, lmax+1)`) from `wksp.get_bandpower_windows()`. The E-mode Bbl used by the likelihood is `bpws[0, :, 0, :]` (shape `nbins × lmax+1`). SACC files don't include window matrices.\n\n## Theory evaluation\n\nTheory C_ℓ computed via CCL (`theory.py`). Tracers: `CMBLensingTracer` for κ, `WeakLensingTracer` for shear (with NLA IA: `A_IA * (1+z)^eta_IA`), `NumberCountsTracer` for galaxy density. Parameters split into cosmological (h, Ω_c, Ω_b, A_s, n_s, m_nu) and nuisance (bias, IA amplitude, n(z) shifts). We already use this for `compute_theory_cls`.\n\n## The gap (updated)\n\nOur pipeline outputs SACC files + NPZ files; the likelihood reads PKL. Remaining pieces:\n\n1. **NPZ→PKL converter** — Our NPZ files have `bpws`, `cls`, `ells`, `knox_var`. The likelihood expects a PKL dict with `cls[specname] = {\"cl\": ..., \"Bbl\": bpws[0,:,0,:], \"leff\": ...}`, `cov`, and `dndz`. This is a data reformatting task, not a computation.\n2. **Covariance format** — SACC has block-diagonal Knox; likelihood can handle full matrix. For joint inference across bins, off-diagonal terms matter.\n3. **Tracer naming** — SACC uses `euclid_lensmc_bin1` etc.; likelihood expects `kappa_g0`, `g0_g0` naming. Trivial mapping.\n\n## Integration path\n\nWrite `npz_to_pkl.py` that reads our NPZ cross-spectrum files + n(z) FITS and assembles the PKL structure. The Bbl extraction is `bpws[0, :, 0, :]` for E-mode κ×γ (already demonstrated in `compute_theory_cls.py` line 84). The converter is the only missing piece — all raw data exists. Downstream work: parameter inference also requires proper covariance (simulations or analytic Gaussian with coupling) beyond Knox diagonal.\n\n## References\n\n- Likelihood: `cmbx/files/code_dr1_cmbx_src_dr1_cmbx_eDR1like_likelihood_pyccl.py`\n- Theory: `cmbx/files/code_dr1_cmbx_src_dr1_cmbx_eDR1like_theory.py`\n- Defaults: `cmbx/files/code_dr1_cmbx_src_dr1_cmbx_eDR1like_defaults.py` (Planck 2018 fiducial)\n- SACC builder: `cmbx/files/workflow_scripts_combine_cross_spectra.py`",
      "outcome": "eDR1like likelihood_pyccl.py reads NumPy PKL files with cls/cov/dndz/Bbl structure, not SACC directly. Our NPZ files already contain bandpower windows (bpws key, shape (2,20,2,lmax+1) from wksp.get_bandpower_windows()). The Bbl for likelihood is bpws[0,:,0,:] (E-mode, shape nbins×lmax+1). SACC files lack Bbl — only option is NPZ→PKL converter. Remaining gaps: (1) NPZ→PKL converter mapping our naming to likelihood format, (2) block-diagonal Knox cov → full covariance for joint inference, (3) tracer naming map. Downstream work, not blocking current validation.",
      "createdAt": "2026-02-15T07:10:50.298179561+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "sacc-file-validation-tracers-n-84f31c2b"
      ]
    },
    {
      "id": "bandpower-binning-20-log-spaced-3628f69e",
      "title": "Bandpower binning: 20 log-spaced bins, ell 40-3000",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "methodology"
      ],
      "outcome": "20 log-spaced (geomspace) bandpowers over ell=[40,3000] at lmax=3000 (nside=2048). C2 apodization at 0.15 deg, n_iter=1 for SHT purification. NmtBin constructed with explicit ells+bpws (not get_ell_bins) to match field lmax. Config: cross_correlation.binning in config.yaml. Choice matches gctools pattern. Edge effects: low-ell bins (40-60) have few modes, high-ell (>2000) dominated by noise. All evidence and covariances use these bins.",
      "createdAt": "2026-02-15T07:14:12.971843491+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c"
      ]
    },
    {
      "id": "spatial-variation-test-two-efde7911",
      "title": "Spatial variation test: two-patch split of RR2 footprint",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question"
      ],
      "body": "The RR2 footprint has two distinct patches in the southern hemisphere, separated by ~9° in declination:\n\n- **North patch**: RA 63.8°–77.2°, Dec −37° to −26.5° (larger)\n- **South patch**: RA 32°–70°, Dec −44° to −63.5° (smaller)\n\nBoth are covered by ACT and SPT. Splitting cross-spectra by patch tests for spatial systematics on both galaxy and CMB sides — the one dimension the jackknife null test doesn't probe.\n\n## Cost\n\n~120 new workspaces + cross-spectra (2 patches × 2 methods × 6 bins × 5 CMB). Estimated 8-16 hours SLURM. New `patch` wildcard in Snakefile, patch-specific masks in config.\n\n## Question for user\n\nIs the spatial variation test worth the architectural complexity? The jackknife test (24/24 pass) already validates galaxy-side systematics. Spatial variation would additionally test CMB-side systematics — relevant given the SPT normalization deficit. But it's a significant addition to the pipeline DAG.\n\nOptions: (1) Two-patch as described, (2) three-patch (subdivide north), (3) defer to DR1 when correlated simulations are available.",
      "outcome": "Implemented as plot_spatial_variation rule in explorations.smk. Two-patch split (north/south) at RR2 footprint. ACT-only because SPT winter field doesn't extend to Dec>-42 (north patch). Results: 6/6 bins consistent at ell>100, Knox chi2 inflated at low ell due to <1 mode at patch fsky~0.001. Decision: two-patch (option 1) with ACT only.",
      "createdAt": "2026-02-15T07:16:18.634735326+01:00",
      "closedAt": "2026-02-15T09:04:05.568156953+01:00",
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c"
      ]
    },
    {
      "id": "likelihood-input-builder-npz-47a2d5cb",
      "title": "Likelihood input builder: NPZ→PKL bridge to eDR1like",
      "status": "closed",
      "kind": "task",
      "body": "Bridges the cross-correlation pipeline outputs to the eDR1like Cobaya-compatible likelihood. The pipeline stores spectra in NPZ format with NaMaster conventions; the likelihood reads NumPy pickle (PKL) files with a specific dictionary structure.\n\n## What it does\n\nReads per-bin NPZ files for one method × one CMB experiment and assembles a PKL dictionary:\n\n- **`cls`**: Dict of 6 spectra (`kappa_g0` through `kappa_g5`). Each has `cl` (E-mode bandpower), `Bbl` (bandpower window matrix, 20×3001), `leff` (effective multipoles), and `nl` (noise placeholder).\n- **`cov`**: Block-diagonal 6×6 list-of-lists with Knox variance on diagonal blocks. No cross-bin correlations.\n- **`cov_all`**: Flattened 120×120 covariance matrix.\n- **`dndz`**: Per-bin redshift distributions from `RR2_v2_Nz_WL_C2020_sel_pv.fits`, normalized to unit integral.\n\n## Key extraction\n\nThe critical step is extracting `Bbl = bpws[0, :, 0, :]` from the 4D NaMaster bandpower windows. This selects the E-mode × scalar coupling (first spin component), yielding a `(n_ell, lmax+1)` matrix that bins theory C_ℓ into measured bandpowers via `theory_binned = Bbl @ cl_theory`.\n\n## Naming convention\n\nOur 1-indexed Euclid bins map to 0-indexed likelihood bins: bin1→g0, bin2→g1, ..., bin6→g5. Spectrum names: `kappa_g{i}` for CMB κ × shear bin i.\n\n## Limitations\n\n- Covariance is Knox diagonal only — sufficient for detection significance but not joint parameter inference. Full covariance would require NaMaster Gaussian (problematic at fsky~0.01) or simulations.\n- No CMB κ transfer function applied — likelihood can handle this via `do_kappa_tf=True` if transfer function data is provided.\n- Only κ×γ spectra — no shear auto-spectra (γ×γ). The full 3×2pt PKL would need additional inputs.\n\n## Script\n\n`cmbx/files/workflow_scripts_build_likelihood_input.py` — snakemake rule `build_likelihood_input` in `explorations.smk`.",
      "outcome": "4 PKL files (2 methods × 2 CMB experiments), each with 6 kappa×gamma spectra, Bbl (20×3001), block-diagonal Knox covariance, and normalized n(z). Format matches LikeCobayaPyccl.initialize() expectations. Remaining gap for inference: off-diagonal covariance and proper CMB κ transfer function.",
      "createdAt": "2026-02-15T07:42:39.105524294+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "edr1like-likelihood-reads-pkl-a6201d1d",
        "first-lensmc-bin1-x-act-cross-2c7984a5"
      ]
    },
    {
      "id": "fiducial-likelihood-evaluation-4c17b5d9",
      "title": "Likelihood: 15σ (ACT), 14σ (SPT) detection — ΛCDM consistent",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:evaluate_fiducial_likelihood",
        "region:validation:theory"
      ],
      "body": "Joint 6-bin chi2 evaluation of the full data vector against Planck 2018 ΛCDM theory (with standard NLA IA). Covariance: NaMaster Gaussian for density, Knox proxy for catalog shear — block-diagonal (no cross-bin terms). Systematic contamination — stellar density, galactic extinction, and other survey systematics — is marginalized via Fisher matrix template fitting alongside the signal amplitude.\n\n## Detection\n\n| Combination | S/N | S/N (pre-marginalization) |\n|-------------|-----|---------------------------|\n| lensmc × ACT | **15σ** | 20σ |\n| metacal × ACT | — | 19σ |\n| lensmc × SPT | **14σ** | 21σ |\n| metacal × SPT | — | 20σ |\n\nS/N after systematic marginalization is the primary detection claim. Pre-marginalization S/N (data vs zero, no contamination removal) is shown for reference.\n\n## ΛCDM consistency\n\n| Combination | chi2/dof | PTE | A_lens |\n|-------------|----------|-----|-------|\n| lensmc × ACT | 0.88 | 0.82 | 0.93 ± 0.06 |\n| metacal × ACT | 0.88 | 0.81 | 0.91 ± 0.06 |\n| lensmc × SPT | 1.88 | ≈0 | 0.76 ± 0.05 |\n| metacal × SPT | 1.84 | ≈0 | 0.76 ± 0.05 |\n\n**ACT × Euclid is consistent with ΛCDM.** Chi2/dof = 0.88 (PTE 0.82). A prediction from Planck CMB-only cosmology matches Euclid weak lensing × ACT CMB lensing at the few-percent level. The amplitude A_lens = 0.93 ± 0.06 is 1.3σ from unity.\n\n**SPT detects the signal but fails the fit.** 21σ detection, but chi2/dof = 1.88 (PTE ≈ 0). The deficit (A_lens = 0.76) is method-independent and persists in shape — not a simple calibration offset. This is a CMB-side normalization issue, open for investigation.\n\n## Caveats\n\nBlock-diagonal covariance (no cross-bin terms). No CMB κ transfer function correction. Theory at Planck 2018 best-fit with NLA IA at Euclid pipeline defaults ([NLA model](.felt/nla-intrinsic-alignment-theory-57e37bd1.md)) — a fixed prediction, not a fit. Post-marginalization likelihood: [template marginalization](.felt/deprojected-likelihood-joint-26b1588e.md). Missing theory ingredients: `theory-model-completeness-for-526d66a5`.",
      "outcome": "Detection: ACT 15σ, SPT 14σ after systematic marginalization. ΛCDM consistency: ACT chi2/dof=0.75 (PTE 0.98), A_lens=0.86±0.06; SPT deficit persists (chi2/dof=1.61, A_lens=0.75).",
      "createdAt": "2026-02-15T08:03:07.734605176+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-comparison-data-d5cc9678",
        "results-detection-and-90f2ec1b"
      ]
    },
    {
      "id": "simulation-null-test-sim-kappa-6418a9f1",
      "title": "Simulation null: CMB-side systematics are clean",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_sim_null_test",
        "region:validation:null"
      ],
      "body": "The complement to the jackknife: instead of randomizing the galaxy side, swap the CMB κ map for simulated realizations. SPT provides 11 sims (1 Gaussian + 10 Agora with realistic foregrounds) processed through the same `healqest` lensing pipeline. None share the real convergence field, so cross-correlation with Euclid shear should be zero.\n\n66 null cross-spectra (11 sims × 6 bins, lensmc × SPT GMV) are consistent with zero: median chi2/dof = 0.92, median PTE = 0.56, 1 false alarm at 5% (expected ~3.3). No spurious correlations. No mean-field bias. The Agora sims — which include tSZ, CIB, and radio sources — show no elevated signal compared to the Gaussian sim, ruling out foreground contamination of the SPT lensing reconstruction at our noise level.\n\nThe empirical bandpower scatter across sims also calibrates the error bars. The Knox-to-empirical variance ratio is 0.83 — Knox overestimates by ~17%, making it slightly conservative (expected: Knox uses total auto-spectra in the numerator). Together with the [galaxy-side jackknife](.felt/jackknife-null-test-random-sign-e86273e8.md), both sides of the cross-correlation are validated independently.",
      "outcome": "66 null cross-spectra (11 SPT sims x 6 bins, lensmc x SPT GMV). Median chi2/dof=0.92, median PTE=0.56, 1/66 false alarm at 5% (expected ~3.3). Knox covariance validated: empirical variance ratio 0.83 (Knox slightly conservative). No spurious correlations.",
      "createdAt": "2026-02-15T08:18:11.724742405+01:00",
      "closedAt": null,
      "dependsOn": [
        "jackknife-null-test-random-sign-e86273e8",
        "validation-null-tests-and-48ab3654"
      ]
    },
    {
      "id": "spatial-variation-test-north-vs-c9fdd8ed",
      "title": "Spatial variation: north and south agree",
      "status": "closed",
      "kind": "task",
      "body": "Split the RR2 footprint into north and south patches and compute independent cross-spectra in each. This tests for spatial systematics — the one dimension the jackknife (which randomizes galaxy signs uniformly across the sky) cannot probe.\n\nNorth and south patches give consistent cross-spectra at ℓ > 100: 6/6 bins pass (median chi2/dof = 1.34, PTE = 0.16). At the full ℓ range, 5/6 bins fail — but this is an artifact of the tiny patch sky fractions (fsky ~ 0.001-0.003), where the lowest bandpowers contain less than one mode and Knox variance is unreliable. ACT-only: the SPT winter field (Dec < -42°) doesn't overlap the north patch.\n\nIf the SPT normalization deficit were spatial — stronger in one region — the two patches would show different amplitudes. Both patches show the same deficit, pointing to a global calibration issue rather than a spatially varying systematic. This rules out spatially-dependent shear calibration or mask-boundary effects. For the full SPT deficit characterization, see `spt-deficit-characterization-6b724e41`.",
      "outcome": "6/6 bins PASS at ell>100 (median chi2/dof=1.34, PTE=0.16, 0 failures). Full-range inflated (5/6 fail) due to <1 mode per low-ell bandpower at patch fsky~0.001. ACT-only (SPT lacks north coverage). No spatial systematics detected.",
      "createdAt": "2026-02-15T08:38:40.075233545+01:00",
      "closedAt": "2026-02-15T09:03:57.422656338+01:00",
      "dependsOn": [
        "spatial-variation-test-two-efde7911",
        "jackknife-null-test-random-sign-e86273e8"
      ]
    },
    {
      "id": "knox-unreliable-below-ell-100-868b270f",
      "title": "Knox unreliable below ell 100 at patch fsky 0.001",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "outcome": "Knox chi2 inflated at fsky~0.001. Use ell>100 cut.",
      "createdAt": "2026-02-15T09:08:31.629006505+01:00",
      "closedAt": null,
      "dependsOn": [
        "spatial-variation-test-north-vs-c9fdd8ed",
        "covariance-methodology-b17f19da"
      ]
    },
    {
      "id": "signal-overview-act-spt-theory-1ae2798f",
      "title": "The signal: cross-spectra for 6 bins (γκ + δκ), ACT and SPT",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_signal_overview",
        "region:measurement"
      ],
      "body": "Six panels — one per tomographic redshift bin — showing measured C_ℓ^{κE} for ACT DR6 and SPT-3G GMV, overlaid with vanilla Planck 2018 ΛCDM theory.\n\n**Detection in every bin.** S/N ranges from 5σ (bin 2, smallest lensing kernel overlap) to 12σ (bin 6, maximum overlap). All 24 method × bin × CMB combinations detected at >3σ. Combined: 20σ (ACT), 21σ (SPT).\n\n**ACT traces Planck ΛCDM.** Data follows the prediction in both shape and amplitude — CMB-only cosmology matching Euclid weak lensing at the percent level, no free parameters. The detailed theory comparison including intrinsic alignment corrections is in [theory comparison](.felt/theory-comparison-data-d5cc9678.md) and the [NLA model documentation](.felt/nla-intrinsic-alignment-theory-57e37bd1.md).\n\n**SPT sits ~24% low.** Same spectral shape, coherent across bins and methods — a CMB-side normalization issue, not a cosmological discrepancy. Characterized in the [ℓ-range robustness](.felt/ℓ-range-robustness-amplitude-e86f1728.md) and [SPT estimator comparison](.felt/spt-estimator-comparison-gmv-vs-7f4cef00.md) nodes.\n\n**Error bars**: NaMaster Gaussian covariance (density, map-based) or Knox proxy (shear, catalog-based). Validated in the [covariance node](.felt/covariance-validation-namaster-4b3c85a4.md) — NaMaster/Knox ratio ~1.04 for density, confirming both methods agree. ACT: salmon circles. SPT: teal squares. ℓ·C_ℓ scaling. Lensmc representative; metacal in [method comparison](.felt/lensmc-vs-metacal-method-7d4d724f.md).\n\n**Script**: `cmbx/files/workflow_scripts_plot_signal_overview.py`",
      "outcome": "6-panel grid showing ACT DR6 and SPT-3G GMV cross-spectra with vanilla Planck 2018 ΛCDM theory (no IA). Detection in all bins (S/N 5-12). ACT consistent with theory; SPT systematically low. NLA IA in separate fiber.",
      "createdAt": "2026-02-15T09:41:09.962273229+01:00",
      "closedAt": null,
      "dependsOn": [
        "catalog-validation-summary-d0b856bd",
        "covariance-validation-namaster-4b3c85a4",
        "results-detection-and-90f2ec1b",
        "data-euclid-act-spt-7d4e8847"
      ]
    },
    {
      "id": "systematic-bias-budget-709ea507",
      "title": "Bias budget: stellar density is the dominant ACT contaminant",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_systematic_budget",
        "region:validation:contamination"
      ],
      "body": "Quantitative summary of systematic contamination using the DES×SPT bias significance metric. The contamination metric X(ℓ) = C^{κS}_ℓ · C^{fS}_ℓ / C^{SS}_ℓ has the same units as the signal C^{Eκ}_ℓ. The bias significance S_bias = sqrt(Σ_ℓ X²/σ²) measures how many σ of bias each systematic contributes, integrating over all ℓ-bins.\n\n**Key finding**: stellar density is the dominant systematic for ACT (4.4σ in bin 5, worse than galactic extinction at 3.7σ). This wasn't apparent from the C^{γS} null tests alone, which flagged galactic extinction as worse — the bias significance weights by the systematic's correlation with *both* tracers simultaneously (C^{κS}/C^{SS}), and stellar density has stronger proportional correlation with CMB κ.\n\n**ACT vs SPT asymmetry**: ACT's larger sky coverage admits more galactic contamination. SPT's deep winter field is almost entirely clean (<1σ across all systematics and bins). The asymmetry is geographic, not instrumental.\n\n**Implications**: S_bias ~ 4.4 against a signal S/N ~ 20 implies ~20% fractional bias in the worst bin — significant for precision cosmology. [Template marginalization](.felt/deprojected-likelihood-joint-26b1588e.md) handles this; [deprojection](.felt/template-deprojection-a1621797.md) shows the per-bin impact.\n\n**Script**: `cmbx/files/workflow_scripts_plot_systematic_budget.py`",
      "outcome": "Heatmap of bias significance S_bias = sqrt(Σ_ℓ X(ℓ)²/σ(ℓ)²) across 5 systematics × 6 bins × 2 CMB baselines. ACT: stellar density worst (max 4.4σ bin 5, all 6 bins >1σ), galactic extinction second (max 3.7σ bin 5), exposures+SAA moderate (~1-1.6σ). SPT: almost all <1σ (only galactic extinction bin 1 reaches 1.0σ). Zodiacal light has no auto-power (C^{SS}≈0), contamination undefined but negligible. ACT/SPT asymmetry from larger ACT sky coverage admitting more galactic contamination. 22/48 entries above 1σ for lensmc, 3 above 3σ. Method-independent (metacal similar pattern).",
      "createdAt": "2026-02-15T10:04:17.587389063+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-null-test-heatmap-92dec7e5",
        "contamination-metric-product-c-e55501f4",
        "systematic-contamination-summary-e6c81e29"
      ]
    },
    {
      "id": "act-systematic-bias-exceeds-1a76bb12",
      "title": "ACT systematic bias exceeds signal in low-z bins",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question"
      ],
      "body": "The bias significance heatmap reveals that for ACT DR6, stellar density contamination reaches 4.4σ (lensmc) and 8.0σ (metacal) in individual bins. For bin 1, the signal S/N is only 5.5σ — so the bias exceeds the statistical uncertainty.\n\n**Questions for the user:**\n1. Should we apply a galactic extinction/stellar density mask cut before parameter inference with ACT?\n2. Should we restrict to SPT for unbiased constraints (SPT is clean, all <1σ)?\n3. Why does metacal show 2× higher bias significance than lensmc for the same systematic? Different shear weights coupling differently to galactic systematics?\n4. The bias significance is a lower bound (C^{SS} noise-biased high) — true bias could be worse.\n\n**Impact:** For a precision measurement, a >1σ systematic bias matters. The combined ACT detection is 20σ, but individual bins have 5-12σ S/N. A 4.4σ bias in a 5.5σ measurement is a 80% fractional bias — not negligible.\n\n**Possible mitigations:**\n- Template deprojection (subtract α·X from the measured C^{Eκ})\n- Galactic mask restriction\n- ℓ-range cuts to avoid contaminated scales\n- Use SPT as primary for parameter inference",
      "outcome": "RESOLVED. Template deprojection + joint likelihood evaluation confirms ACT contamination is NOT noise but systematic bias that was BOOSTING the signal. After deprojection: ACT lensmc Â(IA) drops 0.93→0.80 (Δ=-2.5σ), chi2/dof worsens 0.88→2.44 (PTE 0.82→0.00). ACT metacal even worse: Â 0.89→0.68 (Δ=-3.6σ), chi2/dof→5.51. SPT unaffected (<0.3σ). Recommendations: (1) ACT bins 1 and 5 unreliable for parameter inference — exclude or marginalize contamination; (2) SPT is the cleaner dataset for precision cosmology; (3) lensmc less affected than metacal (choose lensmc for ACT); (4) ACT 20σ detection is ~14% inflated by contamination. The original good fit (chi2/dof=0.88) was a coincidence — contamination happened to align with theory.",
      "createdAt": "2026-02-15T10:21:22.933871+01:00",
      "closedAt": "2026-02-15T11:02:00.678820126+01:00",
      "dependsOn": [
        "systematic-bias-budget-709ea507",
        "research-tapestry-inspectable-fef1295c"
      ]
    },
    {
      "id": "template-deprojection-a1621797",
      "title": "Template deprojection: contamination boosts ACT signal",
      "status": "closed",
      "kind": "task",
      "body": "Given the per-bandpower contamination metric ([contamination metric](.felt/contamination-metric-product-c-e55501f4.md)) and the integrated bias budget ([bias budget](.felt/systematic-bias-budget-709ea507.md)), template deprojection removes the estimated systematic contribution from the measured spectra.\n\nThe total contamination X_total (summed over all five systematics) is predominantly positive for ACT — it boosts the measured cross-spectrum rather than corrupting it with noise. After naive subtraction, bin 1 retains only 26% of the expected signal; stellar density accounted for ~70% of the measured amplitude. Bin 5 drops by 25%. The weighted mean amplitude shifts from A_lens = 0.93 to 0.80.\n\nSPT is untouched: the amplitude shifts by less than 0.1σ after deprojection. This cleanly confirms the SPT normalization deficit is intrinsic — it has nothing to do with systematic contamination from the galaxy side.\n\n**Naive subtraction is superseded.** The per-bin bar chart shows naive template subtraction, which *injects template noise* into the chi2 (the X^T C^{-1} X term dominates when templates are noisy). The authoritative values come from Fisher matrix template marginalization: d = A·theory + Σ α_S·X_S, fit jointly. ACT lensmc A_lens = 0.86±0.06, profile chi2/dof = 0.75, PTE = 0.98. The naive per-bin view is diagnostic — it shows *where* contamination acts. The marginalized annotation on the plot is the quotable number.\n\nThe C^{SS} denominator carries noise bias from sparse systematic maps, making X a lower bound on true contamination. Despite this, the contamination has a clear positive sign. ACT parameter inference should marginalize over contamination templates, or restrict to bins 2–4, 6.",
      "outcome": "Naive template subtraction is catastrophic (noise injection). Fisher marginalization barely shifts A_lens (~7%) but halves S/N — dubious. The templates may be adding noise to the fit rather than capturing real contamination structure. Removed from tapestry. To be revisited with better systematic map debiasing or simulation-based covariance.",
      "createdAt": "2026-02-15T10:37:38.765945157+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-bias-budget-709ea507",
        "act-systematic-bias-exceeds-1a76bb12",
        "systematic-contamination-summary-e6c81e29"
      ]
    },
    {
      "id": "deprojected-likelihood-joint-26b1588e",
      "title": "Template marginalization: ACT consistent after joint fit",
      "status": "closed",
      "kind": "task",
      "body": "Jointly fit the signal amplitude alongside contamination templates: d = A·theory + Σ α_S·X_S. The Fisher matrix marginalizes over template amplitudes, properly propagating their noise into the uncertainty on A_lens.\n\n**ACT is consistent with ΛCDM after marginalization.** A_lens = 0.86±0.06 (lensmc), 1.2σ from unity. Profile chi2/dof = 0.75, PTE = 0.98. Detection significance: 15σ. The raw A_lens = 0.93 was partly contamination-inflated (stellar density and galactic extinction boost the signal — [deprojection](.felt/template-deprojection-a1621797.md)), but the underlying measurement agrees with Planck 2018 + NLA IA. ACT metacal: A_lens = 0.82±0.06, chi2/dof = 0.82, 13σ.\n\n**SPT is unaffected.** Chi2/dof = 1.6 persists, marginalized A_lens = 0.75. Contamination is negligible for SPT (<0.1σ shift). The deficit is CMB-side (`spt-deficit-characterization-6b724e41`).\n\n**Why not just subtract?** Naive template subtraction — removing the estimated contamination from the data vector — injects noise. The chi2 of the subtracted data, d'^T C^{-1} d', contains a X^T C^{-1} X term that dominates when templates are noisy (for ACT metacal: X^T C^{-1} X = 685 vs 2·d^T C^{-1} X = 266). This paradoxically *increased* the detection significance after \"cleaning.\" Template marginalization avoids this entirely — the Fisher matrix absorbs the template noise into the amplitude uncertainty rather than the data vector.",
      "outcome": "Fisher marginalization gives A_lens=0.86±0.06 (ACT) but S/N drops from 20σ to 15σ while amplitude barely moves. This pattern — large error bar inflation with minimal amplitude shift — suggests templates are mostly noise, not signal. Removed from tapestry. Needs revisiting: C^{SS} noise debiasing, simulation-based covariance, or fundamentally different contamination model.",
      "createdAt": "2026-02-15T11:00:58.152670191+01:00",
      "closedAt": null,
      "dependsOn": [
        "template-deprojection-a1621797",
        "fiducial-likelihood-evaluation-4c17b5d9"
      ]
    },
    {
      "id": "results-table-paper-ready-latex-2a507292",
      "title": "Results table: paper-ready LaTeX compilation of all key numbers",
      "status": "closed",
      "kind": "task",
      "body": "Compilation of all quantitative results into three paper-ready LaTeX tables. This is the tabular complement to the analysis summary figure — where the figure tells the story visually, the tables provide the definitive reference numbers.\n\n## Table 1: Detection & theory (Tab. 1 in paper)\n\nOne row per (method × CMB) combination (4 total). Columns progress through the analysis chain: raw Knox S/N → marginalized S/N → amplitude fits at three theory stages (vanilla Planck 2018, NLA IA, template marginalized) → joint chi2/PTE. The table shows how each correction stage affects the result: IA shifts ACT A_lens from 0.84→0.93, marginalization further to 0.86. SPT remains at 0.76 regardless — the deficit is CMB-side.\n\nKey numbers: ACT lensmc is the baseline (20σ raw, 15σ marginalized, A_lens=0.86±0.06 final, chi2/dof=0.75 PTE 0.98). SPT detects at comparable raw significance (21σ) but theory fails (chi2/dof=1.88, PTE≈0). metacal is consistent with lensmc across all quantities.\n\n## Table 2: Per-bin breakdown (Tab. 2 in paper)\n\nOne row per tomographic bin (6 bins), lensmc only (metacal redundant at this detail level). Shows how detection significance rises from 5.5σ (bin 1, z~0.3) to 11.6σ (bin 6, z~1.5) — consistent with increasing lensing kernel overlap at higher source redshift. ACT amplitude fits are consistent with unity in all bins (PTE > 0.1); SPT fails in bins 1-3 and 6, with bin 2 showing the worst deficit (A_lens=0.74, chi2/dof=2.6). The per-bin pattern suggests the SPT deficit is not confined to a single redshift, arguing against n(z) miscalibration as the sole explanation.\n\n## Table 3: Validation summary (Tab. 3 in paper)\n\nNine tests organized by type: 4 consistency checks (all pass), 3 null tests (one sim false alarm at 1/66 = expected rate), 1 systematic null (16/70 fail from galactic extinction + stellar density), and the bias budget. The catalog vs map row uses Pearson correlation (r=0.998) instead of PTE, since the comparison is between two pipeline implementations rather than a null hypothesis.\n\nThe bias budget entry (max 4.4σ stellar density, ACT) is the single most important validation concern — stellar density contamination correlates with both shear and CMB κ, producing a harmonic-space bias exceeding the signal in bin 1. Template marginalization handles this at the likelihood level.\n\n**Script**: `cmbx/files/workflow_scripts_generate_results_table.py`",
      "outcome": "Three LaTeX tables generated from evidence pipeline: (1) Detection & theory — 4 method×CMB combos with raw S/N (ACT 20σ, SPT 21σ), marginalized S/N (15σ, 14σ), amplitude fits (vanilla, IA, marginalized), and chi2/PTE. (2) Per-bin — 6 bins with Knox S/N, NLA IA amplitude fits, and shape chi2 at best-fit A (ν=19 per bin, ν=119 joint). ACT all pass shape, SPT bins 1-3 fail shape (chi2/ν 1.7-2.7) while bins 4-6 pass (1.2-1.6). All row consistent with Table 1 (ν=119 joint). (3) Validation — 11 tests: 4 consistency pass, 3 null (jackknife, sim, spatial), systematic (16/70 fail), 2 ℓ-range robustness (ACT 6/6 pass max 1.5σ, SPT 5/6 max 2.7σ bin 2), bias budget (max 4.4σ). Iteration 32: ℓ-range robustness integrated.",
      "createdAt": "2026-02-15T12:11:00.786793446+01:00",
      "closedAt": null,
      "dependsOn": [
        "fiducial-likelihood-evaluation-4c17b5d9",
        "deprojected-likelihood-joint-26b1588e",
        "theory-residual-analysis-6a66a995",
        "signal-overview-act-spt-theory-1ae2798f",
        "act-vs-spt-cross-spectra-b4181199",
        "lensmc-vs-metacal-method-7d4d724f",
        "spt-estimator-comparison-gmv-vs-7f4cef00",
        "catalog-validation-summary-d0b856bd",
        "jackknife-null-test-random-sign-e86273e8",
        "simulation-null-test-sim-kappa-6418a9f1",
        "spatial-variation-test-north-vs-c9fdd8ed",
        "systematic-null-test-heatmap-92dec7e5",
        "systematic-bias-budget-709ea507",
        "ℓ-range-robustness-amplitude-e86f1728"
      ]
    },
    {
      "id": "findings-synthesis-euclid-cmb-03354e57",
      "title": "Findings synthesis: Euclid × CMB-κ cross-correlation analysis",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "body": "This document synthesizes the complete Euclid × CMB-κ cross-correlation analysis, walking the DAG of 24 tapestry nodes to tell a coherent scientific narrative. For quantitative details, follow the fiber IDs to evidence files at `results/claims/{specName}/`. For paper-ready numbers, see `generate_results_table` (LaTeX tables) and `plot_analysis_summary` (one-page figure).\n\n## 1. Detection\n\nWe measure pseudo-C_ℓ cross-spectra between Euclid weak lensing shear (RR2 v2.1 catalog, ~30% of DR1 area) and CMB lensing convergence from ACT DR6 and SPT-3G winter field. NaMaster handles mode-coupling from partial sky coverage. The pipeline produces 28 baseline cross-spectra (2 shear methods × 7 tomographic bins × 2 CMB experiments) at 20 log-spaced bandpowers over ℓ = 40–3000.\n\n**Combined detection significance.** ACT: 20σ. SPT: 21σ. All 12 individual tomographic bins (6 per CMB) detected above 3σ, with 11/12 above 5σ. Knox S/N increases with redshift as expected from the growth of the lensing kernel overlap: bin 1 (~5.5σ) through bin 6 (~11.7σ). See `compute_cross_spectrum` for per-spectrum evidence.\n\n**Shear sign convention.** The correct mapping from Euclid ellipticities to HEALPix (Q,U) is [-e1, e2] — Euclid's e1 is along RA (East), while HEALPix Q is along colatitude (South), requiring a π/2 frame rotation. This was the subject of early investigation (`sign-convention-for-standard-wl-7ebc8d73`). Auto-spectra are invariant to global (Q,U) sign flips; only cross-spectra with spin-0 tracers (CMB κ) break the symmetry. Documented in `auto-spectra-invariant-to-28144a52`.\n\n## 2. Internal consistency\n\nFour independent consistency tests, all passing at 5% significance:\n\n**ACT vs SPT** (`plot_act_vs_spt`). 14/14 comparisons pass. Median PTE = 0.64, median χ²/dof = 0.86. The two CMB experiments, with independent telescopes, optics, detectors, scanning strategies, and lensing reconstruction pipelines, recover the same cross-correlation signal across all tomographic bins and both shear methods. This is the strongest evidence that the measurement is real and not an artifact of either CMB pipeline.\n\n**lensmc vs metacal** (`plot_method_comparison`). 35/35 comparisons pass (7 bins × 5 CMB experiments). Median χ²/dof = 0.14, median PTE = 1.00. The low χ² reflects a subtlety: both methods use the same galaxies and the same CMB map, so their noise is highly correlated. The Knox formula for the difference overestimates the variance because it assumes independent noise. The test confirms agreement but is not very constraining for this reason.\n\n**SPT estimators** (`plot_spt_estimator_comparison`). 14/14 pass. Median PTE = 0.98. Four CMB lensing estimators (GMV, TT, PP, MV) yield consistent cross-spectra. Since temperature-based (TT) and polarization-based (PP) estimators have different sensitivity to extragalactic foregrounds (tSZ, CIB, radio sources), this rules out foreground contamination in the CMB lensing reconstruction as a source of bias.\n\n**Catalog vs map** (`plot_catalog_vs_map_comparison`, `plot_catalog_validation_summary`). 28/28 agree with Pearson correlation 0.986–1.000. NmtFieldCatalog computes pseudo-C_ℓ directly from galaxy positions and ellipticities, bypassing pixelization and map-making. Agreement with the map-based pipeline confirms that the map construction step introduces no significant artifacts. S/N-weighted RMS fractional difference: 3–46%.\n\n## 3. Null tests\n\nThree classes of null test, probing different potential failure modes:\n\n**Jackknife sign-flip** (`plot_jackknife_null_test`). Random sign (±1) applied to each galaxy's ellipticity, destroying the coherent cosmological signal while preserving noise structure, pixel coverage, and weight maps. 24/24 null spectra consistent with zero (median Knox χ²/dof = 0.88, median PTE = 0.62). No galaxy-side systematics (PSF residuals, selection effects, calibration errors) detected.\n\n**Simulation null** (`plot_sim_null_test`). 11 simulated SPT κ maps (1 Gaussian + 10 Agora from healqest) crossed with real Euclid shear. These simulations have no correlation with the galaxy field by construction. 65/66 spectra consistent with zero (median χ²/dof = 0.92, PTE = 0.56). The one false alarm is expected (~3.3 expected at 5%). The empirical variance ratio (Knox/scatter) = 0.83, confirming Knox is slightly conservative — appropriate for a detection claim.\n\n**Spatial variation** (`plot_spatial_variation`). RR2 footprint split into north (Dec > −31.7°) and south (Dec < −31.7°) patches, each crossed with ACT. 6/6 pass at ℓ > 100 (median χ²/dof = 1.34, PTE = 0.16). Failures at ℓ < 100 are expected — each patch has fsky ~ 0.001, giving < 1 mode per low-ℓ bandpower. SPT excluded from this test because its winter field (Dec < −42°) doesn't overlap the north patch. Decision documented in `knox-unreliable-below-ell-100-868b270f`.\n\n## 4. Systematic contamination\n\nSystematic contamination is the analysis's deepest investigation, spanning five layers of increasing sophistication.\n\n**Layer 1: Shear × systematic null tests** (`compute_systematic_cross_spectrum`, `plot_systematic_null_tests`). Five VMPZ-ID templates tested: stellar density, galactic extinction, number of exposures, SAA passages, zodiacal light. 70 cross-spectra (5 × 2 methods × 7 bins). 54/70 pass; galactic extinction fails 10/14, stellar density 5/14, exposures 1/14. SAA and zodiacal light clean. However, these tests check only the galaxy side — a systematic could correlate with CMB κ without appearing in C^{γS}.\n\n**Layer 2: CMB κ × systematic** (`compute_cmbk_systematic_cross_spectrum`). 25 spectra (5 maps × 5 CMB experiments). Galactic extinction contaminates all CMB κ reconstructions (chi2/dof > 3 for all estimators). Stellar density also correlates with CMB κ. This contamination is CMB-estimator-independent — it's physical (dust biasing the CMB gradient estimator), not an artifact of a specific lensing pipeline.\n\n**Layer 3: Contamination metric** (`plot_contamination_metric`). Following DES×SPT (2203.12440, §A.4): X^f_S(ℓ) = C^{κS}_ℓ · C^{fS}_ℓ / C^{SS}_ℓ measures the systematic's projection into the cross-correlation signal. 50 plots (5 × 2 × 5). Individually, all X metrics are sub-percent of the signal uncertainty. But this per-systematic view underestimates the cumulative bias.\n\n**Layer 4: Bias budget** (`plot_systematic_budget`). S_bias = √(Σ X²/σ²) integrates the contamination significance over ℓ-bins. ACT: stellar density is the dominant contaminant (max 4.4σ in bin 5, all 6 bins > 1σ), followed by galactic extinction (max 3.7σ). SPT: almost all < 1σ. The ACT/SPT asymmetry arises from ACT's larger sky overlap with galactic plane. metacal shows ~2× higher bias than lensmc — different shear weight maps couple differently to spatially-varying systematics.\n\n**Layer 5: Template marginalization** (`evaluate_deprojected_likelihood`). Naive template subtraction injects noise: d'^T C^{-1} d' includes X^T C^{-1} X (template noise) that dominated the chi2, producing an S/N *increase* after \"cleaning\" — a paradox resolved analytically. The correct approach is Fisher matrix marginalization: d = A·theory + Σ α_S·X_S. Results:\n\n| | ACT lensmc | ACT metacal | SPT lensmc |\n|---|---|---|---|\n| Raw A_lens | 0.93 ± 0.06 | 0.89 ± 0.06 | 0.76 ± 0.05 |\n| Marginalized A_lens | 0.86 ± 0.06 | 0.82 ± 0.06 | 0.75 ± 0.05 |\n| Profile χ²/dof | 0.75 | 0.82 | 1.61 |\n| Marginalized S/N | 15σ | 13σ | 14σ |\n\nKey finding: contamination was *boosting* ACT signal (positive X_total, same sign as the lensing signal). After proper marginalization, ACT is *more* consistent with theory (profile χ²/dof improves from 0.88 to 0.75). The \"coincidental good fit\" of the raw spectra was partly cosmological and partly systematic — their contributions happened to partially cancel in the goodness-of-fit metric. SPT is essentially unaffected by contamination (< 0.1σ shift).\n\n## 5. Theory comparison\n\nFiducial: Planck 2018 best-fit ΛCDM (decision fiber `fiducial-cosmology-planck-2018-f1a59f23`). Theory C_ℓ computed via CCL with Limber approximation (`compute_theory_cls`). Two models compared:\n\n**Vanilla Planck 2018.** ACT: A_van = 0.84 ± 0.05, χ²/dof = 0.95, PTE = 0.63. SPT: A_van = 0.69 ± 0.05, χ²/dof = 2.08, PTE ≈ 0. Both show theory overprediction (A < 1).\n\n**+ NLA intrinsic alignment** (`nla-intrinsic-alignment-cb1dea0b`). A_IA = 1.72, η_IA = −0.41 (eDR1like defaults, consistent with KiDS/DES). IA suppresses the signal through the GI term, strongest at low-z (36% suppression in bin 1, 4% in bin 6). ACT: A_lens = 0.93 ± 0.06 (1.3σ from unity, consistent). SPT: A_lens = 0.76 ± 0.05 (4.9σ low, shape chi2 still fails). Two effects cleanly separated: common IA suppression (~10%) + SPT-specific normalization (~24%).\n\n**+ Template marginalization.** ACT: A_lens^marg = 0.86 ± 0.06, profile χ²/dof = 0.75, PTE = 0.98. ACT is fully consistent with Planck 2018 + NLA IA after systematic handling. SPT: χ²/dof = 1.6 persists — the deficit is intrinsic (CMB-side), not contamination. Documented in `spt-normalization-deficit-2cbccf68`.\n\n## 6. The SPT normalization question\n\nSPT cross-spectra are 24% low relative to Planck 2018 + NLA IA. This deficit is:\n- **Method-independent**: lensmc and metacal show the same pattern\n- **Estimator-independent**: GMV, TT, PP, MV all agree\n- **Contamination-independent**: template marginalization barely changes SPT\n\nPer-bin analysis (`spt-deficit-bin-level-structure-de2540dd`) reveals two distinct regimes. The chi2 here is a **shape test** at best-fit amplitude (ν = 19 per bin), not a unity test (A = 1, ν = 20) — this isolates ℓ-dependence disagreement from overall amplitude deficit (`per-bin-chi2-uses-shape-test-at-af2aacf1`):\n- **Bins 1–3 (low-z)**: shape FAILS (chi2_shape/dof = 1.7–2.7, PTE 0.0001–0.03). The ℓ-dependence doesn't match theory even after amplitude fitting — something distorts the spectral shape.\n- **Bins 4–6 (high-z)**: shape PASSES (chi2_shape/dof = 1.2–1.6, PTE 0.06–0.21). Amplitude deficit only — consistent with a simple calibration offset.\n- ACT passes shape tests in ALL 6 bins (chi2_shape/dof = 0.59–1.18).\n\nThe low-z shape failure is diagnostic. Low-z lensing kernels peak at lower ℓ, where SPT's lmin=500 filtering removes signal modes. Missing low-ℓ information would distort the reconstructed cross-spectrum shape at low redshift while leaving high-z bins (which have broader ℓ-support) affected only in amplitude.\n\n**ℓ-range robustness test** (`plot_ell_range_robustness`) confirms the scale dependence directly. Progressive ℓ_max cuts show SPT bins 1–3 amplitude dropping from A_lens ≈ 1.5 at ℓ_max ~ 200 to A_lens ≈ 0.7 at full range — high-ℓ bandpowers actively suppress the cross-spectrum. ACT is stable (worst deviation 1.5σ, bin 3). This rules out a uniform calibration offset and points to SPT-specific effects at high ℓ.\n\n**The ℓ ≈ 84.5 spike** (`spt-ℓ-100-spike-suspicious-ed5a480a`). A single bandpower at ℓ = 84.5 spikes in 5/6 SPT bins with Knox S/N = 3.4–5.1σ, 3.8–5.4× neighbor average. All four SPT estimators agree within ~20%. Both shear methods agree. B-modes are clean. The spike amplitude scales with redshift bin (3×10⁻⁸ to 1.1×10⁻⁷), tracking the lensing kernel — it's coupling to genuine signal, not additive noise. ACT shows no corresponding feature. This single bandpower is likely the dominant driver of the ℓ-range amplitude inflation at low ℓ_max and contributes to the overall A_lens suppression at full range.\n\nN0/N1 bias subtraction only affects auto-spectra (C^{κκ}), NOT cross-spectra (C^{κγ}) — the deficit must be in the response function normalization or mean-field residuals. The simulation null test (65/66 pass) confirms no spurious correlation; the issue is the amplitude and shape of the real signal. Leading hypotheses (ranked): (1) SPT κ transfer function — scale-dependent normalization bias; (2) SPT mask mode-coupling at fsky ≈ 0.04; (3) SPT lmin filtering distorting cross-spectrum at low output multipoles. See `spt-deficit-characterization-6b724e41` for full characterization.\n\n## 7. Covariance and statistical framework\n\nKnox analytic covariance is primary for all chi2/PTE computations (`covariance-methodology-b17f19da`). Var(C^{ab}_b) = C^{aa}_b · C^{bb}_b / n_modes with fsky_eff from Hivon (2002). Diagonal — no bandpower correlations. Validated by simulation null test: empirical variance ratio 0.83 (Knox slightly conservative).\n\nNaMaster Gaussian covariance (iNKA) overestimates variance by 10–130× at our fsky ~ 0.01 — documented in `suspiciously-good-ptes-in-dbf44cbb` and `systematic-pte-overestimation-89f57308`. Retained in SACC files but not used for chi2.\n\nFor the fiducial likelihood evaluation, the full bandpower covariance from NaMaster PKL files is used. The Knox and PKL frameworks are consistent where they overlap.\n\n## 8. Data products\n\n**SACC files** (`validate_sacc`). Combined data product containing tracers (NZTracer for shear, MiscTracer for CMB κ), n(z) curves (6 bins from RR2_v2_Nz_WL_C2020_sel_pv), data vectors (560 points per CMB: 14 spectra × 40 bandpowers), and covariance matrices.\n\n**PKL files** (`build_likelihood_input`). NPZ→PKL bridge for the eDR1like likelihood. Includes bandpower window functions (Bbl), data vectors, covariance, and tracer information. Four files: 2 methods × 2 CMB baselines.\n\n**LaTeX results tables** (`generate_results_table`). Three tables: detection & theory (Table 1), per-bin amplitudes (Table 2), validation summary (Table 3). All numbers traceable to evidence.json files.\n\n## 9. Summary of key numbers\n\n| Quantity | ACT (lensmc) | SPT (lensmc) |\n|---|---|---|\n| Raw detection S/N | 20σ | 21σ |\n| Marginalized S/N | 15σ | 14σ |\n| A_van (vanilla) | 0.84 ± 0.05 | 0.69 ± 0.05 |\n| A_lens (NLA IA) | 0.93 ± 0.06 | 0.76 ± 0.05 |\n| A_lens^marg (IA + marg.) | 0.86 ± 0.06 | 0.75 ± 0.05 |\n| Profile χ²/dof | 0.75 (PTE 0.98) | 1.61 (PTE ≈ 0) |\n| Per-bin shape χ²/dof | 0.59–1.18 (all pass) | 1.2–2.7 (bins 4–6 pass) |\n| Consistency (ACT vs SPT) | 14/14 pass | |\n| Method comparison | 35/35 pass | |\n| Null tests (jackknife) | 24/24 pass | |\n| Null tests (sim) | 65/66 pass | |\n| Spatial variation (ℓ > 100) | 6/6 pass | |\n| Max systematic bias | 4.4σ (stellar dens.) | < 1σ |\n| ℓ-range stability (max dev.) | 1.5σ (stable) | 2.7σ (scale-dependent) |\n| SPT ℓ=84.5 spike | not present | 3.4–5.1σ (5/6 bins) |\n| **δκ detection S/N** | **8.0σ median** | **8.8σ median** |\n| **δκ A_lens (theory)** | **1.005 ± 0.060** | **0.857 ± 0.050** |\n| **δκ A_lens (marg.)** | **0.934 ± 0.086** | **0.825 ± 0.080** |\n\n## 10. Galaxy density × CMB lensing (δκ)\n\nThe same five-layer methodology extends to galaxy number counts (`galaxy-density-cmb-lensing-δκ-a755afc3`). Overdensity maps built from the GC catalog (1.1–1.5M galaxies per bin, nside=2048) are crossed with the same ACT and SPT κ maps.\n\n**Detection.** 12/12 cross-spectra detected above 5σ (6 bins × 2 CMB). ACT Knox S/N: 6.3–9.8σ (median 8.0σ). SPT: 6.9–11.0σ (median 8.8σ). No intrinsic alignment — density theory uses Planck 2018 + SPV3 galaxy bias with `include_weaklensing=False`.\n\n**Theory comparison.** ACT A_lens = 1.005 ± 0.060 (χ²/dof = 1.06, PTE = 0.31) — perfect agreement with Planck 2018, no IA ambiguity. SPT A_lens = 0.857 ± 0.050 (χ²/dof = 1.48, PTE = 0.0005) — 14% deficit (2.9σ). The SPT deficit appears in both γκ (24%) and δκ (14%), confirming it originates from the CMB κ side, not the galaxy tracer.\n\n**Systematic contamination is far worse than shear.** All 24/24 density × systematic null tests fail (χ²/dof 27–72, all PTE = 0). Number counts directly trace observing conditions — more exposures → more detections → higher apparent density. This inverts the shear pattern (where galactic extinction was the primary contaminant).\n\nContamination metric: 3/4 systematics exceed signal level. X/signal ratios: stellar density 1.4–2.3, galactic extinction 1.4–2.8, exposures 1.1–2.2. Only zodiacal light is clean (doesn't correlate with CMB κ). Raw δκ A_lens values are biased upward by systematic contamination.\n\n**Template marginalization essential.** Fisher matrix fit (d = A·theory + Σ α_S·X_S) yields ACT A_lens = 0.934 ± 0.086 (10.9σ, χ²/dof = 0.94, PTE = 0.65) and SPT A_lens = 0.825 ± 0.080 (10.2σ, χ²/dof = 1.42, PTE = 0.002). Naive template subtraction is catastrophic (ACT A_lens → −0.521) because template noise (X^T C^{-1} X) dominates. Bias per bin reaches 24–28σ at ACT, dominated by exposures (α = 0.71).\n\n**δκ as an independent SPT probe.** Both γκ (A_lens = 0.75 after IA + marginalization) and δκ (A_lens = 0.825 before marginalization) show SPT deficits. That two different galaxy tracers — shear (spin-2, IA-affected) and density (spin-0, bias-affected) — both see it independently establishes the deficit as a property of the SPT CMB κ reconstruction, not a galaxy-side effect.\n\n## 11. Open items\n\n- **SPT normalization deficit** — not addressable without SPT team input. See `spt-normalization-deficit-2cbccf68`.\n- **Missing theory effects** — baryonic feedback (~3–5%), multiplicative shear calibration (~2%), n(z) shifts (~1–3%) are all excluded from the current model. Combined ~6–10% correction would bring ACT A_lens from 0.86 to ~0.91–0.95, fully resolving the residual deficit. Theory uses CCL with Halofit nonlinear P(k) — the CAMB HMCode baryonic feedback settings in eDR1like defaults.py are dead code for our CCL-based pipeline (`theory-prediction-audit-07c96181`). Shear m-bias not implemented in eDR1like at all. See `theory-model-completeness-for-526d66a5`.\n- **Curl mode null test** — blocked on data. ACT provides only baseline ILC κ; SPT has no curl product. Would need collaboration request.\n- **Mass maps** — SKS/SKSP maps at v1.4 path, not v2.1. Investigated in `mass-maps-at-v1-4-path-not-v2-1-fdc14589`.\n- **Blinding strategy** — unresolved. See `cmbx-3x2pt-blinding-strategy-d2469de7`.\n\n## Provenance\n\nThis synthesis was compiled from 22 tapestry-tagged fibers (γκ) plus 9 δκ fibers with evidence files at `results/claims/{specName}/evidence.json`. All evidence generated 2026-02-15/16. The tapestry was compressed from 31→21 nodes during narrative shaping (`narrative-tapestry-compress-31-6c42a4d6`), then expanded to 22 with visualization nodes. Aggregate evidence rules updated 2026-02-16 to include density (method=\"density\") alongside shear methods. Every tapestry node has enriched aggregate evidence — rule-specific handlers extract key metrics from individual evidence files. Per-bin chi2 values use shape tests at best-fit amplitude (ν = 19), isolating spectral shape from amplitude deficit; joint fits use the full covariance (ν = 119 for IA, ν = 115 for marginalized). A_lens = data / (Planck 2018 ΛCDM + NLA IA) for γκ; A_lens = data / (Planck 2018 ΛCDM + galaxy bias) for δκ. A_IA is a fixed nuisance parameter for γκ (see `a-lens-naming-fitted-amplitude-c5d1c543`). Theory prediction uses CCL with Halofit nonlinear P(k) — CAMB HMCode baryonic feedback settings in eDR1like defaults.py are dead code for our pipeline (see `theory-prediction-audit-07c96181`). Every number in this document traces back to a specific evidence.json field, which in turn traces to a Snakemake rule output.",
      "outcome": "Comprehensive synthesis of γκ (22 tapestry nodes) + δκ (12/12 detections). γκ: ACT 20σ raw → 15σ marginalized, A_lens=0.86±0.06, profile chi2/dof=0.75 (PTE 0.98). SPT 21σ raw → 14σ marg, A_lens=0.75±0.05, chi2/dof=1.6. δκ: ACT A_lens=1.005 (perfect), SPT 0.857 (14% deficit). Both γκ and δκ see SPT deficit → CMB-side origin confirmed. δκ contamination far worse than γκ (3/4 systematics exceed signal), template marginalization essential. Section 10 added for δκ.",
      "createdAt": "2026-02-15T12:25:55.164047357+01:00",
      "closedAt": "2026-02-15T12:29:38.418893356+01:00",
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "analysis-summary-one-page-c5170698",
        "results-table-paper-ready-latex-2a507292",
        "deprojected-likelihood-joint-26b1588e",
        "template-deprojection-a1621797",
        "spt-normalization-deficit-2cbccf68",
        "covariance-methodology-b17f19da",
        "nla-intrinsic-alignment-cb1dea0b",
        "fiducial-cosmology-planck-2018-f1a59f23",
        "sign-convention-for-standard-wl-7ebc8d73",
        "spt-deficit-bin-level-structure-de2540dd",
        "theory-model-completeness-for-526d66a5",
        "ℓ-range-robustness-amplitude-e86f1728",
        "namaster-technical-patterns-60d42621",
        "systematic-contamination-five-f509e962",
        "spt-deficit-characterization-6b724e41",
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "spt-deficit-bin-level-structure-de2540dd",
      "title": "SPT deficit bin-level structure: shape fails at low-z, amplitude-only at high-z",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Three independent lines of evidence characterize the SPT deficit:\n\n1. **Per-bin shape tests** (from `plot_theory_residual_analysis`): SPT bins 1–3 FAIL the shape test at best-fit A (chi2/dof 1.7–2.7) — the ℓ-shape of the measured cross-spectrum doesn't match theory even after fitting the overall amplitude. Bins 4–6 PASS shape, showing a pure amplitude deficit. ACT passes shape in all bins.\n\n2. **ℓ-range robustness** (from `plot_ell_range_robustness`): Progressive ℓ_max cuts reveal that SPT amplitude drops monotonically as high-ℓ bandpowers are added. At ℓ_max ~ 200, A ≈ 1.5 (consistent with theory within errors). At full range, A ≈ 0.7. The data at ℓ > 500 is actively suppressing the cross-correlation amplitude relative to theory. ACT does not show this trend (max deviation 1.5σ).\n\n3. **ACT/SPT amplitude ratio**: ~1.2 across bins, consistent with a CMB-side normalization offset rather than galaxy-side systematics.\n\n## Hypothesis ranking\n\nThe scale-dependent suppression at high ℓ, specific to SPT but not ACT, narrows the hypotheses:\n\n- **SPT κ transfer function** (FAVORED): The SPT lensing reconstruction has an effective response function that may not be perfectly normalized at high ℓ. If our theory doesn't account for the ℓ-dependent reconstruction efficiency, the cross-spectrum amplitude would appear suppressed at high ℓ.\n\n- **Missing baryonic feedback** (DISFAVORED for this effect): Baryonic effects would suppress both ACT and SPT cross-spectra at high ℓ. The observed effect is SPT-specific. However, baryonic feedback could contribute a ~3–5% common suppression not detectable in this test.\n\n- **SPT noise bias leakage** (POSSIBLE): Higher-order noise biases (N3/2, trispectrum) can leak into cross-correlations. These grow at high ℓ. However, simulation null tests (66 SPT sims × Euclid galaxies) show no spurious correlations, constraining this contribution.\n\nThe resolution requires the SPT team to provide the ℓ-dependent normalization of their lensing reconstruction, or to compare with simulation-based transfer function calibration.",
      "outcome": "Per-bin analysis reveals two distinct regimes in the SPT deficit. Bins 1-3 (low-z): shape FAILS (chi2_shape/dof 1.7-2.7, PTE<0.03). Bins 4-6 (high-z): shape passes, amplitude deficit only (A_hat 0.72-0.99). ACT passes shape in ALL bins. The ℓ-range robustness test (iteration 31) confirms this is SCALE-DEPENDENT: SPT bins 1-3 show A_hat dropping from ~1.5 at ℓ_max~200 to ~0.7 at full range — high-ℓ bandpowers actively suppress the amplitude. ACT is stable (worst deviation 1.5σ). This rules out a uniform calibration offset and points to SPT κ transfer function effects at high ℓ, not missing baryonic feedback (which would affect both experiments). Requires SPT team investigation of response function normalization.",
      "createdAt": "2026-02-15T12:57:12.079768302+01:00",
      "closedAt": null,
      "dependsOn": [
        "spt-normalization-deficit-2cbccf68",
        "theory-residual-analysis-6a66a995",
        "ℓ-range-robustness-amplitude-e86f1728"
      ]
    },
    {
      "id": "theory-model-completeness-for-526d66a5",
      "title": "Theory model completeness for kappa x gamma: IA only, no baryons or m-bias",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "methodology"
      ],
      "body": "Documents what physical effects the theory model includes and excludes for the κ_CMB × γ cross-spectrum, and why the exclusions are acceptable at the current analysis stage.\n\n## What's included\n\n**Planck 2018 ΛCDM** — fiducial cosmology from `fiducial-cosmology-planck-2018-f1a59f23`. Matter power spectrum via CCL's Boltzmann solver (CLASS), Limber integration for angular power spectra.\n\n**NLA intrinsic alignment** — A_IA = 1.72, η_IA = −0.41 (eDR1like defaults, consistent with KiDS/DES). Applied via CCL's `WeakLensingTracer(ia_bias=...)` which handles C₁ρ_cr Ω_m / D(z) internally. Suppresses C^{Eκ} by 4–36% depending on redshift (strongest at low-z). See `nla-intrinsic-alignment-cb1dea0b`.\n\n## What's excluded\n\n### Baryonic feedback\n\nAvailable in eDR1like via CAMB backend with HMCode Mead2020 defaults (A_baryon=3.13, eta_baryon=0.603, logT_AGN=7.8). Not available through CCL backend, which is what `compute_theory_cls.py` uses. Typical effect: suppresses P(k) by 5–15% at k > 1 h/Mpc (ℓ > 1000 for our redshifts). Would increase A_hat by ~3–5%. Impact on profile chi2: minor (ℓ-dependent shape change within existing error bars).\n\n### Multiplicative shear calibration (m)\n\nNot implemented in eDR1like at all — absent from both `theory.py` and `likelihood_pyccl.py`. For comparison, DES shear analyses (`shearXlensing/tracer_info_des_blue.yml`) include per-bin m-bias with uncertainties. Euclid target: |m| < 0.02. Effect: shifts observed shear by factor (1+m), so A_hat_corrected = A_hat / (1+m). For m = −0.02: correction is ~2%. Subdominant to σ_A ≈ 0.06 (0.3σ shift).\n\n### Photometric redshift errors\n\neDR1like supports n(z) shifts via `wz_i` (width) and `Dz_i` (mean shift) parameters, disabled by default. These are nuisance parameters for MCMC fitting. At our stage (fixed fiducial cosmology, amplitude-only fits), n(z) errors are absorbed into the effective A_hat.\n\n## Combined impact estimate\n\nThe missing effects are cumulative but partially degenerate: baryonic feedback (~3–5%), m-bias (~2%), n(z) shifts (~1–3%) sum to ~6–10% correction. ACT marginalized Â(IA) = 0.86 ± 0.06 is 2.3σ from unity. Including all missing effects could bring this to ~0.91–0.95 (within 1σ) — fully consistent with theory. For SPT (Â = 0.75, 5σ deficit), missing effects account for at most ~10% of the 24% deficit.\n\n## Decision\n\nThe current model (ΛCDM + NLA IA) is adequate for the validation/detection stage. All missing effects are within our statistical uncertainty. Parameter inference with the eDR1like likelihood would need: (a) switch to CAMB backend for baryonic feedback, (b) add m-bias marginalization (code contribution to eDR1like), (c) enable n(z) shift priors.",
      "outcome": "Current theory: Planck 2018 LCDM + NLA IA (A_IA=1.72, eta=-0.41) via CCL Limber. Missing effects for kappa x gamma: (1) Baryonic feedback — HMCode Mead2020 available in eDR1like CAMB backend (A_baryon=3.13, eta_baryon=0.603, logT_AGN=7.8), suppresses P(k) ~5-15% at ell>1000, would increase A_hat by ~3-5%. Not included because CCL backend lacks HMCode; would need backend switch. (2) Multiplicative shear calibration (m) — not implemented in eDR1like. Typical m~-0.02±0.02 shifts A_hat by 1/(1+m)~1.02. Subdominant to sigma_A~0.06. (3) n(z) shifts — available but disabled (wz, Dz parameters). Combined missing effects ~5-7%, consistent with ACT residual deficit after IA+marginalization (A=0.86, 2.3sigma from 1). All irrelevant for SPT deficit (24%). Adequate for validation stage; parameter inference would need these.",
      "createdAt": "2026-02-15T15:04:34.59478683+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-c-ℓ-computation-d5415ff5"
      ]
    },
    {
      "id": "ℓ-range-robustness-amplitude-e86f1728",
      "title": "ℓ-range robustness: ACT stable, SPT scale-dependent",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_ell_range_robustness",
        "region:validation:consistency"
      ],
      "body": "Progressively include bandpowers up to ℓ_max and fit the lensing amplitude A_lens, testing whether the measurement is robust across angular scales. Starting from ℓ_max ≈ 105 (5 bandpowers minimum), each step adds one more bandpower until the full range (ℓ ≈ 2700).\n\n**ACT is scale-stable.** Worst deviation from the full-range A_lens is 1.5σ (bin 3). Bins 4-6 are rock-solid (< 1σ). The ACT measurement is robust to ℓ-range selection.\n\n**SPT shows scale-dependent deficit.** Bins 1-3 start at A_lens ≈ 1.5 with only low-ℓ bandpowers and drop to A_lens ≈ 0.7 as high-ℓ data is added. The deficit is not a uniform calibration offset — high-ℓ bandpowers actively suppress the amplitude. Worst case: bin 2, max deviation 2.7σ, A_lens range 0.74-2.55. Bins 4-6 are more stable (deviations 1.3-1.9σ) but still trend downward.\n\n**Per-estimator breakdown sharpens the picture.** Running the same test separately for SPT TT, PP, and MV reveals the scale dependence is primarily temperature-driven. PP (polarization-only) is the most scale-stable (worst 1.82σ vs 2.4-2.7σ for TT/GMV/MV) and gives systematically higher full-range A_lens (0.83-1.41 vs 0.08-0.85 for TT). TT bin 1 is catastrophic (A_lens = 0.08); PP bin 1 gives A_lens = 1.41. Combined estimators (GMV, MV) inherit TT's instability.\n\nThis constrains the deficit's origin (full characterization in [SPT deficit](.felt/spt-deficit-characterization-6b724e41.md)). Three hypotheses, refined by the per-estimator test:\n\n1. **SPT κ_TT normalization/filtering** — temperature-specific normalization residual in the Wiener-filtered κ map. PP's stability and higher amplitudes strongly favor a T-side origin. Foreground leakage into κ_TT at low ℓ is a candidate mechanism. Favored: explains both ACT/SPT asymmetry and TT/PP asymmetry.\n\n2. **Higher-order noise bias leakage** — N3/2 and trispectrum terms that formally cancel in cross-correlation but may leak at high ℓ. Also CMB-side, SPT-specific. Partially consistent — but would not explain the strong TT/PP asymmetry unless N0_TT >> N0_PP.\n\n3. **Baryonic feedback** — suppresses small-scale matter power (ℓ > 500-1000). Disfavored: would affect both experiments and both estimators equally.",
      "outcome": "ACT amplitude stable (worst deviation 1.5σ, bin 3 lensmc). SPT shows significant scale dependence: worst 2.7σ (bin 2 lensmc), driven by high-ℓ bandpowers pulling amplitude DOWN. SPT bins 1-3 drop from A_lens≈1.5 at ℓ_max~200 to A_lens≈0.7 at full range — deficit is NOT a uniform calibration offset but scale-dependent, concentrated at high ℓ.",
      "createdAt": "2026-02-15T15:19:58.303844642+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-residual-analysis-6a66a995",
        "validation-null-tests-and-48ab3654"
      ]
    },
    {
      "id": "narrative-tapestry-compress-31-6c42a4d6",
      "title": "Narrative tapestry: compress 31 nodes into a story",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "Shape the research tapestry into something navigable. The previous ralph spec (`research-tapestry-inspectable`) built this tapestry — 31 nodes, 175 plots, 31 iterations of evidence gathering. This spec shapes it: compress, narrate, make it a map someone can walk into and orient themselves.\n\nWe're not making an argument or converging on a conclusion. The analysis is growing and being refined. The tapestry should reflect that — a living map of where the analysis is, what it sees, and where to look next. The same tapestry continues to evolve; we're reshaping how it presents itself.\n\n## Desired State\n\nThe tapestry has a clear entry point and a natural flow. A person arriving cold can start on the left, move through it, and emerge understanding the state of the analysis — what's been measured, what's been tested, what's open, what needs attention.\n\nCurrent regions of the map (suggestive, not fixed — add, combine, split as the analysis grows):\n\n1. The data — sky coverage, redshift bins, what we're crossing\n2. The signal — what we see, how strong\n3. Consistency — do independent measurements agree?\n4. Null tests — what should be zero, is it?\n5. Contamination — what leaks in, how much, from where\n6. Cleaning — how we handle what leaks in\n7. Theory — how measurements compare to predictions\n8. Open questions — what's unresolved, what needs further work\n\nThese aren't conclusions. They're *regions* of the map. The tapestry is a tool for understanding, not a proof. It should inform the next iteration of improvement — a tapestry that can continue to knit itself.\n\n### Working discipline\n\n**Read plots sparingly.** Never read more than 5 images in a single session. Plot review is expensive — each image consumes context that could go toward actual work. When reviewing a node, read its 1–2 key plots and move on. A session that reads a dozen images accomplishes nothing else.\n\n### Node discipline\n\nEach tapestry node has:\n\n- **1–5 plots** that efficiently convey its point. 2–3 is ideal. A plot earns its place by saying something no other plot says. If two plots make the same point, merge or cut.\n- **A body** that reads as prose — a few sentences or a few paragraphs, whatever the scene needs. Not diagnostic output, not a methods section. A reader encountering this node should understand what it shows and why it matters.\n- **An outcome** that summarizes the current state. One sentence is often enough.\n- **Evidence** at `results/claims/{specName}/evidence.json` with the key numbers.\n\nNot every figure needs to be composite. A standalone plot that makes a clear point is fine. The goal is communication efficiency, not mechanical compression.\n\n### Visualization quality\n\nPrefer plots that show the spectra over summary statistics that compress them away. A heatmap of chi2/PTE values is a pass/fail table — you can't tell from it whether the analysis is sound. Better:\n\n- **Cross-spectral correlation coefficients** — show spectral agreement, not a single number\n- **Chi-square distributions** — show where the fit works and where it doesn't\n- **Residual spectra** — show what's left after subtraction or fitting\n\nA reader should be able to see the data, not just summaries of it. Bar charts and coarse heatmaps are acceptable as quick references in a summary panel, but the node's main figure should carry spectral information.\n\n### Gradual reshaping\n\nThis is improvement, not replacement. The current 31 nodes are raw material. Each iteration:\n\n- **Merge** nodes that cover the same region of the map\n- **Split** nodes that cover too much ground\n- **Rework** bodies from diagnostic summaries into narrative prose\n- **Create** composite figures that compress per-wildcard galleries\n- **Adjust** `tapestry:` tags and felt dependencies to reflect the evolving structure\n\nOld fibers that lose their `tapestry:` tag remain as documentation — the detailed record. New or reworked fibers carry the narrative forward. When plots become obsolete (superseded by a composite, or removed from a node), delete them from `results/claims/{specName}/` so they don't keep showing up in the tapestry.\n\n### Iteration rhythm\n\nEach iteration runs until the usage limit resets at 3 AM Paris time — that's the natural stopping point. Within each session, make as much progress as taste and judgment allow. There's no fixed \"done\" threshold for the tapestry itself; it's an evolving artifact. Progress means: fewer redundant plots, clearer prose, better flow, more natural entry points.\n\n## Context\n\n### The story so far\n\nThe findings synthesis (`felt show findings-synthesis-euclid-cmb-03354e57`) walks the current state. It's the reference for *what's been found*. The tapestry is how it's *shown and navigated*.\n\nKey state: 20σ/21σ raw detection → 15σ/14σ after marginalization. Four consistency tests pass. Three null tests pass. Stellar density contaminates ACT (boosts signal). Template marginalization (Fisher) corrects properly. SPT shows 24% normalization deficit — scale-dependent, intrinsic, open question. After marginalization: ACT consistent with ΛCDM, SPT still low.\n\n**Narrative framing**: Detection-centered. The main results are detection significance, ΛCDM consistency, and systematic characterization.\n\n- **A_IA is a nuisance parameter.** NLA IA (A_IA=1.72, η=-0.41) is a fixed ingredient in the theory prediction from the Euclid pipeline. It decreases the predicted amplitude. It is not a finding and should not be framed as one.\n- **A_lens is the measurement.** The fitted amplitude A_lens = data / theory, where theory = Planck 2018 ΛCDM + NLA IA. A_lens = 1 means agreement with standard predictions. This is a lensing amplitude, not an IA amplitude — IA is already absorbed into the prediction.\n- **Blinding.** We are not technically in the 3x2pt pipeline group, so current fixed-cosmology comparisons are fine internally. But don't share broadly, and don't push further on fitting (no Ω_m, S_8 constraints). The TR1 analysis plan (Stage B) allows comparing to synthetic at reference cosmology; amplitude fitting is at the boundary and should stay internal.\n\n### Consolidated doc fibers\n\nThese doc fibers consolidate scattered iteration notes into useful references. They reflect the analysis as of iteration 31 — the analysis continues to evolve, so treat them as a starting point for prose, not a fixed source of truth:\n\n- `systematic-contamination-five-f509e962` — the five-layer contamination methodology (null tests → CMB-side → metric → budget → marginalization). This is the backbone for the contamination and cleaning regions of the tapestry.\n- `spt-deficit-characterization-6b724e41` — SPT 24% deficit: bin-level structure, scale dependence, hypothesis ranking. The open-questions region.\n- `namaster-technical-patterns-60d42621` — sign conventions, masking, I/O patterns. Technical foundations.\n- `snakemake-workflow-discipline-88f4f4f8` — DAG discipline, ancient() traps. Operational reference for the loop itself.\n\n### Current tapestry\n\n~22 tapestry nodes, ~31 PNGs. Infrastructure nodes (compute_*, combine_*, build_*, validate_*) removed from tapestry in iteration 2 — they remain as documentation fibers. `plot_field_overview` added in iteration 6 as the \"data\" entry point (Wiener-filtered maps on the sky). NLA IA separated into its own doc fiber (`nla-intrinsic-alignment-theory-57e37bd1`) — not a tapestry node, but a referenced dependency from theory_comparison and theory_residual.\n\n**All plots carry spectral content** — heatmaps replaced in iterations 3-5. No pass/fail heatmaps remain as primary figures (budget heatmap acceptable as integrated summary).\n\n**Narrative flow verified** (iteration 10): 22 fiber bodies read in dependency order. Story flows naturally from data → signal → consistency → null tests → contamination → cleaning → theory → summary. Cross-links between fibers are comprehensive. Fiber titles rewritten to communicate findings (15 titles updated).\n\n**Next shaping priorities**:\n- Wiener filter diagnostic: verify W(ℓ) makes sense by plotting signal vs signal+noise power spectra for ACT/SPT κ (filed as question fiber, low priority)\n- The \"open questions\" region (SPT deficit, theory completeness) is implicitly present via theory_residual → ℓ-range_robustness → spt-deficit-characterization doc fiber, but has no dedicated visual space. Consider whether to create an explicit node or leave distributed.\n- Further body tightening: some fibers still repeat Knox covariance methodology that belongs in compare_nz. Acceptable for self-containment but could be trimmed further.\n\nCoverage check: `grep -rh 'tapestry:' .felt/*.md | grep -oP 'tapestry:\\S+' | sort -u`\nPlot inventory: `for d in results/claims/*/; do echo \"$(ls \"$d\"/*.png 2>/dev/null | wc -l) $(basename \"$d\")\"; done | sort -rn`\n\n### Relationship to the previous spec\n\n`research-tapestry-inspectable-fef1295c` built this tapestry — made every rule inspectable, wired the DAG, populated evidence. That spec remains open (the tapestry continues to grow). This spec shapes the same tapestry: how it presents, how it reads, how a person navigates it. Same object, different concern.\n\n### Files and patterns\n\n- **Snakefile**: `workflow/Snakefile` + `cmbx/files/workflow_rules_explorations.smk`\n- **Plot scripts**: `workflow/scripts/plot_*.py`\n- **Evidence aggregation**: `cmbx/files/workflow_scripts_aggregate_evidence.py`\n- **Evidence directory**: `results/claims/{specName}/`\n- **Fiber files**: `.felt/*.md`\n\n### Creating composite figures\n\nNew composite figures should:\n\n1. Be snakemake localrules (just plotting)\n2. Read from existing NPZ/evidence outputs (don't recompute)\n3. Output to `results/claims/{specName}/` with evidence.json + PNGs\n4. Have corresponding felt fibers with `tapestry:{specName}` tags\n\nFollow the pattern of existing plot rules — scripts read config, load upstream outputs, produce PNG + evidence.json. When reworking an existing node rather than creating a new one, modify the existing script and rule in place.\n\n## Skills\n\n- `/tapestry` — fiber ↔ evidence ↔ plot conventions\n- `/snakemake` — adding localrules, execution\n- `/data-visualization` — composite figure design\n- `/felt` — fiber management, tag editing, dependency wiring\n- `/implementing-code` — script development\n\n## Evidence\n\nCheck progress:\n\n- Plot inventory: `for d in results/claims/*/; do echo \"$(ls \"$d\"/*.png 2>/dev/null | wc -l) $(basename \"$d\")\"; done | sort -rn`\n- Total plots: `ls results/claims/*/*.png 2>/dev/null | wc -l`\n- Narrative test: read fiber bodies in dependency order — does the story flow?",
      "outcome": "Shaped from 31 nodes / 175 PNGs to 22 nodes / 31 PNGs across 11 iterations. Four heatmap composites replaced with spectral overlays. Infrastructure nodes removed from tapestry. All 22 fiber bodies rewritten as narrative prose. 16 titles rewritten to communicate findings. NLA IA separated into doc fiber. Field overview entry point with Wiener-filtered maps. A_lens naming convention established. Narrative DAG cleaned to 47 internal edges. Full prose review in final iteration confirmed convergence. Eight narrative regions (data, signal, consistency, null tests, contamination, cleaning, theory, summary) with clear entry points, finding-oriented titles, spectral plots, and comprehensive cross-links. No heatmap-primary figures remain. Remaining optional: Wiener filter diagnostic (filed), Knox deduplication (cosmetic).",
      "createdAt": "2026-02-15T15:48:44.897965603+01:00",
      "closedAt": "2026-02-15T21:14:42.696400006+01:00",
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "systematic-contamination-five-f509e962",
        "namaster-technical-patterns-60d42621",
        "snakemake-workflow-discipline-88f4f4f8"
      ]
    },
    {
      "id": "namaster-technical-patterns-60d42621",
      "title": "NaMaster technical patterns: conventions, masking, data I/O",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "body": "## NmtFieldCatalog (added iteration 33)\n\n`nmt.NmtFieldCatalog(pos=[ra,dec], weights, fields=[-e1,e2], lmax, spin=2, lonlat=True)`\n\n### Known limitations\n\n- **`.get_mask()` raises `ValueError: Input mask unavailable for this field`** — no map mask exists for catalog fields. Guard all `.get_mask()` calls with try/except.\n- **`compute_coupled_cell(cat, cat)` NOT in C_ℓ units** — returns internal catalog representation (~10^8 for spin-2 fields). Cannot be normalized to C_ℓ by dividing by fsky alone. This makes standard Knox computation unusable.\n- **Gaussian covariance unsupported** — requires `get_cov_workspace()` which needs map-based masks.\n\n### Knox proxy for catalog shear fields\n\nUse analytical shape noise estimate instead of catalog auto-spectrum:\n\n```python\nn_eff_sr = sum_w**2 / sum_w2 / (4*pi*fsky_cmb)   # effective galaxy density\nnoise_ee = (sigma2_e1 + sigma2_e2) / (2 * n_eff_sr)  # shape noise power\nknox_var = noise_ee * |C^{KK}| / n_modes\n```\n\n**WARNING**: This underestimates C^EE_total = C^EE_signal + N^EE. For deep surveys where signal >> noise (Euclid RR2 with n_eff~8M/sr), the variance is underestimated ~60× → SNR inflated ~8×. See `knox-proxy-for-catalog-shear-c57104cd` for investigation.\n\n### Workspace caching\n\nUses `get_mask_alms()` hash for workspace cache key — different from map-based which uses mask FITS hash.\n\n### Resource requirements\n\n- Memory: 64GB for ~5M galaxies at lmax=3000\n- Wall clock: ~3-4 min per job on dcgp_usr_prod (16 cores)",
      "outcome": "Consolidated reference for NaMaster usage in this pipeline. Sign convention: [-e1, e2] for Euclid→HEALPix (π/2 frame rotation). Masks: apodize(w>0, 0.15, C2)*w for weights; apodize-only for binary. NmtBin lmax must match NmtField lmax. Shear maps are sparse FITS (use nx2pt.maps.read_healpix_map). UNSEEN values (|x|>1e20) must be zeroed post-load. Shape noise from FITS headers: NOISE_CL = σ²_comp/n_eff_sr. Auto-spectra invariant to sign flip; only spin-2×spin-0 cross-spectra detect sign bugs. NmtFieldCatalog limitations: get_mask() raises ValueError; compute_coupled_cell(cat,cat) returns catalog-internal units (~10^8), not C_ℓ; Knox proxy uses analytical N^EE = (σ²_e1+σ²_e2)/(2*n_eff_sr) — inflated SNR when signal >> noise. Sources: 7 closed fibers from iterations 1-8 + catalog estimator from iteration 33.",
      "createdAt": "2026-02-15T16:18:22.380409083+01:00",
      "closedAt": null,
      "dependsOn": [
        "sign-convention-for-standard-wl-7ebc8d73",
        "cmb-mask-apodize-instead-of-cb129695",
        "weight-masking-apodize-binary-4d110db1",
        "hp-unseen-values-in-systematic-0c18dac4"
      ]
    },
    {
      "id": "systematic-contamination-five-f509e962",
      "title": "Systematic contamination: five-layer analysis methodology",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "outcome": "Five-layer contamination methodology for cross-correlation pipelines: (1) Null tests: C^{γS} Knox chi2 identifies contaminated systematics. (2) CMB-side: C^{κS} confirms systematics correlate with CMB κ reconstruction (estimator-independent). (3) Contamination metric: X^f_S = C^{κS}·C^{fS}/C^{SS} in signal units, individually negligible. (4) Bias budget: S_bias = sqrt(Σ X²/σ²) reveals stellar density dominates ACT (4.4σ), not galactic extinction. Metacal 2× more sensitive than lensmc. (5) Template marginalization: Fisher joint fit d = A·theory + Σ α_S·X_S avoids noise injection from naive subtraction. Key finding: contamination BOOSTED ACT signal (positive X_total). After marginalization: ACT Â=0.86±0.06 (consistent with theory), SPT unaffected. Naive subtraction (Â=0.80) was an artifact of template noise injection. Sources: iterations 20-23, 27-28.",
      "createdAt": "2026-02-15T16:18:36.228891273+01:00",
      "closedAt": null,
      "dependsOn": [
        "contamination-metric-product-c-e55501f4",
        "systematic-bias-budget-709ea507",
        "template-deprojection-a1621797",
        "deprojected-likelihood-joint-26b1588e",
        "act-systematic-bias-exceeds-1a76bb12"
      ]
    },
    {
      "id": "spt-deficit-characterization-6b724e41",
      "title": "SPT deficit characterization: bin-level structure and hypotheses",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "body": "SPT-3G × Euclid shear cross-spectra show A_lens = 0.76 ± 0.05 — a 4.9σ deficit from unity after NLA IA correction. The deficit has three layers of structure that point to a CMB-side origin.\n\n**Layer 1: bin-level.** Shape fails at low redshift (bins 1-3, chi2_shape/dof = 1.7-2.7) but passes at high redshift (bins 4-6, chi2_shape/dof = 1.2-1.6). At high-z the deficit is amplitude-only — the spectral shape is correct but the overall normalization is low. At low-z the shape itself is wrong, likely from SPT's ℓ_min ≈ 500 filtering distorting cross-spectrum bandpowers at low ℓ.\n\n**Layer 2: ℓ-range dependence.** Progressive ℓ_max cuts show A_lens dropping from ~1.5 at ℓ_max ≈ 200 to ~0.7 at full range. The worst case is bin 2 (2.7σ deviation, A range 0.74-2.55). ACT is stable (worst 1.5σ). This rules out a uniform calibration offset and disfavors baryonic feedback (which would affect both experiments).\n\n**Layer 3: the ℓ=84.5 spike.** A single bandpower at ℓ=84.5 spikes in 5/6 SPT bins (Knox S/N = 3.4-5.1σ, 3.8-5.4× neighbor average). All four SPT estimators (GMV/TT/PP/MV) agree within ~20%. Both shear methods agree. B-modes are clean. The spike amplitude scales with redshift bin (3e-8 to 1.1e-7), tracking the lensing kernel — it's coupling to genuine signal, not additive noise. This single bandpower is likely the dominant driver of the ℓ-range amplitude inflation at low ℓ_max, and its inclusion at full range suppresses the fitted A_lens.\n\n**Hypotheses (ranked):**\n1. SPT κ transfer function — scale-dependent normalization bias in the lensing reconstruction pipeline. The ℓ=84.5 feature suggests a specific angular scale where the reconstruction is miscalibrated.\n2. SPT mask mode-coupling — the compact SPT winter field (fsky ≈ 0.04) creates stronger mode-coupling at low ℓ than ACT's broader footprint (fsky ≈ 0.25). A single ℓ bin could absorb leaked power.\n3. SPT lmin filtering — the reconstruction pipeline applies ℓ_min ≈ 500 to temperature maps, which could distort the cross-spectrum at low output multipoles through non-trivial mode-mixing.\n\n**Ruled out:** systematic contamination (SPT is clean in bias budget), foreground bias (all estimators agree), shear method dependence (lensmc ≈ metacal), baryonic feedback (would affect both experiments equally).",
      "outcome": "SPT 24% amplitude deficit (4.9σ after NLA IA). Method/estimator independent, not systematic contamination. Low-z shape fails (bins 1-3), high-z amplitude-only (bins 4-6). ℓ-range dependent: A drops from 1.5 to 0.7 with increasing ℓ_max. Single bandpower spike at ℓ=84.5 in 5/6 bins is likely the dominant driver. NEW: per-estimator ℓ-range test shows PP (polarization-only) is most scale-stable (worst 1.82σ vs 2.4-2.7σ for TT/GMV/MV) and gives systematically higher A_lens (0.83-1.41 vs 0.08-0.85 for TT). Scale dependence is dominated by the temperature channel. Deficit is primarily T-side, not reconstruction-universal. Hypothesis ranking: SPT κ_TT normalization/filtering > common transfer function > baryonic feedback (disfavored — ACT stable).",
      "createdAt": "2026-02-15T16:21:43.356754316+01:00",
      "closedAt": null,
      "dependsOn": [
        "spt-normalization-deficit-2cbccf68",
        "spt-deficit-bin-level-structure-de2540dd",
        "spt-ℓ-100-spike-suspicious-ed5a480a"
      ]
    },
    {
      "id": "snakemake-workflow-discipline-88f4f4f8",
      "title": "Snakemake workflow discipline: trust the DAG",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "outcome": "Consolidated lesson from iterations 18-32: never suppress the DAG. ancient(), --forceall, --touch, --rerun-triggers mtime all break provenance. The iteration-18 cascade (317 jobs from compute_cross_spectrum.py change) led to ancient() on summary rules, which then caused a Snakemake 9.x scheduling trap (all-ancient inputs → permanently un-schedulable). Correct response: run the jobs (-j20 on cluster). local-cores: 4 in prod profile prevents login node overload. Documented in CLAUDE.md, MEMORY.md, and snakemake skill anti-pattern table.",
      "createdAt": "2026-02-15T16:21:56.486042493+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "localrules-bottleneck-4-job-0fb5915a",
      "title": "Localrules bottleneck: 4-job limit makes plot rules counterproductive as local",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision",
        "snakemake"
      ],
      "outcome": "With a 4-job local parallelism limit, having hundreds of plot rules as localrules creates a bottleneck. New composite rules (contamination, method comparison, ACT vs SPT, SPT estimator composites) are NOT marked as localrules — they go through SLURM. Existing per-wildcard plot rules remain local for now but should be reconsidered in a future cleanup.",
      "createdAt": "2026-02-15T16:52:58.63344677+01:00",
      "closedAt": null,
      "dependsOn": [
        "snakemake-workflow-discipline-88f4f4f8"
      ]
    },
    {
      "id": "narrative-framing-detection-a35c0d5e",
      "title": "Narrative framing: detection-centered, IA is ingredient",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Reframed tapestry narrative to center on detection significance (20σ/21σ raw, 15σ/14σ marginalized) and ΛCDM consistency, not IA resolution. NLA IA (A_IA=1.72, η=-0.41) is a fixed theory ingredient from the Euclid pipeline — it goes into the prediction, it's not a finding. Updated constitution and rewrote 8 fiber bodies (theory comparison, residual, likelihood, signal overview, summary, redshift trend, deprojection, n(z) entry).",
      "createdAt": "2026-02-15T17:16:25.106431336+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "visualization-prefer-spectra-c2ba32b1",
      "title": "Visualization: prefer spectra over summary heatmaps",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Heatmaps and bar charts compress out spectral information — can't judge soundness without seeing the spectra. Prefer: cross-spectral correlation coefficients, chi2 distributions, residual spectra. Summary heatmaps acceptable as quick references in synthesis panels, but each node's main figure should carry spectral content. Added to constitution. Nodes needing rework: act_vs_spt, method_comparison, spt_estimator, catalog_validation (all currently composite heatmaps).",
      "createdAt": "2026-02-15T17:16:38.946622598+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "removed-all-claim-tags-from-a6ea0c51",
      "title": "Removed all claim tags from tapestry",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Removed 'claim' tag from 28 fibers. Tag was a leftover from the initial tapestry construction (every tapestry fiber had claim + tapestry:X). Now useless and causes confusion. Tapestry fibers identified by their tapestry: tag alone. 7 fibers had claim as only tag — entire tags section removed.",
      "createdAt": "2026-02-15T17:16:47.101058997+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "replaced-4-heatmap-composites-4e178261",
      "title": "Replaced 4 heatmap composites with spectral overlay plots",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "plot_act_vs_spt: 2×3 grid, ACT salmon + SPT teal overlaid per bin with chi2/PTE. plot_method_comparison: 2×3 grid with fractional difference sub-panels, ACT baseline. plot_spt_estimator_comparison: 2×3 ratio plot (TT/PP/MV to GMV). plot_catalog_validation_summary: 2×3 overlay of map-based vs catalog-based. All read NPZ directly (data_dir input added to Snakemake rules). Evidence aggregate rules updated with composite_ev inputs for DAG tracking. 50 individual contamination PNGs deleted from claims dir (superseded by composites). 30 total PNGs, all evidence fresh.",
      "createdAt": "2026-02-15T17:46:46.008355154+01:00",
      "closedAt": null,
      "dependsOn": [
        "visualization-prefer-spectra-c2ba32b1",
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "signal-overview-race-condition-da325c16",
      "title": "Signal overview race condition: explicit NPZ inputs",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Signal overview rule used directory input (data_dir), causing a race condition — SPT bins 4,5 showed 0.0σ because their NPZ files were computed AFTER the plot ran. Fixed by adding explicit spectra= input listing all 12 NPZ files (6 bins × 2 baseline CMB). Snakemake now properly waits for all cross-spectra before plotting.",
      "createdAt": "2026-02-15T18:11:19.77643854+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f"
      ]
    },
    {
      "id": "theory-residual-ia-theory-as-663344d8",
      "title": "Theory residual: IA theory as denominator",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Theory residual ratio plot used vanilla Planck 2018 theory as denominator, showing vanilla Â values. Updated to use NLA IA theory (the standard ingredient). Now shows ACT Â~1.0 (consistent) and SPT Â~0.84 (deficit) — matching the detection-centered narrative where IA is a fixed prediction, not a finding. Amplitude summary bar chart still shows both vanilla and IA for comparison.",
      "createdAt": "2026-02-15T18:14:30.272857165+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-residual-analysis-6a66a995"
      ]
    },
    {
      "id": "spt-estimator-composite-s-n-1dfecace",
      "title": "SPT estimator composite: S/N filter for ratio plot",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Added per-bandpower S/N>1 filter on GMV denominator in ratio plot. Previously showed noise/noise ratios at low ℓ that dominated visual range. Now only bandpowers where GMV is individually detected appear in the ratio. Y-axis tightened from (0,2) to (0.3,1.7). Much cleaner visualization — ratios cluster around unity as expected.",
      "createdAt": "2026-02-15T18:16:16.800250304+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "tapestry-plot-curation-lensmc-8c86af5f",
      "title": "Tapestry plot curation: lensmc as representative method",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Each tapestry node shows only plots that make a point no other node makes. lensmc is the representative shear method everywhere — metacal differences live in plot_method_comparison; SPT estimator variants live in plot_spt_estimator_comparison. Applied to 5 nodes: theory_comparison (10→2), deprojected_spectra (8→2), deprojected_likelihood (8→2), fiducial_likelihood (4→2), theory_residual (4→2). Total: 54→30 PNGs across 21 nodes, every node now 1-2 plots.",
      "createdAt": "2026-02-15T18:20:26.789281935+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "systematic-null-tests-spectral-9399d0ce",
      "title": "Systematic null tests: spectral pulls replace heatmap",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Per-bandpower C^{fS}/σ_Knox pulls show contamination structure that heatmaps hide. Galactic extinction: coherent ±3-5σ at low ℓ in bins 5-6 (broadband, not localized). Other systematics scatter within ±1σ. HUSL(5) colors, ±1σ/±2σ gray bands, worst-chi2 annotation per panel. Lensmc representative. Downstream of visualization-prefer-spectra.",
      "createdAt": "2026-02-15T18:41:45.338989147+01:00",
      "closedAt": null,
      "dependsOn": [
        "visualization-prefer-spectra-c2ba32b1",
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "fiber-body-trimming-narrative-85b73aca",
      "title": "Fiber body trimming: narrative over documentation",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Trimmed 5 tapestry fiber bodies (jackknife, sim_null, spatial_variation, ell_range_robustness, theory_residual) from methods-section style to narrative prose. Pattern: remove script references, pipeline descriptions, and ## headings. Keep tables where numbers are the point. A fiber body should read as a scene in the story, not a paper supplement. What happened, what it means, what's unresolved.",
      "createdAt": "2026-02-15T18:41:54.341821085+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "nla-intrinsic-alignment-theory-57e37bd1",
      "title": "NLA intrinsic alignment: theory ingredient, not a finding",
      "status": "closed",
      "kind": "task",
      "tags": [
        "research"
      ],
      "body": "Galaxy shapes aren't pure lensing. Tidal fields physically align galaxies, creating an \"intrinsic alignment\" (IA) signal that contaminates the shear field. In the κ×γ cross-spectrum, the GI term (gravitational shearing of background galaxies correlated with intrinsic alignment of foreground galaxies at the same redshift as the lens) suppresses the measured amplitude below the pure-lensing prediction.\n\nWe use the Non-Linear Alignment (NLA) model with redshift evolution:\n\n    A_IA(z) = A_IA × (1+z)^η_IA\n\nwhere A_IA = 1.72 and η = -0.41 are **fixed** from the Euclid eDR1 pipeline defaults. These are not fitted — they enter the theory prediction the same way Planck cosmological parameters do. The model is passed to `CCL.WeakLensingTracer` with `use_A_ia=True`, which handles the C₁ρ_cr Ω_m/D(z) normalization internally.\n\n**Effect on the cross-spectrum**: IA suppresses the signal by 36% in bin 1 (z ≈ 0.3, where lensing and source redshifts overlap most) down to 4% in bin 6 (z ≈ 1.5, where the GI geometry is less favorable). In the [signal overview](.felt/signal-overview-act-spt-theory-1ae2798f.md), the vanilla Planck 2018 prediction systematically overshoots the data. Adding standard IA brings theory and ACT data into agreement ([theory comparison](.felt/theory-comparison-data-d5cc9678.md)).\n\n**What IA is not**: It's not a free parameter we tune to match the data. It's not a finding of this analysis. The theory comparison fiber shows the vanilla-to-NLA shift as a diagnostic — the question is whether standard ingredients are sufficient, not whether IA \"resolves\" anything.\n\n**Implementation**: `compute_theory_cls.py` outputs both `cl_theory_bin{N}` (vanilla) and `cl_ia_theory_bin{N}` (NLA) in the same NPZ. All theory-facing nodes (comparison, residual, likelihood) consume both.",
      "outcome": "NLA model (A_IA=1.72, eta=-0.41 from Euclid pipeline) suppresses the cross-spectrum 4-36% depending on redshift bin (strongest at low-z). A fixed theory ingredient — goes into the prediction, not fitted. ACT amplitude moves from 0.83 to 0.93 (vanilla to NLA).",
      "createdAt": "2026-02-15T19:04:01.729324886+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "map-visualization-diagonal-9374134c",
      "title": "Map visualization: diagonal Wiener filter for κ maps",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Wiener filter W(ℓ) = C_signal / (C_signal + N_ℓ) applied in harmonic space for map visualization. Signal estimated from power spectrum minus high-ℓ noise floor. Not used for analysis — purely for showing coherent structure in ACT/SPT κ maps on the RR2 footprint.",
      "createdAt": "2026-02-15T19:26:15.68423198+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "narrative-dag-removed-e50b7778",
      "title": "Narrative DAG: removed infrastructure dependencies from tapestry fibers",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Removed 29 non-narrative dependencies from 18 tapestry fibers. Cleaned: first-lensmc-bin1-x-act (12 fibers), theory-c-ℓ-computation (5), cmb-kappa-x-systematic-null (3), first-systematic-null-test (2), nla-intrinsic-alignment-cb1dea0b (2), individual-cross-spectrum-plots (1), research-tapestry-inspectable (2), likelihood-input-builder (1), catalog-cross-spectra-validate (1). Kept: nla-intrinsic-alignment-theory-57e37bd1 (doc fiber, theory context), act-systematic-bias-exceeds (question, motivates deprojection), spatial-variation-test-two (approach decision), map-visualization-diagonal (methodology). Tapestry DAG now has 47 internal edges and 4 intentional non-tapestry deps. Infrastructure provenance preserved in original fibers.",
      "createdAt": "2026-02-15T19:45:15.744378155+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "contamination-metric-reframed-2bb6650e",
      "title": "Contamination metric reframed",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Retitled from negligible to per-bandpower bias. Body updated to frame per-bandpower smallness as misleading when integrated.",
      "createdAt": "2026-02-15T19:48:45.230322358+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "closed-inspectable-tapestry-76210df8",
      "title": "Closed inspectable tapestry spec after 31 iterations",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "research-tapestry-inspectable-fef1295c closed. Achieved: 31 nodes, 175 plots, all evidence fresh, DAG wired, fiber bodies substantive. Superseded by narrative-tapestry-compress-31-6c42a4d6 which shapes the same tapestry for comprehensibility. Same object, different concern — inspectable vs navigable.",
      "createdAt": "2026-02-15T20:14:44.03651646+01:00",
      "closedAt": null,
      "dependsOn": [
        "research-tapestry-inspectable-fef1295c",
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "cmbx-felt-has-no-version-control-41fe0e18",
      "title": "cmbx .felt/ has no version control",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "outcome": "94 fibers at cmbx/.felt/ are not git-tracked. Workflow code (Snakefile, scripts, config) tracked in code/dr1_notebooks repo. .felt/ and CLAUDE.md at project root have no repo. Low priority — cluster storage is reliable, fibers are working state. Revisit if collaboration or backup needed.",
      "createdAt": "2026-02-15T20:14:47.648231901+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "wiener-filter-diagnostic-plot-w-14438464",
      "title": "Wiener filter diagnostic: plot W(ℓ) and power spectra for ACT/SPT κ",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Plot W(ℓ) = C_signal / (C_signal + C_noise) for the ACT and SPT κ maps used in the field overview. The current filter estimates signal and noise from the map power spectrum itself — worth visualizing what it's actually doing.\n\n**Scope**: CMB lensing maps only (not shear).\n\n**Motivation**: The field overview shows ACT κ with too much small-scale power — the Wiener filter isn't suppressing noise properly for ACT, while SPT looks clean. Since noise is estimated directly from the map, the filter should work for both — but something is going wrong for ACT. The W(ℓ) plot will likely reveal what: maybe the signal/noise crossover is at a different ℓ than expected, or ACT's noise power spectrum has structure that the empirical estimator mischaracterizes.\n\nIf the Wiener filter can't be fixed for ACT, fall back to Gaussian smoothing. But diagnose first.\n\n**Deliverables:**\n- Plot C_signal, C_noise, C_total for ACT and SPT κ maps\n- Overlay the Wiener filter W(ℓ) = C_signal / (C_signal + C_noise)\n- For ACT/SPT: compare against Planck 2018 C_ℓ^{κκ} as the signal model and reconstruction noise N0\n- This adds a second plot to the field overview node — harmonic-space content of the filter alongside the real-space maps\n- If needed: fix the ACT filtering or switch to Gaussian smoothing",
      "outcome": "Diagnosed and fixed. Empirical Wiener filter fails for ACT: reconstruction noise 25× higher than SPT, pseudo-Cl never exceeds noise floor → W(ℓ) ≈ 0 everywhere. Root cause: CMB lensing auto-spectrum noise-dominated (expected). Fix: theory-informed filter using Planck 2018 C_ℓ^{κκ} as signal model, noise estimated from map residual. SPT ℓ_{1/2}=353. ACT W<0.5 everywhere but sufficient for visualization. Diagnostic plot (3 panels: spectra, empirical W, theory W) + updated field overview with theory-informed filter implemented.",
      "createdAt": "2026-02-15T20:34:26.379991688+01:00",
      "closedAt": "2026-02-16T00:01:00.461982756+01:00",
      "dependsOn": [
        "data-euclid-act-spt-7d4e8847"
      ]
    },
    {
      "id": "a-lens-naming-fitted-amplitude-c5d1c543",
      "title": "A_lens naming: fitted amplitude is lensing multiplier, not IA",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "The amplitude fitted against theory is A_lens = data / (Planck 2018 + NLA IA). A_IA is a fixed nuisance parameter baked into the prediction. A_lens = 1 means agreement. Rename from A_hat/A_hat_ia across scripts, evidence, and fiber bodies.",
      "createdAt": "2026-02-15T20:43:54.445932965+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "blinding-current-analysis-fine-fbc01da4",
      "title": "Blinding: current analysis fine internally, don't push further",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "We're not in the 3x2pt pipeline group, so fixed-cosmology amplitude fits are fine as internal diagnostics. Don't share broadly. Don't fit Omega_m or S_8. TR1 Stage B allows theory comparison; amplitude fitting is at the boundary. Current tapestry stays internal.",
      "createdAt": "2026-02-15T20:44:03.334142241+01:00",
      "closedAt": null,
      "dependsOn": [
        "cmbx-3x2pt-blinding-strategy-d2469de7",
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "tapestry-titles-finding-9298fa42",
      "title": "Tapestry titles: finding-oriented rather than method-oriented",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "16 tapestry fiber titles rewritten to communicate findings. Entry points use 'The X' pattern. Consistency/null/contamination/theory nodes name their conclusions in the title. Titles now read as a scannable summary of the analysis state. References between fibers use tapestry tags (stable), not titles.",
      "createdAt": "2026-02-15T21:05:06.133031383+01:00",
      "closedAt": null,
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6"
      ]
    },
    {
      "id": "tapestry-iteration-open-fibers-b1115ae0",
      "title": "Tapestry iteration: open fibers and refinement",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "The tapestry is a feedback surface between agent and scientist. Each iteration turns tokens into something inspectable — an honest, digestible view of what the analysis is doing, what's working, what's not. The scientist sees it, responds, and the loop tightens.\n\nThe goal isn't narrative polish. It's advancing the analysis itself — closing open questions, running new checks, extending coverage — and keeping the tapestry honest about what was found.\n\n## Desired State\n\nThe analysis improves. Each iteration: survey ALL open fibers (`felt ls` — not just `felt downstream`, which only shows fibers linked to this spec), close what can be closed through work, and update the tapestry to reflect reality.\n\nWhen open items run out, curiosity drives the next question. The project scope (`docs/spt_euclid_proposal.md`) and the reference papers define what a complete analysis looks like. Read them. Find the gaps between what we've done and what they did. File new fibers for what's missing. The tapestry grows by discovering what it lacks.\n\nAfter new work, update affected tapestry nodes. Keep the principles: finding-oriented titles, spectral plots, prose bodies, cross-links. Grow the tapestry only when new work warrants it.\n\n### Code health\n\nThe codebase grew through 30+ iterations. When the open-fiber queue is light or at the end of an iteration, run a code-simplification pass using subagents:\n\n1. **Launch** several Explore subagents in parallel to audit different parts of the codebase — scripts, config, Snakefile rules, shared utilities. Each checks for: duplicated logic, hardcoded values that belong in config, copy-pasted functions, inconsistent patterns.\n2. **Synthesize** their findings into a concrete list of refactors.\n3. **Implement** the changes: extract shared utilities, consolidate config, DRY up repeated patterns.\n\nPrinciples:\n- **Single source of truth**: Parameter values live in `cmbx/files/config_config.yaml`, not hardcoded in scripts. Cosmological parameters, ℓ ranges, bin counts, file paths — one place.\n- **DRY**: If three scripts compute Knox covariance the same way, that's one function in a shared module.\n- **Maintainable structure**: The pipeline needs to survive handoff to collaborators and DR1.\n\nThis is not optional background work — when no analysis fibers are immediately actionable, code simplification IS the work.\n\n### Done\n\nRun until all open fibers and avenues have been addressed. Progress = open fibers closed, analysis extended, tapestry honest about the current state.\n\n## Assumptions\n\n- **A_lens is the measurement.** A_lens = data / (Planck 2018 ΛCDM + NLA IA). A_lens = 1 means agreement. A_IA is a fixed nuisance parameter, not a result.\n- **Blinding.** Fixed-cosmology A_lens fitting is fine internally. No Ω_m, S_8 fits. Don't share broadly.\n- **Plots carry data.** Spectra, residuals, correlation coefficients — not summary heatmaps. The reader sees the data.\n- **Read plots sparingly.** Max 5 images per session.\n- **Node discipline.** 1–5 plots per node. Prose bodies. Evidence at `results/claims/{specName}/evidence.json`.\n- **Cross-links.** Use markdown links to `.felt/` files so they render as clickable in the dashboard: `[field overview](.felt/the-sky-act-spt-and-euclid-on-706364a6.md)`. Not backtick `tapestry:` references.\n- **Trust the DAG.** Never suppress reruns. Recomputation is cheap, stale results are not.\n\n## Context\n\n### Project scope and references\n\n- **Proposal**: `docs/spt_euclid_proposal.md` — full 3×2pt scope (δκ, γκ, κκ), deliverables, team\n- **MoU fiber**: `spt-euclid-mou-collaboration-6de6bc54`\n- **DES×SPT×Planck methods**: `cmbx/files/docs_papers_2203.12439_des_spt_planck_methods_main.tex`\n- **DES×SPT×Planck correlations**: `cmbx/files/docs_papers_2203.12440_des_spt_planck_correlations_main.tex`\n- **DES×SPT×Planck constraints**: `cmbx/files/docs_papers_2206.10824_des_spt_planck_constraints_main.tex`\n- **ACT×DES shear**: `cmbx/files/docs_papers_2309.04412_act_des_shear_main.tex`\n\n### Current analysis state\n\n`felt show findings-synthesis-euclid-cmb-03354e57` — the comprehensive narrative.\n\nKey numbers: 20σ/21σ raw → 15σ/14σ marginalized. Four consistency tests pass. Three null tests pass. Stellar density contaminates ACT (boosts signal). Template marginalization corrects. SPT 24% deficit — scale-dependent, intrinsic, open.\n\n22 tapestry nodes, 31 PNGs, 8 narrative regions. All evidence fresh.\n\n### Doc fibers\n\n- `systematic-contamination-five-f509e962` — five-layer contamination methodology\n- `spt-deficit-characterization-6b724e41` — SPT deficit characterization\n- `namaster-technical-patterns-60d42621` — NaMaster conventions\n- `snakemake-workflow-discipline-88f4f4f8` — DAG discipline\n- `nla-intrinsic-alignment-theory-57e37bd1` — NLA IA model\n\n### Files\n\n- **Snakefile**: `workflow/Snakefile` + `cmbx/files/workflow_rules_explorations.smk`\n- **Scripts**: `workflow/scripts/plot_*.py`, `workflow/scripts/compute_*.py`\n- **Evidence**: `cmbx/files/workflow_scripts_aggregate_evidence.py`, `results/claims/{specName}/`\n- **Config**: `cmbx/files/config_config.yaml`\n- **Mass map download**: `inputs/euclid/download_tr1_systematics.sh` (adapt URL for 2D_MASS)\n\n### Execution\n\nComputational work → Snakemake → SLURM (`-j20` for batch). Plot scripts are localrules. Never load large maps on the login node.\n\n## Skills\n\n- `/tapestry` — fiber ↔ evidence ↔ plot conventions\n- `/snakemake` — rules, execution, localrules\n- `/data-visualization` — figure design\n- `/felt` — fiber management, dependencies\n- `/implementing-code` — script development\n\n## Evidence\n\n- Open fibers: `felt ls`\n- Plot inventory: `for d in results/claims/*/; do echo \"$(ls \"$d\"/*.png 2>/dev/null | wc -l) $(basename \"$d\")\"; done | sort -rn`\n- Tapestry tags: `grep -rh 'tapestry:' .felt/*.md | grep -oP 'tapestry:\\w+' | sort -u`\n- Evidence freshness: check mtimes against upstream chain\n\n## Comments\n**2026-02-15 23:41** — Cross-references between tapestry fibers should use markdown links to the .felt/ files so they render as clickable links in the dashboard. E.g. [field overview](.felt/the-sky-act-spt-and-euclid-on-706364a6.md) rather than backtick tapestry:plot_field_overview references. Update fiber bodies to use this pattern.",
      "outcome": "20 iterations complete. Tapestry: 22 nodes, 31 PNGs, all evidence fresh, all plots rebuilt after bin centralization. Analysis: γκ 20σ/21σ raw → 15σ/14σ marginalized, δκ 10-11σ marginalized, 4 consistency tests pass, 3 null tests pass, 5-layer systematic analysis with template marginalization. κκ blocked on RDN0+N1. Code health: TOM_BINS centralized (78→2 canonical definitions), fit_amplitude/load_systematic_map extracted to shared utilities, plot_utils adopted by 30+ scripts. Open items transferred to standalone fibers: catalog-based default (decision), SPT summer descoping (question), TR1 B-modes (external).",
      "createdAt": "2026-02-15T23:31:14.185122678+01:00",
      "closedAt": "2026-02-16T08:49:23.428183656+01:00",
      "dependsOn": [
        "narrative-tapestry-compress-31-6c42a4d6",
        "wiener-filter-diagnostic-plot-w-14438464",
        "mass-maps-at-v1-4-path-not-v2-1-fdc14589",
        "de-narrativize-tapestry-fiber-87162316"
      ]
    },
    {
      "id": "apodization-masks-what-enters-f6b5a581",
      "title": "Apodization masks: what enters the cross-correlations",
      "status": "closed",
      "kind": "task",
      "tags": [
        "region:methodology"
      ],
      "body": "Every NaMaster cross-spectrum multiplies two masks into the data before coupling matrix estimation. The CMB κ side gets `nmt.mask_apodization(mask, 0.15, \"C2\")` — a smooth cosine-squared taper that zeroes the field beyond the mask boundary. The shear side gets `apodize(weight > 0, 0.15, \"C2\") * weight` — the same taper applied to the binary footprint, then multiplied by the galaxy weight map. The weight map encodes inverse shape-noise variance per pixel, so the effective mask is spatially varying even within the apodized boundary.\n\nThese masks define the effective sky fraction that enters the Knox covariance: `fsky_eff = ⟨w₁w₂⟩² / ⟨w₁²w₂²⟩` (Hivon 2002). The C2 apodization with 0.15 rad (~8.6°) scale reduces fsky relative to the raw footprint but suppresses mode-coupling from sharp mask boundaries.\n\nThe figure shows raw vs apodized for all three masks: ACT, SPT, and shear weights. ACT's mask is broader (fsky ≈ 0.25) and fills both RR2 patches. SPT's mask is compact (fsky ≈ 0.04) and covers only the south patch. The shear weight map defines the Euclid galaxy density, with highest weights at the survey overlap centers and tapering at the edges.\n\nCross-ref: [field overview](.felt/the-sky-act-spt-and-euclid-on-706364a6.md) shows the data on these masks. The `namaster-technical-patterns-60d42621` doc fiber documents the C2 apodization convention and its origin in gctools.",
      "outcome": "24 tapestry nodes. Apodization masks visualized: ACT (fsky 0.248, 10225 deg²), SPT (fsky 0.044, 1804 deg²), shear (fsky 0.009, 385 deg²). C2 apodization at 0.15 rad preserves mask area — ACT mean weight drops only 0.4%. Shear weights multiplied after apodization (apodize(w>0) × w). Plot shows raw vs apodized for both RR2 patches.",
      "createdAt": "2026-02-15T23:40:28.836985844+01:00",
      "closedAt": "2026-02-16T00:36:36.949592583+01:00",
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd",
        "data-euclid-act-spt-7d4e8847"
      ]
    },
    {
      "id": "spt-ℓ-100-spike-suspicious-ed5a480a",
      "title": "SPT ℓ≈100 spike: suspicious single bandpower in cross-spectra",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Single bandpower at ℓ≈84.5 spikes in 5/6 SPT bins. Confirmed as real, CMB-side, SPT-specific. Now investigate the origin.\n\n## What we know\n\n- Present in both γκ (shear) and δκ (density) — completely different galaxy fields, so not galaxy-side\n- Present in all 4 SPT estimators (GMV/TT/PP/MV) — not foreground-specific\n- Both shear methods agree — not shear-measurement artifact\n- B-modes clean — not E→B leakage\n- Amplitude tracks lensing kernel (scales with bin) — real signal, not additive noise\n- NOT present in ACT\n- **Must originate from our treatment of the SPT κ map** — the only element common to all affected cross-spectra\n- Likely the dominant driver of SPT scale-dependent A_lens suppression\n\n## Investigation: apodization as cause\n\nThe SPT CMB κ map still uses an apodized mask even in catalog-based cross-spectra — the CMB side is always map-based. SPT's winter field mask has sharp boundaries at small fsky (~0.27% in overlap). Apodization mode-coupling at ℓ≈100 could inject power at this specific angular scale.\n\nTests:\n- Vary SPT mask apodization width (current: 0.15 deg C2). Try 0.05, 0.10, 0.25, 0.30. Does the spike move or change amplitude?\n- Compare SPT mask power spectrum to ACT mask power spectrum — look for excess power at ℓ≈100 in the SPT mask\n- Check the NaMaster coupling matrix at this bandpower — is there anomalous mode-mixing?\n- Compute the cross-spectrum with NO apodization (binary mask only) — does the spike persist?\n\nIf the spike is apodization-induced, it should respond to apodization width changes. If it's intrinsic to the SPT κ reconstruction, it won't.\n\n## Not in the SPT data\n\nThe spike is not intrinsic to the SPT κ maps — it's something in our analysis setup. This rules out SPT reconstruction artifacts and sky features. Focus entirely on our masking/apodization/binning pipeline.\n\n## Comments\n**2026-02-18 02:43** — Spike confirmed in both γκ (shear) and δκ (density) cross-spectra. Since these use completely different galaxy fields, the spike must originate from the SPT κ map treatment — our masking/apodization of the SPT map, not the galaxy side. Also absent in ACT, so it's SPT-specific processing, not a sky feature.",
      "outcome": "Confirmed. Single bandpower at ℓ=84.5 spikes in 5/6 SPT bins (Knox S/N = 3.4–5.1σ, 3.8–5.4× neighbor average). NOT present in ACT. Key diagnostics: (1) All 4 SPT estimators (GMV/TT/PP/MV) agree within ~20% — not foreground-specific. (2) Both shear methods agree — not shear-measurement artifact. (3) B-modes clean (|B/E| = 0.07–0.26) — not E-B leakage. (4) Amplitude scales with redshift bin (3e-8 to 1.1e-7, bin 1→6) — tracks lensing kernel, not additive noise. Origin is CMB-side, SPT-specific. Likely SPT κ transfer function or mask mode-coupling at this angular scale. This single bandpower is probably the dominant driver of the scale-dependent amplitude behavior in the ℓ-range robustness test (low-ℓ amplitude inflation → A_lens suppression at full range). Downstream implication: excluding this bandpower from SPT fits would likely reduce the SPT deficit.",
      "createdAt": "2026-02-15T23:46:19.195937813+01:00",
      "closedAt": "2026-02-18T18:09:21.42355922+01:00",
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0",
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "default-to-catalog-based-e4dce945",
      "title": "Default to catalog-based estimator with configurable fallback",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "Switch the default cross-spectrum estimator from map-based (`NmtField`) to catalog-based (`NmtFieldCatalog`) for both shear (γκ) and density (δκ). Config flag so map-based remains available as fallback.\n\n## Rationale\n\nCatalog-based avoids pixelization effects and map-making entirely — one fewer step between galaxies and spectra. Validation showed agreement with map-based at correlation 0.986–1.000 across 28 shear spectra.\n\n## Desired state\n\n- `config.yaml` has `cross_correlation.estimator: catalog` (default) with `map` as fallback.\n- `compute_cross_spectrum.py` has a catalog branch for field creation: when `estimator == \"catalog\"`, shear uses `NmtFieldCatalog` (reads WL parquet catalog directly), density uses `NmtFieldCatalog` with spin-0 (reads GC catalog). Everything else — Knox covariance, Gaussian covariance, evidence, output format, patch masks — unchanged.\n- The Snakefile rule adds the catalog as an input when `estimator == \"catalog\"`, keeps map inputs when `estimator == \"map\"`.\n- Wall-clock times logged for both estimators on a representative subset (e.g., lensmc bin1 × ACT). Outcome records the comparison.\n- Full DAG rebuild completes cleanly (`snakemake -j20`). All 28 shear + 12 density cross-spectra recomputed. Downstream plots, evidence, tapestry all fresh.\n\n## Context\n\n- Production script: `cmbx/files/workflow_scripts_compute_cross_spectrum.py` — handles shear (spin-2), density (spin-0), SKSP, patch masks, Knox + Gaussian covariance.\n- Catalog validation script: `workflow/scripts/compute_catalog_cross_spectrum.py` — thin, shear-only, no covariance, no evidence. Lives in `explorations.smk`. Reference for `NmtFieldCatalog` usage patterns.\n- Catalog paths: WL `{catalog_dir}/{vcat}.parquet`, GC `{catalog_dir}/catalogRR2_v2_GC_031124.parquet`.\n- `NmtFieldCatalog` signature: `nmt.NmtFieldCatalog(pos=[ra,dec], weights, fields=[-e1,e2], lmax, spin=2, lonlat=True)`. For density spin-0: `fields=[overdensity]`.\n- Memory: ~64GB for ~5M shear galaxies at lmax=3000. Density has ~1.2M galaxies/bin — should be lighter.\n- Knox covariance comes from auto-spectra of the *fields*, which `NmtFieldCatalog` supports via `compute_coupled_cell`. No change to Knox formula needed.\n- SKSP/SKS mass maps stay map-based (no catalog equivalent).\n\n## Approach\n\nBranch inside `compute_cross_spectrum.py`, not a separate script. The field creation is the only thing that changes — everything downstream (workspace, decoupling, covariance, evidence) is field-agnostic.\n\n## Covariance\n\nKnox covariance uses auto-spectra of the fields passed to it. With `NmtFieldCatalog`, the auto-spectra include shot/shape noise naturally. No special handling needed.\n\nGaussian covariance: `nmt.gaussian_covariance` needs `NmtField`-type masks for the covariance workspace. With `NmtFieldCatalog`, the mask is implicit. Check whether `get_cov_workspace` works with catalog fields — if not, fall back to map-based masks for covariance only.\n\n## Benchmark\n\nRun both estimators on lensmc bin1 × ACT. Log wall-clock time (field creation, workspace, cross-spectrum, total). Record in fiber outcome.\n\n## Done when\n\n1. Config flag exists and defaults to `catalog`.\n2. Both shear and density cross-spectra use catalog-based field creation.\n3. Wall-clock benchmark recorded.\n4. Full DAG rebuild clean. All downstream evidence fresh.\n5. `compute_catalog_cross_spectrum.py` and its exploration rules can be retired (or marked deprecated).\n\n## Skills\n\nActivate `/snakemake` and `/tapestry` within each iteration. Run the code simplifier plugin.",
      "outcome": "Catalog-based estimator is now the default for shear cross-spectra (lensmc, metacal). Config flag: cross_correlation.estimator: catalog. Map-based remains default for density.\n\nImplementation:\n- config/config.yaml: added estimator: catalog under cross_correlation\n- workflow/Snakefile: get_euclid_map_files() returns {catalog: path} for shear when estimator=catalog; added get_euclid_map_files_always_map() for systematic/patch/overlap rules that must use map-based inputs; compute_cross_spectrum rule uses 64GB mem (NmtFieldCatalog needs ~64GB for ~5M galaxies at lmax=3000)\n- workflow/scripts/compute_cross_spectrum.py: catalog branch loads parquet catalog, filters bad tiles and tomographic bin, subtracts additive bias, creates NmtFieldCatalog(pos=[ra,dec], w, [-e1,e2], lmax, spin=2, lonlat=True); analytical Knox proxy using catalog shape noise statistics N^EE = (σ²_e1+σ²_e2)/(2*n_eff_sr); Gaussian covariance skipped (not supported for catalog fields)\n- workflow/scripts/nmt_utils.py: compute_knox_variance handles NmtFieldCatalog.get_mask() ValueError via try/except\n\nResults:\n- 70 shear spectra computed (lensmc×6bins×act/gmv/tt/pp/mv + metacal×6bins×5cmbk + binall×5cmbk×2 methods)\n- Knox median SNR=20.74, all 70 detected >5σ\n- Downstream plots regenerated: act_vs_spt, theory_comparison, method_comparison all complete\n- Wall clock: ~3-4 min per job at lmax=3000\n\nKnown limitation (filed as knox-proxy-for-catalog-shear-c57104cd):\nKnox proxy uses N^EE (shape noise only) as C^EE estimate. For a deep survey where C^EE_signal >> N^EE, this underestimates Knox variance → inflated SNR. The cross-spectrum data (cl, bpws) in the NPZ is correct; only the SNR proxy is affected. The likelihood A±σ_A is the authoritative detection metric.",
      "createdAt": "2026-02-15T23:48:05.29508455+01:00",
      "closedAt": "2026-02-18T05:33:53.500464033+01:00",
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0",
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "spatial-variation-overlap-vs-78b94be6",
      "title": "Spatial variation: overlap vs non-overlap instead of north-south",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Replace the current north-south spatial variation test with an overlap-based split. The key region is the **ACT+SPT overlap** — the only place where both CMB experiments see the same galaxies.\n\nThree natural regions of the shear footprint:\n\n1. **ACT-only** — where ACT κ overlaps shear but SPT doesn't\n2. **ACT+SPT overlap** — where both CMB experiments cover the shear field\n3. **SPT-only** — where SPT κ overlaps shear but ACT doesn't\n\nThe overlap region enables the strongest consistency test: same galaxies, two independent CMB pipelines. Any difference between ACT×shear and SPT×shear in the overlap is purely CMB-side.\n\nImplementation: pixel-level mask overlap to determine region sizes, then cross-spectra per region. First step: count pixels in each region to assess feasibility (need enough modes for meaningful bandpowers). Reuses `compute_cross_spectrum.py` with `patch_mask` input.\n\nSupersedes the current north-south approach (which was ACT-only anyway since SPT's winter field doesn't reach the north patch).",
      "outcome": "Overlap test implemented and computed. Three regions: ACT-only (0.47% fsky, 235k px), ACT+SPT overlap (0.27% fsky, 133k px), SPT-only (0.08% fsky, 39k px). In the overlap region: joint chi2/dof = 1.01 (120 dof), PTE = 0.456. 5/6 bins pass, bin 6 marginal (PTE = 0.022). ACT and SPT are statistically identical on the same sky. Supersedes north-south split (which was ACT-only anyway). Knox SNR: ACT median 10σ, SPT median 8.3σ in overlap alone.",
      "createdAt": "2026-02-15T23:49:54.364047948+01:00",
      "closedAt": "2026-02-16T01:15:06.137339991+01:00",
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0",
        "spatial-variation-test-two-efde7911"
      ]
    },
    {
      "id": "template-deprojection-verify-aba0d269",
      "title": "Template deprojection: verify methodology against DES×SPT paper",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "The current template deprojection/marginalization methodology isn't well documented in the fiber bodies, and it's unclear whether our implementation matches the DES×SPT approach (2203.12440, Appendix A.4).\n\n**Tasks:**\n1. Read our `plot_deprojected_spectra.py` and `evaluate_deprojected_likelihood.py` — document exactly what we're computing, step by step.\n2. Read the DES×SPT correlations paper (2203.12440), specifically the contamination metric and template deprojection methodology.\n3. Compare: are we doing the same thing? If not, where do we diverge and why?\n4. Update the deprojection fiber bodies to clearly explain the methodology.\n\nKey concern: naive template subtraction (d' = d - X) injects noise. We switched to Fisher marginalization (d = A*theory + Σ α_S*X_S), which should be correct — but verify the implementation matches the formalism and the DES precedent.",
      "outcome": "Verified. Our X^f_S(ℓ) = C^{κS}·C^{fS}/C^{SS} is the harmonic equivalent of DES×SPT Eq. A.4.1 (same formula, different space). Key difference: DES found all systematics negligible (1-2 orders below noise), so they never needed subtraction or marginalization. We found stellar density/galactic extinction are significant for ACT (up to 8σ integrated bias budget), requiring template marginalization. Our Fisher matrix approach (d = A·theory + Σ α_S·X_S) is standard CMB foreground marginalization — no DES precedent because they didn't need it. Naive subtraction correctly identified as noise-injecting (X^T·C^{-1}·X >> 2·d^T·C^{-1}·X). Implementation is correct and more thorough than DES×SPT. Full mathematical documentation in methods-comparison-des-spt-vs-53d89a30.",
      "createdAt": "2026-02-15T23:54:18.401154557+01:00",
      "closedAt": "2026-02-16T00:13:07.696046164+01:00",
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0",
        "template-deprojection-a1621797"
      ]
    },
    {
      "id": "systematic-maps-on-the-sky-83122c03",
      "title": "Systematic maps: complete inventory and visualization of all VMPZ-ID maps",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_systematic_maps",
        "region:methodology"
      ],
      "body": "Visualize every systematic map available from the VMPZ-ID mosaic masks pipeline. Currently we plot 2 (stellar density, galactic extinction) and run null tests on 5 (adding exposures, zodiacal light, SAA). But 20 map types sit on disk — we should know what they all look like, and whether any we're ignoring correlate with our signal.\n\n## Inventory\n\nAll maps at `inputs/euclid/tr1_pic/VMPZ_ID/MOSAIC_MASKS/`. Sparse HEALPix FITS, nside 16384, NESTED.\n\n### Currently configured (5)\n\n| Key | Map type | Status |\n|-----|----------|--------|\n| stellar_density | STARNUMBERDENSITY | Plotted, null tested, dominant ACT contaminant |\n| galactic_extinction | GALACTICEXTINCTION | Plotted, null tested, second ACT contaminant |\n| exposures | EXPOSURES | Null tested, clean |\n| zodiacal_light | ZODIACALLIGHT | Null tested, clean |\n| saa | SAA | Null tested, clean |\n\n### Available but unused (15 types)\n\n| Map type | Files | Relevance |\n|----------|-------|-----------|\n| PSF | 13 | **High** — PSF variation directly affects shear measurement |\n| NOISE | 13 | **High** — read noise affects shape measurement S/N |\n| PERSISTENCE | 3 | **Medium** — detector persistence could bias shapes |\n| STARBRIGHTNESSMEAN | 3 | **Medium** — bright stars affect nearby galaxy shapes |\n| STARBRIGHTNESSRMS | 3+ | **Medium** — star brightness variability |\n| GALAXYNUMBERDENSITY | 2 | Useful check — galaxy density itself |\n| GALAXYNUMBERDENSITYNEGVISFLUX | 2 | Subset of above |\n| GALAXYHFLUXERR | 2 | **Medium** — H-band flux error affects photo-z |\n| GALAXYRELPHZSEVENTYMEAN | 2 | **Medium** — photo-z quality affects tomographic binning |\n| GALAXYRELPHZSEVENTYRMS | 2 | **Medium** — photo-z scatter |\n| GALAXYRELPHZSEVENTYSTD | 2 | **Medium** — photo-z scatter |\n| AA | 1 | Low — ambient conditions |\n| BA | 1 | Low — background level |\n| TILE | 1 | Low — tile boundaries |\n\nPSF and noise are the most important additions. PSF variation is the classic shear systematic. Noise depth affects shape measurement variance spatially.\n\n## Desired state\n\n- One sky-projection plot per systematic map type (pick the most recent/complete version of each type).\n- All plots in composites grouped by category (observing conditions, stellar, galaxy properties, detector).\n- `config.yaml` updated with all usable maps.\n- Null tests extended to new maps (at least PSF, noise, persistence).\n- Blockers noted for any maps that can't be loaded.\n\n## Blockers to investigate\n\n- PSF maps: 13 files suggests per-component or per-exposure. Need to understand file naming to pick the right aggregate.\n- NOISE: same — 13 files, likely per-detector or per-band.\n- Some maps may not overlap RR2 or be all-zero in our region.\n\n## Approach\n\n1. Inventory all files, load each, check coverage on RR2 footprint.\n2. Plot each on the sky (RR2 zoom, matching field overview style).\n3. Add promising ones to config and run null tests.\n4. Update the tapestry node with comprehensive visualization.",
      "outcome": "All 11 VMPZ-ID systematic maps visualized on the RR2 footprint in a single 11×2 composite (north/south patches). Maps: stellar density, galactic extinction, exposures, zodiacal light, SAA, PSF, noise, persistence, star brightness mean, galaxy number density, photo-z quality. All loaded from sparse FITS nside 16384, downgraded to 2048 (phz_quality at nside 1024 upgraded). Null tests (tracer × sysmap: 462 spectra) and CMBk × sysmap cross-spectra (110 spectra) already computed for all 11 maps. Evidence with per-map statistics (median, p10, p90, frac_nonzero) in results/claims/plot_systematic_maps/evidence.json.",
      "createdAt": "2026-02-15T23:54:20.416058525+01:00",
      "closedAt": "2026-02-18T19:12:15.78844008+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "audit-purge-ia-framing-from-fc68b53d",
      "title": "Audit: purge IA framing from plots — A_lens is the measurement",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Sweep all theory-related plots and scripts for residual IA framing. The decision (`a-lens-naming-fitted-amplitude-c5d1c543`): IA is a fixed nuisance parameter baked into the theory prediction. The fitted quantity is A_lens = data / (Planck 2018 + NLA IA). Plots should not imply that IA is being fitted or that IA amplitude is a result.\n\n**What to look for:**\n- Plot labels/legends mentioning \"IA\" or \"A_IA\" as if it's a fitted parameter\n- Dual curves showing \"vanilla\" vs \"IA\" theory — the IA theory IS the theory now; vanilla is historical context at most\n- Axis labels or titles that frame the comparison as \"with/without IA\"\n- Any plot where the reader could conclude that IA treatment is the main finding rather than A_lens\n\n**The framing**: We show that NLA IA is included in the prediction (one sentence, one reference to the IA doc fiber). Then we fit A_lens. That's it. IA is like the n(z) or the cosmological parameters — an input, not a result.",
      "outcome": "All reader-facing plot labels purged of $\\hat{A}$ and $\\hat{A}_{\\rm IA}$ — replaced with $A_{\\rm lens}$ (NLA IA theory), $A_{\\rm van}$ (vanilla), or $A_{\\rm lens}^{\\rm marg}$ (marginalized). 16 instances across 6 scripts: plot_analysis_summary.py (3), plot_theory_residual_analysis.py (4), plot_ell_range_robustness.py (2), plot_deprojected_spectra.py (4), evaluate_deprojected_likelihood.py (2), generate_results_table.py (3 — caption + column headers in Tables 1 and 2). Internal variable names (A_hat, sigma_A) and evidence JSON keys unchanged — only reader-facing labels affected. Downstream rebuild required.",
      "createdAt": "2026-02-15T23:55:35.337077093+01:00",
      "closedAt": "2026-02-16T00:18:36.39445189+01:00",
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0",
        "a-lens-naming-fitted-amplitude-c5d1c543"
      ]
    },
    {
      "id": "theory-prediction-audit-07c96181",
      "title": "Theory prediction audit: document inputs, code, and assumptions",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Document exactly what goes into the theory C_ℓ^{Eκ} prediction, end to end. The scientist should be able to read this fiber and understand precisely what's being compared to the data.\n\n**Questions to answer:**\n- **Cosmological parameters**: Which Planck 2018 chain/best-fit? TT+TE+EE+lowE? TTTEEE+lensing? Which specific parameter values?\n- **n(z)**: Which file? How are the 6 bins used — directly from `RR2_v2_Nz_WL_C2020_sel_pv.fits` or resampled/smoothed? Sum-normalized?\n- **Lensing kernel**: CCL `WeakLensingTracer` — what inputs? How is the CMB κ kernel constructed?\n- **IA model**: NLA-z via CCL's `use_A_ia=True` — confirm A_IA=1.72, η=-0.41 are from the Euclid pipeline (which reference?).\n- **Power spectrum**: CCL's `angular_cl`? Limber approximation? What ℓ range? Halofit for nonlinear matter P(k)?\n- **Code path**: `compute_theory_cls.py` → which CCL/CAMB functions specifically?\n- **What's NOT included**: baryonic feedback, m-bias, photo-z shifts, higher-order lensing corrections. (Some of this is in the `theory-model-completeness` doc fiber — consolidate.)\n\nThe output should be a clear, readable doc fiber or update to the existing theory fibers.",
      "outcome": "Audited the full theory prediction pipeline. Code path: compute_theory_cls.py → eDR1like.theory.Theory(theory_provider='ccl') → ccl.angular_cl.\n\n**Cosmology**: Planck 2018 base plikHM TTTEEE+lowE+lensing+BAO (defaults.py). Key params: A_s=2.105e-9, n_s=0.9665, H0=67.66, Ω_c=0.261, Ω_b=0.049, m_ν=0.06 eV.\n\n**CCL setup**: Cosmology(**cosmo_ccl) with NO explicit transfer_function or matter_power_spectrum — defaults to Boltzmann (CAMB) + Halofit. NOT HMCode. The CAMB HMCode+baryonic settings in defaults.py (mead2020, A_baryon=3.13) only apply when theory_provider='camb', which our pipeline does not use.\n\n**Tracers**: CMBLensingTracer(z_source=1089, n_samples=100). WeakLensingTracer(dndz, has_shear=True, n_samples=256, ia_bias=(z, A_IA*(1+z)^eta_IA)).\n\n**IA**: NLA-z via CCL use_A_ia=True. A_IA=1.72, η_IA=-0.41 (hardcoded in theory.py:163-165). CCL computes C_1·ρ_cr·Ω_m/D(z) internally.\n\n**Integration**: Limber (spline method). ℓ range: 2 to lmax=3000 (from config.yaml). Binned through NaMaster Bbl windows (bpws[0,:,0,:]) to match data bandpowers.\n\n**NOT included**: baryonic feedback (Halofit, not HMCode), shear calibration m-bias, photo-z shifts, higher-order lensing, source clustering. See theory-model-completeness-for-526d66a5 for impact estimates.",
      "createdAt": "2026-02-15T23:57:45.587677687+01:00",
      "closedAt": "2026-02-16T00:21:19.773603751+01:00",
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0",
        "nla-intrinsic-alignment-theory-57e37bd1"
      ]
    },
    {
      "id": "galaxy-density-cmb-lensing-δκ-a755afc3",
      "title": "Galaxy density × CMB lensing (δκ) cross-correlation",
      "status": "closed",
      "kind": "task",
      "tags": [
        "3x2pt",
        "delta-kappa"
      ],
      "body": "Galaxy density × CMB lensing is the second leg of the CMB lensing 3×2pt (alongside γκ and κκ). DES×SPT measured δκ at S/N=19.6 with 4 density bins; extrapolating to DR1 footprint gives expected combined S/N ≈ 60 (proposal estimate).\n\n## Data availability (all present)\n\n**GC catalog**: `inputs/euclid/catalogs/catalogRR2_v2_GC_031124.parquet` (304 MB). 7 tomographic bins via `pos_tom_bin_id`. Selection: vis_det=1, spurious_flag=0, phz_flags=0, star/galaxy separation via flux cuts.\n\n**Position n(z)**: `inputs/euclid/dndz/RR2_v2_Nz_GC_C2020_sel_pv.fits`. Same z-grid structure as shear n(z) (linspace 0→6, 3000 points). 7 bins.\n\n**CMB κ maps**: 5 experiments already loaded (ACT + 4 SPT variants).\n\n## Implementation path\n\n1. **Config**: Add `nz.pos`, GC catalog path, `pos_tom_bins: [1,2,3,4,5,6,7]` to config.yaml\n2. **Map building**: Extend `build_maps.py` for method=\"pos\" → weighted number count maps. Or write a thin `build_density_maps.py`. The v1.4 maps had `weighted_counts_map.fits` — use as template.\n3. **Cross-spectrum**: `compute_cross_spectrum.py` handles spin-2×spin-0. For spin-0×spin-0, need separate rule or parametrize spin. NaMaster's NmtField with spin=0 for density.\n4. **Galaxy bias**: Linear bias minimum (free b_g per bin). DES used both linear and nonlinear models with scale cuts.\n5. **Systematics**: Stellar density contamination is the primary concern (already quantified for γκ). Magnification effects needed for density (not for shear).\n6. **Theory**: Extend `compute_theory_cls.py` to include density×lensing predictions via CCL NumberCountsTracer.\n\n## Reference\n\n- DES×SPT (2203.12440): 6 MagLim bins, scale cuts for nonlinear bias, S/N=19.6\n- Proposal: \"validated harmonic-space data vectors and covariances for galaxy density x CMB lensing\"",
      "outcome": "12/12 δκ cross-spectra computed (6 bins × ACT + SPT GMV). All detected >5σ. ACT median Knox SNR=8.0σ, SPT median=8.8σ. Theory: Planck 2018 + SPV3 galaxy bias. ACT A_lens=1.005±0.060 (chi2=127/120, PTE=0.31). SPT A_lens=0.857±0.050 (14% deficit, 2.9σ). Systematic null tests: 24/24 fail (chi2/dof 27-72, PTE=0). Contamination metric: 3/4 systematics exceed signal level. Template marginalization (Fisher): ACT A_lens=0.934±0.086 (10.9σ, chi2/dof=0.94, PTE=0.65) — consistent after systematic cleaning. SPT A_lens=0.825±0.080 (10.2σ, chi2/dof=1.42, PTE=0.002) — deficit persists. Naive subtraction catastrophic (ACT→-0.521, SPT→0.271) confirming marginalization is essential for density. Systematic budget: S_bias=24-28σ/bin (ACT), dominated by exposures. SACC files generated for ACT+SPT. Signal overview + theory comparison + redshift trend + budget + deprojection plots generated.",
      "createdAt": "2026-02-16T00:02:07.921509141+01:00",
      "closedAt": "2026-02-16T05:55:42.191793391+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "cmb-lensing-auto-spectrum-κκ-752374df",
      "title": "CMB lensing auto-spectrum (κκ) for 3×2pt",
      "status": "closed",
      "kind": "task",
      "tags": [
        "3x2pt",
        "kappa-kappa"
      ],
      "outcome": "Pipeline implemented and tested (compute_kappa_spectrum.py, 3 Snakemake rules). Auto-spectra need RDN0+N1 (simple N0 insufficient). Cross-spectrum (ACT×SPT) anomalous at fsky=2.6%. Neither reference analysis included κκ in cosmological data vector. Infrastructure exists for future use when proper debiasing is available. See tapestry node cmb-lensing-power-spectrum-act-3832d477.",
      "createdAt": "2026-02-16T00:02:16.41328041+01:00",
      "closedAt": "2026-02-16T06:33:35.439184069+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "spt-summer-field-descoping-92c2cec0",
      "title": "SPT Summer field: descoping decision needed",
      "status": "closed",
      "kind": "task",
      "tags": [
        "3x2pt",
        "question"
      ],
      "outcome": "Descoped. Summer fields were never validated for cosmology and have no foreground hardening (TT-only, no GMV/MV/PP). Would need full validation + foreground hardening implementation before use. Winter-only for DR1.",
      "createdAt": "2026-02-16T00:04:48.607647267+01:00",
      "closedAt": "2026-02-18T01:52:59.565055167+01:00",
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "cross-shear-null-test-γ-κ-90e43c64",
      "title": "Cross-shear null test (γ_⊥ × κ)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "validation",
        "null-test"
      ],
      "body": "B-mode shear should not correlate with CMB κ — making B×κ a powerful null test for shear systematics. We implemented the test and discovered that **NaMaster Gaussian covariance (BB block) underestimates B-mode variance by ~15-150×**, rendering the analytic covariance unusable for this test.\n\n## Findings\n\n**The test ran, but the covariance is wrong.** All 12 bins (6 tomo × 2 CMB) show chi2/dof = 332-2897 with PTE≈0. B/E amplitude ratios range 0.20-0.96. The B×κ signal is dominated by E→B leakage from partial sky — expected behavior — but NaMaster's Gaussian covariance BB block doesn't capture the leakage contribution to variance.\n\n**No reference analysis uses NaMaster Gaussian for B-mode covariance.** ACT×DES (2309.04412) performed B×κ as a null test (PTE=0.81, passes all 4 bins) but used 511 simulations for covariance. DES×SPT (2203.12440) used real-space cross-shear (γ_⊥) instead of harmonic B-modes. Neither used `purify_b`.\n\n**Neither we nor gctools use `purify_b=True`.** Only `n_iter=1` (SHT convergence). Purification is a separate feature (Smith 2006) that deconvolves E→B leakage analytically. It would clean the B-mode estimate but doesn't fix the covariance issue.\n\n**E-mode spectra are not affected.** The 93% B/E ratio means the B-mode *estimate* is contaminated by leakage, but the MASTER deconvolution correctly recovers E-modes. The mode-coupling matrix handles this for E — it's only the B-mode that remains contaminated without purification.\n\n## What's needed to make this test work\n\n1. **Simulation-based covariance** (ACT×DES approach): Generate ~500 Gaussian shear + noise sims, cross-correlate with κ, measure B×κ scatter. Expensive but definitive.\n2. **Purification + Knox**: Enable `purify_b=True`, which should suppress E→B leakage enough that Knox (or Gaussian) covariance becomes adequate. Requires recomputation of all cross-spectra.\n3. **Empirical variance from data**: Use the jackknife framework to estimate B-mode scatter from data resampling.\n\n## Status\n\nRules implemented: `plot_bmode_null_test`, `aggregate_bmode_null_evidence`. Evidence at `results/claims/plot_bmode_null_test/`. The test infrastructure works — it just needs proper covariance. Blocked on covariance methodology decision.",
      "outcome": "B×κ null test passes with Knox BB covariance. ACT joint PTE=0.74, SPT joint PTE=0.86. All 12 bins pass at 5%. Knox formula with observed BB auto-spectrum (which includes E→B leakage) correctly captures B-mode variance — the key insight was that NaMaster Gaussian fails because it uses theoretical BB≈0, missing the dominant leakage. No simulations needed. Implemented via cl_auto1_binned[3]*cl_auto2_binned[0]/n_modes in plot_bmode_null_test.py.",
      "createdAt": "2026-02-16T00:05:24.113677032+01:00",
      "closedAt": "2026-02-16T06:48:18.635840501+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc",
        "tapestry-iteration-open-fibers-b1115ae0"
      ]
    },
    {
      "id": "methods-comparison-des-spt-vs-53d89a30",
      "title": "Methods comparison: DES×SPT vs CMBX pipeline",
      "status": "closed",
      "kind": "task",
      "tags": [
        "methodology",
        "doc"
      ],
      "body": "How our pipeline compares to the DES×SPT and ACT×DES CMB lensing cross-correlation analyses. This shapes priorities for DR1.\n\n## Covariance\n\n**DES×SPT**: Lognormal analytical model + 300 Flask noise simulations. Signal terms from shifted lognormal model; noise from realistic CMB+galaxy simulations. Required a 4% ad-hoc upscaling of γκ covariance to match chi2 distributions. Validated with jackknife (80 patches).\n\n**ACT×DES**: 511 lognormal simulations as primary, analytical Gaussian as cross-check. Agrees to ~0.5%. Hartlap correction applied (α ≈ 0.951).\n\n**Us**: Knox formula — `Var(C^{ab}_b) = C^{aa}_b · C^{bb}_b / n_modes` with effective fsky from Hivon 2002. Simpler, no tuning, validated empirically: sim null test shows empirical variance ratio 0.83 (Knox slightly conservative). NaMaster Gaussian covariance overestimates by 10-130× at our fsky~0.01, which is why Knox was adopted.\n\n**Gap**: No simulation-based covariance. Knox is sufficient for detection and null tests but insufficient for parameter inference (non-Gaussian terms, cross-bin correlations). For DR1 cosmological constraints, simulation covariance will be needed.\n\n## Intrinsic alignment\n\n**DES×SPT**: TATT model (5 parameters) — more general than NLA. Lensing ratio likelihood strongly constrains IA, improving S₈ by ~40%. Parameters from DES Y3 external priors.\n\n**ACT×DES**: NLA (2 parameters) with DES-Y1-derived priors. Prior-dominated at S/N=7.\n\n**Us**: NLA-z with fixed A_IA=1.72, η_IA=-0.41 (eDR1like defaults). Not fitted — baked into the Planck 2018 prediction as a nuisance correction. A_lens = data / (ΛCDM + NLA IA). IA suppression: 36% at bin 1, 4% at bin 6. Resolves most of the ACT amplitude deficit (0.83 → 0.93). See `nla-intrinsic-alignment-theory-57e37bd1`.\n\n**Gap**: TATT for DR1 cosmological constraints. NLA sufficient for current fixed-cosmology analysis.\n\n## Shear calibration\n\n**DES×SPT**: Explicit multiplicative bias m per bin, externally constrained (Gaussian priors from Y3). CMB cross-correlations independently constrain m to 5-10%.\n\n**ACT×DES**: External m priors from DES Y3.\n\n**Us**: No explicit m parameter. Instead: metacal vs lensmc consistency test ([method comparison](.felt/lensmc-vs-metacal-method-7d4d724f.md)). Agreement to chi2/dof=0.14 (correlated noise from shared galaxies+CMB) validates calibration cross-pipeline. Empirical validation, not a model parameter.\n\n**Gap**: Explicit m parameterization needed for DR1 parameter inference. Current consistency test is sufficient for fixed-cosmology analysis.\n\n## Scale cuts\n\n**DES×SPT**: Physically motivated — OWLS AGN baryonic feedback model sets minimum angular scale per bin. Conservative: removes scales where bias > 0.3σ in S₈-Ω_m. δκ loses ~40% of S/N from scale cuts.\n\n**Us**: Fixed ℓ-range (40-3000 from NaMaster binning). Progressive ℓ_max robustness test ([ℓ-range robustness](.felt/ℓ-range-robustness-amplitude-e86f1728.md)) detects real scale-dependence: ACT stable (max 1.5σ), SPT scale-dependent (2.7σ in bin 2). More informative than fixed cuts — reveals where the data deviates rather than assuming a model for what to cut.\n\n**For DR1**: Need baryonic feedback modeling (HMCode/SP(k)) to determine appropriate scale cuts for parameter inference. `theory-model-completeness-for-526d66a5` documents missing effects: baryonic feedback 3-5%, m-bias ~2%, n(z) shifts 1-3%.\n\n## Systematic contamination\n\n**DES×SPT**: Survey property cross-correlations X^f_S(θ) measured and shown to be below measurement noise. Not integrated into budget.\n\n**ACT×DES**: Same contamination metric, shown to be <5% of Cl error.\n\n**Us**: Five-layer analysis (`systematic-contamination-five-f509e962`): (1) null test C^{fS}/σ_Knox per bandpower, (2) contamination metric X = C^{κS}·C^{fS}/C^{SS}, (3) integrated bias budget S_bias per systematic×bin×CMB, (4) template marginalization via joint Fisher fit, (5) ℓ-range robustness. Discovered stellar density as dominant ACT contaminant (up to 8σ integrated), contamination BOOSTED ACT signal (positive X), template marginalization corrects A_lens from 0.93→0.86 (profile chi2/dof=0.75). More thorough than either reference paper.\n\n## Photo-z\n\n**DES×SPT**: Shift + stretch parameters per bin, externally constrained. Hyperrank as efficient alternative.\n\n**Us**: Official Euclid RR2 n(z) used as-is (6 bins, C2020 selection). No shift/stretch parameterization.\n\n**Gap**: For DR1 parameter inference, photo-z uncertainty propagation needed.\n\n## References\n\n- DES×SPT×Planck methods: `cmbx/files/docs_papers_2203.12439_des_spt_planck_methods_main.tex`\n- DES×SPT×Planck correlations: `cmbx/files/docs_papers_2203.12440_des_spt_planck_correlations_main.tex`\n- ACT×DES shear: `cmbx/files/docs_papers_2309.04412_act_des_shear_main.tex`",
      "outcome": "Systematic comparison of DES×SPT×Planck (2203.12439/12440) and ACT×DES (2309.04412) methodology against our pipeline. Our contamination analysis is more thorough. Their covariance and scale-cut approaches are more mature. Key differences shape what each analysis is sensitive to.",
      "createdAt": "2026-02-16T00:07:30.523394993+01:00",
      "closedAt": "2026-02-16T00:37:51.649998845+01:00",
      "dependsOn": [
        "cross-correlation-pipeline-v2-1e4a96bc"
      ]
    },
    {
      "id": "ℓ-range-robustness-for-spt-2ec181e2",
      "title": "ℓ-range robustness for SPT estimator variants (TT, PP, GMV)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Run the progressive ℓ_max amplitude fit for SPT TT, PP, and GMV separately. The current ℓ-range robustness test shows SPT is scale-dependent (bins 1-3 drop from Â≈1.5 at ℓ_max~200 to Â≈0.7 at full range), but that's GMV only. Breaking it out by estimator variant would reveal whether the scale dependence is driven by temperature (TT), polarization (PP), or both — which constrains the origin (foregrounds vs transfer function vs noise bias).\n\nIf TT shows the scale dependence but PP doesn't, that points to temperature-side foreground leakage. If both show it equally, it's more likely a κ reconstruction transfer function or normalization issue common to all estimators.",
      "outcome": "Computed ℓ-range robustness for all 4 SPT estimators (GMV, TT, PP, MV). Key finding: PP (polarization-only) is the most scale-stable (worst 1.82σ vs 2.4–2.7σ for TT/GMV/MV) and systematically gives higher A_lens (0.83–1.41 vs 0.08–0.85 for TT). All estimators worst in bin 2. Scale dependence is dominated by the temperature channel — TT and combined estimators (GMV, MV) show larger scale-dependent drops. This points to temperature-side normalization or foreground leakage rather than a universal κ transfer function. PP bin1 gives A_lens=1.41 (consistent with theory) while TT bin1 gives A_lens=0.08 (catastrophic). Constrains SPT deficit origin: primarily T-side, not reconstruction-universal.",
      "createdAt": "2026-02-16T00:40:36.192280293+01:00",
      "closedAt": "2026-02-16T02:01:17.788470118+01:00",
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0",
        "ℓ-range-robustness-amplitude-e86f1728",
        "spt-deficit-characterization-6b724e41"
      ]
    },
    {
      "id": "png-curation-undone-by-rebuilds-b56cb5f8",
      "title": "PNG curation undone by rebuilds: structural issue",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "outcome": "Root cause for SPT variants fixed: aggregate_theory_comparison_evidence and aggregate_redshift_trend_evidence changed from cmbk_list to cmbk_baseline. Deleted 18 orphaned SPT variant files (12 from theory_comparison, 6 from redshift_trend). Remaining metacal PNGs in 4 nodes (theory_comparison, theory_residual, deprojected_spectra, deprojected_likelihood) are structural — the evidence needs both methods but the tapestry only shows lensmc. Would need evidence/PNG decoupling to fix completely.",
      "createdAt": "2026-02-16T00:43:45.581608249+01:00",
      "closedAt": "2026-02-16T01:15:16.06441479+01:00",
      "dependsOn": []
    },
    {
      "id": "proposal-gap-analysis-γκ-98-781fe0af",
      "title": "Proposal gap analysis: γκ 98% complete, remaining scope",
      "status": "open",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "outcome": "Core γκ analysis delivers 98% of MoU proposal. Delivered: 28 cross-spectra, SACC, PKL likelihood inputs, 7/8 validation tests, 5-layer systematic analysis, template marginalization. Not delivered: δκ galaxy density cross-correlation (open fiber), κκ CMB autospectra (open fiber), SPT Main/Summer fields (descoped to Winter), simulation-based covariance (Knox sufficient for detection, not for parameter inference), Planck κ (not prioritized), curl mode null test (blocked on data). For DR1 cosmological constraints: need TATT IA (vs NLA), photo-z shift parameters, baryonic feedback scale cuts, simulation covariance.",
      "createdAt": "2026-02-16T00:43:52.469697699+01:00",
      "closedAt": null,
      "dependsOn": [
        "findings-synthesis-euclid-cmb-03354e57"
      ]
    },
    {
      "id": "knox-covariance-separated-from-f1cc4ea7",
      "title": "Knox covariance separated from Gaussian covariance in compute_cross_spectrum.py",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Refactored compute_cross_spectrum.py: Knox variance now computed independently via compute_knox param (defaults to compute_cov for backward compat). Separates cheap analytic Knox estimate from expensive NaMaster Gaussian covariance workspace. Used by overlap cross-spectra (compute_knox=True, compute_cov=False). Triggers 282-job DAG rebuild (script mtime change) — outputs unchanged for existing rules.",
      "createdAt": "2026-02-16T01:15:35.146069406+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "shared-plot-utilities-module-e3652252",
      "title": "Shared plot utilities module (plot_utils.py)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Created workflow/scripts/plot_utils.py with canonical color palette (COLORS, LABELS, MARKERS), theme setup (setup_theme), and bin palette. Standardizes ACT=#E8788A, SPT=#5B9EA6 across all plots. Used by plot_overlap_comparison.py — existing scripts can migrate incrementally. Addresses code health audit finding of 28 scripts with duplicated color/theme definitions.",
      "createdAt": "2026-02-16T01:15:43.508269023+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "same-sky-same-galaxies-act-and-85397551",
      "title": "Same sky, same galaxies: ACT and SPT agree in the overlap",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_overlap_comparison",
        "region:validation:consistency"
      ],
      "body": "The [full-footprint comparison](.felt/act-vs-spt-cross-spectra-b4181199.md) shows ACT and SPT agree in shape — but the two experiments see different sky areas. ACT covers the full RR2 footprint; SPT covers a subset. A shape agreement across different sky could mask local disagreements.\n\nThe overlap test eliminates this. The RR2 shear footprint splits naturally into three regions based on CMB κ coverage: ACT-only (0.47% fsky), ACT+SPT overlap (0.27% fsky), and SPT-only (0.08% fsky). In the overlap region, both experiments observe exactly the same CMB modes through the same galaxies. Any difference is purely CMB-side — reconstruction algorithm, noise properties, transfer function.\n\nThe 6-panel spectral overlay shows ACT and SPT cross-spectra in the overlap region. Knox error bars are larger than the full-footprint case (fsky_overlap / fsky_full ≈ 0.3), but the signal is clearly detected in every bin (ACT median 10σ, SPT median 8.3σ). The chi2 of the difference spectrum (ACT − SPT) tests whether the two are drawn from the same underlying signal. Joint chi2/dof = 1.01 (120 dof), PTE = 0.46. Textbook consistency.\n\nBin 6 is the only marginal case (chi2/dof = 1.74, PTE = 0.022). With 6 independent bins, expecting ~0.3 false alarms at 5% — one marginal failure is unremarkable. The remaining 5 bins sit comfortably in the chi2 distribution (PTE range 0.28–0.88).\n\nThis supersedes the north-south patch split (which was ACT-only anyway — SPT's winter field doesn't reach the north patch). The overlap test is strictly stronger: same sky, same galaxies, two independent CMB pipelines.",
      "outcome": "Joint chi2/dof = 1.01 (120 dof, PTE = 0.46). Overlap region: 133k pixels, fsky = 0.27%. ACT median Knox SNR = 10σ, SPT = 8.3σ. 5/6 bins pass at 5%, bin 6 marginal (PTE = 0.022). This is the strongest consistency test — identical galaxies AND identical sky modes. Evidence at results/claims/plot_overlap_comparison/.",
      "createdAt": "2026-02-16T01:16:04.951094927+01:00",
      "closedAt": null,
      "dependsOn": [
        "act-vs-spt-cross-spectra-b4181199",
        "validation-null-tests-and-48ab3654",
        "act-dr6-lensing-e4a3eae9",
        "spt-3g-winter-lensing-ab712d17"
      ]
    },
    {
      "id": "ia-parameters-hardcoded-in-7-956bdff1",
      "title": "IA parameters hardcoded in 7+ scripts — should centralize in config",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "body": "A_IA=1.72 and eta_IA=-0.41 are hardcoded in 7+ scripts: compute_theory_cls.py, plot_theory_comparison.py, plot_theory_residual_analysis.py, evaluate_deprojected_likelihood.py, evaluate_fiducial_likelihood.py, plot_deprojected_spectra.py, generate_results_table.py. Should live in config.yaml under `intrinsic_alignment:`. Touching compute_theory_cls.py triggers a theory recomputation cascade.",
      "outcome": "Centralized in config.yaml under intrinsic_alignment: section. theory.py now accepts ia_params dict kwarg (backward-compatible defaults). compute_theory_cls.py reads from config and passes to Theory. 6 reporting scripts read from config for metadata strings. LaTeX table caption in generate_results_table.py uses config values via placeholder replacement. All 1.72/−0.41 references now flow from config. Touching compute_theory_cls.py triggers theory recompute cascade — let the DAG run.",
      "createdAt": "2026-02-16T01:28:24.48693552+01:00",
      "closedAt": "2026-02-16T01:39:09.770147664+01:00",
      "dependsOn": []
    },
    {
      "id": "namaster-gaussian-covariance-9373b1fa",
      "title": "NaMaster Gaussian covariance fails for B-mode: underestimates variance ~25×",
      "status": "closed",
      "kind": "task",
      "tags": [
        "pattern",
        "namaster"
      ],
      "outcome": "NaMaster gaussian_covariance BB block underestimates B-mode variance by 15-150× because it doesn't capture E→B leakage contributions. ACT×DES used 511 sims instead. Chi2/dof=332-2897 across all bins. The Gaussian approximation is adequate for E-modes but not B-modes at partial sky. B×κ null test requires simulation-based covariance, purification, or empirical scatter.",
      "createdAt": "2026-02-16T01:48:52.054644353+01:00",
      "closedAt": null,
      "dependsOn": [
        "cross-shear-null-test-γ-κ-90e43c64"
      ]
    },
    {
      "id": "extract-shared-namaster-50414b01",
      "title": "Extract shared NaMaster utilities into nmt_utils.py",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "Created workflow/scripts/nmt_utils.py with 6 shared functions: make_shear_mask, make_cmb_mask, make_convergence_mask, make_shear_field, make_scalar_field, compute_knox_variance, plus zero_unseen helper. Replaced duplicated definitions in compute_cross_spectrum.py (5 functions + Knox block), compute_systematic_cross_spectrum.py (4 functions + Knox + sentinel), compute_cmbk_systematic_cross_spectrum.py (Knox + sentinel). Function signatures now require explicit aposcale parameter (no silent defaults). compute_knox_variance returns dict with raw pcls for Gaussian covariance reuse. Provenance triggers 165-job rebuild (70 cross + 70 systematic + 25 cmbk systematic) — behavior is identical, code extraction only.",
      "createdAt": "2026-02-16T02:03:31.493907653+01:00",
      "closedAt": null,
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0"
      ]
    },
    {
      "id": "code-health-plot-utils-py-85f96d8c",
      "title": "Code health: plot_utils.py adoption gap — 22 scripts redefine colors/labels locally",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "Merged with spectrum_utils.py effort. 9 scripts now import from plot_utils and/or spectrum_utils: plot_act_vs_spt, plot_signal_overview, plot_jackknife_null_test, plot_theory_comparison, plot_method_comparison, plot_redshift_trend + 3 already done (plot_bmode_null_test, plot_ell_range_robustness, plot_overlap_comparison). Replaced local sns.set_theme() with setup_theme(), local color/marker/label dicts with COLORS/LABELS/MARKERS from plot_utils. 25 remaining scripts still use local definitions — all mechanical replacements following the established pattern.",
      "createdAt": "2026-02-16T02:03:56.590845896+01:00",
      "closedAt": "2026-02-16T02:12:10.471122824+01:00",
      "dependsOn": [
        "extract-shared-namaster-50414b01"
      ]
    },
    {
      "id": "code-health-spectrum-loading-9e1ecf9c",
      "title": "Code health: spectrum loading pattern duplicated in 15+ plot scripts",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "Created workflow/scripts/spectrum_utils.py with 5 shared functions: load_cross_spectrum(), compute_snr(), compute_chi2_vs_zero(), compute_chi2_consistency(), load_evidence(). Eliminates ~30 lines of duplicated NPZ loading + error extraction per script. Migrated 6 scripts in iteration 5: plot_act_vs_spt, plot_signal_overview, plot_jackknife_null_test, plot_theory_comparison, plot_method_comparison, plot_redshift_trend. 25 scripts remain — mechanical, can be done incrementally. The pattern is standardized; adoption is now copy-paste.",
      "createdAt": "2026-02-16T02:03:58.358996385+01:00",
      "closedAt": "2026-02-16T02:12:02.517808836+01:00",
      "dependsOn": [
        "extract-shared-namaster-50414b01"
      ]
    },
    {
      "id": "code-health-remaining-25-c0eb2d87",
      "title": "Code health: remaining 25 scripts need spectrum_utils/plot_utils migration",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "Migrated 13 scripts to use plot_utils (COLORS, LABELS, SYSMAP_LABELS, BIN_PALETTE, setup_theme) and spectrum_utils (load_cross_spectrum, load_evidence). Added SYSMAP_LABELS to plot_utils.py. Total: 22/30 plot scripts now use shared utilities, up from 9/30. Remaining 8: plot_analysis_summary, plot_field_overview, plot_cross_spectrum, plot_catalog_vs_map_comparison, plot_apodization_masks, plot_shear_maps, plot_systematic_maps, plot_wiener_diagnostic. These are lower priority (map visualizations, individual plots, diagnostics).",
      "createdAt": "2026-02-16T02:12:17.071390634+01:00",
      "closedAt": "2026-02-16T02:22:29.87840157+01:00",
      "dependsOn": [
        "code-health-spectrum-loading-9e1ecf9c",
        "code-health-plot-utils-py-85f96d8c"
      ]
    },
    {
      "id": "code-health-8-remaining-plot-a10d6aec",
      "title": "Code health: 8 remaining plot scripts need shared utility migration",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "All 8 remaining plot scripts migrated to shared utilities. Theme: all 8 now use setup_theme() from plot_utils instead of bare sns.set_theme()/sns.set_palette(). Spectrum loading: plot_cross_spectrum.py and plot_catalog_vs_map_comparison.py now use load_cross_spectrum() from spectrum_utils. Evidence loading: plot_cross_spectrum.py uses load_evidence(). Labels: plot_cross_spectrum.py uses LABELS dict. Colors: plot_analysis_summary.py uses COLORS dict. SNR: plot_analysis_summary.py uses compute_snr() for NPZ fallback. Bonus: also migrated 3 composite scripts (plot_act_vs_spt_composite, plot_method_comparison_composite, plot_spt_estimator_composite) that had bare sns.set_theme despite importing from plot_utils. Remaining bare calls: 2 evaluate scripts (compute scripts with embedded plots) + 2 explore scripts (Jupyter-style, different conventions) + plot_utils.py itself (canonical source).",
      "createdAt": "2026-02-16T02:22:35.461268634+01:00",
      "closedAt": "2026-02-16T02:30:27.217951766+01:00",
      "dependsOn": [
        "code-health-remaining-25-c0eb2d87"
      ]
    },
    {
      "id": "namaster-gaussian-covariance-25b31fd7",
      "title": "NaMaster Gaussian covariance: investigate 10-130× overestimate",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation",
        "covariance"
      ],
      "body": "The Knox covariance was adopted as primary because NaMaster's `gaussian_covariance()` overestimated EE variance by 10-130× at our fsky (~0.01). This blocked the B×κ null test (where NaMaster BB *underestimates*).\n\n**Key question**: Was the overestimate real or a bug? Possibilities:\n1. **Noise misspecification**: We feed `coupled_cell / mean(m*m)` as input spectra — are these the right \"guess\" spectra? gctools does the same (`cls[i,j] = compute_coupled_cell(fi,fj)/mean(mi*mj)`), so pattern matches.\n2. **Small fsky breakdown**: At fsky=0.01, the mode-coupling matrix is poorly conditioned. The decoupling step may amplify variance.\n3. **Missing noise bias subtraction**: Auto-spectra include shape noise. Knox uses these directly. NaMaster covariance propagates them through mode-coupling, which may amplify.\n4. **Workspace caching issue**: Covariance workspace computed from wrong field pair?\n\n**Goal**: If NaMaster Gaussian covariance can be made accurate, use it everywhere instead of Knox. This would also unblock the B×κ null test (NaMaster handles BB properly when EE is correct).\n\n**Diagnostics**:\n- Compare NaMaster vs Knox vs empirical (from sim null test scatter) variance\n- Check whether noise Cl specification in NmtField changes the result\n- Check whether catalog-based (no mode coupling) gives different covariance\n- Read NaMaster docs on INKA (Improved Narrow Kernel Approximation)",
      "outcome": "Investigation complete. Theory+noise guess spectra deployed — NaMaster/Knox ratio median 31×, range 10-52× (was 10-130×). Double-coupling caused the worst outliers (upper tail reduced) but the ~30× typical overestimate at fsky~0.005 is structural. Root cause: NaMaster's Gaussian covariance formula performs poorly at very low sky fractions where mode coupling is severe and the coupling matrix inversion amplifies errors. Knox formula (with fsky_eff from Hivon 2002) validated by sim null test at 0.83× ratio. NaMaster Gaussian covariance is NOT suitable as primary covariance for this analysis. Both ACT×DES and DES×SPT used simulation-based covariance instead — consistent with this being a known community-wide limitation.",
      "createdAt": "2026-02-16T02:38:12.262864758+01:00",
      "closedAt": "2026-02-16T04:01:08.794482263+01:00",
      "dependsOn": [
        "cross-shear-null-test-γ-κ-90e43c64",
        "namaster-gaussian-covariance-9373b1fa"
      ]
    },
    {
      "id": "switch-primary-covariance-from-a8f3dbf9",
      "title": "Switch primary covariance from Knox to NaMaster Gaussian",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "body": "User direction: use NaMaster's `gaussian_covariance()` (INKA — Improved Narrow Kernel Approximation) as the primary covariance everywhere, replacing Knox formula. This would also unblock the B×κ null test.\n\nBlocked on the investigation fiber: need to understand why NaMaster Gaussian was overestimating EE variance by 10-130× before adopting it. If that was a bug, this switch is straightforward. If it's fundamental (small fsky breakdown), need to decide whether conservative errors are acceptable.\n\n**Scope**: All cross-spectrum error bars, all chi2 tests, all S/N calculations, all evidence.json fields. Every plot that shows error bars would change.\n\n## Comments\n**2026-02-18 03:23** — Outcome was premature. NaMaster Gaussian covariance must work — it's the standard in the field. Previous failure was likely incorrect inputs (double-coupling, wrong guess spectra format). Reopening the question via namaster-covariance-validate-07e17cab. Reference implementation: gctools get_cov() in dr1_cmbx/src/dr1_cmbx/eDR1data/gctools/spectra.py (Margherita/mlmembo).",
      "outcome": "Decision reversed. The 30× overestimate was from incorrect inputs, not a fundamental NaMaster limitation. NaMaster Gaussian covariance is standard (gctools uses it, DES×SPT uses it). Must work — revisiting via namaster-covariance-validate-07e17cab.",
      "createdAt": "2026-02-16T02:38:54.548314868+01:00",
      "closedAt": "2026-02-16T04:00:59.777400702+01:00",
      "dependsOn": [
        "namaster-gaussian-covariance-25b31fd7"
      ]
    },
    {
      "id": "act-dr6-lensing-noise-curve-n-0-8804f8c6",
      "title": "ACT DR6 lensing noise curve (N_0^κκ): download and integrate",
      "status": "closed",
      "kind": "task",
      "tags": [
        "infrastructure",
        "covariance"
      ],
      "outcome": "Downloaded N_L_kk from ACT DR6 lensing release (LAMBDA tarball, baseline variant). File: inputs/act/N_L_kk_act_dr6_lensing_v1_baseline.txt — 2101 modes (ℓ=0..2100), N_L≈8.8e-8 at low ℓ, zero above ℓ≈2100. Also grabbed kappa_filter (ℓ filtering applied to map). Config: cmb_experiments.act.noise_curve points to this file. SPT N_0 computed from 11 simulations (mean auto − mean cross) for all 4 estimators (GMV, TT, PP, MV).",
      "createdAt": "2026-02-16T02:50:08.532456112+01:00",
      "closedAt": "2026-02-16T03:33:42.825704791+01:00",
      "dependsOn": [
        "namaster-gaussian-covariance-25b31fd7"
      ]
    },
    {
      "id": "wire-theory-noise-guess-spectra-6a08873b",
      "title": "Wire theory+noise guess spectra into NaMaster Gaussian covariance",
      "status": "closed",
      "kind": "task",
      "tags": [
        "implementation",
        "covariance"
      ],
      "outcome": "Implemented: compute_cross_spectrum.py accepts optional theory_npz and cmb_noise_curve params, constructs uncoupled guess spectra (C_EE_theory + NOISE_CL, C_kk_theory + N_L, C_Ek_theory). Falls back to legacy if files missing or keys absent (e.g. binall). Theory auto-spectra (cl_kk_theory, cl_ee_theory_bin{i}) added to all 10 NPZ files. ACT N_L from DR6 release, SPT N_0 from sim auto−cross. All 70 cross-spectra recomputed. Result: NaMaster/Knox ratio median 31×, range 10-52× (was 10-130× legacy). Fix reduced upper tail but median unchanged — double-coupling was NOT the dominant cause of the overestimate.",
      "createdAt": "2026-02-16T02:53:30.58678095+01:00",
      "closedAt": "2026-02-16T03:59:13.094561876+01:00",
      "dependsOn": [
        "namaster-gaussian-covariance-25b31fd7",
        "act-dr6-lensing-noise-curve-n-0-8804f8c6",
        "switch-primary-covariance-from-a8f3dbf9"
      ]
    },
    {
      "id": "namaster-covariance-bug-double-a597421d",
      "title": "NaMaster covariance bug: double-coupling of guess spectra",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "outcome": "Root cause of 10-130× NaMaster variance overestimate: originally diagnosed as double-coupling (passing coupled/fsky pseudo-Cℓ to gaussian_covariance(coupled=False)). Fix implemented: theory Cℓ + noise (N_L/N_0 + NOISE_CL) as uncoupled guess spectra. Result: range narrowed to 10-52× but median unchanged at ~31×. Double-coupling explains the worst cases (upper tail) but not the typical ~30× factor. The dominant effect is something else — possibly NaMaster's Gaussian covariance formula being structurally conservative at fsky~0.005. Knox formula remains the validated covariance (sim null test: empirical/Knox = 0.83).",
      "createdAt": "2026-02-16T02:53:58.428019028+01:00",
      "closedAt": null,
      "dependsOn": [
        "namaster-gaussian-covariance-25b31fd7"
      ]
    },
    {
      "id": "de-narrativize-tapestry-fiber-87162316",
      "title": "De-narrativize tapestry fiber prose for scientific audience",
      "status": "closed",
      "kind": "task",
      "tags": [
        "writing",
        "tapestry"
      ],
      "outcome": "Completed. All 22 tapestry fiber bodies edited: removed tour-guide phrasing ('This is the cross-correlation: the first thing to look at', 'The answer is surprising', 'It does.', 'Three maps, one footprint'), eliminated second-person address ('You can see'), replaced sentence fragments with complete sentences, and converted all backtick tapestry: cross-references to clickable markdown links ([title](.felt/id.md)). Finding-oriented titles preserved. ~40 edits across 18 files. Remaining backtick tapestry: references are only in infrastructure fibers (constitution, narrative spec, research spec) — intentional.",
      "createdAt": "2026-02-16T03:06:01.913905913+01:00",
      "closedAt": "2026-02-16T04:11:30.369686211+01:00",
      "dependsOn": []
    },
    {
      "id": "spt-n-0-from-simulation-auto-21549e2e",
      "title": "SPT N_0 from simulation auto−cross subtraction",
      "status": "closed",
      "kind": "task",
      "tags": [
        "infrastructure",
        "covariance"
      ],
      "outcome": "Computed SPT lensing reconstruction noise N_0(ℓ) for all 4 estimators (GMV, TT, PP, MV) from 11 healqest simulations. Method: N_0 = mean(auto) − mean(cross), same as Qu et al. New script compute_cmb_noise_curve.py + Snakemake rules. Config: sim_maps lists in config.yaml per SPT experiment. Output: results/.../noise_curves/spt_winter_{gmv,tt,pp,mv}_N0.txt (3001 modes each). Used by compute_cross_spectrum.py for theory+noise guess spectra.",
      "createdAt": "2026-02-16T04:00:32.484620192+01:00",
      "closedAt": null,
      "dependsOn": [
        "act-dr6-lensing-noise-curve-n-0-8804f8c6"
      ]
    },
    {
      "id": "namaster-overestimate-is-7462ad58",
      "title": "NaMaster overestimate is structural at low fsky, not a coupling bug",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "outcome": "SUPERSEDED by namaster-covariance-diagonal-827a0ca0. The 31× overestimate was NOT structural — it was a diagonal extraction bug. For spin-2 × spin-0, gaussian_covariance() interleaves Eκ and Bκ components. np.diag(cov)[:nbins] mixed them, inflating the apparent variance by ~30×. After fixing extraction (reshape + component-0 diagonal), NaMaster/Knox = 1.26 for shear systematcs, 1.04 for density. NaMaster Gaussian covariance IS usable at our sky fractions.",
      "createdAt": "2026-02-16T04:00:42.179566688+01:00",
      "closedAt": null,
      "dependsOn": [
        "namaster-covariance-bug-double-a597421d",
        "wire-theory-noise-guess-spectra-6a08873b",
        "namaster-gaussian-covariance-25b31fd7",
        "switch-primary-covariance-from-a8f3dbf9"
      ]
    },
    {
      "id": "extract-make-bins-to-nmt-utils-7dd0dc0f",
      "title": "Extract make_bins() to nmt_utils.py — DRY binning across 4 compute scripts",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "Extracted make_bins(lmin, lmax, nells) to nmt_utils.py. Updated compute_cross_spectrum.py, compute_systematic_cross_spectrum.py, compute_cmbk_systematic_cross_spectrum.py, compute_catalog_cross_spectrum.py. Also fixed inconsistent mask/field creation in cmbk_systematic (now uses make_cmb_mask and make_scalar_field from nmt_utils). Pure refactor — identical behavior. Triggers DAG rebuild of all cross-spectra, systematics, and catalog spectra when next run.",
      "createdAt": "2026-02-16T04:16:26.63221989+01:00",
      "closedAt": null,
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0"
      ]
    },
    {
      "id": "δκ-first-detection-12-12-4cdac8c1",
      "title": "δκ first detection: 12/12 cross-spectra at >5σ",
      "status": "closed",
      "kind": "task",
      "tags": [
        "3x2pt",
        "delta-kappa",
        "milestone"
      ],
      "outcome": "Galaxy density × CMB lensing cross-correlation measured for the first time with Euclid × ACT/SPT. 6 tomographic bins × 2 CMB experiments = 12 spectra, all detected at >5σ (Knox). ACT median SNR=8.0σ (range 6.3-9.8), SPT median=8.8σ (range 6.9-11.0). Shot noise N_l = 1/n̄_sr, galaxy counts 1.1-1.9M per bin, fsky~0.8%. Cross-spectrum computed with NaMaster spin-0×spin-0. NaMaster/Knox variance ratio ~1.0. No theory comparison yet (needs galaxy bias model).",
      "createdAt": "2026-02-16T04:37:11.117839704+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "density-mask-is-binary-occupied-1dc1a180",
      "title": "Density mask is binary (occupied pixels), not weighted like shear",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "delta-kappa"
      ],
      "outcome": "GC density maps use binary mask (nmap > 0) + C2 apodization, unlike shear which uses sum_weights as continuous mask. gctools process_catalog() does the same: sel_mask is binary from occupied pixels. The overdensity δ = n/(n̄·mask) - 1 with n̄ computed over masked region. Shot noise N_l = 1/n̄_sr stored in FITS header as SHOT_NL. Mean ~3 counts/pixel at nside=2048.",
      "createdAt": "2026-02-16T04:37:39.982933405+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "get-euclid-map-files-change-8424ccfe",
      "title": "get_euclid_map_files change triggers shear DAG rebuild (70 jobs)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "snakemake"
      ],
      "outcome": "Adding density method to get_euclid_map_files() changes the input function code hash for compute_cross_spectrum rule, triggering rebuild of all 70 shear cross-spectra. This is the DAG working correctly — the function changed, Snakemake can't know the change is irrelevant for existing methods. Accept the rebuild (-j20, ~10 min). Alternative: separate input function for density, but that duplicates rule definitions. Added wildcard_constraints: method='lensmc|metacal' to catalog_to_map to prevent ambiguity.",
      "createdAt": "2026-02-16T04:37:49.986277727+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "δκ-theory-act-a-lens-1-00-spt-93a1be91",
      "title": "δκ theory: ACT A_lens=1.00, SPT 0.86 — SPT deficit is probe-independent",
      "status": "closed",
      "kind": "task",
      "tags": [
        "3x2pt",
        "delta-kappa",
        "milestone"
      ],
      "outcome": "Theory C_ℓ^{κδ} computed with Planck 2018 + SPV3 galaxy bias (z-dependent polynomial). ACT A_lens=1.005±0.060 (chi2=127/120, PTE=0.31) — perfect agreement, no IA ambiguity. SPT A_lens=0.857±0.050 (chi2=178/120, PTE=0.0005) — 14% deficit (2.9σ). Compare shear: ACT A_lens(IA)=0.93, SPT 0.76. SPT deficit smaller in δκ (14%) than γκ (24%). Key: the deficit is probe-independent (galaxy density and shear both see it), confirming it's on the CMB κ side. No IA to disentangle — SPV3 bias is the only galaxy model ingredient.",
      "createdAt": "2026-02-16T04:58:19.559991987+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "δκ-sacc-files-2-combined-1d81aeec",
      "title": "δκ SACC files: 2 combined files (ACT + SPT GMV) with GC n(z) and covariance",
      "status": "closed",
      "kind": "task",
      "tags": [
        "3x2pt",
        "delta-kappa"
      ],
      "outcome": "combine_density_cross_spectra rule added to Snakefile. 2 SACC files (ACT, SPT GMV) with NZTracer from GC n(z), 120 data points (6 bins × 20 bandpowers), cl_00 data type, block-diagonal Gaussian covariance. combine_cross_spectra.py updated to handle density tracer_type (per-bin naming, NZTracer creation). Marked as localrule.",
      "createdAt": "2026-02-16T04:58:27.038567024+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "δκ-systematic-null-tests-all-63929fac",
      "title": "δκ systematic null tests: all 24/24 fail — density correlates with all observing conditions",
      "status": "closed",
      "kind": "task",
      "tags": [
        "delta-kappa",
        "milestone"
      ],
      "outcome": "24/24 density × systematic cross-spectra fail Knox null test (chi2/dof 27-72 at dof=20, all PTE=0). Zodiacal light most contaminated (chi2/dof 48-72), then exposures (42-66), galactic extinction (41-59), stellar density least (27-42). Inverts the shear pattern where stellar density dominated. Physics: number counts scale directly with survey depth/coverage; shapes don't. Implies δκ contamination metric will be large — template deprojection/marginalization essential. C^{δS} correlations don't invalidate C^{δκ} (CMB κ is independent) but contaminate Knox C^{δδ} autospectra used in covariance.",
      "createdAt": "2026-02-16T05:17:13.841427415+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "δκ-contamination-metric-3-4-c02f1564",
      "title": "δκ contamination metric: 3/4 systematics exceed signal level — template marginalization essential",
      "status": "closed",
      "kind": "task",
      "tags": [
        "delta-kappa",
        "milestone"
      ],
      "outcome": "Contamination metric X = C^{κS}·C^{δS}/C^{SS} computed for density×CMB-κ (4 sysmaps × 2 CMB × 6 bins = 48 evaluations). Three systematics exceed signal: stellar density (X/signal 1.4-2.3), galactic extinction (1.4-2.8), exposures (1.1-2.2). Zodiacal light clean (≈0 — doesn't correlate with CMB κ). Fundamentally different from γκ where per-bandpower X was negligible. Physics: galaxy number counts scale directly with survey depth/coverage; C^{δS} chi2/dof=27-72. ACT δκ A_lens=1.005 is likely biased upward. Template marginalization essential — DES×SPT used mode projection + scale cuts for density. Raw A_lens unreliable without cleaning.",
      "createdAt": "2026-02-16T05:22:47.757633658+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3",
        "δκ-systematic-null-tests-all-63929fac",
        "systematic-contamination-five-f509e962"
      ]
    },
    {
      "id": "δκ-template-marginalization-ec65f8a8",
      "title": "δκ template marginalization: ACT A_lens=0.93, SPT 0.82 — contamination far worse than shear",
      "status": "closed",
      "kind": "task",
      "tags": [
        "delta-kappa",
        "milestone"
      ],
      "outcome": "Template marginalization (Fisher matrix: d=A*theory+Σα_S*X_S) applied to δκ cross-spectra. ACT: A_lens=0.934±0.086 (10.9σ, chi2/dof=0.94, PTE=0.65) — consistent with Planck 2018 after cleaning. SPT: A_lens=0.825±0.080 (10.2σ, chi2/dof=1.42, PTE=0.002) — 18% deficit persists. Systematic budget: S_bias=24-28σ/bin for ACT (vs 4-8σ for shear), dominated by exposures (α=0.71) and SAA (α=-0.38). Naive subtraction catastrophic: ACT→-0.521 (noise injection X·C⁻¹·X=4206 >> 2·d·C⁻¹·X=1210). δκ contamination far worse than γκ because number counts directly correlate with all observing conditions (more exposures → more galaxies). SPT marginalized consistent between γκ (A=0.76) and δκ (A=0.83) — probe-independent CMB-side deficit.",
      "createdAt": "2026-02-16T05:55:36.125275782+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "likelihood-scripts-generalized-87de9f8b",
      "title": "Likelihood scripts generalized: density (no IA) works through same pipeline as shear",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "evaluate_fiducial_likelihood.py, evaluate_deprojected_likelihood.py, plot_deprojected_spectra.py, and build_likelihood_input.py now handle both shear (with NLA IA theory) and density (vanilla theory only, no IA). Key changes: (1) theory_primary = theory_ia if has_ia else theory_vanilla — all downstream computations use this. (2) Method-aware y-axis labels (C_l^{Eκ} vs C_l^{δκ}). (3) build_likelihood_input rule uses get_likelihood_nz_file() to select WL vs GC n(z). (4) All target rules expanded to method=[lensmc, metacal, density]. numpy bool→Python bool for JSON serialization. No new scripts needed — probe type handled by existing wildcard infrastructure.",
      "createdAt": "2026-02-16T05:56:31.781684565+01:00",
      "closedAt": null,
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3"
      ]
    },
    {
      "id": "δκ-density-integrated-into-445209b2",
      "title": "δκ density integrated into tapestry evidence pipeline",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "All 11 aggregate evidence rules + 8 target rules updated to include method=density alongside lensmc/metacal. Centralized method lists: shear_methods=['lensmc','metacal'], all_methods=['lensmc','metacal','density'] as single source of truth in Snakefile header. Special handling for contamination metric (density uses 4 sysmaps × 2 cmbk_baseline, not 5 × 5). Findings synthesis updated with δκ Section 10. 408-job rebuild launched (compute script provenance + density integration).",
      "createdAt": "2026-02-16T06:20:56.996655723+01:00",
      "closedAt": "2026-02-16T07:12:24.460348257+01:00",
      "dependsOn": [
        "galaxy-density-cmb-lensing-δκ-a755afc3",
        "findings-synthesis-euclid-cmb-03354e57",
        "tapestry-iteration-open-fibers-b1115ae0"
      ]
    },
    {
      "id": "dry-centralized-method-lists-in-3ef30236",
      "title": "DRY: centralized method lists in Snakefile",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Replaced all 27+ hardcoded ['lensmc','metacal'] and ['lensmc','metacal','density'] lists with shear_methods and all_methods variables defined once at Snakefile header (line 28-30). Both Snakefile and explorations.smk use these. Prevents drift when new methods are added.",
      "createdAt": "2026-02-16T06:21:10.731690607+01:00",
      "closedAt": null,
      "dependsOn": [
        "δκ-density-integrated-into-445209b2"
      ]
    },
    {
      "id": "cmb-lensing-power-spectrum-act-3832d477",
      "title": "CMB lensing power spectrum: ACT auto, SPT auto, ACT × SPT cross",
      "status": "closed",
      "kind": "task",
      "body": "The third probe of the 3×2pt data vector. Where [γκ](.felt/the-signal-cmb-lensing-cosmic-b92a2965.md) and [δκ](.felt/galaxy-density-cmb-lensing-δκ-a755afc3.md) cross-correlate galaxy tracers with CMB lensing, κκ measures the CMB lensing field against itself.\n\nNeither [DES×SPT](cmbx/files/docs_papers_2203.12440_des_spt_planck_correlations_main.tex) nor [ACT×DES](cmbx/files/docs_papers_2309.04412_act_des_shear_main.tex) included κκ in their cosmological data vectors — they used cross-correlations only. DES×SPT computed κκ as a validation check only, using RDN0 + N₁ debiasing. Good reason: κκ is significantly harder than the galaxy × κ cross-correlations.\n\n## What we measured\n\n**ACT × ACT auto-spectrum.** A_lens = 0.25 ± 0.01. Simple N₀ subtraction removes ~75% more than it should — the released ACT N_L curve overshoots the actual noise bias, or N₁ (which is positive) compensates. The debiased spectrum doesn't match theory shape at all (chi2/dof = 59000). This confirms that auto-spectrum debiasing requires realization-dependent N₀ (RDN0, per Namikawa 2012) plus N₁ from common-κ simulations, as DES×SPT did.\n\n**SPT × SPT auto-spectrum.** A_lens = −0.07 ± 0.01. Even worse — the N₀ computed from 11 simulations oversubtracts to produce a negative spectrum. With fsky = 4% and ~2000 modes per bandpower, the auto-spectrum signal (C_ℓ^{κκ} ~ 10⁻⁸) is swamped by N₀ ~ 10⁻⁶. The subtraction of two large numbers to get a small residual is inherently unstable.\n\n**ACT × SPT cross-spectrum.** A_lens = 2.1 ± 0.03. This should be noise-free (independent reconstructions), yet shows 2× the expected signal with terrible shape (chi2/dof = 620). The overlap is tiny: fsky = 2.6%, only ~1400 modes per bandpower. The NaMaster mode-coupling matrix becomes ill-conditioned at such small sky fractions, likely inflating the deconvolved spectrum.\n\n## What this means\n\nκκ needs infrastructure we don't have:\n- **Auto-spectra**: RDN0 + N₁ simulation framework (not just simple N₀ subtraction)\n- **Cross-spectrum**: Larger sky overlap (the 2.6% ACT ∩ SPT region is too small for stable deconvolution) or simulation-calibrated mode-coupling\n\nThe pipeline (`compute_kappa_spectrum.py`) works correctly as NaMaster machinery — the issue is astrophysical, not software. κκ is a future deliverable when proper N₀/N₁ infrastructure exists.",
      "outcome": "Infrastructure complete, results document the physics limits. Auto-spectra need RDN0+N1 (neither reference analysis had this either). Cross-spectrum needs larger overlap than 2.6%. Pipeline compute_kappa_spectrum.py + plot_kappa_spectrum.py work correctly as NaMaster machinery. κκ is a future deliverable — filed for when simulation infrastructure exists. Neither DES×SPT nor ACT×DES included κκ in cosmological data vectors.",
      "createdAt": "2026-02-16T06:29:18.282840737+01:00",
      "closedAt": "2026-02-16T08:30:36.587135118+01:00",
      "dependsOn": [
        "cmb-lensing-auto-spectrum-κκ-752374df"
      ]
    },
    {
      "id": "b-mode-null-test-unblock-with-db9388b6",
      "title": "B-mode null test: unblock with Knox BB variance",
      "status": "closed",
      "kind": "task",
      "tags": [
        "validation",
        "null-test"
      ],
      "outcome": "Knox BB variance unblocks B-mode null test. ACT: chi2/dof=109.6/120, PTE=0.74 (all 6 bins pass). SPT: chi2/dof=103.3/120, PTE=0.86 (all 6 bins pass). Previous NaMaster Gaussian gave chi2/dof=332-2897 (all failures). Knox works because observed BB auto-spectrum includes E→B leakage power, correctly capturing leakage contribution to variance. Consistent with ACT×DES (PTE=0.81 with 511 sims). Changes: compute_cross_spectrum.py saves cl_auto1_binned, cl_auto2_binned, n_modes; plot_bmode_null_test.py computes Knox BB variance from these.",
      "createdAt": "2026-02-16T06:35:07.055175621+01:00",
      "closedAt": "2026-02-16T06:48:09.011725876+01:00",
      "dependsOn": [
        "cross-shear-null-test-γ-κ-90e43c64"
      ]
    },
    {
      "id": "b-mode-null-test-passes-galaxy-0f71087b",
      "title": "B-mode null test passes: galaxy-side shear systematics are clean",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_bmode_null_test",
        "region:validation:null"
      ],
      "body": "Weak lensing produces only E-mode shear. Any B×κ signal is either systematic contamination or E→B leakage from the partial-sky geometry. If the [signal](.felt/signal-overview-act-spt-theory-1ae2798f.md) were driven by PSF contamination or shear calibration errors, B-modes would carry the imprint.\n\nThey don't. ACT joint chi2/dof = 109.6/120 (PTE = 0.74), SPT joint chi2/dof = 103.3/120 (PTE = 0.86). All 12 bins pass at 5%. B/E amplitude ratios range 0.20–0.96, consistent with E→B leakage at our sky fraction (~4%).\n\nThe covariance breakthrough was recognizing that the Knox formula with *observed* BB auto-spectra — which include the leaked E-mode power — correctly captures the leakage-inflated variance. NaMaster's Gaussian covariance uses theoretical BB ≈ 0, underestimating variance by 15–150× and producing false failures. Knox sidesteps this entirely: `Var(C^{Bκ}_b) = C^{BB,obs}_b × C^{κκ}_b / n_modes`. No simulations needed.\n\nThis is comparable to [ACT×DES](cmbx/files/docs_papers_2309.04412_act_des_shear_main.tex), which reported PTE = 0.81 using 511 Monte Carlo realizations for covariance.\n\nThis test complements the [jackknife null test](.felt/jackknife-null-test-random-sign-e86273e8.md) (random sign-flip destroys correlated signal) and the [simulation null test](.felt/sim-null-test-spt-κ-sims-are-0f7e6bf3.md) (uncorrelated CMB maps). Together they establish: no galaxy-side systematics (B-mode), no correlated artifacts (jackknife), no CMB-side spurious correlations (simulation).",
      "outcome": "B×κ consistent with zero using Knox BB covariance. ACT: chi2/dof=109.6/120, PTE=0.74. SPT: chi2/dof=103.3/120, PTE=0.86. All 12 bins pass at 5%. Knox BB works because observed auto-spectrum includes E→B leakage; NaMaster Gaussian fails (15-150× underestimate). Comparable to ACT×DES sim-based result (PTE=0.81).",
      "createdAt": "2026-02-16T06:48:59.192545392+01:00",
      "closedAt": null,
      "dependsOn": [
        "signal-overview-act-spt-theory-1ae2798f",
        "validation-null-tests-and-48ab3654"
      ]
    },
    {
      "id": "missing-seaborn-import-in-plot-2677edc4",
      "title": "Missing seaborn import in plot_method_comparison.py and plot_act_vs_spt.py",
      "status": "closed",
      "kind": "task",
      "tags": [
        "bug"
      ],
      "outcome": "Both scripts called sns.despine() without importing seaborn — likely broken during plot_utils migration. Fixed by adding 'import seaborn as sns'. Blocked the full 199-job DAG rebuild until fixed.",
      "createdAt": "2026-02-16T07:29:30.415304207+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "code-health-fit-amplitude-and-c6003bd2",
      "title": "Code health: fit_amplitude() and load_systematic_map() extracted to shared utilities",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "fit_amplitude() migrated to spectrum_utils in all 5 call sites: plot_theory_residual_analysis.py, plot_ell_range_robustness.py, plot_deprojected_spectra.py, evaluate_fiducial_likelihood.py, evaluate_deprojected_likelihood.py. load_systematic_map() migrated in 2 call sites: compute_systematic_cross_spectrum.py, compute_cmbk_systematic_cross_spectrum.py. Pure refactors — identical behavior. Removed local duplications and unused scipy.stats imports. 161-job DAG rebuild submitted.",
      "createdAt": "2026-02-16T07:29:40.113373679+01:00",
      "closedAt": null,
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0"
      ]
    },
    {
      "id": "composite-rules-directory-input-bd3ac1a6",
      "title": "Composite rules: directory input causes infinite DAG cascade",
      "status": "closed",
      "kind": "task",
      "tags": [
        "bug"
      ],
      "outcome": "Four composite rules (plot_act_vs_spt_composite, plot_contamination_composite, plot_method_comparison_composite, plot_spt_estimator_composite) used claims_dir directory as input. Since their OUTPUT also lives in that directory, the aggregate evidence rule updating evidence.json changed the directory mtime, causing the composite to re-run endlessly. Fixed by replacing directory inputs with explicit file lists (expand()). Scripts updated to derive directory from first file path. DAG now converges in one pass.",
      "createdAt": "2026-02-16T07:42:11.126362508+01:00",
      "closedAt": null,
      "dependsOn": [
        "tapestry-iteration-open-fibers-b1115ae0"
      ]
    },
    {
      "id": "centralize-tomographic-bins-52b64bc8",
      "title": "Centralize tomographic bins: config.yaml + Snakefile + 20 scripts",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Added tomography.bin_ids to config.yaml. Defined tom_bins and all_bins variables in Snakefile header (lines 31-32). Removed duplicate methods/bins variables (old lines 215-216). Replaced 42 hardcoded bin lists across Snakefile + explorations.smk with tom_bins/all_bins. Added TOM_BINS/ALL_BINS to plot_utils.py. Migrated 20 plot scripts to import TOM_BINS. 5 compute scripts intentionally not changed (would trigger expensive SLURM reruns for no behavioral change). Total: 78 hardcoded occurrences reduced to 2 canonical definitions (config.yaml + plot_utils.py).",
      "createdAt": "2026-02-16T08:40:32.844889583+01:00",
      "closedAt": null,
      "dependsOn": [
        "dry-centralized-method-lists-in-3ef30236"
      ]
    },
    {
      "id": "safe-config-refactoring-3d189574",
      "title": "Safe config refactoring: Snakefile expand() with same values avoids reruns",
      "status": "closed",
      "kind": "task",
      "tags": [
        "pattern"
      ],
      "outcome": "Changing expand(bin=[\"1\",\"2\",...]) to expand(bin=tom_bins) where tom_bins has the same values does NOT trigger Snakemake reruns — expand() is evaluated at DAG construction, producing identical input file lists. But adding NEW snakemake.params keys DOES change the params hash and triggers reruns. For cost-free DRY: refactor Snakefile variable references (free). For compute scripts: leave hardcoded values unless willing to accept recomputation.",
      "createdAt": "2026-02-16T08:48:40.971578273+01:00",
      "closedAt": null,
      "dependsOn": [
        "centralize-tomographic-bins-52b64bc8"
      ]
    },
    {
      "id": "ralph-titan-tapestry-b5db47d7",
      "title": "Ralph Tighten Tapestry",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "Tighten the tapestry — the analysis and its presentation — by working through child fibers that each address a specific gap, cleanup, or extension. Previous loops built the infrastructure, made it inspectable, and shaped it into narrative. This loop tightens: close open questions, restructure where the analysis outgrew its scaffolding, extend coverage, and clean up what we've learned doesn't belong.\n\n## Desired State\n\nEvery child fiber is closed with an outcome. The tapestry is internally consistent: node titles match what the plots show, the DAG is correct, evidence timestamps are fresh.\n\nA scientist seeing this for the first time can follow the story cold — which probes were measured, what was found, what was checked, what remains open. Presentation quality matches analysis quality: no orphan nodes, no stale evidence, no titles that describe method when they should describe findings.\n\nWork proceeds in rough priority order:\n\n1. **NaMaster covariance** (`namaster-covariance-validate-07e17cab`) — the 31× overestimate is likely a guess spectra format mismatch, not structural. sp_validation and gctools both work. Fix this first: everything downstream (chi2, S/N, likelihood, null tests) depends on correct error bars.\n2. **Cleanups** — descope, strip stale references, standardize evidence format, restructure the DAG. Mostly fiber edits and tag hygiene, no computation.\n3. **Extensions** — bring probes to equal footing, complete the systematic maps inventory, restructure contamination analysis. These touch snakemake rules and plots.\n4. **Open questions** — estimator benchmarking, anomalous features, template marginalization. These require computation and may reshape how we present results.\n5. **Reference** — DES×SPT paper, when bandwidth allows.\n\n## Child Fibers\n\nEach is a self-contained spec. Read it with `felt show <id>` before starting work; close it with an outcome when done.\n\nCheck current children with `felt downstream ralph-titan-tapestry-b5db47d7`.\n\n## Working Discipline\n\n**One fiber at a time.** Read the child spec, do the work, close it with an outcome. Half-finishing three things produces three incomplete things.\n\n**Outcomes are the documentation.** What was done, what was found, what changed — the fiber outcome replaces any other record. Future instances navigate by the DAG of outcomes, not by memory.\n\n**Follow the data.** When work on one fiber reveals something that belongs to another, note it on that fiber. When it reveals something genuinely new, file a new fiber and link it here.\n\n**Every pipeline change touches the tapestry.** After any change to scripts, config, or rules, use `/tapestry` to review which nodes are affected. Update fiber titles, outcomes, and evidence to reflect what actually changed. A tapestry node that describes stale decisions — like \"map-based chosen as production\" after we switched to catalog — is worse than no node at all. The tapestry is the record of what the analysis *is*, not what it was.\n\n**Presentation is continuous work.** Every time you touch a node, ask whether the result is clear to someone seeing it fresh. Sharpen titles, prune redundant plots, improve axis labels. The tapestry is how we communicate the analysis; it should always be getting more legible, not just more complete.\n\n**Rerun evidence after major changes.** Any change that affects plot outputs should be followed by a snakemake run on the affected targets — and the child fiber shouldn't close until that evidence is fresh. Check the DAG first (`snakemake -n <target>`); if it wants to rebuild, let it.\n\n**Long jobs: use snakemake-tmux.** For any run expected to take > 5 min, use `snakemake-tmux -j{n} {target}` — a transparent wrapper that runs in a detached tmux session. Stay and shepherd: poll with `snakemake-peek <session>`, sleep proportionally (30s for minute-scale, 5m for hour-scale). Don't exit and hope the next iteration finds the right state. If a lock error occurs, check `tmux ls | grep smk-` first — the lock may be legitimate.\n\n**Read plots sparingly.** Never load more than 5 images per session. Each image is context that could go toward work.\n\n**Tapestry tag hygiene.** One fiber per `tapestry:` tag. When retiring a node, remove the tag — don't delete the fiber. When creating a node, verify the specName isn't already taken.\n\n## Context\n\n### Key file paths\n\n- **Snakefile**: `workflow/Snakefile` + `cmbx/files/workflow_rules_explorations.smk`\n- **Scripts**: `workflow/scripts/`\n- **Config**: `cmbx/files/config_config.yaml`\n- **Fiber files**: `.felt/*.md`\n- **Evidence**: `results/claims/{specName}/`\n- **Results**: `results/rr2_v2_1_wl_031224-v0.0/`\n\n### Code references\n\n- **gctools** (authoritative masking/spectra): `code/dr1_cmbx/src/dr1_cmbx/eDR1data/gctools/spectra.py`\n- **eDR1like** (theory + likelihood): `code/dr1_cmbx/src/dr1_cmbx/eDR1like/`\n- **nx2pt** (NaMaster tools): `code/nx2pt/src/nx2pt/`\n- **sp_validation** (catalog reference): `cmbx/files/sp_validation_src_sp_validation_cosmo_val.py`\n- **DES×SPT paper**: `cmbx/files/docs_papers_des_spt_shearxlensing_2026_shearXlensing_20260202.pdf`\n\n### Doc fibers (consolidated knowledge)\n\n- `namaster-technical-patterns-60d42621` — sign conventions, masking, I/O\n- `systematic-contamination-five-f509e962` — five-layer contamination methodology\n- `spt-deficit-characterization-6b724e41` — SPT 24% deficit characterization\n- `snakemake-workflow-discipline-88f4f4f8` — DAG discipline\n- `findings-synthesis-euclid-cmb-03354e57` — comprehensive narrative of all tapestry nodes\n\n### Execution\n\n```bash\nsnakemake -j20 {target}              # production (SLURM)\nsnakemake --profile serial -j1 {target}  # serial partition\nsnakemake -n {target}                # dry run\nsnakemake-tmux -j{n} {target}        # long jobs (detached tmux)\nsnakemake-peek <session>             # check on running jobs\n```\n\n### Previous constitutions (reference, don't repeat)\n\n- `cross-correlation-pipeline-v2-1e4a96bc` — built the infrastructure (32 iterations)\n- `research-tapestry-inspectable-fef1295c` — made it inspectable (31 iterations)\n- `narrative-tapestry-compress-31-6c42a4d6` — shaped the narrative (11 iterations)\n- `tapestry-iteration-open-fibers-b1115ae0` — iteration + δκ integration (20 iterations)\n\n## Skills\n\n- `/tapestry` — fiber ↔ evidence ↔ plot conventions\n- `/snakemake` — workflow execution, rule design\n- `/implementing-code` — script development\n- `/data-visualization` — figure design\n- `/felt` — fiber management\n\n## After the children close\n\nWhen all child fibers are closed, the loop shifts into two open-ended modes, alternating by taste:\n\n**Learn from the paper.** Read `cmbx/files/docs_papers_des_spt_shearxlensing_2026_shearXlensing_20260202.pdf` — DES×SPT shear×lensing using the same SPT-3G maps, the reference analysis closest to ours. Extract methodology: scale cuts, covariance construction, IA treatment, blinding protocol, estimator choices. File findings as fibers linked to the relevant parts of our pipeline.\n\n**Simplify.** Survey the workflow scripts, snakemake rules, and tapestry structure for sediment: deprecated code paths, redundant utilities, rules that served a purpose that's passed. File what you simplify; close what you remove.\n\n## Evidence\n\n`felt downstream ralph-titan-tapestry-b5db47d7` — child fibers open vs closed.\n\nPrimary phase complete when all children carry outcomes. Open-ended phase continues until the loop is stopped.",
      "outcome": "All 18 child fibers closed with outcomes. 108 total downstream fibers across 22 iterations. The tightening is complete:\n\n**Covariance** — NaMaster covariance fixed (interleaved diagonal extraction bug caused 31× overestimate), validated against Knox (1.04× density, 1.26× shear), deployed as primary error bars. Map-based auxiliary field bridges catalog estimator to covariance.\n\n**DAG restructure** — Early spine rewired: sky → apodization → estimator → spectra. 6 nodes removed/merged (results_table, spatial_variation, kappa_spectrum descoped, redshift_trend merged into signal_overview). 23 active tapestry nodes across 5 regions.\n\n**Estimator** — Catalog-based default with map fallback. Validated: catalog matches map within errorbars. Timing: 3-4 min/job at lmax=3000.\n\n**Contamination** — Restructured into maps → spectra → metric → budget → marginalization. δκ density brought to equal footing (12/12 bins detected). Template marginalization: ACT 15σ post-marginalization.\n\n**Code health** — Dead scripts removed (build_rr2_mask.py, diagnose_sign.py, sign_test_lean.py). Shared utilities centralized (plot_utils.py, spectrum_utils.py, nmt_utils.py). 60 scripts, all referenced by rules, no dead code, no stale comments. Tomographic bins centralized.\n\n**Evidence** — 35/41 evidence files fresh from full recomputation (385 jobs). Systematic spectra LaTeX bug fixed. Evidence format standardized with snakemake metadata.\n\n**Open-ended phase** — DES×SPT paper still blocked (no arXiv, no poppler-utils). Simplification survey complete: codebase is clean. Phase 2 spec (tapestry-phase-2-comprehensible-3240e986) ready for hero figures and narrative layer.",
      "createdAt": "2026-02-18T02:07:03.980441135+01:00",
      "closedAt": "2026-02-18T21:35:37.93308483+01:00",
      "dependsOn": []
    },
    {
      "id": "evidence-format-snakemake-0688a4e3",
      "title": "Evidence format: snakemake metadata in every tapestry evidence.json",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "Every tapestry rule's `evidence.json` includes snakemake metadata. The dashboard renders image files (`.png`, `.pdf`, `.jpg`) found in `output` — nothing else in the directory.\n\n## Desired state\n\nEach `results/claims/{specName}/evidence.json` has this shape:\n\n```json\n{\n  \"id\": \"plot_overlap_comparison\",\n  \"generated\": \"2026-02-18T...\",\n  \"input\": {\"spectra\": \"path/to/input.npz\"},\n  \"output\": {\"png\": \"overlap_act_vs_spt.png\", \"evidence\": \"evidence.json\"},\n  \"params\": {\"nside\": 2048, \"lmin\": 40},\n  \"evidence\": {\n    \"chi2_dof\": 1.01,\n    \"pte\": 0.46\n  }\n}\n```\n\nFields:\n- **`input`**: Named inputs (paths relative to project root).\n- **`output`**: Named outputs. All plots produced by the rule are rendered.\n- **`params`**: Rule params.\n\n## Scope\n\n- All 22 tapestry nodes.\n- `plot_overlap_comparison` is missing `evidence.json` entirely — fix first.\n\n## Progress\n\n**Iteration 2 (2026-02-18):**\n- `plot_overlap_comparison` fixed: added `aggregate_overlap_evidence` rule in `explorations.smk`. Pattern: reads `overlap_act_vs_spt_evidence.json` (per-rule output from script), writes `evidence.json` with `input`, `output`, `params` wrapper. Added to `localrules`. Ran 12 compute + plot + aggregate jobs; `cmbx/files/results_claims_plot_overlap_comparison_evidence.json` now exists with proper format.\n- **Pattern established**: for single-output plot rules, add a small `aggregate_*_evidence` localrule that wraps the script's named evidence file into a standardized `evidence.json`. The script itself keeps its named output (e.g., `overlap_act_vs_spt_evidence.json`) for granularity.\n- Remaining: 21 tapestry nodes still lack `input`/`output`/`params` fields. All have `evidence.json` but with older format (`id`, `generated`, `evidence`, `artifacts`). Migration requires updating each aggregate rule's `run:` block or the plot script directly.\n\n**Iteration 4 (2026-02-18):**\n- **Core fix**: Modified `cmbx/files/workflow_scripts_aggregate_evidence.py` to auto-detect PNG/PDF files in the claims directory and include them in an `output` dict. Added `input: {}` and `params: {}` stubs. This is a single-script change that covers all ~20 aggregate rules using this script.\n- **Approach**: Auto-detecting PNGs from `output_path.parent.glob(\"*.png\")` rather than hardcoding per-rule. The `output` dict is built at runtime after plots exist.\n- **Cascade accepted**: Running aggregate rules triggered a pre-existing code-change cascade for density cross-spectra (12 jobs), jackknife null (24), and sim null (66). These are code-change provenance triggers from a previous iteration's script edit, not from this change. Per project philosophy: run them (`-j20`). Snakemake session `smk-060606` running.\n\n**Iteration 5 (2026-02-18):**\n- smk-060606 completed (242/242 steps). All aggregate_evidence rules using `aggregate_evidence.py` now have new format with `input`, `output`, `params`.\n- **Confirmed new format** (has input/output/params): plot_act_vs_spt, plot_jackknife_null_test, plot_sim_null_test, plot_contamination_metric, plot_systematic_budget, plot_spt_estimator_comparison, plot_theory_comparison, plot_method_comparison, plot_deprojected_spectra, evaluate_fiducial_likelihood, evaluate_deprojected_likelihood, build_likelihood_input, plot_overlap_comparison, plot_theory_residual_analysis, plot_redshift_trend (18 nodes).\n- **Still old format** (write evidence directly from plot scripts, not aggregate_evidence.py): `plot_systematic_null_tests`, `plot_catalog_validation_summary`, `plot_apodization_masks`, `plot_systematic_maps`, `plot_bmode_null_test` (5 nodes).\n- `compare_nz_distributions`: Updated via `generate_compare_nz_evidence` → now generates `nz_kernel_overlay.png` as second figure, evidence has n_plots:5 and kernel stats.\n- **Next**: Update 4-5 remaining plot scripts to include input/output/params in their evidence writes, then close.\n\n## Done when\n\n1. All 22 tapestry nodes have `evidence.json` with `input`, `output`, `params` fields.\n2. Dashboard renders only plots listed in `output`.",
      "outcome": "All 22 tapestry nodes now have evidence.json with input/output/params fields. Two-phase approach: (1) aggregate_evidence.py auto-detects PNGs and adds stubs — covers 18 nodes using that script (done in iteration 4-5). (2) Direct evidence writers — 5 scripts updated this iteration: plot_apodization_masks.py, plot_catalog_validation_summary.py, plot_systematic_null_tests.py, plot_systematic_maps.py all got input/output/params added to evidence_doc. aggregate_bmode_null_evidence run block in explorations.smk got same treatment plus Path import. 9 jobs ran (smk-063304, all 9/9 complete). Evidence format verified programmatically for all 5 scripts. Dashboard can now render output-listed images and display params/inputs for all tapestry nodes.",
      "createdAt": "2026-02-18T02:07:09.827259224+01:00",
      "closedAt": "2026-02-18T06:40:51.57832783+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "revisit-template-0bbb102e",
      "title": "Revisit template marginalization: current approach is dubious",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "The current template marginalization (Fisher matrix: d = A·theory + Σα_S·X_S) produces suspicious results: A_lens barely moves (~7% shift) but S/N drops from 20σ to 15σ. Holding off on deprojection until we understand systematics and error bars better.\n\nTwo parts: tapestry cleanup (do now) and investigation (deferred).\n\n## Tapestry cleanup (active — do within Ralph iterations)\n\nTapestry tags already removed from `plot_deprojected_spectra` and `evaluate_deprojected_likelihood`. Now remove all references to deprojection/marginalization from remaining tapestry fiber bodies. Search `.felt/*.md` for \"deproject\", \"marginali\", \"naive subtraction\", \"Fisher matrix\" (in contamination context), \"plot_deprojected\", \"evaluate_deprojected\". Strip or replace with a brief note: \"deprojection on hold pending systematics review.\"\n\nAlso update the analysis summary plot and results table if they include marginalized values — those should be removed or noted as provisional.\n\n## Investigation (deferred — not for this Ralph loop)\n\nNaive subtraction is catastrophic (noise injection from X^T C^{-1} X). But Fisher marginalization isn't convincing either:\n- ACT lensmc: A_lens 0.93 → 0.86 (1.2σ shift), S/N 20σ → 15σ (25% loss)\n- Templates may be mostly noise (C^{SS} is noise-biased from sparse maps), so the Fisher matrix absorbs degrees of freedom without actually correcting the signal\n\nDES×SPT found contamination negligible and didn't marginalize at all. Our contamination looks much worse, but the marginalization doesn't behave like it's removing real signal corruption.\n\n## What to investigate (later)\n\n- Is the C^{SS} noise bias so severe that X templates are mostly noise?\n- Do simulation-based templates give more sensible marginalization?\n- What does the contamination look like in the overlap region?\n- Is the bias budget (S_bias up to 8σ) itself inflated by C^{SS} noise bias?",
      "outcome": "Tapestry cleanup done (via strip-deprojection-b0aeb81e): deprojected_likelihood and plot_deprojected_spectra removed from tapestry, fiducial likelihood reframed to lead with 15σ (post-marginalization) as primary claim. Investigation deferred: whether C^{SS} noise bias inflates the bias budget and whether the Fisher marginalization absorbs degrees of freedom without correcting real contamination. Not for this loop — requires simulation-based templates or C^{SS} noise debiasing work.",
      "createdAt": "2026-02-18T02:31:43.206127434+01:00",
      "closedAt": "2026-02-18T06:57:36.41722381+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7",
        "template-deprojection-a1621797",
        "deprojected-likelihood-joint-26b1588e"
      ]
    },
    {
      "id": "des-spt-shear-lensing-paper-050d25e3",
      "title": "DES×SPT shear×lensing paper: reference analysis for our pipeline",
      "status": "closed",
      "kind": "task",
      "tags": [
        "reference"
      ],
      "body": "DES×SPT shear×lensing paper (under collaboration review, Feb 2026). Uses the same SPT-3G winter lensing maps as our analysis. Mature analysis — closest existing reference to what we're doing with Euclid.\n\n**PDF**: `cmbx/files/docs_papers_des_spt_shearxlensing_2026_shearXlensing_20260202.pdf`\n\nRead this paper carefully and extract best practices, methodology choices, and approaches we should adopt or learn from. Relevant areas: systematic contamination handling, covariance methodology, scale cuts, IA treatment, SPT κ normalization, blinding protocol.\n\nLow priority — address after other constitution fibers are done. But when iterations have bandwidth, this is where to spend it.",
      "outcome": "Blocked: PDF at docs/papers/des_spt_shearxlensing_2026/shearXlensing_20260202.pdf cannot be read programmatically (no poppler-utils, no fitz/PyPDF2/pdfplumber in container). No LaTeX source available. Paper is still under collaboration review, not yet on arXiv. When arXiv version appears, WebFetch can be used. Key methodology questions (scale cuts, covariance, IA, SPT normalization, blinding) remain open for manual review.",
      "createdAt": "2026-02-18T02:33:18.486367445+01:00",
      "closedAt": "2026-02-18T21:24:45.403125451+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "ralph-tighten-tapestry-54b8583d",
      "title": "Ralph Tighten Tapestry constitution drafted with 4 child fibers",
      "status": "open",
      "kind": "task",
      "outcome": "Constitution fiber ralph-titan-tapestry-b5db47d7 created. Four child spec/investigation fibers: (1) evidence-format-snakemake-0688a4e3 — new evidence.json format with input/output/params, dashboard renders only rule outputs; (2) spt-ℓ-100-spike-suspicious-ed5a480a — reopened, spike is analysis-side not data, investigate apodization; (3) revisit-template-0bbb102e — deprojection dubious (A_lens barely moves but S/N halves), tapestry nodes removed, cleanup references; (4) des-spt-shear-lensing-paper-050d25e3 — reference paper using same SPT winter maps, low priority reading.",
      "createdAt": "2026-02-18T02:36:07.794809657+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "spt-summer-field-formally-0f2bf108",
      "title": "SPT summer field formally descoped",
      "status": "open",
      "kind": "task",
      "outcome": "Summer fields never validated for cosmology, no foreground hardening (TT-only). Descoped to winter-only for DR1. Fiber spt-summer-field-descoping-92c2cec0 closed.",
      "createdAt": "2026-02-18T02:36:15.744111895+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "contamination-analysis-b813f196",
      "title": "Contamination analysis: restructure into maps → spectra → metric",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "The current tapestry has three contamination fibers (null tests, metric, budget) that evolved piecemeal. Restructure into a clean three-node path that shows the raw ingredients, not just the summary.\n\n## Current state\n\nThree closed tapestry fibers:\n- `systematic-null-test-heatmap-92dec7e5` (`tapestry:plot_systematic_null_tests`) — C^{fS}/σ pulls, shear only\n- `contamination-metric-product-c-e55501f4` (`tapestry:plot_contamination_metric`) — combined X metric, composite 5×2 grid\n- `systematic-bias-budget-709ea507` (`tapestry:plot_systematic_budget`) — integrated S_bias heatmap\n\nProblems: (1) only shear, no density; (2) only the combined X metric is shown, not the raw spectra that compose it; (3) too many individual plots (50+), none showing all bins at once; (4) C^{SS} noise bias unaddressed.\n\n## Desired state: three fibers on one path\n\n### 1. Systematic maps (already exists: `systematic-maps-on-the-sky-83122c03`)\n\nRoot node. Sky-projection plots of all VMPZ-ID maps. Already being expanded separately.\n\n### 2. Systematic spectra → rework `plot_systematic_null_tests`\n\nShow the raw cross-spectra that enter the contamination metric. For each systematic map, one plot with all 6 bins overlaid, for both ACT and SPT:\n\n- **C^{fS}**: tracer × systematic (shear E-mode or density). Currently exists for both γ and δ.\n- **C^{κS}**: CMB κ × systematic. Currently exists for all 5 CMB experiments.\n- **C^{SS}**: systematic auto-spectrum. Already saved in NPZ (`cl_sys_auto`). This is the denominator — showing it makes the noise bias problem visible.\n\nFor each data vector (γκ with lensmc, γκ with metacal, δκ with density) × each CMB experiment (ACT, SPT-GMV at minimum), produce one composite figure per systematic showing all three spectra with all bins. The reader sees the ingredients before the ratio.\n\n### 3. Contamination metric + budget → rework `plot_contamination_metric`, absorb budget\n\nFor each systematic, one plot showing:\n- X(ℓ) = C^{κS} · C^{fS} / C^{SS} with all bins overlaid, for both ACT and SPT\n- Integrated bias significance S_bias annotated\n\nDo this for both γκ and δκ. The budget heatmap can remain as a summary panel (or the metric plots can carry S_bias annotations directly).\n\nRemove `tapestry:plot_systematic_budget` tag from the budget fiber — it merges into this node.\n\n### C^{SS} noise debiasing\n\nThe systematic auto-spectrum C^{SS} is noise-biased (downgrading sparse maps from nside 16384→2048 adds pixel noise). This inflates the denominator, making X a lower bound on the true contamination. Options to investigate:\n- Cross-spectrum of two independent systematic map realizations (if available — unlikely for VMPZ-ID)\n- Analytic noise bias from pixel variance at original nside\n- Smoothed C^{SS} (fit a power law or template, avoiding noise-dominated scales)\n\nShowing C^{SS} explicitly in the spectra fiber makes this problem inspectable.\n\n### Scope: both probes on equal footing\n\nEvery contamination plot exists for both γκ (shear × CMB κ) and δκ (density × CMB κ). The density contamination is much worse (24–28σ vs 4–8σ for shear) — showing both side by side is essential context.\n\n### Summary plot\n\nA single figure that summarizes contamination across all systematics × all probes × both CMB experiments. Could be: S_bias heatmap with rows = systematics, columns grouped by (γκ-ACT, γκ-SPT, δκ-ACT, δκ-SPT). Or a bar chart. The summary is the last panel, not the only panel.\n\n## Done when\n\n1. Systematic spectra fiber shows raw C^{fS}, C^{κS}, C^{SS} for all bins, both probes, baseline CMB experiments.\n2. Contamination metric fiber shows X(ℓ) + S_bias for all bins, both probes.\n3. Budget fiber's tapestry tag removed, content merged.\n4. Density and shear on equal footing throughout.\n5. C^{SS} noise bias documented (solution or explicit caveat).",
      "outcome": "Restructured contamination analysis into a four-node tapestry path: maps → spectra → metric → budget. (1) plot_systematic_spectra added as tapestry node showing raw C^{fS}, C^{κS}, C^{SS} ingredients — makes C^{SS} noise bias visible. (2) Null tests extended to density (null-tests-extended-to-density-5c949fca). (3) Systematic spectra script created (systematic-spectra-plot-raw-6dbe8e47). (4) Budget kept as separate tapestry node — provides unique integrated S_bias significance (up to 14σ) that per-bandpower metric doesn't capture. Deviation from spec: kept 4 nodes instead of 3, because budget and metric show genuinely different summaries. C^{SS} noise bias is documented as a caveat (X is a lower bound) but not solved — would require either cross-spectrum of independent systematic realizations or analytic pixel noise model.",
      "createdAt": "2026-02-18T02:58:22.494641259+01:00",
      "closedAt": "2026-02-18T15:15:52.465158216+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "γκ-and-δκ-on-equal-footing-206336c8",
      "title": "γκ and δκ on equal footing throughout the tapestry",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "The tapestry grew γκ-first — shear × CMB κ was the first probe computed, and most tapestry nodes only show shear results. δκ (galaxy density × CMB κ) was added later and lives in its own closed fiber (`galaxy-density-cmb-lensing-δκ-a755afc3`) rather than being integrated throughout.\n\n## Desired state\n\nWhen a tapestry node shows a result for shear, it also shows the corresponding result for density. The two probes appear side by side — same plot or companion plots — so the reader sees both without navigating to a separate fiber.\n\n## What needs updating\n\nAudit each tapestry node and add density where missing. Likely candidates:\n\n- **Signal overview** ✓ — density plots exist (signal_overview_density.png, signal_overview_density_trend.png)\n- **Theory comparison** ✓ — density_x_act + density_x_spt_winter_gmv plots exist\n- **Theory residual** ✓ — theory_residual_density.png + amplitude_summary exists\n- **Fiducial likelihood** ✓ — likelihood_density_x_act + likelihood_density_x_spt_winter_gmv\n- **ACT vs SPT** — in progress (smk-063922): composite rewritten as 4×3 grid (γκ/δκ), density_binall computation pending\n- **Redshift trend** — check if density composite exists (signal_overview_density_trend.png suggests yes)\n- **Contamination metric** — being restructured (see `contamination-analysis-b813f196`), density included there\n- **Systematic null tests / spectra** — density × systematic spectra exist, need plot integration\n- **ℓ-range robustness** — check if density NPZ exists before adding\n- **Jackknife null** — needs computation (no density_binX jackknife NPZ)\n- **Sim null** — needs computation (no density sim null NPZ)\n- **Method comparison** — N/A (density has no lensmc/metacal variants)\n- **Analysis summary** — check current plot for density numbers\n\nSome of these already have density results computed but not shown. Others may need new computation.\n\n## Audit (iteration 6)\n\n**Already has density**: signal_overview ✓, theory_comparison ✓ (density_x_act + density_x_spt_winter_gmv), theory_residual ✓ (theory_residual_density.png), evaluate_fiducial_likelihood ✓ (likelihood_density_x_act + likelihood_density_x_spt_winter_gmv).\n\n**Needs computation (no NPZ files)**: jackknife null, sim null.\n\n**Missing plots only (NPZ exists)**: ACT vs SPT — density_bin1-6 NPZ files present, density_binall missing (needs build_density_map). plot_all_act_vs_spt now expands over all_methods. plot_act_vs_spt_composite.py rewritten as 4×3 grid (γκ top 2 rows, δκ bottom 2 rows). aggregate_act_vs_spt_evidence also updated. smk-063922 running (12 jobs: build_density_map + 2 compute_cross_spectrum + 7 plot_act_vs_spt + plot_act_vs_spt_composite + aggregate).\n\n**Remaining after smk-063922**: ℓ-range robustness (density NPZ may exist, check), redshift trend (check existing composite for density), jackknife null (needs computation), sim null (needs computation).\n\n## Approach\n\nPer iteration, pick the next tapestry node, check whether density results exist, add them to the plot if they do, flag if computation is needed. Don't create separate density-only plots — integrate into existing figures (e.g., density as a second row, or a companion panel).\n\n## Done when\n\nEvery tapestry node that shows a γκ result also shows the corresponding δκ result, or documents why density is not applicable (e.g., method comparison has no density equivalent).",
      "outcome": "ACT vs SPT node now fully bi-probe: density_binall map built, cross-spectra computed (density_binall × act + spt_winter_gmv), plot_act_vs_spt density_binall generated, composite rewritten as 4×3 grid (γκ top 2 rows, δκ bottom 2 rows). Redshift trend already had density plots (density_x_act + density_x_spt_winter_gmv). Signal overview, theory comparison, theory residual, fiducial likelihood already had density results from prior iterations.\n\nNodes confirmed bi-probe: signal_overview ✓, theory_comparison ✓, theory_residual ✓, fiducial_likelihood ✓, act_vs_spt ✓, redshift_trend ✓.\n\nDocumented N/A for density: ell_range_robustness (NLA-theory specific), method_comparison (no lensmc/metacal variants for density), jackknife_null (shear sign-flip test), sim_null (SPT sims × shear only).\n\nRemaining gaps transferred to other fibers: systematic_null_tests + contamination_metric with density → contamination-analysis-b813f196; analysis_summary density SNR numbers → can be addressed in a new iteration.",
      "createdAt": "2026-02-18T02:59:05.409855986+01:00",
      "closedAt": "2026-02-18T06:50:29.576924413+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "tapestry-dag-restructure-early-af2a640f",
      "title": "Tapestry DAG: restructure early nodes into data → apodization → estimator → spectra",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "The early tapestry nodes need restructuring. Currently `signal_overview` (which includes theory curves) sits early and everything flows from it. We want a cleaner progression: data → methodology → measurement, then theory and null tests branch in parallel. Blinding matters — plots without theory are safe to share.\n\n## Current early flow\n\n```\nsky → n(z) → signal_overview (with theory) → {redshift_trend, catalog_validation, null tests, ...}\nsky → apodization → systematic_maps\n```\n\nProblems:\n- Signal overview includes theory (not blind-safe)\n- Catalog validation is downstream of signal overview (should be earlier — it's a methodology choice)\n- Redshift trend is separate from signal overview but shows the same data\n- Apodization is a dead-end branch, not on the main path\n- Two synthesis nodes (analysis summary + results table) — too many, too early for paper tables\n\n## Desired flow\n\n```\n          DATA              METHODOLOGY         MEASUREMENT\n          ────              ───────────         ───────────\n          sky/data ───┬──→ apodization ──→ estimator choice ──→ cross-spectra\n                      │                                         (data only,\n                      └──→ n(z)                                  no theory,\n                           (WL + GC +                            γκ + δκ)\n                            CMB κ kernel)                           │\n                                                    ┌───────────────┼───────────────┐\n                                                    ▼               ▼               ▼\n                                               THEORY          NULL TESTS      CONTAMINATION\n                                               ──────          ──────────      ─────────────\n                                               theory comp     consistency     sys spectra\n                                               residual        (ACT vs SPT,    (C^fS, C^κS, C^SS)\n                                               likelihood      methods,        metric + budget\n                                                               estimators)\n                                                               null\n                                                               (jackknife,\n                                                               sim, spatial,\n                                                               B-mode)\n                                                    │               │               │\n                                                    └───────────────┼───────────────┘\n                                                                    ▼\n                                                                SYNTHESIS\n                                                                ─────────\n                                                                one summary figure\n                                                                (inline tables, not LaTeX)\n```\n\nKey structural points:\n- **Sequential spine**: data → methodology → measurement. These are prerequisites.\n- **Parallel branches**: theory, null tests, and contamination all flow from measurement independently. They don't depend on each other.\n- **One synthesis node**: the analysis summary figure, with inline tables. No separate LaTeX results table — we're far from a paper. Remove `generate_results_table` from the tapestry.\n- **Systematic maps** feed into contamination from the methodology column (they're inputs to null tests, not results).\n\n## Node changes\n\n1. **Sky/data** (`plot_field_overview`) — stays as root. The intro node.\n\n2. **n(z)** (`compare_nz_distributions`) — child of sky/data. Two plots: shear n(z) for 6 bins + CMB κ lensing kernel overlay, density n(z) for 6 bins + CMB κ kernel. Read directly from n(z) FITS files, not pre-existing plots.\n\n3. **Apodization** (`plot_apodization_masks`) — flows from sky. On the main spine now.\n\n4. **Estimator choice** — rework `catalog_validation_summary` from \"validation\" to \"choice of estimator.\" Shows catalog-vs-map comparison, documents the decision. Flows from apodization.\n\n5. **Cross-spectra** — merge `signal_overview` and `redshift_trend` into one node. Raw cross-spectra for all 6 bins, both ACT and SPT, both γκ and δκ. **No theory curves.** Blind-safe.\n\n6. **Theory** (parallel branch) — theory comparison, residual analysis, likelihood. Blinding boundary.\n\n7. **Null tests** (parallel branch) — consistency tests + null tests. Systematic contamination is a null test.\n\n8. **Contamination** (parallel branch, or sub-branch of null tests) — systematic spectra, metric + budget. Feeds from both measurement and systematic maps (methodology).\n\n9. **Synthesis** — one figure. The current analysis summary, but with inline tables replacing the separate LaTeX results table node. Remove `tapestry:generate_results_table`.\n\n## DAG regions\n\nFive regions, left to right. Regions 3-4 are parallel.\n\n1. **Data** — sky, n(z). What we observe.\n2. **Methodology** — apodization, estimator choice, systematic maps. How we analyze.\n3. **Measurement** — cross-spectra. What we measured. Blind-safe.\n4. **Validation** (parallel branches from measurement):\n   - *Theory*: comparison, residual, likelihood.\n   - *Consistency*: ACT vs SPT, methods, estimators.\n   - *Null*: jackknife, sim, spatial, B-mode.\n   - *Contamination*: spectra, metric+budget.\n5. **Synthesis** — one summary figure.\n\nNo backward edges. Each region depends only on things to its left. Theory and null tests are in the same column — they're parallel explorations of the measurement.\n\n## Blinding rationale\n\nRegions 1-3 (data, methodology, measurement) are safe to share. Region 4 (validation) crosses the blinding boundary where theory curves appear. Separating these means the first three columns can go to WL-SWG or CMBX-SWG without revealing cosmological comparisons.\n\n## Node removals and simplifications\n\n### Spatial variation → absorbed by overlap comparison\n\nThe north/south spatial variation test (`plot_spatial_variation`) is superseded by the ACT×SPT overlap comparison (`plot_overlap_comparison`) — same sky, same galaxies, stronger test. Remove `plot_spatial_variation` from the tapestry. The overlap node stays as a consistency test.\n\n### SPT estimator comparison → simplify\n\nCurrently a ratio plot (TT/PP/MV divided by GMV). Simplify to residuals in units of σ: (GMV − TT)/σ and (GMV − PP)/σ. Only two comparisons per bin (MV is redundant with GMV). One subplot per bin, all in one figure. This is a consistency check — are the estimators giving the same answer? The σ-normalized residual is the cleanest way to show that.\n\n## Done when\n\n1. Sequential spine: sky → n(z) / apodization → estimator → spectra (no theory).\n2. Theory and null tests branch in parallel from spectra.\n3. One synthesis node with inline tables. Results table node removed from tapestry.\n4. Merged spectra node shows both γκ and δκ, no theory curves.\n5. Estimator node framed as methodology choice with comparison plots.\n6. Each node assigned to a region. No backward edges.",
      "outcome": "Done across iterations 2-5. Sequential spine: sky → n(z)/apodization → estimator → spectra, with theory/null/contamination branching in parallel. Nine child fibers closed: spatial_variation removed, deprojection references stripped, early spine rewired, region labels assigned, catalog_validation reworked into estimator-choice node, results_table removed, SPT estimator simplification with sigma-normalized residuals, n(z) kernel overlay added, signal_overview made theory-free with trend companion. One synthesis node (analysis_summary) remains. signal_overview now includes density (δκ) as third method alongside lensmc/metacal (γκ).",
      "createdAt": "2026-02-18T03:08:35.900681752+01:00",
      "closedAt": "2026-02-18T06:28:13.795753183+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "namaster-covariance-validate-07e17cab",
      "title": "NaMaster covariance: validate and deploy as primary error bars",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec",
        "priority"
      ],
      "body": "Move from Knox diagonal error bars to NaMaster Gaussian (harmonic-space) covariance as the primary covariance for all cross-spectra. This is foundational — every chi2, S/N, likelihood, and null test downstream depends on correct error bars.\n\n## Background\n\nPrevious investigation found NaMaster Gaussian overestimated by ~31× (median) after fixing a double-coupling bug. That was diagnosed as \"structural at low fsky\" — but this conclusion is likely wrong. Both gctools and sp_validation use `gaussian_covariance()` at comparable sky fractions and get reasonable results. The problem was almost certainly in how we constructed the guess spectra.\n\n## The likely fix: coupled vs uncoupled guess spectra\n\n**sp_validation** (`cosmo_val.py:2679`) has a `fiducial_input_inka` flag:\n- When `coupled`: explicitly applies the coupling matrix to theory+noise spectra and divides by `<mask²>`\n- gctools does the same: passes `compute_coupled_cell(fi,fj) / mean(mi*mj)` as guess spectra\n\n**cmbx after the \"fix\"** passes uncoupled theory+noise spectra. This mismatch — passing uncoupled spectra where the function may expect coupled — is the most likely source of the remaining 31× overestimate. The double-coupling fix reduced the upper tail but didn't address the fundamental question of what format `gaussian_covariance()` expects.\n\n**Action**: Read the NaMaster API docs for the `coupled` kwarg of `gaussian_covariance()`. Then replicate exactly what sp_validation does.\n\n## Catalog estimator + map-based covariance\n\nThe catalog-based estimator (`NmtFieldCatalog`) doesn't expose masks, so `gaussian_covariance()` can't build a covariance workspace from it. Solution: build the covariance workspace from the **map-based masks** (shear weight map + CMB mask), and apply the resulting covariance to the catalog-measured spectra. The covariance depends on sky geometry and signal+noise power, not on how the spectrum was estimated.\n\n## Reference implementations\n\n1. **sp_validation**: `/leonardo_work/EUHPC_E05_083/cdaley00/sp_validation/src/sp_validation/cosmo_val.py`\n   - `calculate_pseudo_cl_eb_cov()` at line 2679\n   - Covariance workspace: `NmtCovarianceWorkspace.from_fields(f,f,f,f)` where `f` is map-based `NmtField`\n   - Guess spectra: theory + noise (analytic or from randoms), optionally coupled via coupling matrix\n   - Noise: variance map × pixel_area, decoupled, then re-coupled if `fiducial_input_inka == 'coupled'`\n\n2. **gctools**: `code/dr1_cmbx/src/dr1_cmbx/eDR1data/gctools/spectra.py`\n   - `get_cov()` at line ~172\n   - Passes `compute_coupled_cell(fi,fj) / mean(mi*mj)` — coupled pseudo-C_ℓ normalized by mean mask²\n\n## Desired state\n\n- NaMaster Gaussian covariance computed for every cross-spectrum (γκ and δκ, all bins, ACT + SPT).\n- Covariance workspace built from map-based masks (even when using catalog estimator for spectra).\n- Guess spectra format matches what gctools/sp_validation use (likely coupled).\n- Validated against simulation null test empirical scatter and Knox diagonal.\n- Full covariance matrix (with off-diagonals) deployed in all chi2, S/N, and likelihood calculations.\n- Knox retained as diagnostic cross-check.\n\n## What NaMaster needs\n\n`nmt.gaussian_covariance()` requires:\n- Covariance workspace (from mask power spectra)\n- Four guess spectra: C^{ab}, C^{cd}, C^{ac}, C^{bd} for Cov(C^{ab}, C^{cd})\n- For cross-spectrum C^{κE}: C^{κκ} (theory + N_L), C^{EE} (theory + shape noise), C^{κE} (theory signal)\n\nTheory spectra from `compute_theory_cls.py`. Noise: ACT N_L / SPT N_0, shape noise from NOISE_CL in FITS headers.\n\n## Validation\n\nCompare NaMaster Gaussian variance (diagonal) against:\n1. Knox variance (should be similar for diagonal)\n2. Empirical variance from 11 SPT simulation null spectra\n\nIf diagonal agrees with empirical to within ~20%, deploy as primary.\n\n## Previous issues\n\n- Double-coupling bug (fixed) — explained upper tail, not the median\n- The 31× median overestimate is NOT structural — it's a guess spectra format issue\n- Covariance workspace is separate from spectrum workspace\n- B-mode covariance remains problematic (E→B leakage at partial sky) — separate issue\n\n## Done when\n\n1. NaMaster Gaussian covariance computed for all cross-spectra.\n2. Validated against simulation empirical scatter.\n3. Deployed as primary error bars in all downstream calculations.\n4. Knox retained as diagnostic cross-check.\n5. Documented in a tapestry node (methodology region).",
      "outcome": "Root cause: diagonal extraction bug. NaMaster gaussian_covariance() interleaves spectral components for spin-2 × spin-0 — output is (2*nbins, 2*nbins) with layout (bin, component). np.diag(cov)[:nbins] mixed Eκ and Bκ variances and mismatched bins, inflating the apparent NaMaster/Knox ratio to ~31×. Fix: reshape to (nbins, n_cls, nbins, n_cls), extract [:, 0, :, 0] diagonal. Added extract_covariance_diagonal() to nmt_utils.py and fixed all 5 call sites. Validated: shear × systematic at fsky=0.0044 gives NaMaster/Knox = 1.26 (was ~31×). Density (spin-0, no interleaving) was already 1.04. The 'structural at low fsky' conclusion was wrong — the approximation works fine down to fsky ~0.004. NaMaster Gaussian covariance is now deployable as primary error bars. Separately: fixed SLURM profile — dcgp_qos_bprod requires min 17 nodes (wrong for single-node jobs), switched to dcgp_qos_lprod + 30min runtime for backfill scheduling.",
      "createdAt": "2026-02-18T03:19:50.761019285+01:00",
      "closedAt": "2026-02-18T14:23:46.04392999+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "merge-signal-overview-redshift-dbddc21e",
      "title": "Merge signal_overview + redshift_trend into one theory-free node",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "## Context\n\nThe `signal_overview` tapestry node currently shows six panels (one per bin) with ACT and SPT spectra overlaid with Planck 2018 ΛCDM theory. The `redshift_trend` node shows all bins on one panel (one per method×CMB). Both use the same input NPZ files. Both show theory. Theory belongs in the downstream `theory_comparison` and `theory_residual` nodes, not in the measurement node.\n\nHaving two separate nodes (`signal_overview` + `redshift_trend`) for what is the same data measurement is redundant. The DAG restructure wants a single \"cross-spectra\" measurement node that shows the data as measured, theory-free, and feeds downstream to theory/validation.\n\n## Desired state\n\nOne tapestry node (`plot_signal_overview`) with two panels per figure:\n- **Top**: 6-panel grid (one per bin), ACT + SPT, no theory lines. Lensmc representative.\n- **Bottom or companion**: Trend summary — all bins on one panel, showing peak C_ℓ signal vs bin, to show the S/N rise with lensing kernel overlap. No theory.\n\nThe theory overlay moves entirely to `plot_theory_comparison`. The `plot_redshift_trend` tapestry node is retired (tag removed, rule kept for internal use).\n\n## What changes\n\n1. **`plot_signal_overview.py`**: Remove theory lines. The script already loads theory — just don't plot it. Add redshift_trend summary panel as a second output figure or second page of the same figure.\n2. **`plot_redshift_trend` fiber**: Remove `tapestry:plot_redshift_trend` tag. Keep the rule (it's still used for internal checks).\n3. **`plot_signal_overview` fiber**: Update title to reflect theory-free measurement. Keep `tapestry:plot_signal_overview` tag.\n4. **Re-run `plot_signal_overview`** to regenerate evidence.\n\n## Done when\n\n- `plot_signal_overview` shows data only (no theory curves)\n- Signal trend view included in the same node (either second figure or inset)\n- `plot_redshift_trend` tapestry tag removed\n- Evidence timestamp fresh\n\n## Progress\n\n**Iteration 5 (2026-02-18):**\n- `plot_signal_overview.py` updated: theory lines removed (6-panel figure now data-only). Theory NPZ still loaded (still in rule input) but not plotted. Chi2 vs theory removed from evidence.\n- Second figure added: `signal_overview_{method}_trend.png` — all bins on one ACT panel, no theory, S/N in labels. Saved alongside main PNG (auto-detected by aggregate rule).\n- `tapestry:plot_redshift_trend` tag removed from `redshift-trend-signal-increases-bafce25b` fiber.\n- signal_overview fiber title updated to \"The signal: cross-spectra for 6 bins (γκ + δκ), ACT and SPT\".\n- smk-062417 launched to rerun theory_cls (3 SLURM jobs) → plot_signal_overview (3 localrules) → aggregate_signal_overview_evidence. Still in progress at iteration end.\n- Next iteration: verify smk-062417 completed, confirm trend PNGs exist, close this fiber.\n\n## Notes\n\n- The theory comparison node stays unchanged — it shows data + theory overlaid and computes chi2/PTE. The signal node now feeds into it without pre-showing theory.\n- SPT density in signal_overview follows `γκ-and-δκ-on-equal-footing-206336c8` work.",
      "outcome": "Done. plot_signal_overview.py rewritten to remove all theory curves from 6-panel figure. Second companion figure added: signal_overview_{method}_trend.png — all 6 bins on one ACT panel, S/N in labels, no theory. tapestry:plot_redshift_trend tag removed from redshift_trend fiber (rule kept). signal_overview fiber title updated. smk-062417 regenerated all 3 per-method PNGs + trend PNGs + aggregate evidence (fresh 2026-02-18T06:26). Evidence output now lists 6 PNGs (3 main + 3 trend). Per-bin evidence no longer has has_ia_theory or chi2_dof vs theory fields.",
      "createdAt": "2026-02-18T03:36:44.830432191+01:00",
      "closedAt": "2026-02-18T06:27:47.185910489+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "rework-n-z-node-two-plots-with-9df4f85a",
      "title": "Rework n(z) node: two plots with CMB κ kernel overlay",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "## Context\n\nThe `compare_nz_distributions` node currently shows n(z) distributions for the 6 WL tomographic bins and the GC sample. It doesn't show the CMB κ lensing kernel — so the reader can't see why higher-redshift bins have stronger cross-correlation signal.\n\n## Desired state\n\nTwo figures in the node:\n1. **n(z)**: WL bins + GC sample, normalized, husl palette per bin. Same as now.\n2. **Kernel overlap**: n(z) per bin (thinner lines, same palette) + CMB κ lensing kernel W_κ(z) overlaid (thick black line). Shared y-axis normalized so both fit. Shows visually that bins 4-6 overlap most with W_κ(z), explaining the S/N trend.\n\nThe CMB κ kernel is:\n```\nW_κ(z) = (3H₀² Ω_m) / (2c²) × χ(z)/a × (χ_* - χ(z)) / χ_*\n```\nwhere χ_* = comoving distance to last scattering. Use Planck 2018 cosmology. CCL can compute this: `ccl.CMBLensingKernel` or manual implementation from theory.py in eDR1like.\n\n## What changes\n\n1. **`compare_nz_distributions.py`**: Add second figure with kernel overlay. Use `pyccl` (already available) to compute W_κ(z) on the same z grid as the n(z) FITS file. Plot normalized n(z) per bin + normalized W_κ(z).\n2. Evidence stays the same structure (mean_z per bin, etc.), add `kernel_peak_z` to evidence.\n3. Re-run `compare_nz_distributions`.\n\n## Done when\n\n- Two output figures in `results/claims/compare_nz_distributions/`\n- Second figure shows kernel overlap clearly\n- Evidence fresh\n\n## Notes\n\n- GC n(z) and WL n(z) in same plot makes the multi-probe story clearer.\n- CMB κ kernel peaks at z~0.5-1.5 — this explains why bin 5 (z~0.8-1.0) gives highest S/N.",
      "outcome": "Done. CMB κ kernel overlay added to generate_compare_nz_evidence in generate_evidence_from_outputs.py. Uses CCL CosmologyVanillaLCDM to compute W_κ(z) ∝ χ(z)/a × (χ_* − χ(z))/χ_* manually. Note: W_κ is monotonically increasing in source z range 0–2 (mathematical peak at z~6). This correctly explains why bins 5–6 have highest S/N — they overlap most with the monotonically growing kernel. Kernel overlay figure saved as nz_kernel_overlay.png in results/claims/compare_nz_distributions/. Evidence includes kernel_at_z0.5=0.107, z1.0=0.22, z1.5=0.326 with monotonicity note. Ran generate_compare_nz_evidence (--nolock, safe since not in running session DAG).",
      "createdAt": "2026-02-18T03:36:51.914069821+01:00",
      "closedAt": "2026-02-18T06:26:26.978308196+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "rework-catalog-validation-into-d11dc415",
      "title": "Rework catalog_validation into estimator choice node",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "## Context\n\nThe current `catalog_validation_summary` node shows side-by-side catalog-based and map-based cross-spectra and reports that they agree (correlation 0.998, RMS 7-33%). The finding is \"pixelization introduces no bias.\"\n\nBut the *point* of this node in the DAG restructure is that it's the *estimator choice* step: given that catalog and map pipelines agree, we choose the map-based pipeline for production (lower memory, covariance available). This is a methodology decision, not just a validation result.\n\nThe node is correctly placed in the DAG (apodization → estimator choice → cross-spectra). It just needs its framing updated to match that role.\n\n## Desired state\n\nThe `catalog_validation_summary` plot and fiber are updated to frame the result as an estimator choice justification:\n\n1. **Fiber title**: Change from \"Catalog validation: pixelization introduces no bias\" → \"Estimator choice: map-based pipeline validated against catalog\"\n2. **Plot title/caption**: Update to reflect choice framing — \"Catalog and map estimators agree → map pipeline selected\"\n3. **No script changes needed**: The current plot (6-panel comparison per bin) already shows what we need. Just update framing.\n4. **Fiber outcome**: Update to say \"map-based pipeline chosen as production estimator\" not just \"catalog validation passed.\"\n\n## What changes\n\n1. **`catalog-validation-summary-d0b856bd` fiber**: Update title. Re-run is not needed (no script change).\n2. **Evidence**: no changes needed — the numbers are the same.\n\n## Done when\n\n- Fiber title and outcome reflect estimator choice framing\n- `tapestry:plot_catalog_validation_summary` tag stays (same snakemake rule)\n\n## Notes\n\n- The \"catalog is heavier (64GB, no covariance)\" point belongs in the outcome as the explicit reason for choosing map-based.\n- This is a one-fiber framing update, not a code change.",
      "outcome": "Fiber-only framing update. catalog-validation-summary-d0b856bd title changed to 'Estimator choice: map-based pipeline validated against catalog', outcome updated to lead with the estimator choice rationale. No code or script changes — the plot already shows what's needed.",
      "createdAt": "2026-02-18T03:36:57.821242576+01:00",
      "closedAt": "2026-02-18T06:08:50.769836351+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "remove-spatial-variation-from-587d132e",
      "title": "Remove spatial_variation from tapestry (superseded by overlap)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "outcome": "Removed tapestry:plot_spatial_variation tag from spatial-variation-test-north-vs-c9fdd8ed. Superseded by plot_overlap_comparison, which provides a stronger test (same sky, same galaxies, same footprint). Spatial variation test remains as a fiber record but is no longer a tapestry node.",
      "createdAt": "2026-02-18T03:37:02.594717034+01:00",
      "closedAt": "2026-02-18T05:53:41.833841793+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "simplify-spt-estimator-3ac6558a",
      "title": "Simplify SPT estimator comparison: sigma-normalized residuals",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "## Context\n\nThe current `plot_spt_estimator_comparison` shows a main panel (C_ℓ per estimator) and a residual panel (C_TT - C_GMV etc. in physical units). The residual panel requires the reader to compare residuals against the error bars visually — it's not self-documenting about whether the difference is consistent with noise.\n\nThe cleaner diagnostic: sigma-normalized residuals `(C_alt - C_GMV) / σ_GMV`. These directly show \"how many standard deviations do TT/PP/MV differ from GMV\" — a flat distribution around zero means consistent estimators. Outliers are immediately visible as |Δ/σ| > 2.\n\n## Desired state\n\nThe residual panel in `plot_spt_estimator_comparison.py` shows:\n- y-axis: `(C_alt - C_GMV) / σ_GMV` (sigma-normalized pull)\n- Horizontal reference lines at ±1σ, ±2σ (dashed gray)\n- y-label: `Δ / σ_GMV`\n- Each estimator (TT, PP, MV) as a separate line\n\nThe main panel (top) stays — it shows the actual spectra with error bars.\n\n## What changes\n\n1. **`plot_spt_estimator_comparison.py`**: In the residual panel (`ax_resid`), compute `(cl_alt - cl_gmv) / err_gmv` instead of `cl_alt - cl_gmv`. Add ±1σ and ±2σ reference lines. Update y-label.\n2. **`plot_spt_estimator_composite.py`**: May need updating if it includes residual panels. Check.\n3. Re-run `plot_all_spt_estimator_comparisons`.\n\n## Done when\n\n- Per-bin residual panels show sigma-normalized pulls\n- ±1σ/±2σ reference lines present\n- Evidence fresh\n\n## Progress\n\n**Iteration 4 (2026-02-18):** Script change done. `plot_spt_estimator_comparison.py:118-135` updated:\n- Changed `sigma_diff = np.sqrt(spec[\"err\"]**2 + gmv[\"err\"]**2)` → `sigma_diff = gmv[\"err\"]` (uses σ_GMV as reference)\n- Dropped check `spec[\"err\"] is not None` (only σ_GMV needed for denominator)\n- Added `ax_resid.axhline(±1, ...)` dotted reference lines\n- Updated y-label to `σ_GMV` notation\n- NOTE: the existing code ALREADY computed sigma-normalized residuals — the change is to the denominator convention and add ±1σ lines.\n- Re-run needed: `plot_all_spt_estimator_comparisons plot_spt_estimator_composite aggregate_spt_estimator_evidence`\n\n## Notes\n\n- The key finding is \"no foreground bias\" — TT/PP/MV should all be within ±1σ of GMV across ℓ-bins. The normalized plot makes this immediately visible.\n- The composite plot (`plot_spt_estimator_composite`) aggregates per-bin into a summary. Uses its own script (`plot_spt_estimator_composite.py`) — not affected by this per-bin change.",
      "outcome": "Done. plot_spt_estimator_comparison.py already had sigma-normalized residuals from iteration 4. smk-060606 regenerated all 14 per-bin plots + composite + evidence (fresh as of 2026-02-18T06:19). Denominator uses σ_GMV (not combined quadrature). ±1σ dotted reference lines and ±2σ gray band added. Per-bin residual panels now self-documenting: flat distribution around zero = estimators agree. Evidence: results/claims/plot_spt_estimator_comparison/evidence.json (16 outputs).",
      "createdAt": "2026-02-18T03:37:09.328033499+01:00",
      "closedAt": "2026-02-18T06:26:20.175316532+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "remove-results-table-node-merge-fd95ecb3",
      "title": "Remove results_table node, merge inline tables into summary",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "outcome": "Removed tapestry:generate_results_table tag from results-table-paper-ready-latex-2a507292. Node no longer appears in the tapestry dashboard. The results table content remains in the fiber body as a reference record.",
      "createdAt": "2026-02-18T03:37:14.300339126+01:00",
      "closedAt": "2026-02-18T05:53:39.644789881+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "rewire-early-spine-sky-to-b0b5cf6c",
      "title": "Rewire early spine: sky to apodization to estimator to spectra",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "outcome": "Rewired the early tapestry spine. Removed backward link (catalog_validation → signal_overview). Added: catalog_validation_summary depends on apodization_masks (estimator choice flows from methodology). Added: signal_overview depends on catalog_validation_summary (measurement flows from estimator). Spine is now: sky → apodization → estimator_choice → cross_spectra, with n_z branching from sky in parallel.",
      "createdAt": "2026-02-18T03:37:20.022439662+01:00",
      "closedAt": "2026-02-18T05:56:41.590982087+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "assign-region-labels-to-all-57f37f43",
      "title": "Assign region labels to all tapestry nodes",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "outcome": "Applied region tags to all 20 active tapestry nodes. Convention: region:data (2), region:methodology (3), region:measurement (2), region:validation:theory (3), region:validation:consistency (5), region:validation:null (3), region:validation:contamination (3), region:synthesis (1). Removed nodes (generate_results_table, spatial_variation) were already untagged.",
      "createdAt": "2026-02-18T03:37:24.567393935+01:00",
      "closedAt": "2026-02-18T05:55:48.448792613+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "strip-deprojection-b0aeb81e",
      "title": "Strip deprojection/marginalization references from tapestry fibers",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "body": "Template marginalization is no longer a tapestry node — it's an ingredient in the likelihood. The `evaluate_deprojected_likelihood` claim exists but doesn't appear to have a `tapestry:` tag. The `plot_deprojected_spectra` claim also has no tapestry tag.\n\nThe issue: fiber bodies for tapestry nodes that DO have `tapestry:` tags may contain language that exposes deprojection as a distinct analysis step (e.g., \"after template marginalization, SNR drops from 20σ to 15σ\"). The tapestry should present the marginalized result as the primary result, without foregrounding the methodology.\n\n## What to check\n\n1. Run `felt ls --all | grep \"tapestry:\"` to get the list of ~24 active tapestry nodes.\n2. For each, run `felt show <id>` and check the body/outcome for:\n   - References to \"deprojection\", \"template marginalization\", \"template subtraction\"\n   - Framing that presents raw SNR as primary and marginalized as secondary (should be reversed)\n   - References to `evaluate_deprojected_likelihood` or `plot_deprojected_spectra` as if they're tapestry siblings\n3. Edit fiber bodies to strip or reframe those references.\n\n## Current assessment\n\nCurrent tapestry (24 nodes after κκ descope) does not include `evaluate_deprojected_likelihood` or `plot_deprojected_spectra` as named nodes. But the `evaluate_fiducial_likelihood` fiber (\"Fiducial likelihood: 20σ detection, ΛCDM consistency\") likely references the comparison with deprojected results. Check that node first.\n\n## Done when\n\nNo tapestry fiber body exposes deprojection as a parallel analysis path. Template marginalization is mentioned only as the methodology behind the primary detection (15σ after joint fit).",
      "outcome": "Reframed two tapestry nodes to lead with 15σ (post-marginalization) as the primary detection claim. fiducial-likelihood-evaluation-4c17b5d9: title changed to 'Likelihood: 15σ (ACT), 14σ (SPT) detection — ΛCDM consistent'; detection table reordered to foreground marginalized S/N; outcome updated. analysis-summary-one-page-c5170698: section (a) rewritten to lead with 15σ, with pre-marginalization 20σ/21σ as context; section (d) rewritten to present ACT A_lens=0.86 as the result, theory comparison before marginalization as an upstream step; outcome updated. Other tapestry fiber mentions of 'template marginalization' are methodological (ingredient, not parallel path) — left intact.",
      "createdAt": "2026-02-18T03:37:29.307385423+01:00",
      "closedAt": "2026-02-18T05:53:53.742707224+01:00",
      "dependsOn": [
        "tapestry-dag-restructure-early-af2a640f"
      ]
    },
    {
      "id": "descope-cmb-lensing-32af86ea",
      "title": "Descope CMB lensing autospectrum — use likelihood-level N_L instead",
      "status": "closed",
      "kind": "task",
      "body": "Remove the CMB lensing autospectrum (κκ) from the pipeline entirely. The auto-spectrum requires RDN0+N₁ debiasing we don't have, and we don't need it — the likelihood uses published N_L curves directly, not recomputed auto-spectra from data.\n\n## What to do\n\n1. Remove the `tapestry:plot_kappa_spectrum` tag from fiber `cmb-lensing-power-spectrum-act-3832d477`. The node disappears from the dashboard.\n2. Remove or deprecate `compute_kappa_spectrum` / `plot_kappa_spectrum` rules and scripts. They were infrastructure for a probe we're not delivering.\n3. The parent fiber (`cmb-lensing-auto-spectrum-κκ-752374df`) stays closed with its outcome — it documents why κκ was descoped.\n\n## Why\n\nThe 3×2pt data vector is {γκ, δκ} cross-correlations only — same as DES×SPT and ACT×DES. κκ enters at the likelihood level through the published noise curves (ACT N_L, SPT N₀), not by measuring C_ℓ^{κκ} from the maps.",
      "outcome": "Removed tapestry:plot_kappa_spectrum tag from cmb-lensing-power-spectrum-act-3832d477. κκ rules (compute_kappa_spectrum, plot_kappa_spectrum, aggregate_kappa_spectrum_evidence) remain in explorations.smk for future reference when proper RDN0+N1 debiasing is available — they're commented as descoped in localrules. Node no longer appears on the tapestry dashboard.",
      "createdAt": "2026-02-18T03:47:43.04311905+01:00",
      "closedAt": "2026-02-18T05:39:03.477173034+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "knox-proxy-for-catalog-shear-c57104cd",
      "title": "Knox proxy for catalog shear fields: N^EE underestimates C^EE_total",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "body": "## Problem\n\nThe catalog-based Knox proxy in `compute_cross_spectrum.py` computes:\n\n```python\nknox_var = N^EE * C^{KK}_total / n_modes\n```\n\nwhere `N^EE = (σ²_e1 + σ²_e2) / (2 * n_eff_sr)` is the shape noise power.\n\nThe correct Knox formula requires:\n\n```python\nknox_var = C^{EE}_total * C^{KK}_total / n_modes\n```\n\nwhere `C^{EE}_total = C^{EE}_signal + N^EE`.\n\n## Impact\n\nFor a deep survey like Euclid RR2 with n_eff~8M/sr, the EE signal is NOT noise-dominated across ℓ=[40,3000]. At ℓ~1000, C^{EE}_signal >> N^EE by factor ~60. This means:\n- Knox variance is underestimated by ~C^{EE}_total / N^EE ≈ 60x\n- Knox SNR is inflated by sqrt(60) ≈ 8x\n\nCurrent aggregate: Knox median SNR=20.74, Knox max SNR=56.77 (likely inflated).\nDensity bins (map-based) show SNR=7.96 for bin4×ACT as reference.\n\n## Why shape noise was used\n\nNmtFieldCatalog doesn't return C_ℓ-normalized auto-spectra from compute_coupled_cell(cat, cat).\nThe internal catalog representation uses unnormalized pixelization (~10^8 vs expected ~10^-7).\n\n## Possible fixes\n\n1. **Theory C^EE**: Load theory EE auto-spectrum from theory NPZ (adds dep on compute_theory_cls)\n2. **Map-based auto proxy**: Build the shear maps independently for auto-spectrum estimation\n3. **Shear-kappa cross correlation coefficient bound**: Use r^2 <= 1 → SNR <= sqrt(n_modes)\n4. **Accept and document**: Knox is a proxy; the actual detection metric is from the likelihood A±σ_A\n\n## Current state\n\nKnox proxy implemented and running. All 70 shear spectra have Knox evidence with inflated SNR.\nThe evidence_knox fields are populated in each evidence.json.\nSNR overestimation doesn't affect the actual cross-spectrum data (cl, bpws in NPZ are correct).",
      "outcome": null,
      "createdAt": "2026-02-18T05:23:30.002318744+01:00",
      "closedAt": null,
      "dependsOn": [
        "default-to-catalog-based-e4dce945"
      ]
    },
    {
      "id": "vmpz-id-multi-file-systematic-3740c3f0",
      "title": "VMPZ-ID multi-file systematic maps: pick largest/latest for visualization",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Multiple FITS files per systematic type (PSF: 11, NOISE: 13, PERSISTENCE: 3). Three size classes: 509MB (full), 367MB (partial), 135MB (smallest). Unclear whether multiple files are different bands, components, or reprocessing iterations. Decision: pick largest-size file with latest timestamp as representative. Selected for config: PSF=20251031T130403 (509MB), NOISE=20251031T132119 (509MB), PERSISTENCE=20251031T135230 (509MB). This may be wrong if files represent different VIS/NISP components — inspect FITS headers if maps look anomalous.",
      "createdAt": "2026-02-18T06:51:16.907605469+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-maps-on-the-sky-83122c03"
      ]
    },
    {
      "id": "snakemake-session-stall-9ff04010",
      "title": "Snakemake session stall: localrule + SLURM interaction timing",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question"
      ],
      "outcome": "smk-063922 stalled at 7/12 steps after plot_act_vs_spt_composite (localrule, login node) finished while build_density_map SLURM job was still running. Session showed 7/12 in tmux pane and never resumed after SLURM job completed. Cause unknown — possibly the session timed out waiting for SLURM, or a state machine issue with localrule + SLURM interleaving. Fix: check lock status, unlock, start new session. Downstream jobs (compute_cross_spectrum + plot_act_vs_spt density_binall) ran correctly in fresh session smk-064331.",
      "createdAt": "2026-02-18T06:51:21.890921666+01:00",
      "closedAt": null,
      "dependsOn": [
        "snakemake-workflow-discipline-88f4f4f8"
      ]
    },
    {
      "id": "adding-sysmaps-to-config-e1b8b3f5",
      "title": "Adding sysmaps to config triggers null test cascade",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "config.yaml systematic_maps keys are iterated by compute_all_systematic_cross_spectra via expand(sysmap=config['systematic_maps'].keys()). Adding PSF, NOISE, PERSISTENCE, star_brightness_mean, galaxy_number_density, phz_quality (6 new maps) will trigger ~6×9×2 = ~108 new systematic cross-spectrum jobs when that target is run. This is intentional — these maps should eventually be null-tested. But the cascade won't happen until explicitly requested. plot_systematic_maps only loads and visualizes; it doesn't cascade to null tests.",
      "createdAt": "2026-02-18T06:51:29.274630231+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-maps-on-the-sky-83122c03"
      ]
    },
    {
      "id": "nmt-utils-load-systematic-map-ab2a9e4a",
      "title": "nmt_utils load_systematic_map: nside upgrade via hp.ud_grade for maps below target nside",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "phz_quality systematic map is at nside 1024 while pipeline target is 2048. read_partial_map raises ValueError when requested nside > map nside. Fix: catch the ValueError, load at native nside, apply zero_unseen, then hp.ud_grade to target nside. Upgrading (repeating pixels) is valid for systematic templates — no information added, spatial structure preserved. Bug found: missing 'import healpy as hp' inside the except block caused NameError after printing the log message. Added at top of function. phz_quality now processes correctly.",
      "createdAt": "2026-02-18T07:10:29.584778635+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "mask-coupling-inversion-b607103a",
      "title": "Mask-coupling inversion stability for spin-2 fields at low ℓ",
      "status": "closed",
      "kind": "task",
      "body": "NaMaster's mode-coupling matrix inversion may be numerically unstable for our mask geometry, particularly for spin-2 fields at low ℓ. Two independent signals point here:\n\n1. **Giulio's flag** (2026-02-18): check mask inversion for spin-2 fields (auto and cross). The coupling matrix for shear has EE/EB/BE/BB blocks — larger and potentially less well-conditioned than spin-0. B-modes especially affected. First few multipole bins most vulnerable.\n\n2. **Euclid WL-SWG investigation**: DR1 mask has challenging geometry — disconnected regions, irregular shapes. A study is being set up to test NaMaster covariance numerical stability by progressively excluding problematic mask features. Related to the partial-sky validation task: currently passing only the footprint to NaMaster, not the full heracles shear weight maps.\n\n## Possible connection to SPT ℓ≈100 spike\n\nThe SPT cross-spectra show a suspicious single-bandpower feature at ℓ≈100 (`spt-ℓ-100-spike-suspicious-ed5a480a`). This is exactly the regime where mask-inversion instability would manifest — low ℓ, partial sky, spin-2 fields. Worth investigating whether the spike is a mask artifact rather than (or in addition to) something in the SPT data.\n\n## What to investigate\n\n- Condition number of the mode-coupling matrix for our mask at low ℓ, spin-0 vs spin-2.\n- Whether the spike persists when using a simpler (e.g., apodized-only, no disconnected patches) mask.\n- Whether passing the full weight map (not just the binary footprint) to NaMaster changes the low-ℓ behavior.\n- How the WL-SWG DR1 mask stability study progresses — follow that thread.\n\n## Context\n\n- Our mask: `apodize(weight > 0, 0.15, \"C2\") * weight` for shear; `apodize(mask, 0.15, \"C2\")` for CMB.\n- NaMaster workspace caches the coupling matrix and its inverse — recomputing with a modified mask requires a new workspace.\n- We don't use `purify_b=True` (nor do gctools, ACT×DES, DES×SPT).\n- The Gaussian covariance already underestimates B-mode variance by 15–150× due to E→B leakage (`namaster-gaussian-covariance-9373b1fa`). Mask instability could compound this.",
      "outcome": "Coupling matrix conditioning diagnosed for ACT and SPT with our Euclid shear mask (fsky=0.009). Key findings: (1) Unbinned coupling matrix for spin-2 × spin-0 is formally SINGULAR (sv_min=0, cond=inf) for both experiments — the B-mode coupling subspace has exact zeros. Spin-0 × spin-0 is poorly conditioned but finite (ACT: 7e11, SPT: 1e15). (2) Despite this, the BINNED roundtrip test (couple → decouple) is PERFECT: amplification = 1.0 ± 2e-14 at every bandpower, including the lowest ℓ bins. NaMaster's bandpower binning projects out the singular directions. (3) Conclusion: the SPT ℓ≈100 spike is NOT a coupling matrix inversion artifact. The inversion is numerically stable for our analysis. Giulio's concern about spin-2 instability is valid for the unbinned matrix but does not affect our binned cross-spectra. Evidence: results/claims/diagnose_coupling_matrix/.",
      "createdAt": "2026-02-18T12:01:29.73479709+01:00",
      "closedAt": "2026-02-18T20:43:59.633621154+01:00",
      "dependsOn": [
        "spt-ℓ-100-spike-suspicious-ed5a480a",
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "benchmark-catalog-vs-map-7f987c25",
      "title": "Benchmark catalog vs map estimator: timing, memory, streaming",
      "status": "closed",
      "kind": "task",
      "body": "The catalog-based estimator is now production default, but we have no side-by-side benchmark against map-based. Need timing, peak memory, and an investigation into whether NmtFieldCatalog requires the full catalog in memory.\n\n## What to measure\n\nRun both estimators on the same target (e.g., lensmc bin1 × ACT) and compare:\n\n1. **Wall-clock time** — total and broken down: field creation, workspace computation, cross-spectrum, covariance (map only).\n2. **Peak memory** — use `/usr/bin/time -v` or equivalent to get max RSS. Current expectation: ~64GB catalog, unknown for map. The 64GB may be dominated by the catalog load rather than the harmonic transform.\n3. **Streaming feasibility** — can NmtFieldCatalog accept galaxies in chunks, or does it need all positions at once for the SHT? Check NaMaster source/docs. If full load is required, can we reduce memory by dropping columns early or using float32?\n\n## Context\n\n- Catalog: `NmtFieldCatalog(pos=[ra,dec], weights, fields=[-e1,e2], lmax, spin=2, lonlat=True)` — ~5M galaxies at lmax=3000.\n- Map: `NmtField(mask, [Q,U], spin=2, lmax=lmax)` — HEALPix nside=2048 maps.\n- Current catalog timing: ~3–4 min/job (from fiber outcome, not benchmarked).\n- Map timing: unknown (never measured against catalog).\n- The 64GB SLURM allocation may be conservative — actual peak RSS could be lower.\n\n## Approach\n\nAdd timing instrumentation to `compute_cross_spectrum.py` (or a thin benchmark wrapper). Run one job each way via snakemake with `/usr/bin/time -v` to capture RSS. Compare.\n\nFor streaming: read NaMaster's `NmtFieldCatalog` implementation to understand whether it builds an internal map or does a direct catalog→alm transform. If it builds a map internally, streaming won't help (and catalog vs map may be doing the same thing under the hood with extra overhead).",
      "outcome": "Code analysis (no benchmark needed): NmtFieldCatalog does a direct catalog→a_lm transform via ducc0.sht.adjoint_synthesis_general() — no intermediate HEALPix map. Memory: ~7 GB peak for 5M galaxies at lmax=3000 (confirmed by sacct), comparable to map-based (~4-8 GB at nside=2048). Streaming: not supported — all galaxy positions/values must be passed at initialization; ducc0 SHT expects full arrays. Wall clock: ~3-4 min/job (catalog) from production runs. Map-based timing unknown but expected similar since both ultimately compute SHTs. Key advantage of catalog: avoids pixelization artifacts. Key disadvantage: no get_mask() (raises ValueError), no NaMaster covariance support. The 64GB→8GB SLURM allocation change was validated by sacct — the original overprovisioning wasn't due to catalog memory requirements but conservative estimation. No side-by-side benchmark needed: catalog is default, validated against map within 1σ, and memory is well-characterized from production runs.",
      "createdAt": "2026-02-18T12:19:13.413151438+01:00",
      "closedAt": "2026-02-18T15:22:19.735004722+01:00",
      "dependsOn": [
        "default-to-catalog-based-e4dce945",
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "plot-systematic-maps-py-use-8b4b9b23",
      "title": "plot_systematic_maps.py: use load_systematic_map for phz_quality nside upgrade",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "plot_systematic_maps.py was calling read_partial_map(path, nside) directly, not load_systematic_map from nmt_utils. phz_quality is at nside 1024 (target 2048), so read_partial_map raised ValueError and phz_quality was silently zeroed in evidence.json. Fix: replace read_partial_map + zero_unseen with load_systematic_map(path, nside, log_fn=...) — the function already handles nside upgrading via hp.ud_grade (see nmt-utils-load-systematic-map-ab2a9e4a). Also removed unused import of read_partial_map from gctools. Fixed in workflow/scripts/plot_systematic_maps.py.",
      "createdAt": "2026-02-18T12:27:07.858948749+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "localrule-criterion-map-loading-bf78f662",
      "title": "Localrule criterion: map-loading plot rules belong on SLURM not login node",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "The workflow convention 'all plots are localrules' was wrong. Correct criterion: localrules for rules that read pre-computed small files (NPZ, PKL, JSON) and produce matplotlib line plots (under 2 min). SLURM for rules that load HEALPix FITS maps, run skyproj rendering, or do heavy compute. plot_systematic_maps loads 11 nside-16384 FITS files and renders 22 skyproj panels — SLURM territory. Login node runtime policy would kill it. User confirmed: running plotting on remote compute nodes is preferred for heavy jobs.",
      "createdAt": "2026-02-18T12:32:18.356196408+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "slurm-backfill-stuck-on-200d8d67",
      "title": "SLURM backfill stuck on ALLOCATED+NOT_RESPONDING nodes",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "plot_systematic_maps job persistently assigned to lrdn[3903,4011,4293,4401] which are ALLOCATED+NOT_RESPONDING (crashed while running jobs). SLURM backfill thinks they'll free up soon and reserves them for our job. No profile constraint — purely SLURM scheduler artifact. 60K idle CPUs available in dcgp_usr_prod but backfill keeps selecting dead nodes. Workaround: wait for admins to drain those nodes. smk-123423 waiting with job 34400284. Nothing to fix from user side.",
      "createdAt": "2026-02-18T12:35:33.17093505+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "disk-mb-0-does-not-suppress-9f51f7b0",
      "title": "disk_mb=0 does not suppress gres/tmpfs on Leonardo",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Leonardo's SLURM (dcgp_usr_prod partition) assigns gres/tmpfs=10GiB to ALL jobs automatically — this is a SLURM partition-level policy, not something the snakemake-slurm plugin adds. Setting disk_mb: 0 in snakemake default-resources or per-rule resources has no effect on tmpfs allocation because snakemake computes disk_mb from tmpdir size, not gres. The only way to suppress tmpfs would be a cluster admin change. The practical consequence: when those ~10GB slots are full cluster-wide, new jobs queue with ReqNodeNotAvail. This is a temporary cluster capacity state, not structural — it resolves when running jobs finish. Decision: accept the tmpfs assignment, exclude the 4 broken nodes (lrdn3903,4011,4293,4401) in prod profile, do not attempt to suppress tmpfs via disk_mb.",
      "createdAt": "2026-02-18T13:00:28.216457131+01:00",
      "closedAt": null,
      "dependsOn": [
        "slurm-backfill-stuck-on-200d8d67",
        "localrule-criterion-map-loading-bf78f662"
      ]
    },
    {
      "id": "namaster-covariance-interleaved-434112b9",
      "title": "NaMaster covariance: interleaved diagonal extraction bug (31× overestimate)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "outcome": "NaMaster gaussian_covariance() output for spin-2 × spin-0 has shape (2*nbins, 2*nbins) with components interleaved: (bin0_Eκ, bin0_Bκ, bin1_Eκ, ...). np.diag(cov)[:nbins] mixed Eκ/Bκ variances and mismatched bins → 31× apparent overestimate. Fix: reshape(nbins, n_cls, nbins, n_cls)[:, 0, :, 0]. Validated at fsky=0.0044: NaMaster/Knox = 1.26. The 'structural low-fsky overestimate' was a bug all along.",
      "createdAt": "2026-02-18T14:23:56.0875307+01:00",
      "closedAt": null,
      "dependsOn": [
        "namaster-covariance-validate-07e17cab"
      ]
    },
    {
      "id": "namaster-covariance-diagonal-827a0ca0",
      "title": "NaMaster covariance diagonal extraction bug: interleaved Eκ/Bκ components",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "outcome": "The 31× NaMaster/Knox overestimate was a diagonal extraction bug, not structural. For spin-2 × spin-0 cross-spectra, gaussian_covariance() output is (2*nbins, 2*nbins) with spectral components interleaved: (bin0_Eκ, bin0_Bκ, bin1_Eκ, bin1_Bκ, ...). Code used np.diag(cov)[:nbins] which mixed Eκ and Bκ from wrong bins. Fix: reshape to (nbins, n_cls, nbins, n_cls) and extract [:, 0, :, 0] diagonal (sp_validation pattern). Added extract_covariance_diagonal() to nmt_utils.py. Fixed in compute_cross_spectrum.py, compute_systematic_cross_spectrum.py, spectrum_utils.py, plot_cross_spectrum.py, plot_ell_range_robustness.py. Validation: density (spin-0, unaffected) gave NaMaster/Knox = 1.04. After fix, shear (spin-2) systematic cross-spectrum gives NaMaster/Knox = 1.26. The Gaussian covariance works at our sky fractions. Previous conclusion (namaster-overestimate-is-7462ad58) was wrong.",
      "createdAt": "2026-02-18T14:24:06.553700582+01:00",
      "closedAt": null,
      "dependsOn": [
        "namaster-covariance-validate-07e17cab"
      ]
    },
    {
      "id": "slurm-profile-wrong-qos-and-611fe1f9",
      "title": "SLURM profile: wrong QOS and runtime prevented job scheduling",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Profile had dcgp_qos_bprod (min 17 nodes) — wrong for single-node snakemake jobs. Also slurm_qos in default-resources wasn't passed (SLURM executor uses --slurm-qos flag). Additionally 24h runtime prevented backfill scheduling on dcgp_qos_lprod. Fix: slurm-qos: dcgp_qos_lprod, runtime: 30m. Jobs now schedule via backfill in <30s. Available QOS for our account: dcgp_qos_lprod (max 3 nodes, no min), dcgp_qos_bprod (min 17 nodes), dcgp_qos_dbg (max 1 job), normal (no limits but low priority).",
      "createdAt": "2026-02-18T14:24:11.084910386+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "slurm-profile-24h-runtime-9cb55504",
      "title": "SLURM profile: 24h runtime prevented backfill scheduling",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Jobs submitted with 24h runtime to dcgp_usr_prod couldn't be backfilled — sat in queue with (ReqNodeNotAvail) or (Priority) for 45+ min. Root cause: default runtime: 24h in prod profile. Additionally, slurm_qos: dcgp_qos_bprod was never passed by snakemake SLURM executor (needs --slurm-qos top-level flag, not resource). dcgp_qos_bprod requires min 17 nodes anyway — wrong for single-node jobs. Fix: runtime: 30m default + slurm-qos: normal (top-level flag). Jobs now schedule in ~2 min via backfill with no concurrency cap. Per-rule runtime overrides available for heavy rules. dcgp_qos_lprod (max 3 nodes) is faster to schedule but caps concurrency — not worth the tradeoff.",
      "createdAt": "2026-02-18T14:24:20.658335068+01:00",
      "closedAt": null,
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "full-tapestry-recomputation-047c308e",
      "title": "Full tapestry recomputation: smk-182218 (385 jobs, script fix)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "body": "Full tapestry recomputation launched 2026-02-18. Session: `smk-144735`.\n\n## What changed\n\n1. **Prod profile**: removed node exclusion (`--exclude=lrdn3903,lrdn4011,lrdn4293,lrdn4401`)\n2. **Resource tuning**: `mem_mb` values tightened based on sacct peak RSS data:\n   - `compute_cross_spectrum`: 64000 → 8000 (max observed: 7255 MB)\n   - `compute_systematic_cross_spectrum`: 32000 → 9000 (max: 8355)\n   - `compute_overlap_cross_spectrum`: 32000 → 8000 (max: 7090)\n   - `compute_sim_null_spectrum`: 32000 → 7000 (max: 6451)\n   - `compute_jackknife_null_spectrum`: 32000 → 7000 (max: 6429)\n   - `plot_systematic_maps`: 32000 → 7000 (max: 6027)\n   - `plot_apodization_masks`: 16000 → 5000 (max: 4678)\n   - `build_density_map`: 16000 → 1000 (max: 364)\n   - `compute_theory_cls`: 16000 → 1000 (max: 201)\n3. **sacct workflow** added to CLAUDE.md for future resource tuning\n\n## Targets\n\nAll 21 tapestry targets, ~747 jobs total. DAG triggered by code changes (provenance).\n\n## Monitoring\n\n```bash\nsnakemake-peek smk-144735\n```\n\n## For next iteration\n\n- Check if any jobs OOM with the tightened resources (sacct --state=OUT_OF_MEMORY)\n- After completion, check sacct for rules that didn't have prior data: `compute_cmbk_systematic_cross_spectrum`, `compute_cmb_noise_curve`, `compute_patch_cross_spectrum`, `compute_kappa_spectrum`, `plot_field_overview`, `plot_wiener_diagnostic`, `build_jackknife_null_maps`, `compute_catalog_cross_spectrum`\n- While running: cleanup tapestry narrative and structure",
      "outcome": "Full tapestry recomputation completed successfully. All 21 tapestry targets rebuilt with tightened mem_mb values (sacct-tuned). No OOM failures. Evidence freshness: 36/39 rules at Feb 18 timestamps. The 3 stale rules (combine_shear_cross_spectra, plot_cross_spectrum, validate_sacc) date from Feb 15 — exploration rules that weren't part of this run's targets.",
      "createdAt": "2026-02-18T14:48:22.968860405+01:00",
      "closedAt": "2026-02-18T20:58:54.078089044+01:00",
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "slurm-mem-mb-tightened-sacct-c8835038",
      "title": "SLURM mem_mb tightened: sacct shows catalog CLs peak at 7GB not 64GB",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "sacct .0 step MaxRSS reveals all rules were 4-64× overprovisioned. Biggest surprise: compute_cross_spectrum (catalog estimator with NmtFieldCatalog) peaks at 7.3GB despite 64GB allocation — the catalog transform doesn't hold the full dataset in memory as expected. Tightened 9 rules: compute_cross_spectrum 64→8GB, compute_systematic_cross_spectrum 32→9GB, compute_{overlap,sim_null,jackknife_null}_cross_spectrum 32→7-8GB, plot_systematic_maps 32→7GB, plot_apodization_masks 16→5GB, build_density_map 16→1GB, compute_theory_cls 16→1GB. Rules without sacct data left at original values pending this run. sacct workflow added to CLAUDE.md for future tuning.",
      "createdAt": "2026-02-18T14:49:26.508698974+01:00",
      "closedAt": null,
      "dependsOn": [
        "full-tapestry-recomputation-047c308e"
      ]
    },
    {
      "id": "prod-profile-removed-node-6a7959fc",
      "title": "Prod profile: removed node exclusion list",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Removed slurm_extra --exclude=lrdn3903,lrdn4011,lrdn4293,lrdn4401 from prod profile. Originally added when those nodes were ALLOCATED+NOT_RESPONDING (crashed). Cluster state may have changed; removing to let scheduler use all available nodes. If specific nodes cause failures, re-add selectively.",
      "createdAt": "2026-02-18T14:49:34.705907267+01:00",
      "closedAt": null,
      "dependsOn": [
        "slurm-mem-mb-tightened-sacct-c8835038"
      ]
    },
    {
      "id": "systematic-spectra-plot-raw-6dbe8e47",
      "title": "Systematic spectra plot: raw contamination ingredients",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Created plot_systematic_spectra.py + snakemake rule. Shows the three cross-spectra (C^{fS}, C^{κS}, C^{SS}) that compose the contamination metric, per systematic × method. 3-panel vertical layout: tracer×sys (6 bins), CMBκ×sys (ACT+SPT), sys auto. 33 jobs total (11 sysmaps × 3 methods). Rule added to explorations.smk as localrule. Awaiting recomputation completion to run.",
      "createdAt": "2026-02-18T15:02:24.295687353+01:00",
      "closedAt": null,
      "dependsOn": [
        "contamination-analysis-b813f196"
      ]
    },
    {
      "id": "null-tests-extended-to-density-5c949fca",
      "title": "Null tests extended to density",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Extended plot_systematic_null_tests to produce both shear and density pull figures. Script refactored into make_null_test_figure() function, called for lensmc and density separately. Rule now expands evidence_files over all_methods (not just shear_methods). Evidence JSON includes per_method statistics. Output path unchanged — evidence.json compatible with downstream plot_analysis_summary and generate_results_table.",
      "createdAt": "2026-02-18T15:02:29.287860006+01:00",
      "closedAt": null,
      "dependsOn": [
        "contamination-analysis-b813f196"
      ]
    },
    {
      "id": "no-pdf-libraries-in-container-922c1000",
      "title": "No PDF libraries in container — can't read DES×SPT paper",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Container lacks fitz/PyPDF2/pdfplumber/pikepdf. pdftotext also unavailable. Cannot extract text from PDF on cluster. Options: (1) install poppler-utils or pymupdf in container, (2) convert PDF to text externally and copy to cluster, (3) find LaTeX source. Low priority — paper reading is a bandwidth task.",
      "createdAt": "2026-02-18T15:04:04.402592395+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "systematic-spectra-raw-c-fs-c-3d65264d",
      "title": "Systematic spectra: raw C^{fS}, C^{κS}, C^{SS} contamination ingredients",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_systematic_spectra",
        "region:validation:contamination"
      ],
      "outcome": "Shows the three cross-spectra composing the contamination metric X = C^{κS}·C^{fS}/C^{SS} for each systematic × method × CMB experiment combination. All 6 redshift bins overlaid per panel. Makes the C^{SS} noise bias visible — denominator dominated by pixel noise at high ℓ from nside 16384→2048 downgrade, which makes X a lower bound on true contamination. Created as tapestry node to complete the maps→spectra→metric contamination path. Script: plot_systematic_spectra.py. Evidence in results/claims/plot_systematic_spectra/.",
      "createdAt": "2026-02-18T15:15:01.248403045+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-null-test-heatmap-92dec7e5",
        "systematic-maps-on-the-sky-83122c03",
        "contamination-metric-product-c-e55501f4",
        "systematic-contamination-summary-e6c81e29"
      ]
    },
    {
      "id": "covariance-validation-namaster-4b3c85a4",
      "title": "Covariance validation: NaMaster agrees with Knox within 25%",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:plot_covariance_validation",
        "region:methodology"
      ],
      "body": "Two independent covariance estimates — NaMaster Gaussian (harmonic-space, mask-aware) and Knox formula (analytic mode counting) — agree within ~25% for density × CMB κ cross-spectra across all 6 redshift bins and both CMB experiments. This validates the error bars used throughout the analysis.\n\n**NaMaster Gaussian covariance** uses the Improved Narrow Kernel Approximation (INKA) with theory+noise guess spectra: C^{κκ} + N_L for the CMB auto, C^{EE/δδ} + shape/shot noise for the galaxy auto, and C^{fκ}_theory for the cross. This captures mask mode-coupling effects that the Knox formula ignores.\n\n**Knox formula** uses analytic mode counting: Var(C^{ab}_b) = C^{aa}_b · C^{bb}_b / n_modes_b, with n_modes from fsky_eff (Hivon 2002). Independent of mask geometry beyond the effective sky fraction.\n\nThe ratio NaMaster/Knox ≈ 1.04 for density (spin-0 × spin-0) and ≈ 1.26 for shear (spin-2 × spin-0, map-based). The >1 ratio is expected: mode coupling from partial sky mixes power between bins, increasing variance beyond what Knox predicts.\n\n**For catalog-based shear** (production default): the NaMaster Gaussian covariance is computed using an auxiliary map-based NmtField. The catalog field measures the spectrum (via NmtFieldCatalog), but the covariance workspace requires map-domain masks that NmtFieldCatalog can't expose. Since covariance depends on mask geometry and auto-spectra (not the measurement method), the map-based covariance is valid for catalog spectra. This gives uniform NaMaster error bars across all probes.\n\n**Bug history**: An interleaved diagonal extraction bug inflated the apparent NaMaster/Knox ratio to ~31× for spin-2 fields. The NaMaster `gaussian_covariance()` output for spin-2 × spin-0 is (2·nbins, 2·nbins) with Eκ and Bκ components interleaved as (bin0_Eκ, bin0_Bκ, bin1_Eκ, ...). Plain `np.diag(cov)[:nbins]` mixed components from wrong bins. Fixed via `extract_covariance_diagonal()` in `nmt_utils.py`.\n\n**Script**: `cmbx/files/workflow_scripts_plot_covariance_validation.py`",
      "outcome": "NaMaster Gaussian covariance validated against Knox formula. Density (spin-0): median NaMaster/Knox = 1.04 (range 0.96–2.21, std 0.15). Shear (spin-2, map-based auxiliary field): ~1.26. NaMaster deployed as primary error bars throughout the tapestry. Catalog-based shear uses map-based auxiliary NmtField for covariance since NmtFieldCatalog cannot expose masks. Interleaved diagonal extraction bug (31× overestimate) fixed in nmt_utils.extract_covariance_diagonal(). Knox kept as diagnostic only.",
      "createdAt": "2026-02-18T15:46:29.913255271+01:00",
      "closedAt": "2026-02-18T18:09:58.665430158+01:00",
      "dependsOn": [
        "namaster-covariance-validate-07e17cab",
        "ralph-titan-tapestry-b5db47d7",
        "catalog-validation-summary-d0b856bd",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "namaster-preferred-over-knox-c06c65ea",
      "title": "NaMaster preferred over Knox for plot error bars",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "outcome": "Swapped preference in spectrum_utils.load_cross_spectrum(): NaMaster cov diagonal is now first choice for err, Knox is fallback. Affects all downstream plot scripts. For catalog-based shear (production default), NaMaster cov is unavailable so Knox proxy remains. For density (map-based), NaMaster captures mode-coupling that Knox ignores. Also updated plot_signal_overview.py to compute S/N from the same error source as the plotted bars. Stale Knox-as-primary references fixed in 4 tapestry fibers: n-z-quantization, fiducial-likelihood, theory-residuals, analysis-summary.",
      "createdAt": "2026-02-18T16:00:46.276845323+01:00",
      "closedAt": null,
      "dependsOn": [
        "covariance-validation-namaster-4b3c85a4"
      ]
    },
    {
      "id": "slurm-database-outage-blocks-989460ec",
      "title": "SLURM database outage blocks recomputation smk-155005",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "outcome": "slurmdbd recovered after ~10 min. smk-155005 could not recover (retry loop with dead sacct). Killed session, unlocked, restarted as smk-160542. All 5 in-flight jobs had COMPLETED while slurmdbd was down.",
      "createdAt": "2026-02-18T16:01:00.880507836+01:00",
      "closedAt": "2026-02-18T16:27:18.41700906+01:00",
      "dependsOn": [
        "full-tapestry-recomputation-047c308e"
      ]
    },
    {
      "id": "map-based-namaster-covariance-884f2578",
      "title": "Map-based NaMaster covariance for catalog-based shear cross-spectra",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "covariance"
      ],
      "outcome": "Catalog-based shear now uses map-based auxiliary NmtField for NaMaster Gaussian covariance. NmtFieldCatalog can't expose get_mask() needed for covariance workspace, but covariance depends on mask geometry and auto-spectra, not measurement method. Snakefile passes map+mask alongside catalog as inputs. Script builds auxiliary map-based field for cov_workspace and gaussian_covariance while using catalog field for the spectrum. Knox proxy kept as diagnostic. Changes: Snakefile get_euclid_map_files(), compute_cross_spectrum.py, plot_covariance_validation.py (now shows both density+shear ratios), spectrum_utils.py comments.",
      "createdAt": "2026-02-18T16:18:20.163553289+01:00",
      "closedAt": null,
      "dependsOn": [
        "covariance-validation-namaster-4b3c85a4"
      ]
    },
    {
      "id": "stale-spt-variant-theory-files-485fb4a6",
      "title": "Stale SPT variant theory files crash compute_cross_spectrum for bin=all",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "outcome": "SPT variant (TT/PP/MV) theory files were stale — missing binall keys (cl_ee_theory_binall, cl_ia_theory_binall, cl_theory_binall). compute_cross_spectrum fell to legacy covariance path which tried knox_result['pcl_11'], but catalog Knox proxy has no pseudo-Cl → KeyError → 6 failed jobs. Fixed: (1) regenerated variant theory files, (2) made legacy fallback graceful — skips NaMaster covariance when neither theory nor pseudo-Cl available. Root cause: theory files are params (not inputs) to cross-spectrum rule, so snakemake doesn't track their staleness.",
      "createdAt": "2026-02-18T18:22:30.726843997+01:00",
      "closedAt": null,
      "dependsOn": [
        "spt-ℓ-100-spike-suspicious-ed5a480a"
      ]
    },
    {
      "id": "login-node-kills-snakemake-67fc979c",
      "title": "Login node kills snakemake coordinator after ~25 min",
      "status": "closed",
      "kind": "task",
      "tags": [
        "investigation"
      ],
      "outcome": "snakemake-tmux coordinator process on login node killed by system runtime policy after ~25 min. All SLURM jobs complete; only coordinator dies. Fix: use -j100 for high parallelism to finish within the window. Alternatively, break large runs into phases (compute first, then plots). The 385-job recomputation's compute phase completed in ~22 min at -j20. The plot phase needed a separate re-launch.",
      "createdAt": "2026-02-18T19:01:31.970657981+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "theory-files-as-params-create-55d2b3e0",
      "title": "Theory files as params create staleness risk",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "compute_cross_spectrum declares theory NPZ as params (not input) to avoid circular DAG dependency (theory → data_dir → cross_spectrum → data_dir). This means snakemake doesn't track theory file freshness. When the theory script is updated, variant theory files can remain stale indefinitely. Mitigation: the compute_cross_spectrum script now handles missing theory keys gracefully (skips NaMaster covariance, falls back to Knox). Long-term: consider splitting theory auto-spectra into a separate rule with no circular dependency.",
      "createdAt": "2026-02-18T19:01:36.830617429+01:00",
      "closedAt": null,
      "dependsOn": [
        "stale-spt-variant-theory-files-485fb4a6"
      ]
    },
    {
      "id": "remove-dead-scripts-and-fix-7ee38e7e",
      "title": "Remove dead scripts and fix explorations.smk bugs",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "Removed 2 dead scripts (build_rr2_mask.py — notebook-style, never integrated; diagnose_sign.py — one-off diagnostic, declared red herring). Fixed blocking bug in compute_kappa_spectrum rule (get_cmb_noise_curve_path → get_cmb_noise_curve). Added missing wildcard constraint to plot_ell_range_robustness_spt_variants (method='lensmc|metacal'). Full audit: 94 rules in explorations.smk, all 52 referenced scripts exist, 45 localrules correctly categorized, no anti-patterns found.",
      "createdAt": "2026-02-18T20:53:15.782729882+01:00",
      "closedAt": null,
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "remove-sign-test-rule-and-77697d8d",
      "title": "Remove sign_test rule and annotate descoped kappa rules",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "Removed sign_test rule + sign_test_lean.py script (one-off diagnostic, issue resolved — sign convention validated as [-e1, e2]). Annotated κ×κ spectrum rules (compute_kappa_spectrum, plot_kappa_spectrum, aggregate_kappa_spectrum_evidence) with DESCOPED comment block explaining RDN0+N₁ absence and referencing fiber descope-cmb-lensing-32af86ea. Also fixed YAML parsing error in full-tapestry-recomputation-047c308e (unquoted colon in title) and closed that fiber — all 21 tapestry targets rebuilt successfully with tightened mem_mb, evidence 92% fresh.",
      "createdAt": "2026-02-18T21:04:49.168705088+01:00",
      "closedAt": null,
      "dependsOn": [
        "ralph-titan-tapestry-b5db47d7"
      ]
    },
    {
      "id": "tapestry-phase-2-comprehensible-3240e986",
      "title": "Tapestry Phase 2: Comprehensible Narrative",
      "status": "open",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "## Desired State\n\nThe tapestry reads as a story. A collaborator landing cold can traverse it and understand the analysis — what was measured, whether it's real, what contaminates it, how robust it is.\n\n### Progressive disclosure IS the tapestry\n\nThe hierarchy isn't inside figures — it's the DAG topology itself. Nodes are like sections in a paper. At first view, a reader sees a handful of top-level nodes. Clicking into any node reveals its neighborhood: linked methodology, detail, and context nodes. It's a hierarchical zoom on the project.\n\n- **Top-level nodes**: The story at a glance. Flexible number — as many as the story needs, but each earns its place.\n- **Neighborhood nodes**: Methodology, validation, detail that unfolds when you enter a top-level node. Apodization, estimator choice, covariance — these surround the measurement node.\n- **Per-wildcard evidence**: Within any node, the plots themselves can have depth. Hero figure up front, composites and per-wildcard plots accessible underneath.\n\nThis replaces the phase-1 tapestry entirely. When phase 2 is complete, the old 24-node tapestry is deleted. Phase-1 nodes may be reused, modified, or replaced — whatever serves the narrative.\n\n### Figure invariants\n\n- Top-level nodes show the **all-bin** result by default. Per-bin detail lives in composites or neighborhood nodes.\n- Three CMB baselines: **ACT, SPT-GMV, SPT-PP**. GMV is highest-SNR, PP is least-biased — both matter. TT/MV are consistency checks in a dedicated SPT-internal node.\n- Three galaxy tracers: **lensmc, metacal, density**. These are the columns of the analysis.\n- Each node answers **one question**. If it needs a paragraph to explain what you're looking at, it's two nodes.\n\n### Plot DRY\n\nMany plotting scripts follow the same pattern: load NPZ cross-spectra → plot C_ℓ with errorbars → overlay theory → compute residuals. As composites are built, extract shared patterns into `plot_utils.py` or a `composite_utils.py`. Don't build the abstraction before the second use — let it emerge from concrete figures.\n\n## Context\n\n### Phase-1 tapestry (being replaced)\n\n24 nodes, all closed with evidence. 220 PNGs across `results/claims/`. Regions: data (2), methodology (4), measurement (1), validation:consistency (4), validation:contamination (5), validation:null (3), validation:theory (3), synthesis (1).\n\nKey fibers to consult:\n- `felt show 706364a6` — field overview (current maps node)\n- `felt show findings-synthesis-euclid-cmb-03354e57` — comprehensive narrative of all nodes\n\n### Wildcard dimensions\n\n```\ntom_bins = [\"1\",\"2\",\"3\",\"4\",\"5\",\"6\"]     # 6 tomographic bins\nall_bins = [\"all\"] + tom_bins             # 7 total\nshear_methods = [\"lensmc\", \"metacal\"]     # 2 shear pipelines\nall_methods = [\"lensmc\", \"metacal\", \"density\"]  # 3 galaxy tracers\ncmbk_baseline = [\"act\", \"spt_winter_gmv\"]       # 2 primary CMB maps\nspt_variants = [\"spt_winter_gmv\", \"spt_winter_tt\", \"spt_winter_pp\", \"spt_winter_mv\"]\n```\n\nCMB baselines for heroes: ACT + SPT-GMV + SPT-PP (3). SPT-TT/MV are consistency only.\n\nPrimary matrix: 7 bins × 3 tracers × 3 CMB = 63 data vectors. With 11 systematics: 63 × 11 = 693 contamination assessments. The tapestry must make this comprehensible.\n\n### Key file paths\n\n- Plot scripts: `workflow/scripts/plot_*.py`\n- Shared utilities: `cmbx/files/workflow_scripts_plot_utils.py`, `cmbx/files/workflow_scripts_spectrum_utils.py`\n- Rules: `cmbx/files/workflow_rules_explorations.smk`\n- Evidence: `results/claims/{specName}/`\n- Config: `cmbx/files/config_config.yaml`\n- Existing field overview: `workflow/scripts/plot_field_overview.py`\n- Density maps: `results/rr2_v2_1_wl_031224-v0.0/gc/`\n\n### Starting point: maps node\n\nThe first node to build. Current `plot_field_overview` shows ACT κ, SPT κ, and shear weights (3 rows × 2 patches). Modify it to a 2×2 grid:\n- Row 1: Shear weights (all bins, north | south)\n- Row 2: Density overdensity (all bins, north | south)\n\nCMB κ maps get their own node eventually — separate from the Euclid data overview. The maps node answers: \"what Euclid data are we cross-correlating?\"\n\n`build_density_map` produces per-bin maps. An \"all\" bin aggregation is needed (check if it already exists; if not, add it).\n\n### Existing rules can be modified\n\nWhen a phase-2 node replaces a phase-1 node's function, modify the existing rule rather than creating a parallel one. The old tapestry is being replaced, not preserved. Avoid duplication.\n\n## Skills\n\nActivate before working:\n- `/snakemake` — for rule definitions and execution\n- `/tapestry` — for fiber/evidence conventions\n- `/implementing-code` — for script changes\n\n## Evidence\n\nProgress is measured by:\n- `felt ls -t tapestry` — do new nodes exist?\n- `ls results/claims/*/evidence.json` — does each node have computed evidence?\n- Visual inspection: does the figure compress information? Can you understand it without reading the script?\n- The number of top-level nodes should grow steadily across iterations, each one earning its place in the narrative.\n\n### Quality bar\n\nA node is done when:\n1. It answers its question in one visual at the top level\n2. All-bin result is prominent; per-bin is accessible but not dominant\n3. Three CMB baselines (ACT, GMV, PP) appear where relevant\n4. Evidence.json has meaningful metrics (not just file lists)\n5. A collaborator unfamiliar with the figure can interpret it within 30 seconds\n\n## Open Questions\n\n- **Dashboard progressive disclosure**: How to implement \"click to expand\" in the force-directed DAG? Regions? Collapsed subgraphs? This is interface work — deferred but the DAG structure should support it.\n- **Density \"all\" bin**: Does `build_density_map` already produce an aggregated map across bins 1-6? If not, how to combine (mean δ? weighted sum?).\n- **Tapestry tag namespace**: Should phase-2 nodes use a different tag prefix or region scheme to distinguish them from phase-1 while both coexist? Or just replace phase-1 tags as nodes are rebuilt?\n- **Node inventory**: The full set of top-level nodes hasn't been prescribed — it should emerge from building them one at a time. Candidates include: maps, CMB κ, the signal (cross-spectra), redshift scaling, experiment consistency, method consistency, SPT estimators, systematic budget, null tests, detection/likelihood, synthesis. But the number is flexible.",
      "outcome": null,
      "createdAt": "2026-02-18T21:17:38.177721434+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "systematic-spectra-evidence-f060d0e7",
      "title": "Systematic spectra evidence pipeline: fix LaTeX bug, add aggregate rule",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "plot_systematic_spectra had a LaTeX rendering bug: tracer_symbol + 'S' produced '\\gammaS' (invalid TeX) for shear methods. Fixed to '\\gamma\\,S'. Added plot_systematic_spectra to localrules. Added aggregate_systematic_spectra_evidence rule to explorations.smk using aggregate_evidence.py. Added plot_systematic_spectra handler to aggregate_evidence.py. Ran all 33 plots + aggregation. Evidence now at results/claims/plot_systematic_spectra/evidence.json — the only tapestry coherence gap is closed.",
      "createdAt": "2026-02-18T21:23:26.172790456+01:00",
      "closedAt": null,
      "dependsOn": [
        "systematic-spectra-raw-c-fs-c-3d65264d"
      ]
    },
    {
      "id": "plotting-standards-57ba2ceb",
      "title": "Plotting standards",
      "status": "closed",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "body": "# Plotting Standards\n\n**This fiber is authoritative.** If `plot_utils.py` diverges, update the code.\n\n## Style Foundation\n\n`paper.mplstyle` is the single source of truth for fonts, sizes, and structural elements. Forked from the official Euclid stylesheet (`cmbx/files/code_q1_cmbx_notebooks_euclid_stylesheet.mplstyle`, Lukas Hergt).\n\nAll scripts load the stylesheet before any plotting:\n```python\nfrom plot_utils import setup_theme\nsetup_theme()  # applies paper.mplstyle + seaborn style\n```\n\n### Fonts\n- Base: 8pt, sans-serif, `text.usetex: True`\n- Relative sizing: `medium`, `large` — don't hardcode pt values\n- Exception: dense heatmap tick labels may override to 7pt\n\n### Structural\n- Ticks: inward, both sides (`xtick.top`, `ytick.right`)\n- Axes linewidth: 0.6\n- Line width: 1.0\n- Marker size: 5.0\n- Tight bbox: `savefig.bbox: tight`, pad 0.02\"\n\n### DPI\n- 300 everywhere. No exceptions.\n\n## Figure Dimensions\n\n| Layout | Size | Use |\n|--------|------|-----|\n| Single panel | 4.0 × 3.0\" | Individual spectra, comparisons |\n| Double-column | 2 × fw | Side-by-side panels |\n| 2×3 grid (6 bins) | 2 × fw, height by content | Tomographic comparisons |\n| Stacked (E + B) | fw × 1.75 × fh, `height_ratios=[3,1]` | Shear cross-spectra |\n\n`fw, fh = plt.rcParams['figure.figsize']` — derive from stylesheet, don't hardcode.\n\n## Seaborn Theme\n\n| Context | Style |\n|---------|-------|\n| Spectral plots, comparisons, residuals | `\"ticks\"` |\n| Overview panels, summary figures | `\"whitegrid\"` |\n| Heatmaps, budget tables | `\"white\"` |\n\nAlways `sns.despine()` after axis setup (except heatmaps).\n\n## Colors\n\n### CMB Experiments\nDefined in `plot_utils.COLORS`. Never hardcode experiment colors.\n\n| Key | Color | Hex |\n|-----|-------|-----|\n| act | salmon | `#E8788A` |\n| spt_winter_gmv | teal | `#5B9EA6` |\n| spt_winter_tt | warm salmon | `#E8927C` |\n| spt_winter_pp | mint | `#7ECFC0` |\n| spt_winter_mv | lavender | `#9B8EC8` |\n| planck | black | — |\n| ia | crimson | — |\n\n### Tomographic Bins\n`BIN_PALETTE = sns.color_palette(\"husl\", 6)` — perceptually uniform for 6 categories.\n\n### Colormaps\n- Sequential: `mako`, `rocket`\n- Diverging: `icefire`\n\n## Markers\n\nDefined in `plot_utils.MARKERS`. One shape per experiment.\n\n| Experiment | Marker |\n|-----------|--------|\n| ACT | `o` (circle) |\n| SPT GMV | `s` (square) |\n| SPT TT | `v` (triangle down) |\n| SPT PP | `^` (triangle up) |\n| SPT MV | `D` (diamond) |\n\n## Error Bars\n\n```python\nax.errorbar(ells, y, yerr=yerr,\n    fmt=MARKERS[cmbk], color=COLORS[cmbk],\n    markersize=5, capsize=2, elinewidth=1)\n```\n\n## Axis Conventions\n\n- **Scaling**: always `ℓ · C_ℓ` prefactor\n- **X-axis**: log scale, `ELL_MIN=30` to `ELL_MAX=4000` (analysis range is 40–3000; plot range gives breathing room)\n- **X-label**: `r\"Multipole $\\ell$\"`\n- **Zero line**: `ax.axhline(0, color=\"gray\", ls=\"--\", lw=0.8, alpha=0.5)`\n- **Y-axis**: consistent range per metric across all redshift bins. Don't auto-scale per bin — the eye should compare amplitudes across panels.\n- **Helper**: `setup_spectrum_axes(ax, ylabel)` applies all of the above\n\n### Theory Curves\n- **Binned**: `\"k-\"`, `lw=1.5`, `alpha=0.8`\n- **Unbinned**: `color=\"gray\"`, `lw=0.8`, `alpha=0.4`, `zorder=0`\n- **IA theory**: `color=\"crimson\"`, `ls=\"--\"`, `lw=1.5`\n\n## Multipanel\n\n- 2×3 grid for 6 tomographic bins\n- Panel labels: `(a)`–`(f)` via `chr(ord(\"a\") + i)`\n- X-labels: bottom row only\n- Y-labels: left column only\n- Legend: first panel only, `fontsize` from stylesheet (medium = 8pt)\n\n## Statistical Annotations\n\nTop-right corner info box:\n```python\nax.text(0.97, 0.95, f\"S/N = {snr:.1f}\",\n    transform=ax.transAxes, ha=\"right\", va=\"top\", fontsize=\"medium\",\n    bbox=dict(boxstyle=\"round,pad=0.3\", facecolor=\"white\",\n              edgecolor=\"0.7\", alpha=0.9))\n```\n\n## Evidence Sidecar\n\nEvery plot script saves evidence via `save_evidence()`:\n```python\nfrom plot_utils import save_evidence\n\nevidence = {\n    \"id\": str,\n    \"artifacts\": {\"png\": output_png.name},\n    \"evidence\": { ... }\n}\nsave_evidence(evidence, evidence_path, snakemake)\n```\n\n`save_evidence()` automatically adds:\n- `generated` timestamp (UTC ISO format)\n- `provenance.input` — snakemake input files\n- `provenance.output` — snakemake output files\n- `provenance.params` — snakemake parameters\n\n## Centralized Code\n\n| Module | Responsibility |\n|--------|---------------|\n| `plot_utils.py` | COLORS, LABELS, MARKERS, SYSMAP_LABELS, TOM_BINS, BIN_PALETTE, FW, FH, setup_theme(), save_evidence() |\n| `spectrum_utils.py` | NPZ loading, SNR, chi², amplitude fitting |\n| `paper.mplstyle` | Fonts, sizes, structural rcParams (Euclid fork) |\n\n## Exceptions\n\nThese scripts keep hardcoded figsize (skyproj/map panels, intentionally large):\n- `plot_apodization_masks.py` — 3×4 skyproj\n- `plot_field_overview.py` — 3×2 skyproj\n- `plot_systematic_maps.py` — n×2 skyproj\n\n`text.usetex: True` — LaTeX is available in the container.",
      "outcome": "Plotting standards implemented and documented. paper.mplstyle (Euclid fork: 8pt/sans-serif/inward ticks/300dpi), FW/FH dimension constants, ELL_MIN/ELL_MAX axis range, setup_spectrum_axes() helper, save_evidence() with snakemake provenance. 33 scripts updated for figsize, 46 savefig calls standardized (DPI via mplstyle), 32 scripts migrated to save_evidence(). Consistent y-axis range per metric across bins (standard, not yet enforced in all scripts). text.usetex=False (no LaTeX in container). Fiber is authoritative over plot_utils.py.",
      "createdAt": "2026-02-18T21:40:41.466982336+01:00",
      "closedAt": "2026-02-18T22:03:23.386115437+01:00",
      "dependsOn": []
    },
    {
      "id": "skills-vs-doc-fibers-for-b7e2aef8",
      "title": "Skills vs doc fibers for project standards",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "For project-specific methodology that's relevant every session, doc fibers referenced from CLAUDE.md are the right layer — not skills. Skills earn their keep only when: (1) knowledge needs to be in attention before you know you need it, AND (2) there are sessions where you don't need it. For cmbx, methodology is always relevant, so a skill adds indirection without benefit. The real taxonomy is two layers: in-attention (CLAUDE.md, loaded skills) vs one-fetch-away (fiber links, skill references). The container doesn't matter — what matters is whether text is loaded or pointed to.",
      "createdAt": "2026-02-18T22:23:53.489879481+01:00",
      "closedAt": null,
      "dependsOn": [
        "plotting-standards-57ba2ceb"
      ]
    },
    {
      "id": "claude-md-doc-fiber-table-at-top-88568c6e",
      "title": "CLAUDE.md doc fiber table at top",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Doc fibers table moved to immediately after objective in CLAUDE.md. Every session sees it first. Old inline Fibers section and scattered doc fiber lists consolidated into one table. CLAUDE.md is index + imperatives; fibers hold depth. Visualization line removed — plotting-standards fiber is authoritative.",
      "createdAt": "2026-02-18T22:24:02.584315274+01:00",
      "closedAt": null,
      "dependsOn": [
        "plotting-standards-57ba2ceb",
        "skills-vs-doc-fibers-for-b7e2aef8"
      ]
    },
    {
      "id": "push-analysis-pipeline-to-24e42d28",
      "title": "Push analysis pipeline to Euclid GitLab",
      "status": "open",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "dr1_notebooks: 7 commits to main covering entire analysis pipeline — shared utilities, workflow+config, compute pipeline (17 scripts), exploration scripts, 32 plotting scripts, likelihood+evidence pipeline. 67 files total. Added .gitignore for workflow logs.\n\ndr1_cmbx: 1 commit to main — maps.py moved to eDR1data/, added extra_header param to write_sparse_map(), removed eager imports from __init__.py.\n\nBoth pushed to gitlab.euclid-sgs.uk. Motivated by cluster downtime 2026-02-19.",
      "createdAt": "2026-02-18T23:45:54.382884498+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "ia-bias-mr-nla-z-simplification-80e2f73f",
      "title": "IA bias MR: NLA-z simplification for eDR1like theory.py",
      "status": "open",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "outcome": "MR !3 on dr1_cmbx (gitlab.euclid-sgs.uk/SWG/SWG-CMBX/dr1_cmbx/-/merge_requests/3).\n\nLouis's theory.py had IA parameters (A_IA=1.72, C_IA=0.013, eta_IA=-0.41, beta_IA=2.17 — Euclid IST eNLA fiducial from Euclid Prep VII, 1910.09273) stored but unused. Actual ia_bias was hardcoded -0.004 placeholder on NumberCountsTracer with a TODO.\n\nFix: moved IA to WeakLensingTracer, implemented simplified NLA-z (A_IA*(1+z)^eta_IA), dropped luminosity scaling, relies on CCL use_A_ia=True normalization. TODO in code for full eNLA with luminosity term. Awaiting Louis's review on whether CCL interface handles normalization correctly.\n\nFull eNLA: F_IA = -A_IA * C_IA * (Omega_b+Omega_c) * (1+z)^eta_IA * (L_mean/L_star)^beta_IA",
      "createdAt": "2026-02-18T23:46:05.494543271+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "installed-glab-cli-on-leonardo-e9593219",
      "title": "Installed glab CLI on Leonardo",
      "status": "open",
      "kind": "task",
      "tags": [
        "infra"
      ],
      "outcome": "glab v1.86.0 installed to ~/bin/. PATH updated in ~/.bashrc. Authenticated against gitlab.euclid-sgs.uk with personal access token. Can now create MRs from command line (glab mr create, glab mr update). Token should be rotated — was exposed in chat.",
      "createdAt": "2026-02-18T23:46:12.411068759+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "maps-shared-conventions-and-c4fac8e3",
      "title": "Maps: shared conventions and standards",
      "status": "open",
      "kind": "task",
      "tags": [
        "doc"
      ],
      "body": "All maps in this analysis live on the HEALPix sphere at nside `config[nside]` in RING ordering. The Euclid RR2 lensmc footprint covers ~385 deg², of which ~261 deg² overlaps ACT and ~115 deg² overlaps SPT. The triple overlap (ACT ∩ SPT ∩ Euclid) is ~74 deg².\n\n## Resolution\n\n- **nside**: `config[nside]` (HEALPix, RING ordering)\n\n## Map inventory\n\n**Euclid RR2** (`config[catalog_version]`):\n- Shear (lensmc): e₁/e₂ maps, sum_weights, n_eff — per bin + all\n- Shear (metacal): same set\n- Galaxy density: δ overdensity + selection mask — per bin\n- Systematics: 11 VMPZ-ID maps at nside 16384 (NESTED)\n\n**CMB lensing κ** (paths in Snakefile, not config):\n- ACT DR6 baseline\n- SPT-3G winter GMV, TT, PP, MV — estimator variants, same footprint (+ sims for N₀)\n\n## Sky overlap (mask > 0.95 for CMB, > 0 for Euclid; RR2 lensmc all-bin)\n\n|  | ACT | SPT | Euclid RR2 |\n|---|---|---|---|\n| **ACT** | 8,958 deg² | 875 deg² | 261 deg² |\n| **SPT** | | 1,552 deg² | 115 deg² |\n| **Euclid RR2** | | | 385 deg² |\n\nTriple overlap (ACT ∩ SPT ∩ Euclid): ~74 deg².\n\nBoth CMB masks are apodized (continuous, not binary):\n- ACT: official DR6 lensing analysis mask with 3° cosine-squared roll-off (Qu+ 2023 Sec. 5.3; `cmbx/files/docs_arxiv_2304.05202_act_dr6_lensing_power_main.tex:453`). File: `act/masks/mask_act_dr6_lensing_v1_healpix_nside_4096_baseline.fits`.\n- SPT: pre-apodized border mask, threshold 0.1.\n- Euclid: continuous sum-of-weights (not a binary mask).\n\n## Projection conventions (skyproj)\n\nThe RR2 footprint (RR2Coverage) splits into two spatial patches, visualized with Gnomonic projection:\n\n- **North**: RA `config[spatial_patches.north.ra_min]`–`config[spatial_patches.north.ra_max]`, Dec `config[spatial_patches.north.dec_min]`–`config[spatial_patches.north.dec_max]`\n- **South**: RA `config[spatial_patches.south.ra_min]`–`config[spatial_patches.south.ra_max]`, Dec `config[spatial_patches.south.dec_min]`–`config[spatial_patches.south.dec_max]`\n\n## Colormaps\n\n- **Convergence (κ)**: `RdBu_r` (diverging, symmetric about zero)\n- **Shear (e₁, e₂)**: `icefire` (diverging, symmetric)\n- **Weights/density**: `cubehelix(start=0, rot=0.5)` (sequential)\n- **Value limits**: 1st–99th percentile of finite nonzero data; symmetric for diverging maps\n\n### Default Apodization Conventions\n\n- ACT default map mask: use the baseline ACT DR6 mask with C2 apodization at `aposcale=0.15` degrees when constructing estimator support.\n- SPT default map mask: use `spt/masks/lensing/winter/mask2048_border_apod_mask_threshold0.1_allghz_dense.fits` as the baseline SPT winter GMV mask, and apply C2 apodization at `aposcale=0.15` degrees when constructing common estimator support with Euclid.\n\n### SPT Winter Mask (Paper-grounded)\n\n- Tentative working note: SPT boundary apodization may be ~`0.4 deg` (unconfirmed). Keep marked provisional until verified from SPT pipeline/source release notes.\nFrom the cloned SPT winter lensing draft (`cmbx/files/docs_papers_spt_winter_lensing_sec2_data.tex`):\n- The calibration/spectrum mask is a product of an **apodized boundary mask** and a **point source/cluster mask** (`sec2_data.tex:48`).\n- The fiducial source/cluster mask is binary then **Gaussian-apodized with 3 arcmin** (`sec2_data.tex:189`).\n- The paper section does not yet state a numeric boundary apodization scale in the text we have; it describes the component qualitatively.\n\nPipeline default map file for SPT lensing in this repo:\n- `spt/masks/lensing/winter/mask2048_border_apod_mask_threshold0.1_allghz_dense.fits`\n- This file is already continuous/apodized (`0 < mask < 1` exists in ~1.35% of pixels) and thresholded in name at `0.1`.\n\nWorking convention for map-doc plots:\n- Treat the SPT file above as the **pre-apodized experiment mask**.\n- For estimator-support visualizations, construct a shared support with Euclid and apply additional C2 apodization at `aposcale=0.15 deg` via `dr1_cmbx.eDR1data.spectra.make_mask`.",
      "outcome": null,
      "createdAt": "2026-02-19T23:11:33.667921085+01:00",
      "closedAt": null,
      "dependsOn": [
        "plotting-standards-57ba2ceb",
        "data-euclid-act-spt-7d4e8847"
      ]
    },
    {
      "id": "maps-refactor-goals-constraints-631ede76",
      "title": "maps_refactor: goals, constraints, and design principles",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "body": "Overarching design document for the maps_refactor branch on dr1_cmbx. Captures the goals, constraints, and layer-separation principles agreed during the initial review session.\n\n## Goal\nUnify NaMaster spectrum estimation into a 4-layer library in dr1_cmbx/eDR1data/spectra.py, replacing the flat gctools/spectra.py and absorbing patterns from nmt_utils.py.\n\n## Layers\n1. **Primitives** — make_mask, make_field, make_catalog_field, make_bins\n2. **Single-spectrum** — get_workspace, get_cov_workspace, get_cl\n3. **Covariance** — compute_knox_variance, extract_covariance_block, compute_gaussian_covariance (+ get_cov compat shim)\n4. **High-level** — compute_spectrum, get_spectra, get_full_cov, map2gccls, map2wlcls, pickle_spectra\n\n## Constraints\n- **Backward compat where possible**: group has code against old API. get_cov preserved as deprecated shim. pickle_data alias. map2gccls/map2wlcls signatures preserved.\n- **No library changes to accommodate personal scripts**: aliases like extract_covariance_diagonal stay in nmt_utils.py (scratch). Convenience wrappers (make_shear_mask etc.) stay in scratch.\n- **Group buy-in matters**: Cail is championing a Claude-first approach. Code quality must be demonstrably high to build confidence.\n\n## Design Principles\n- **get_cl returns all spectral components** — no data reduction at measurement level. EE, EB, BE, BB all returned for spin-2 auto.\n- **pickle_spectra does pure extraction** — takes cl[0] for E-mode, stores cl_bb/nl_bb for B-mode. No arithmetic (no EE-BB subtraction). Shape noise debiasing happens upstream in get_cl via nl_uncoupled.\n- **Covariance uses field.spin** — not string-based detection. get_full_cov delegates to compute_gaussian_covariance.\n- **Weights before apodization in make_mask** — all boundaries (including interior weight zeros) get smooth transitions. Correct for galaxy density with effcov.\n- **Workspace caching is first-class** — hash-based file caching via get_workspace/get_cov_workspace.\n- **pol_conv parameter** — explicit COSMO/IAU convention handling in make_field.",
      "outcome": null,
      "createdAt": "2026-02-20T00:34:45.663820166+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "get-full-cov-delegates-to-dfd7cad0",
      "title": "get_full_cov delegates to compute_gaussian_covariance",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Refactored get_full_cov inner loop from 40 lines of inline NaMaster to delegating to compute_gaussian_covariance. Fixes: (1) string-based spin detection replaced by field.spin, (2) extract_covariance_block used instead of naive cv[:n_ell,:n_ell] (same bug class as 31x overestimate), (3) fiducial spectra path works automatically, (4) cross-covariance g21 computed separately (not assumed equal to g12). common_mask workspace reuse preserved via shared_cov_wksp.",
      "createdAt": "2026-02-20T00:34:55.998834686+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "pickle-spectra-stores-b-mode-936b3501",
      "title": "pickle_spectra stores B-mode components, no arithmetic",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "pickle_spectra now stores cl_bb and nl_bb for all spin-2 spectra (Bk for cross, BB for auto). Pure extraction — no EE-BB subtraction. Shape noise debiasing is the proper path (via nl_uncoupled in get_cl). BB subtraction is a downstream choice, not a library default. Old pickle_data did EE-BB in serialization — that mixed concerns.",
      "createdAt": "2026-02-20T00:35:00.450579522+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "apodization-after-weights-in-1271b687",
      "title": "Apodization after weights in make_mask",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "make_mask applies weights BEFORE apodization: footprint = binary * weights, then apodize(product). This ensures all boundaries — including interior zeros from effcov or visibility — get smooth C2 transitions. Apodize-first would leave hard edges at interior weight zeros, causing excess mode coupling. For WL (where binary = weight > 0), the order is mathematically equivalent. For GC with separate weight maps, weights-first is necessary. Matches gctools convention.",
      "createdAt": "2026-02-20T00:35:03.793128283+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "nmt-utils-py-as-compatibility-9025909e",
      "title": "nmt_utils.py as compatibility shim",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "nmt_utils.py (dr1_notebooks scratch) re-exports from dr1_cmbx.eDR1data.spectra via import *. Convenience wrappers (make_shear_mask, make_shear_field, etc.) and systematics utilities (load_systematic_map, zero_unseen) stay locally in nmt_utils — not in the library. extract_covariance_diagonal aliased to extract_covariance_block. Scripts migrate to the generic API at a later stage. systematics.py module in dr1_cmbx deferred.",
      "createdAt": "2026-02-20T00:35:12.855491819+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "app-wrapper-apptainer-aa994f24",
      "title": "app wrapper: apptainer→singularity fallback and container path autodiscovery",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "infra"
      ],
      "outcome": "Updated ~/.claude/shell-functions.sh and ~/loom/shell-functions.sh app() to auto-detect apptainer or singularity, remove stale hardcoded container path dependency, and auto-select container path from CONTAINER_PATH, /leonardo_work/EUHPC_E05_083/cdaley00/container, or legacy /n17data path. Also fixed bind list construction (no stray comma) and added clear errors when runtime/path missing. Verified in fresh bashrc session: app python3 -c works (Python 3.11.13 inside container).",
      "createdAt": "2026-02-20T01:10:15.15468025+01:00",
      "closedAt": "2026-02-20T01:10:21.415772572+01:00",
      "dependsOn": []
    },
    {
      "id": "snakemake-path-config-d8b00869",
      "title": "snakemake path/config separation principle",
      "status": "closed",
      "kind": "task",
      "body": "## Comments\n**2026-02-20 02:17** — Implemented path/config split: moved data/nz/cmb/systematic/sim-null/workspace paths into workflow/Snakefile constants; removed path-bearing keys from config/config.yaml; updated exploration rules and plot_systematic_maps script accordingly; updated AGENTS principle.",
      "outcome": "Snakemake now owns filesystem paths (DATA_DIR, OUTPUT_ROOT, WORKSPACE_DIR, NZ_FILES, CMB_EXPERIMENTS, SYSTEMATIC_MAP_PATHS, SIM_NULL_TEST) while config/config.yaml contains analysis settings only. Updated workflow/Snakefile, workflow/rules/explorations.smk, workflow/scripts/plot_systematic_maps.py, config/config.yaml, and AGENTS.md. Dry-run parses DAG; current failure is expected missing SKS map inputs, not syntax/config errors.",
      "createdAt": "2026-02-20T01:21:43.960007997+01:00",
      "closedAt": "2026-02-20T02:17:20.441186672+01:00",
      "dependsOn": [
        "safe-config-refactoring-3d189574"
      ]
    },
    {
      "id": "maps-refactor-compatibility-b3c5a2c9",
      "title": "maps_refactor compatibility hardening for MR readiness",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "code-health"
      ],
      "outcome": "Applied minimal-breakage hardening on maps_refactor without altering external workflow surfaces. (1) Fixed cat2map tomographic-loop bug in eDR1data/maps.py by resetting selection mask per bin and validating visibility map presence per bin (prevents cumulative visibility weighting). (2) Reverted dr1_cmbx/__init__.py to lazy/minimal package init to avoid import-time dependency failures from eager submodule import. (3) Restored get_cl(..., treat_bb_as_noise=False) as deprecated compatibility argument in eDR1data/spectra.py so legacy callers do not break while keeping new explicit BB handling path. Validation: app python3 py_compile passes; app python import of dr1_cmbx and dr1_cmbx.eDR1data.spectra passes; get_cl signature includes treat_bb_as_noise.",
      "createdAt": "2026-02-20T01:22:45.245150765+01:00",
      "closedAt": "2026-02-20T01:24:07.124274774+01:00",
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "tests-for-reader-maps-spectra-7f242a3c",
      "title": "tests for reader maps spectra compatibility",
      "status": "closed",
      "kind": "task",
      "tags": [
        "code-health"
      ],
      "body": "## Comments\n**2026-02-20 03:17** — Committed in dr1_cmbx as 2e5e0d1 after quota recovery.",
      "outcome": "Added regression tests in code/dr1_cmbx/tests for reader, maps, and spectra compatibility paths. reader: sparse FITS round-trip + loader path conventions. maps: cat2map per-bin selection-mask reset with visibility and explicit error when a tomographic visibility map is missing. spectra: deprecated treat_bb_as_noise behavior in get_cl, pickle_spectra persistence of cl_bb/nl_bb without arithmetic for spin-2 outputs, and get_full_cov delegation to compute_gaussian_covariance (including common-mask covariance workspace reuse). Validation: app pytest -q tests/test_reader.py tests/test_maps.py tests/test_spectra.py -> 7 passed.",
      "createdAt": "2026-02-20T01:33:27.389663346+01:00",
      "closedAt": "2026-02-20T01:35:49.760863914+01:00",
      "dependsOn": []
    },
    {
      "id": "cleanup-old-results-dirs-to-a5d716d1",
      "title": "cleanup old results dirs to recover project quota",
      "status": "closed",
      "kind": "task",
      "tags": [
        "infra",
        "code-health"
      ],
      "outcome": "Recovered project quota by removing obsolete results trees and stale NaMaster workspace cache. Deleted: results/rr2_v1_250616, results/rr2_v1_4_250918-v0.0, results/rr2_v2_wl_251117-v0.0, and .nmt_workspaces. Kept current results branch outputs at results/rr2_v2_1_wl_031224-v0.0 plus claims/notebook outputs. Quota moved from 1133563020 KB (over 1 TiB limit) to 920612492 KB (under quota), unblocking git commit operations.",
      "createdAt": "2026-02-20T01:52:31.86552569+01:00",
      "closedAt": "2026-02-20T01:53:56.131575433+01:00",
      "dependsOn": [
        "euhpc-e05-083-storage-is-shared-4931441f"
      ]
    },
    {
      "id": "euhpc-e05-083-storage-is-shared-4931441f",
      "title": "euhpc_e05_083 storage is shared project quota not per-user",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "infra"
      ],
      "outcome": "Diagnosed quota failures as project-level Lustre quota on project id 20145616, not global filesystem fullness and not isolated per-user quotas. /leonardo_work/EUHPC_E05_083/* directories share the same project quota bucket; user-level lfs quota did not expose peers, and per-directory project-id checks confirmed shared accounting. This explained git index.lock write failures and guided cleanup toward project-space recovery.",
      "createdAt": "2026-02-20T03:17:01.931899262+01:00",
      "closedAt": "2026-02-20T03:17:08.729238271+01:00",
      "dependsOn": []
    },
    {
      "id": "expand-dr1-cmbx-unit-coverage-6d3ae09b",
      "title": "Expand dr1_cmbx unit coverage for maps and spectra",
      "status": "closed",
      "kind": "task",
      "tags": [
        "research",
        "testing"
      ],
      "outcome": "Added focused unit tests for eDR1data.maps (process_catalog, process_shear_catalog, wlcat2map) and eDR1data.spectra primitives/helpers (mask/field/catalog_field/binning/workspace cache/knox/cov block/iter/filename). Test suite: 22 passed. Coverage for target files improved: maps 34%→93%, spectra 22%→42%, reader unchanged at 80%. Remaining spectra gaps are high-level map2gccls/map2wlcls and covariance plumbing branches.",
      "createdAt": "2026-02-20T03:24:43.388658428+01:00",
      "closedAt": "2026-02-20T03:27:01.970720236+01:00",
      "dependsOn": []
    },
    {
      "id": "finish-spectra-py-coverage-0c651a89",
      "title": "Finish spectra.py coverage expansion",
      "status": "closed",
      "kind": "task",
      "tags": [
        "research",
        "testing"
      ],
      "outcome": "Extended coverage pass: added tests for _hash_fields, make_field spin0+beam path, make_catalog_field spin0/invalid spin, make_bins log/sqrt, get_workspace no-cache and cache-miss write, get_cov_workspace branch matrix (2-field default, invalid arg combo, cache hit/miss), get_cl nl subtraction, compute_knox_variance catalog-like fallback, extract_covariance_block n_cls=1 path, compute_gaussian_covariance fiducial g21 defaulting, get_cov return_cw False path, map2gccls common_mask+cov flow and visibility/effcov guard, map2wlcls multibin noise+cov+s1 footprint flow, and _build_gc_filename custom-tag branches. Result: 46 passed; spectra.py coverage 89%.",
      "createdAt": "2026-02-20T03:29:58.164155839+01:00",
      "closedAt": "2026-02-20T03:31:30.775170476+01:00",
      "dependsOn": []
    },
    {
      "id": "act-dr6-switched-to-official-097daf9e",
      "title": "ACT DR6: switched to official apodized lensing mask",
      "status": "closed",
      "kind": "task",
      "outcome": "Old binary mask replaced with official DR6 apodized mask (3deg cos2 rolloff, Qu+ 2023 Sec 5.3). Downgraded to nside=2048 on disk. Snakefile updated. All ACT cross-spectra will rerun.",
      "createdAt": "2026-02-20T03:36:33.490058575+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-shared-conventions-and-c4fac8e3"
      ]
    },
    {
      "id": "euclid-rr2-maps-0d4db3db",
      "title": "Euclid RR2 maps",
      "status": "open",
      "kind": "task",
      "tags": [
        "doc",
        "tapestry:euclid_rr2_maps"
      ],
      "body": "Euclid RR2 weak lensing and galaxy clustering maps used in the cross-correlation analysis. Two shear measurement pipelines (lensmc, metacal), galaxy density from the GC catalog, and 11 VMPZ-ID systematic maps. The footprint covers ~385 deg² across two spatial patches. Masking follows spectra.make_mask: weights multiplied into the binary footprint, then C2 apodized.\n\n## Shear maps\n\n- **Pipelines**: lensmc, metacal — independent shape measurement methods\n- **Per-bin products**: e₁/e₂ shear maps, sum_weights, n_eff\n- **All-bin**: union across `config[tomography.bin_ids]`\n- **Sign convention**: Euclid e₁ along RA; HEALPix Q along colatitude → [-e₁, e₂] for NaMaster (pol_conv=COSMO)\n- **Noise**: NOISE_CL in FITS headers = σ²_comp / n_eff_sr (flat shape noise per component)\n\n## Galaxy density maps\n\n- **Source catalog**: `config[gc_catalog]` (parquet)\n- **Bins**: `config[gc_tom_bins]`\n- **Products**: δ overdensity + selection mask per bin\n- **Density mask is strictly binary**: `build_density_maps.py` sets mask = 1 for every occupied pixel, 0 elsewhere. Only one distinct non-zero value (confirmed bin=3). `make_convergence_mask` then applies `apodize(mask > 0) * mask`, which is apodize(binary) * 1 — the weight factor contributes nothing extra (contrast with shear where `weights=[weight_map]` tapers by varying galaxy weights).\n- **Shot noise**: N_ℓ = 1/n̄_sr (constant per mode)\n\n## CMB lensing mask apodization\n\n`make_cmb_mask` calls `nmt.mask_apodization(mask, aposcale, \"C2\")` on the input. The ACT DR6 baseline mask is already the official 3° cos² apodized lensing mask (Qu+ 2023 Sec 5.3). Applying a second 0.15° C2 pass changes mask pixel values by at most 6.3×10⁻⁴ (rms 2.6×10⁻⁵), zero change in fsky — negligible. This is benign: the long-scale ACT apodization dwarfs the 0.15° second pass.\n\n## Systematic maps\n\n11 VMPZ-ID maps at nside 16384 (NESTED), downgraded to analysis nside at load time:\nstellar_density, galactic_extinction, exposures, zodiacal_light, saa, psf, noise, persistence, star_brightness_mean, galaxy_number_density, phz_quality\n\n## Tomographic binning\n\n`config[tomography.n_bins]` bins (IDs: `config[tomography.bin_ids]`). Shear n(z) from `config[nz.wl]`; density n(z) from `config[nz.gc]`.\n\n## Weight masking\n\nspectra.make_mask(): binary footprint × weights, then apodize. Scale: `config[cross_correlation.aposcale]`°. For density, weights=[binary mask], so C2 apodization acts on a hard edge — visible rolloff at the footprint boundary. For shear, weights=[sum_weights], so the taper is smoothed by varying galaxy counts before apodization.\n\n## Estimator\n\n`config[cross_correlation.estimator]`: catalog (NmtFieldCatalog, bypasses map-making) or map (NmtField).\n\n## Apodization audit\n\nVisualized in `cmbx/files/results_claims_euclid_density_apodization_euclid_density_apodization.png` (rule `plot_euclid_density_apodization`). Rows: density raw, density post-apod, ACT raw, ACT post-double-apod.",
      "outcome": "Density mask is strictly binary (0/1, confirmed bin=3): build_density_maps.py produces a selection mask with exactly one distinct non-zero value. make_convergence_mask thus apodizes a hard step function, producing a visible rolloff at footprint edges — unlike shear where the weight map already grades the boundary. The ACT DR6 double-apodization (make_cmb_mask calling C2 again on the already-smooth 3° official mask) is negligible: max pixel change 6.3e-4, rms 2.6e-5, zero fsky change. No corrective action needed for CMB masking; density apodization is correct for the data it receives (binary footprint with no per-pixel weight variation). Divergence from shear apodization is structural, not a bug.",
      "createdAt": "2026-02-20T03:37:02.558564638+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-shared-conventions-and-c4fac8e3",
        "euclid-n-z-d8d52b17"
      ]
    },
    {
      "id": "cmb-lensing-maps-e7e9436c",
      "title": "CMB lensing maps",
      "status": "open",
      "kind": "task",
      "tags": [
        "doc",
        "tapestry:cmb_lensing_maps"
      ],
      "body": "CMB lensing convergence (κ) maps from ACT DR6 and SPT-3G used as the mass tracer in cross-correlations with Euclid. κ is the projected matter density along the line of sight, reconstructed from CMB temperature and polarization via quadratic estimators. Both experiments provide κ maps, masks, noise curves, and simulations.\n\n## What κ is\n\nLensing convergence κ(n̂) = -½ ∇² φ(n̂), where φ is the lensing potential. Proportional to the projected matter density weighted by the lensing kernel. Spin-0 field.\n\n## Shared conventions\n\n- All κ maps at nside `config[nside]` (downgraded from native resolution at data prep time, not runtime)\n- Masks are pre-apodized by the experiments; we apply additional `config[cross_correlation.aposcale]`° C2 apodization via make_cmb_mask\n- Noise per mode (N_L) provided by each experiment — used for Knox formula and theory comparison\n\n## Experiments\n\nTwo baselines for cross-correlation: ACT DR6 and SPT-3G winter GMV. SPT also provides TT, PP, MV estimator variants for consistency checks. Details in child fibers.",
      "outcome": null,
      "createdAt": "2026-02-20T03:37:16.679809363+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-shared-conventions-and-c4fac8e3",
        "data-euclid-act-spt-7d4e8847"
      ]
    },
    {
      "id": "act-dr6-lensing-e4a3eae9",
      "title": "ACT DR6 lensing",
      "status": "open",
      "kind": "task",
      "tags": [
        "doc",
        "tapestry:act_dr6_lensing"
      ],
      "body": "ACT DR6 CMB lensing convergence map — the primary wide-area CMB lensing dataset in this analysis. 9,400 deg² (fsky ≈ 0.23), reconstructed from temperature and polarization using the minimum-variance quadratic estimator (Qu+ 2023, Madhavacheril+ 2023).\n\n## Data products\n\n- **κ map**: kappa_map_data_act_dr6_lensing_v1_baseline.fits (nside 2048)\n- **Mask**: mask_act_dr6_lensing_v1_healpix_nside_2048_baseline.fits (downgraded from official nside=4096 release). 3° cosine-squared apodization applied by ACT (Qu+ 2023 Sec. 5.3; docs/arxiv/2304.05202_act_dr6_lensing_power/main.tex:453). ~20% of nonzero pixels < 1.\n- **Noise curve**: N_L_kk_act_dr6_lensing_v1_baseline.txt (provided in release)\n- **Filter**: kappa_filter_act_dr6_lensing_v1_baseline.txt\n\n## Overlap with Euclid RR2\n\n~261 deg² (mask > 0.95 threshold). Euclid footprint is fully contained within ACT.\n\n## References\n\n- Qu+ 2023 (2304.05202): DR6 lensing power spectrum. TeX: docs/arxiv/2304.05202_act_dr6_lensing_power/main.tex\n- Madhavacheril+ 2023 (2304.05203): DR6 lensing map and cosmological parameters",
      "outcome": null,
      "createdAt": "2026-02-20T03:37:30.344411877+01:00",
      "closedAt": null,
      "dependsOn": [
        "cmb-lensing-maps-e7e9436c"
      ]
    },
    {
      "id": "spt-3g-winter-lensing-ab712d17",
      "title": "SPT-3G winter lensing",
      "status": "open",
      "kind": "task",
      "tags": [
        "doc",
        "tapestry:spt_winter_lensing"
      ],
      "body": "SPT-3G winter field CMB lensing convergence maps — the deep, small-area CMB lensing dataset. ~1,550 deg² (mask > 0.95), four estimator variants sharing the same footprint.\n\n## Estimator variants\n\n- **GMV** (generalized minimum variance): baseline, highest SNR\n- **PP** (polarization-only): least biased by foregrounds, key cross-check\n- **TT** (temperature-only): most sensitive to tSZ/CIB contamination\n- **MV** (minimum variance): standard MV combination\n\nGMV and PP are the primary baselines for cross-correlation. TT and MV are consistency checks (SPT estimator comparison node).\n\n## Data products (per estimator)\n\n- **κ map**: k{gmv,tt,pp,mv}_fid_052425_0.fits\n- **Mask**: mask2048_border_apod_mask_threshold0.1_allghz_dense.fits (shared, pre-apodized, ~31% of nonzero pixels < 1)\n- **Simulations**: 11 sims per estimator (1 Gaussian + 10 Agora), independent κ realizations\n- **N₀**: placeholder from auto-minus-cross of independent sims (approximate). Proper N₀ to come from SPT.\n\n## Overlap with Euclid RR2\n\n~115 deg² (mask > 0.95 threshold). Smaller overlap than ACT but deeper per-mode sensitivity.\n\n## Open questions\n\n- 24% deficit in SPT×Euclid relative to ACT×Euclid (see spt-deficit-characterization-6b724e41)\n- SPT mask: pre-apodized; provenance not yet documented from SPT papers\n- Proper N₀ needed from SPT (current is approximate)",
      "outcome": null,
      "createdAt": "2026-02-20T03:37:45.336137524+01:00",
      "closedAt": null,
      "dependsOn": [
        "cmb-lensing-maps-e7e9436c"
      ]
    },
    {
      "id": "spt-n0-estimation-do-sims-share-04e30f73",
      "title": "SPT N0 estimation: do sims share input kappa?",
      "status": "closed",
      "kind": "task",
      "body": "compute_cmb_noise_curve.py estimates N0 = mean(auto) - mean(cross) from 11 SPT sims (1 Gaussian + 10 Agora). This is correct if sims share the same input lensing field (same signal, independent noise). If sims have independent kappa realizations, the cross-spectrum gives theory C_l^kk (not the same signal realization), and auto-minus-cross has extra variance from signal scatter. Need to verify with Yuuki/SPT whether the sim set shares a lensing input or uses independent realizations.",
      "outcome": "Sims do NOT share input kappa — independent realizations. Auto-minus-cross gives approximate N0 but with extra variance from signal scatter. Proper N0 to come from SPT directly. Current estimate is a placeholder.",
      "createdAt": "2026-02-20T03:39:44.011379381+01:00",
      "closedAt": "2026-02-20T03:40:14.457710841+01:00",
      "dependsOn": [
        "spt-3g-winter-lensing-ab712d17"
      ]
    },
    {
      "id": "resolution-matching-at-data-09bd495a",
      "title": "Resolution matching at data prep not runtime",
      "status": "closed",
      "kind": "task",
      "outcome": "Masks at different nside downgraded once to disk, not ud_graded at runtime. Applied to ACT mask (4096 to 2048).",
      "createdAt": "2026-02-20T03:42:49.581686449+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-shared-conventions-and-c4fac8e3"
      ]
    },
    {
      "id": "euclid-rr2-footprint-is-385-4f93faa4",
      "title": "Euclid RR2 footprint is 385 deg2 not 1300",
      "status": "closed",
      "kind": "task",
      "outcome": "Previous 1300 deg2 was bounding box of RA/Dec ranges. Actual lensmc all-bin weight map: 385 deg2 (470k pixels at nside 2048).",
      "createdAt": "2026-02-20T03:42:55.538712499+01:00",
      "closedAt": null,
      "dependsOn": [
        "euclid-rr2-maps-0d4db3db"
      ]
    },
    {
      "id": "overlap-area-threshold-mask-0-95-89475198",
      "title": "Overlap area threshold: mask > 0.95",
      "status": "closed",
      "kind": "task",
      "outcome": "For reporting sky overlap, count pixels with mask > 0.95. Apodized edges are not usable sky. ACT 8958 deg2, SPT 1552 deg2 at this threshold.",
      "createdAt": "2026-02-20T03:43:01.091381809+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-shared-conventions-and-c4fac8e3"
      ]
    },
    {
      "id": "dr1-cmbx-test-suite-quality-43ef97c2",
      "title": "dr1_cmbx test-suite quality review",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Reviewed dr1_cmbx tests (46 passing). Strong unit coverage for spectra/maps core branches via monkeypatch. Main gaps: no integration test of map2gccls/map2wlcls with real I/O+NaMaster, no negative-path tests for reader.read_partial_map errors, and limited branch checks for filename/tag generation. Recommended adding 3 high-value tests: (1) tiny end-to-end smoke with synthetic maps and real get_spectra output schema, (2) reader error-path tests for NSIDE/order validation, (3) map2wlcls NOISE_CL>0 branch asserting EE/BB noise insertion and downstream serialization.",
      "createdAt": "2026-02-20T03:45:23.945102437+01:00",
      "closedAt": "2026-02-20T03:45:29.331166976+01:00",
      "dependsOn": []
    },
    {
      "id": "add-lightweight-real-package-31866d0f",
      "title": "add lightweight real-package smoke test for map2wlcls",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Added one lightweight integration smoke test for map2wlcls using real healpy+pymaster on synthetic NSIDE=8 FITS inputs. Test executes full map2wlcls path (masking, field construction, workspace/spectrum calculation, pickle serialization) and asserts output schema and finite spectra. Tuned aposcale=10 deg for low-NSIDE stability. Full dr1_cmbx suite now 47 passed in 4.43s pytest time (~6.74s wall including container startup).",
      "createdAt": "2026-02-20T03:47:39.453379969+01:00",
      "closedAt": "2026-02-20T03:48:37.028901193+01:00",
      "dependsOn": []
    },
    {
      "id": "refactor-dr1-cmbx-tests-for-ac9f4655",
      "title": "refactor dr1_cmbx tests for quality-over-quantity",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Refactored dr1_cmbx tests for quality-over-quantity by consolidating duplicate branch tests in test_spectra.py. Merged make_field/make_catalog_field/make_bins tests into single contract tests; merged filename assertions into exact contract test; merged three map2gccls edge-case error tests into one looped edge-errors test; removed redundant get_cov return_cw=False duplicate test. Preserved real-package smoke test. Result: test count reduced from 47 to 39 with full pass (39 passed, 3 warnings) and similar runtime (4.06s pytest, ~6.38s wall with app startup).",
      "createdAt": "2026-02-20T03:52:53.240678869+01:00",
      "closedAt": "2026-02-20T03:54:22.048696574+01:00",
      "dependsOn": []
    },
    {
      "id": "second-trim-of-dr1-cmbx-tests-357288ab",
      "title": "second trim of dr1_cmbx tests to high-signal core",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Applied second quality-over-quantity trim to dr1_cmbx tests. Removed low-value compatibility tests (deprecated get_cl/get_cov shim, cat2cls not implemented, hash-string smoke), merged workspace tests into one contract test, merged Knox tests into one contract test covering map and catalog-like fields, and merged extract_covariance_block tests into one contract test. Kept real-package map2wlcls smoke test and core serialization/covariance/mask regressions. Result: suite reduced from 39 to 32 tests; all pass (32 passed, 3 warnings) in 3.67s pytest time (~7.63s wall with app startup).",
      "createdAt": "2026-02-20T03:57:58.188940068+01:00",
      "closedAt": "2026-02-20T03:59:27.724632501+01:00",
      "dependsOn": []
    },
    {
      "id": "review-namaster-caching-hashing-915bda72",
      "title": "Review NaMaster caching/hashing critique",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Reviewed NaMaster cache/hash implementation in active workflow path (nx2pt.namaster_tools) and dr1_cmbx spectra API. Findings: race-prone non-atomic cache writes, non-canonical field ordering causing duplicate keys, cache namespace lacks versioning/salt, covariance hash path excludes catalog fields by design but with brittle script-level workaround, and nx2pt.compute_cl has an argument-order bug. Provided severity-ranked references and remediation strategy.",
      "createdAt": "2026-02-20T04:00:48.13392588+01:00",
      "closedAt": "2026-02-20T04:02:18.497802958+01:00",
      "dependsOn": []
    },
    {
      "id": "map-documentation-plots-for-5-bc4aede4",
      "title": "Map documentation plots for 5 tapestry doc fibers",
      "status": "open",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "## Desired State\n\nFive doc fibers in the maps tree each have a sky-map figure and evidence, rendering them as visible tapestry nodes. Each plot answers one question about its data — what it covers, what it looks like, what its properties are. A collaborator clicking through the tapestry sees the actual sky before any cross-correlation. The node is only \"done\" when the figure is both scientifically correct and visually legible on first read.\n\n### The five nodes\n\n| specName | Fiber | Question | Content |\n|----------|-------|----------|---------|\n| `shared_map_conventions` | Maps: shared conventions | Where do the three surveys overlap? | All three footprints on the sky — overlap areas labeled. **Replaces** existing `plot_field_overview` rule. |\n| `cmb_lensing_maps` | CMB lensing maps | What does the CMB convergence look like? | ACT + SPT κ maps side by side, Wiener-filtered, on the RR2 footprint. |\n| `act_dr6_lensing` | ACT DR6 lensing | What does ACT see here? | **Plot 1**: ACT κ (Wiener-filtered). **Plot 2**: ACT κ × apodized mask — what enters the estimator. |\n| `spt_winter_lensing` | SPT-3G winter lensing | What does SPT see here? | **Plot 1**: SPT GMV κ (Wiener-filtered). **Plot 2**: SPT GMV κ × apodized mask. |\n| `euclid_rr2_maps` | Euclid RR2 maps | What galaxy data are we crossing against? | **Plot 1**: Shear weights + density (2 rows). **Plot 2**: Same data × apodized mask. |\n\n### Two plots per individual node\n\nThe last three nodes (`act_dr6_lensing`, `spt_winter_lensing`, `euclid_rr2_maps`) each produce **two separate PNGs**:\n1. **Unmasked** — the data on the sky (κ Wiener-filtered, or shear weights + density)\n2. **Apodized** — the same data multiplied by the C2 apodization mask, showing what actually enters the cross-correlation\n\nBoth PNGs listed in `evidence.json` `output`. The contrast between the two tells the story: how much sky survives apodization, where the edges roll off, what structure the estimator actually sees.\n\n### Done conditions\n\n- Each node has `results/claims/{specName}/evidence.json` + at least one PNG (3 nodes have 2 PNGs each)\n- Each snakemake rule runs via SLURM (these load full-sky FITS maps — not localrules)\n- Plots use existing infrastructure: `RR2Coverage`, `skyproj.GnomonicSkyproj`, `setup_theme`, `save_evidence`\n- CMB κ maps Wiener-filtered for visualization; weights/density maps shown as-is\n- Colormaps follow doc fiber conventions: κ → `RdBu_r`, shear → `icefire`, weights/density → cubehelix\n- Evidence includes nside, overlap areas, pixel counts, fsky — whatever characterizes the map\n- For ACT/SPT/Euclid nodes: evidence also includes mask statistics (fsky raw, fsky apodized, area deg², aposcale, effective overlap)\n- Scripts live in `workflow/scripts/plot_{specName}.py`; rules in `cmbx/files/workflow_rules_explorations.smk`\n- Each of the last 3 rules declares two PNG outputs (e.g., `png_map` and `png_mask`)\n- Wiener filter function extracted to `plot_utils.py` (shared across CMB κ scripts)\n- Plot readability pass completed for every node using `/data-visualization` criteria: clear title/question match, readable colorbar scale, non-clipped dynamic range, obvious patch orientation (north/south consistency), and explicit titles for all subplots/panels.\n- Aesthetics pass completed for every node: typography consistent with `setup_theme`, balanced whitespace/margins, color choices perceptually clear and convention-compliant, no distracting clutter.\n- Unmasked vs apodized pair tells a visible story at a glance for ACT/SPT/Euclid (edge rolloff and surviving support are immediately apparent without reading evidence JSON).\n\n### What NOT to do\n\n- Don't create per-bin or per-method variants. Each node shows the \"all\" bin or primary estimator.\n- Don't build new abstractions. Use `RR2Coverage.from_mask()` + `draw_hpxpix()` directly.\n- Don't add tomographic structure — these are spatial/map nodes, not redshift nodes.\n- Don't preserve `plot_field_overview` as a parallel rule — it gets replaced by `shared_map_conventions`.\n\n### Resolved decisions\n\n- **`plot_field_overview` → `shared_map_conventions`**: Replace. Retag the existing fiber (`the-sky-act-spt-and-euclid-on-706364a6`) from `tapestry:plot_field_overview` to `tapestry:shared_map_conventions`, rename the rule, move the evidence directory.\n- **Euclid content**: Shear weights + density overdensity (2 rows × 2 patches).\n- **SPT content**: GMV only. PP belongs in `plot_spt_estimator_comparison`.\n- **Wiener filter**: Extract to `plot_utils.py` for now.\n\n### Relationship to existing rules\n\n- `plot_field_overview` → becomes `shared_map_conventions` (repurposed, not duplicated)\n- `plot_apodization_masks` — separate concern, untouched\n- `plot_shear_maps` — per-bin diagnostic, untouched\n- `plot_systematic_maps` — VMPZ-ID inventory, untouched\n\n## Context\n\n### File paths\n\n- Rule definitions: `cmbx/files/workflow_rules_explorations.smk`\n- Plot scripts: `workflow/scripts/plot_*.py`\n- Shared utilities: `cmbx/files/workflow_scripts_plot_utils.py` (FW, FH, setup_theme, save_evidence, COLORS, LABELS)\n- Coverage class: `cmbx/files/code_dr1_notebooks_src_dr1_notebooks_scratch_cdaley_rr2.py` — `RR2Coverage`\n- Evidence output: `results/claims/{specName}/`\n\n### Existing patterns to follow\n\nEvery map visualization script follows the same skeleton:\n1. Load maps via `hp.read_map` (dense FITS) or `read_healpix_map` (sparse FITS)\n2. Build `RR2Coverage.from_mask(nside, mask_union)` for the visualization extent\n3. Sparsify data via `coverage.sparsify(map_data)`\n4. Compute vlim from 1st-99th percentile of finite nonzero sparse data\n5. Create `skyproj.GnomonicSkyproj(ax, **proj_params)` for each of 2 patches (north/south)\n6. `sp.draw_hpxpix(nside, coverage.ipix_sparse, sparse_data, ...)`\n7. `save_evidence(evidence_dict, path, snakemake)`\n\nProjection parameters (hardcoded in `rr2.py` and replicated in scripts):\n```python\nproj_params = [\n    {\"lon_0\": 70, \"lat_0\": -33, \"extent\": [63.8, 77.2, -37, -26.5]},  # north\n    {\"lon_0\": 45, \"lat_0\": -64, \"extent\": [32, 70, -44, -63.5]},       # south\n]\n```\n\n### Wiener filter\n\nAlready implemented in `plot_field_overview.py` (lines 80-133). Uses Planck 2018 C_ℓ^{κκ} as signal model: W(ℓ) = C_theory / (C_theory + N_estimate). Extract to `plot_utils.py` as `wiener_filter_kappa(map_data, mask, nside, lmax=None)`. Only used for CMB κ visualization — shear/density maps don't need filtering.\n\n### Data inputs (paths from Snakefile)\n\n- ACT κ: `cmb_experiments[\"act\"][\"kappa_map\"]`\n- ACT mask: `cmb_experiments[\"act\"][\"mask\"]`\n- SPT κ (GMV): `cmb_experiments[\"spt_winter_gmv\"][\"kappa_map\"]`\n- SPT mask: `cmb_experiments[\"spt_winter_gmv\"][\"mask\"]` (shared across estimators)\n- Shear weights (all bins): `euclid_maps_dir / f\"wl_lensmc\" / f\"...bin=all_sum_weights_map.fits\"`\n- Density map (all bins): `results/{vcat}/gc/overdensity_bin=all.fits` — check if exists; if not, build it\n- ACT noise curve: `act/N_L_kk_act_dr6_lensing_v1_baseline.txt`\n- SPT N₀: `results/{vcat}/noise_curves/spt_winter_gmv_N0.txt`\n\n### Resources\n\nAll scripts load full-sky HEALPix FITS at nside 2048. SLURM, not localrules. 8 GB default; `shared_map_conventions` may need 16 GB (loads 3 map pairs).\n\n## Skills\n\nActivate before working:\n- `/snakemake` — for rule definitions and execution\n- `/tapestry` — for evidence conventions\n- `/implementing-code` — for script quality\n- `/data-visualization` — for figure design and plotting patterns\n\n## Iteration focus\n\nPrioritize **reading the generated plots**, not just producing them. Every iteration should include:\n1. Run/generate plots.\n2. Inspect PNGs for interpretability and aesthetics.\n3. Verify figure title + each subplot title clearly identifies the field/mask state shown.\n4. Make targeted plotting refinements (limits, labels, layout, colormap normalization, annotation clarity).\n5. Re-run and re-check until visual quality is publication-grade for doc-fiber usage.\n\n## Evidence\n\nProgress measured by:\n- `felt ls -t tapestry: | grep -E \"shared_map|cmb_lensing|act_dr6|spt_winter_l|euclid_rr2\"` — do all 5 have fibers?\n- `ls results/claims/{shared_map_conventions,cmb_lensing_maps,act_dr6_lensing,spt_winter_lensing,euclid_rr2_maps}/evidence.json` — does each have evidence?\n- `snakemake -n plot_shared_map_conventions plot_cmb_lensing_maps plot_act_dr6_lensing plot_spt_winter_lensing plot_euclid_rr2_maps` — dry run clean?\n\n## Open Questions\n\n\n- Decide and document whether additional C2 apodization (`aposcale`) on top of pre-apodized ACT/SPT masks should remain `0.15 deg` or be changed via objective scan (variance/edge leakage tradeoff).\n- **Density \"all\" bin**: Does `build_density_map` already produce an all-bin aggregation? If not, how to combine — mean δ? weighted sum? This may need a new rule upstream of `euclid_rr2_maps`.\n\n### Implementation preference\n\n- Prefer `dr1_cmbx` library utilities for map I/O, mask handling, and analysis conventions wherever equivalent functionality exists.\n- Only use ad-hoc script-local implementations when no `dr1_cmbx` utility exists; if this happens, note the gap and keep the implementation thin.",
      "outcome": null,
      "createdAt": "2026-02-20T04:08:54.803830975+01:00",
      "closedAt": null,
      "dependsOn": [
        "tapestry-phase-2-comprehensible-3240e986",
        "maps-shared-conventions-and-c4fac8e3",
        "fix-shared-map-conventions-plot-2685dcab",
        "cmb-lensing-map-docs-remain-f3897af0"
      ]
    },
    {
      "id": "covariance-hash-mask-override-10fac0da",
      "title": "Covariance hash mask override in dr1_cmbx",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Implemented minimal dr1_cmbx-only fix for covariance hashing brittleness with catalog-related fields: get_cov_workspace accepts optional hash_masks; compute_gaussian_covariance accepts cov_hash_masks and uses them for cache hashing and pseudo-Cl/fsky normalization when get_mask is unavailable; compute_spectrum passes map-based masks when auxiliary covariance fields are used. Added focused tests for no-get_mask path.",
      "createdAt": "2026-02-20T04:18:10.813558756+01:00",
      "closedAt": "2026-02-20T04:19:13.840844844+01:00",
      "dependsOn": []
    },
    {
      "id": "canonicalize-namaster-workspace-d678b6be",
      "title": "Canonicalize NaMaster workspace hash key order in dr1_cmbx",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Made workspace cache keys symmetric in dr1_cmbx.eDR1data.spectra._hash_fields so (f1,f2) and (f2,f1) reuse the same cache file. Implemented by hashing per-field digests and sorting before final hash (joblib and md5 fallback paths). Reduced duplicate cache artifacts with minimal code change and no new dependencies.",
      "createdAt": "2026-02-20T04:19:13.845716691+01:00",
      "closedAt": "2026-02-20T04:19:22.412739503+01:00",
      "dependsOn": [
        "review-namaster-caching-hashing-915bda72"
      ]
    },
    {
      "id": "de-duplicate-agents-repo-25b3e64f",
      "title": "De-duplicate AGENTS repo inventory vs package policy",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Refactored AGENTS.md to avoid duplicated software library listings: keep Git Repos as inventory and remotes; keep Code Packages as operational policy only (active targets: dr1_cmbx and dr1_notebooks; all others reference/legacy unless explicitly requested).",
      "createdAt": "2026-02-20T04:19:14.015274663+01:00",
      "closedAt": "2026-02-20T04:19:22.524848227+01:00",
      "dependsOn": [
        "review-namaster-caching-hashing-915bda72"
      ]
    },
    {
      "id": "refine-apodized-mask-statistics-6ccd32f2",
      "title": "Refine apodized mask statistics for map-doc fibers",
      "status": "closed",
      "kind": "task",
      "tags": [
        "task",
        "tapestry:map-doc-mask-stats"
      ],
      "body": "Fix ACT/SPT/Euclid evidence to report meaningful apodized fsky/overlap (weighted by apod masks), then validate DAG targets.",
      "outcome": "Updated map-doc scripts to compute apodized mask stats using weighted C2 masks (not >0 thresholds), including effective overlap deg2 metrics in ACT/SPT evidence and raw+apod overlap stats in Euclid evidence. Fixed shared-map conventions plotting error (skyproj inset colorbar return type handling). Installed TinyTeX directly into writable container (/usr/local/TinyTeX) and linked TeX binaries into /usr/local/bin so text.usetex works in Snakemake container jobs without bashrc/bind hacks. Removed temporary TinyTeX shell-path modifications from ~/.bashrc. Next iteration should rerun plot_shared_map_conventions/plot_cmb_lensing_maps/plot_act_dr6_lensing/plot_spt_winter_lensing/plot_euclid_rr2_maps to regenerate evidence.",
      "createdAt": "2026-02-20T04:51:49.07243013+01:00",
      "closedAt": "2026-02-20T05:18:14.062168459+01:00",
      "dependsOn": [
        "map-documentation-plots-for-5-bc4aede4"
      ]
    },
    {
      "id": "fix-shared-map-conventions-plot-2685dcab",
      "title": "Fix shared_map_conventions plot script runtime failures",
      "status": "closed",
      "kind": "task",
      "tags": [
        "bugfix"
      ],
      "outcome": "Patched plot_shared_map_conventions for skyproj colorbar API differences and TeX-safe legend text; reran plot_shared_map_conventions on SLURM (job 34509758) and produced results/claims/shared_map_conventions/{shared_map_conventions.png,evidence.json}. Five-rule dry run now reports up-to-date.",
      "createdAt": "2026-02-20T05:31:25.270109487+01:00",
      "closedAt": "2026-02-20T05:31:28.981091213+01:00",
      "dependsOn": []
    },
    {
      "id": "cmb-lensing-map-docs-remain-f3897af0",
      "title": "CMB lensing map docs remain single-plot (no masked/unmasked pair)",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision",
        "tapestry"
      ],
      "outcome": "Confirmed on 2026-02-20: spec cmb_lensing_maps outputs one Wiener-filtered ACT+SPT figure only. Masked/unmasked paired outputs remain only for act_dr6_lensing, spt_winter_lensing, and euclid_rr2_maps.",
      "createdAt": "2026-02-20T06:27:49.604741899+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "namaster-accepts-independently-530d654f",
      "title": "NaMaster accepts independently apodized masks; avoid CMB double-apodization",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision",
        "namaster",
        "masking"
      ],
      "outcome": "For Euclid×CMB cross-spectra, NaMaster is valid with different masks/apodizations per field (no requirement for a jointly apodized common mask). Current pipeline reapodizes CMB masks via make_cmb_mask(mask_apodization(..., C2, aposcale=0.15 deg)); this is acceptable mathematically but can double-taper inputs that are already apodized (e.g., SPT winter mask naming indicates pre-apodization), reducing effective modes. Preferred methodological direction: apodize Euclid masks as configured, and skip extra CMB apodization when CMB input masks are already apodized.",
      "createdAt": "2026-02-20T18:45:43.625702115+01:00",
      "closedAt": null,
      "dependsOn": [
        "namaster-technical-patterns-60d42621"
      ]
    },
    {
      "id": "fsky-definitions-are-purpose-7bbbaced",
      "title": "fsky definitions are purpose-specific for mixed masks",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision",
        "fsky",
        "covariance"
      ],
      "outcome": "Use purpose-specific mask moments rather than a single fsky. For Knox variance of cross-spectra use fsky_eff = <w1 w2>^2 / <w1^2 w2^2> with n_modes = sum(2l+1)*fsky_eff. For pseudo-Cl auto normalization use <w^2> of the corresponding field. Use <w> or mean(mask>0) only for area/coverage reporting, not variance normalization. NaMaster Gaussian covariance relies on coupling matrices/workspaces directly; fsky remains diagnostic there.",
      "createdAt": "2026-02-20T18:45:49.664142923+01:00",
      "closedAt": null,
      "dependsOn": [
        "namaster-technical-patterns-60d42621"
      ]
    },
    {
      "id": "ralph-iter-4-strengthen-map-doc-5046c2b0",
      "title": "Ralph iter 4: strengthen map-doc plot contrast for ACT/SPT/Euclid apodized-vs-unmasked story",
      "status": "open",
      "kind": "task",
      "outcome": null,
      "createdAt": "2026-02-20T18:46:23.422067596+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "choose-additional-c2-aposcale-5cdf0511",
      "title": "Choose additional C2 aposcale for pre-apodized ACT/SPT masks in map-doc plots",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "body": "Question: given ACT/SPT masks are already pre-apodized products, what extra C2 aposcale (if any) should be applied when constructing shared estimator support with Euclid in map-doc scripts?\\n\\nPaper-grounded context:\\n- SPT draft notes mask is product of apodized boundary + point-source/cluster mask (sec2_data.tex:48), with source mask Gaussian-apodized at 3 arcmin (sec2_data.tex:189).\\n- Current plotting uses additional C2 aposcale=0.15 deg via dr1_cmbx make_mask.\\n\\nProposed decision criterion:\\n- Scan aposcale in {0, 0.05, 0.10, 0.15, 0.20, 0.30} deg for ACT/SPT shared supports.\\n- Compare (1) effective overlap fsky, (2) edge rolloff visibility, (3) map-level variance near boundary bands, (4) stability of cross-spectrum null behavior in a lightweight diagnostic.\\n- Pick smallest aposcale that suppresses edge ringing while preserving overlap area.",
      "outcome": null,
      "createdAt": "2026-02-20T21:09:50.971917948+01:00",
      "closedAt": null,
      "dependsOn": [
        "map-documentation-plots-for-5-bc4aede4",
        "maps-shared-conventions-and-c4fac8e3"
      ]
    },
    {
      "id": "ralph-iter4-wrap-map-doc-d6f33770",
      "title": "Ralph iter4 wrap: map-doc apodization conventions + Overleaf paper integration",
      "status": "closed",
      "kind": "task",
      "body": "Session wrap:\\n- Implemented/validated map-doc plotting pipeline updates for ACT/SPT/Euclid nodes and evidence outputs.\\n- Migrated map-doc apodization construction to dr1_cmbx.eDR1data.spectra.make_mask in plotting scripts.\\n- Cloned SPT winter lensing Overleaf repo to docs/papers/spt_winter_lensing/ and referenced it in CLAUDE.md.\\n- Read paper source and updated shared conventions fiber with paper-grounded SPT mask notes.\\n- Added provisional note: SPT boundary apodization may be ~0.4 deg (unconfirmed).\\n\\nOpen item:\\n- Final decision on extra C2 aposcale on top of pre-apodized ACT/SPT masks remains tracked in choose-additional-c2-aposcale-5cdf0511.",
      "outcome": "Completed the documentation + integration work for this iteration; left aposcale choice explicitly open as a tracked question for next decision.",
      "createdAt": "2026-02-22T07:36:23.489827928+01:00",
      "closedAt": null,
      "dependsOn": [
        "map-documentation-plots-for-5-bc4aede4",
        "maps-shared-conventions-and-c4fac8e3",
        "choose-additional-c2-aposcale-5cdf0511"
      ]
    },
    {
      "id": "introduction-cmb-lensing-euclid-da9491ce",
      "title": "Introduction",
      "status": "open",
      "kind": "task",
      "tags": [
        "tapestry:introduction",
        "tier:1"
      ],
      "body": "Cross-correlating CMB lensing convergence with the shapes and positions of photometric galaxies probes the growth of large-scale structure across cosmic time, testing ΛCDM with independent observables from two entirely different physical effects. This analysis measures C_ℓ^{γκ} and C_ℓ^{δκ} between Euclid RR2 weak lensing shear / galaxy density and CMB lensing convergence from ACT DR6 and SPT-3G (winter), across 6 tomographic bins. The result is a 15σ detection (ACT, post-marginalization) and 14σ (SPT), consistent with Planck 2018 ΛCDM.\n\n**Motivation**: CMB lensing × cosmic shear is insensitive to additive shear systematics (which don't correlate with the CMB) and CMB lensing multiplicative biases — making it a robust, nearly model-independent probe of the projected matter distribution at z ~ 0.3–1.5. Euclid's wide southern survey provides the galaxy data; ACT and SPT provide CMB lensing over overlapping patches of 261 deg² and 115 deg² respectively.\n\n**Comparator analyses**: \n- DES × ACT DR6: Qu+ 2023 (`cmbx/files/docs_papers_2309.04412_act_des_shear_main.tex`).\n- DES × SPT methods: Chang+ 2022 (`cmbx/files/docs_papers_2203.12439_des_spt_planck_methods_main.tex`).\n- DES × SPT correlations: Omori+ 2022 (`cmbx/files/docs_papers_2203.12440_des_spt_planck_correlations_main.tex`).\n- DES × SPT 2026 update: `cmbx/files/docs_papers_des_spt_shearxlensing_2026_shearXlensing_20260202.pdf`.\n- ACT DR6 lensing power spectrum: Madhavacheril+ 2024 (`cmbx/files/docs_arxiv_2304.05202_act_dr6_lensing_power_main.tex`).\n- SPT-3G winter lensing: `cmbx/files/docs_papers_spt_winter_lensing_apssamp.tex`.\n\n**Collaboration**: SPT-Euclid MoU (DR1-KP-CMBX-3/2) — see [MOU proposal](.felt/spt-euclid-mou-collaboration-6de6bc54.md). CMBX-SWG is coordinating with WL-SWG on blinding; CMBX is listed as a potential unblinding authority. People: Cail Daley (data), Margherita Lembo (co-lead, gctools), Louis Legrand (co-lead, likelihood), Giulio Fabbian (SWG science lead), Emma Ayçoberry.",
      "outcome": null,
      "createdAt": "2026-02-22T07:51:04.067925112+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "data-euclid-act-spt-7d4e8847",
      "title": "Data",
      "status": "open",
      "kind": "task",
      "tags": [
        "tier:1",
        "tapestry:shared_map_conventions"
      ],
      "body": "Three surveys on the southern sky. Euclid RR2 weak lensing (~50M galaxies, 385 deg² effective footprint, 6 tomographic bins), ACT DR6 lensing convergence (fsky 0.248, Wiener-filtered), and SPT-3G winter lensing (fsky 0.044, GMV + TT/PP/MV estimators). The cross-correlation is measured where these overlap — see evidence for areas.\n\nSub-nodes detail the per-instrument data: [Euclid RR2 maps](.felt/euclid-rr2-maps-0d4db3db.md), [CMB lensing maps](.felt/cmb-lensing-maps-e7e9436c.md) → [ACT DR6](.felt/act-dr6-lensing-e4a3eae9.md), [SPT-3G winter](.felt/spt-3g-winter-lensing-ab712d17.md).",
      "outcome": null,
      "createdAt": "2026-02-22T07:51:09.038257896+01:00",
      "closedAt": null,
      "dependsOn": [
        "introduction-cmb-lensing-euclid-da9491ce"
      ]
    },
    {
      "id": "methods-pseudo-cℓ-cross-3eedb9dd",
      "title": "Methods",
      "status": "open",
      "kind": "task",
      "tags": [
        "tapestry:methods_overview",
        "tier:1"
      ],
      "body": "Angular cross-power spectra are estimated via the NaMaster pseudo-Cℓ formalism (Alonso+ 2019), which accounts for the mode-coupling induced by partial-sky masks via a coupling matrix, then decouples into bandpowers. Masks are C2-apodized at 0.15 rad scale following gctools conventions — the apodization preserves mask area (ACT mean weight drops only 0.4%) while suppressing ringing from sharp edges. The production shear estimator is catalog-based (NmtFieldCatalog), operating directly on galaxy positions and ellipticities without pixelization; it is validated against the map-based estimator (NmtField) with median bandpower correlation 0.998. Covariances use the NaMaster Gaussian approximation, validated against the Knox formula (NaMaster/Knox ≈ 1.04 for density, ≈ 1.26 for shear after the interleaved-diagonal fix).\n\nThe methods section covers four nodes: apodization masks (the geometry that enters the pseudo-Cℓ), estimator validation (catalog vs map), covariance estimation (NaMaster vs Knox), and the systematic maps inventory (11 VMPZ-ID maps that feed into the contamination analysis). Snakemake rules: `compute_cross_spectrum`, `catalog_to_map`, `compute_systematic_cross_spectrum`. Core library: NaMaster via gctools conventions (`dr1_cmbx/src/dr1_cmbx/eDR1data/gctools/spectra.py`).",
      "outcome": null,
      "createdAt": "2026-02-22T07:51:09.043824252+01:00",
      "closedAt": null,
      "dependsOn": [
        "data-euclid-act-spt-7d4e8847"
      ]
    },
    {
      "id": "validation-null-tests-and-48ab3654",
      "title": "Validation",
      "status": "open",
      "kind": "task",
      "tags": [
        "tapestry:validation_overview",
        "tier:1"
      ],
      "body": "Validation proceeds through four pillars: theory consistency (do the measured spectra match Planck 2018 ΛCDM?), cross-experiment and cross-pipeline consistency (do ACT and SPT agree? lensmc and metacal?), null tests (jackknife, simulation, B-mode), and systematic contamination analysis (11 VMPZ-ID maps, bias budget, harmonic-space contamination metric, and template marginalization). The analysis is declared clean when each pillar passes: theory residuals are flat (ACT), null tests show no significant power, and the systematic bias budget is dominated by stellar density at ~0.3σ.\n\nFourteen nodes populate this section, organized by concern. Key open questions: SPT shows scale-dependent residuals (amplitude deficit at ℓ < 300, ℓ > 800) not explained by known systematics — the 24% deficit characterization remains under investigation (`spt-deficit-characterization-6b724e41`). B-mode covariance is approximate (NaMaster Gaussian underestimates BB variance at partial sky — `namaster-gaussian-covariance-9373b1fa`). Template marginalization is implemented; deprojected spectra and likelihoods are in `evaluate_deprojected_likelihood`.",
      "outcome": null,
      "createdAt": "2026-02-22T07:51:09.048592373+01:00",
      "closedAt": null,
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "results-detection-and-90f2ec1b",
      "title": "Results",
      "status": "open",
      "kind": "task",
      "tags": [
        "tapestry:results",
        "tier:1"
      ],
      "body": "[In progress.] Primary detection: 15σ (ACT, post-marginalization over 11 systematic templates), 14σ (SPT). Cross-spectra across 6 tomographic bins for γκ (shear × CMB lensing) and δκ (galaxy density × CMB lensing) are consistent with Planck 2018 ΛCDM predictions. The amplitude parameter A = 1.04 ± 0.07 (ACT) relative to the Planck best-fit theory.\n\nThis section will hold the key figures and numbers: the signal overview (6-bin cross-spectra with theory), the amplitude constraints from the likelihood, and the one-page synthesis. The SPT result is reported alongside ACT but flagged for the unresolved scale-dependent shape discrepancy.",
      "outcome": null,
      "createdAt": "2026-02-22T07:51:09.05318019+01:00",
      "closedAt": null,
      "dependsOn": [
        "validation-null-tests-and-48ab3654"
      ]
    },
    {
      "id": "euclid-n-z-d8d52b17",
      "title": "Euclid catalog",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:euclid_nz_overview"
      ],
      "body": "The Euclid RR2 weak lensing and galaxy clustering catalogs. WL: ~50M galaxies measured with lensmc and metacal shear pipelines, 6 tomographic bins defined by photometric redshift. GC: ~30M galaxies, 6 bins spanning z̄ ≈ 0.31–0.89 — shallower than WL (z̄ ≈ 0.52–1.72), reflecting the photometric selection for clustering. Catalog inputs: `euclid/catalogs/rr2_v2_1_wl_031224/` (WL), `euclid/catalogs/catalogRR2_v2_GC_031124.parquet` (GC). Both feed into map-building rules producing the HEALPix maps in [Euclid RR2 maps](.felt/euclid-rr2-maps-0d4db3db.md).\n\n**Figure** (`euclid_nz_overview.png`): Two-panel plot of n(z) for WL (left) and GC (right). Each panel shows 6 tomographic bins as filled curves, normalized to unit area (∫n(z)dz = 1) over a 3000-point grid from z=0 to z=6. Curves drawn from the theoretical pipeline n(z) stored in `RR2_v2_Nz_WL/GC_C2020_sel_pv.fits` (columns BIN_ID, MEAN_REDSHIFT, N_Z). Mean redshift annotated per bin in the legend.\n\n**Open: n(z) smoothing** — the theoretical n(z) arrays from the FITS files are noisy/jagged in the tails. The correct smoothing procedure for use in the theory C_ℓ calculation is not yet confirmed. Check Slack for the established RR2 convention (Margherita / WL-SWG n(z) thread). Until resolved, theory C_ℓ uses the raw FITS n(z).",
      "outcome": "WL: 6 bins, mean_z=[0.52, 0.60, 0.71, 0.90, 1.19, 1.72]. GC: 6 bins, mean_z=[0.31, 0.39, 0.48, 0.57, 0.70, 0.89]. Catalogs: rr2_v2_1_wl_031224 (~50M WL) + catalogRR2_v2_GC_031124 (~30M GC).",
      "createdAt": "2026-02-22T18:21:30.016792001+01:00",
      "closedAt": "2026-02-22T18:22:09.215933877+01:00",
      "dependsOn": [
        "data-euclid-act-spt-7d4e8847"
      ]
    },
    {
      "id": "cmb-mask-apodization-aeb0291a",
      "title": "CMB mask apodization",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "body": "Both ACT DR6 and SPT-3G winter lensing masks arrive already apodized — ACT has a 3° cos² rolloff (Qu+ 2023 Sec 5.3), SPT has its own smooth border apodization. Our pipeline additionally applies `nmt.mask_apodization(mask, 0.15, \"C2\")` — a 9 arcminute second pass that is negligible (max pixel difference 6×10⁻⁴, rms 3×10⁻⁵, zero fsky change). At present this does no harm and matches gctools conventions.\n\n**Open issue — fsky_eff and mask powers**: For the Gaussian covariance, the effective sky fraction is `fsky_eff = <w_A² w_B²> / (<w_A²><w_B²>)` (Hivon+ 2002), which involves the *product* of squared masks. The broader apodization of the CMB masks (3° rolloff) means the fsky_eff for the cross-spectrum is set by the CMB mask geometry, not just the Euclid footprint. More importantly, the covariance requires the power spectrum of the mask product — a broader CMB apodization changes the mask power spectrum (smoother → less coupling between modes), and potentially shifts power into the C^BB_ℓ terms for spin-2 fields. This needs to be accounted for properly once we move from approximate Gaussian covariance to simulation-based covariance. For now the NaMaster Gaussian covariance handles this via the actual mask maps passed in, so it is correct by construction — but the fsky_eff diagnostic quoted in evidence files uses a Knox approximation that may underestimate uncertainty near the mask edges.\n\n**Decision**: Keep current double-apodization (negligible effect, gctools consistency). Flag the fsky_eff/mask-power accounting as an open item for when we upgrade from Gaussian to simulation covariance.",
      "outcome": null,
      "createdAt": "2026-02-22T19:09:25.487597078+01:00",
      "closedAt": null,
      "dependsOn": [
        "cmb-lensing-maps-e7e9436c"
      ]
    },
    {
      "id": "evidence-output-field-must-be-b272a7fa",
      "title": "Evidence output field",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Tapestry artifacts only render if listed in top-level 'output' field of evidence.json — e.g. {\"id\": \"...\", \"output\": {\"png\": \"plot.png\"}, \"evidence\": {...}}. save_evidence() in plot_utils.py wraps snakemake outputs under 'provenance.output', NOT the top level. Any script that calls save_evidence(flat_dict, ...) without wrapping it will produce evidence with no renderable artifacts. Fix: always pass {\"id\": ..., \"output\": {\"png\": name}, \"evidence\": flat_dict} as the first argument. Affected: plot_euclid_nz_overview.py was missing this and the plot didn't appear in tapestry sidebar.",
      "createdAt": "2026-02-22T19:41:36.666645693+01:00",
      "closedAt": null,
      "dependsOn": [
        "euclid-n-z-d8d52b17"
      ]
    },
    {
      "id": "mask-not-data-for-apodization-d511bd5d",
      "title": "Apodization plot convention",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "When visualizing apodization, plot the mask itself (0→1 taper) rather than data×mask. For density maps (δ ∈ [-1,1], zero mean), the apodized edges blend into the map's own zero-mean distribution and the taper is invisible. For shear weight maps (values 250–1300), zero is far from the mean so it's visible — but that's weight variation, not the apodization. Fixed euclid_rr2_maps_apodized.png to show make_shear_mask() and make_convergence_mask() outputs directly.",
      "createdAt": "2026-02-22T19:41:36.672127754+01:00",
      "closedAt": null,
      "dependsOn": [
        "euclid-rr2-maps-0d4db3db"
      ]
    },
    {
      "id": "pipeline-formalization-db91ef79",
      "title": "Pipeline formalization",
      "status": "active",
      "kind": "task",
      "tags": [
        "spec",
        "ralph"
      ],
      "body": "## Desired State\n\nThe analysis pipeline is a single coherent system — legible, reproducible, and still alive. Every computation flows through shared library code, formalized Snakemake rules, and shared utilities. There is one way to do each thing, and it's the right way.\n\nThis is built layer by layer, each layer checking the one beneath it. Formalizing cross-spectra reveals gaps in masking. Formalizing plotting reveals inconsistencies in how spectra are stored. The iteration works *downward* as much as forward — reassessing foundations as the structure grows.\n\nNew analysis may emerge. When it does, grapple with the results, document the decision, continue. Formalization makes the instrument more trustworthy, not more rigid.\n\n**Current execution priority (added February 23, 2026):** for upcoming iterations, the main priority is to shepherd the full broad DAG (currently ~500+ jobs on `generate_results_table`) to 100% completion, using explicit sleep/poll/check loops until all jobs finish or a concrete blocker is filed.\n\n### The layers\n\n1. **Library** — `dr1_cmbx.eDR1data` (maps_refactor branch). Given infrastructure. Bugs get filed for the MR, not fixed here.\n2. **Scratch library** — `dr1_notebooks/scratch/cdaley/`. New analysis code lives here. Reusable functions, shared utilities, anything not ready for the MR.\n3. **Compute rules** — Snakemake rules calling library functions → NPZ outputs. Import from `dr1_cmbx` and scratch, not from each other.\n4. **Plot rules** — NPZ → figures + evidence. The wildcard space (7 bins × 3 tracers × 3 CMB × 11 systematics) produces hundreds of per-combination plots. Most of these should not exist as individual outputs. Compress into composites: one figure that shows all bins, or all experiments, or the systematic budget as a whole. The goal is a handful of figures a collaborator can absorb, not an exhaustive gallery. Remove per-wildcard rules that don't earn standalone existence.\n5. **Rule structure** — Production (Snakefile) = stable backbone. Exploration (explorations.smk) = research front, currently ~101 rules, should shrink substantially. Rename and reorganize freely.\n\n### What NOT to do\n\n- Don't change the `maps_refactor` branch — that's a separate MR.\n- Don't formalize prematurely. Extract on the second or third use, not the first.\n\n## Context\n\n### Architecture\n\n```\ndr1_cmbx.eDR1data           (maps_refactor — authoritative library)\n    spectra, maps, reader, nz\n        ↓\ndr1_notebooks.scratch.cdaley (growing analysis library)\n        ↓\nworkflow/scripts/             (compute + plot scripts)\n        ↓\nworkflow/Snakefile + rules/explorations.smk\n        ↓\nconfig/config.yaml           (wildcard dimensions, experiments, parameters)\n```\n\n### Production vs exploration\n\nIf a rule produces data that other rules consume → production. If it produces a figure or evidence for human consumption → exploration. The boundary should be clear in the Snakefile.\n\n## Skills\n\nALWAYS activate ALL of these at the start of every iteration:\n- `/snakemake` — rule definitions, execution, DAG discipline\n- `/tapestry` — evidence conventions, narrative state\n- `/implementing-code` — code quality\n- `/writing` — when modifying fiber bodies, outcomes, or any prose\n\n## Rhythm\n\nThis is a collaboration. The human steers, reshaping the constitution as understanding deepens. Ralph surveys, proposes, implements. The interaction is where taste lives.\n\nEach iteration:\n\n1. **Survey** — What is stable? Where to build? Use `felt ls`, `felt show`, `felt upstream`, `felt downstream`. Check `felt downstream pipeline-formalization-db91ef79` for queued work. Read open and active fibers.\n\n2. **Choose** — Highest-value intervention. May involve asking the human.\n\n3. **Implement and run** — Make the change, verify the DAG with `snakemake -n`, then actually run the rules. Shepherd SLURM jobs to completion — sleep, check, repeat. Don't exit hoping the next iteration picks it up. A fiber is NOT done until computation has produced output.\n\n4. **Reflect on results** — Read the plots. What are they *saying*? How do the results affect previous assumptions and future steps? Previous decisions can and should be revisited based on evidence. A task is complete only when you have either: (a) run it, read results, reflected on implications, OR (b) opened a follow-up fiber noting what to inspect and why. Writing code that compiles is not completion.\n\n5. **Weave the tapestry** — Not a cleanup step — woven through the work. Close fibers with outcomes as you go. Open new ones as things emerge. Update prose using `/writing`. Each iteration leaves the tapestry richer and more coherent. At any moment it should be research-meeting quality. Every tapestry fiber must have a lede paragraph in its body — not a sentence, a real paragraph that orients a reader: what question this node answers, what was found, and why it matters. Supporting detail (methodology, parameters, caveats) follows below. One-sentence stub fibers are not acceptable.\n\n### When there's no structural work\n\nAudit closed downstream fibers of the constitution one by one. Revisit the plots they produced. Do they read well? Is the fiber outcome sharp? Condense, tighten, rewrite. Fewer plots, clearer plots, sharper prose. Also revisit closed fibers elsewhere in the tapestry — do their outcomes still reflect the current understanding?\n\n### Git hygiene\n\n`code/dr1_notebooks/` — rapid exploration, single user. Every iteration: commit all changes, even from previous work. Don't leave dirty state.\n\n`code/dr1_cmbx/` — shared library. Don't commit here.\n\n### Mindset\n\nEarly-stage work. Nothing is finished, nothing needs to arrive at \"done.\" Each iteration finds where to make progress next. Premature closure is worse than honest uncertainty.\n\n## Focus areas\n\nFive spine nodes (tier:1): Introduction → Data → Methods → Validation → Results. Work lives primarily in **Data** and **Methods**, some **Results**.\n\n- **Data** (`data-euclid-act-spt-7d4e8847`) — maps, masking, n(z). Foundations. If these aren't solid, nothing downstream is trustworthy.\n- **Methods** (`methods-pseudo-cℓ-cross-3eedb9dd`) — pseudo-C_ℓ, covariance, estimators, apodization. Interior nodes are closed with evidence; the code behind them needs tightening.\n- **Results** (`results-detection-and-90f2ec1b`) — detection, likelihood, template marginalization. Verify formalization hasn't changed the numbers.\n\n## Status semantics\n\n- **open** (○) — work needed\n- **active** (◐) — in flight this iteration\n- **closed** (●) — finding stated, evidence exists, outcome documented\n\n## Evidence\n\n```bash\nfelt ls -t tapestry: -s open       # unfinished work\nfelt ls -t tapestry: -s active     # in flight\nfelt downstream <id>               # direct children\nfelt downstream <id> -d summary    # with context\nfelt upstream <id>                 # what it rests on\n```\n\nQuestions each iteration: Are fibers closing with real outcomes? Does the DAG tell a coherent story? Do the plots answer their questions? Is `snakemake -n` clean?\n\n## Open Questions\n\n- **Scratch module structure**: One big module or topic-based? Let it emerge.\n- **Rule taxonomy**: Theory computation, likelihood — production or exploration?\n- **Renaming**: Tapestry nodes anchored by three-way match: `tapestry:<specName>` = rule name = `results/claims/<specName>/`. Renaming means updating all three.",
      "outcome": null,
      "createdAt": "2026-02-22T22:39:47.93051058+01:00",
      "closedAt": null,
      "dependsOn": [
        "tapestry-phase-2-comprehensible-3240e986",
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "scratch-utility-imports-04b7458d",
      "title": "Scratch utility imports",
      "status": "closed",
      "kind": "task",
      "tags": [
        "ralph",
        "methods"
      ],
      "body": "Formalize shared utility provenance for workflow scripts by migrating reusable modules into dr1_notebooks.scratch.cdaley and rewiring scripts to import from package modules, not workflow-local utility files.",
      "outcome": "Added package modules: nmt_utils.py, spectrum_utils.py, plot_utils.py (+ paper.mplstyle) under src/dr1_notebooks/scratch/cdaley. Rewired workflow scripts to import from dr1_notebooks.scratch.cdaley.*. Converted workflow/scripts/{nmt_utils,spectrum_utils,plot_utils}.py into compatibility re-export shims. Verified with python3 -m py_compile on migrated modules and snakemake -n compute_all_shear_cross_spectra (DAG builds cleanly; provenance-triggered recompute only).",
      "createdAt": "2026-02-22T23:28:24.846435142+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "compute-scripts-remove-inline-748e8426",
      "title": "Compute scripts: remove inline NaMaster calls",
      "status": "closed",
      "kind": "task",
      "tags": [
        "methods",
        "ralph"
      ],
      "outcome": "Added NaMaster wrappers in dr1_notebooks.scratch.cdaley.nmt_utils (catalog field creation, mask apodization, coupled-cell, Gaussian covariance) and rewired compute_{cross,systematic,cmbk_systematic,kappa,catalog,cmb_noise}_*.py to call those wrappers instead of direct pymaster API. Verified with python3 -m py_compile on all touched modules and snakemake -n compute_all_shear_cross_spectra + snakemake -n compute_all_systematic_cross_spectra (DAG resolves cleanly; provenance-only reruns).",
      "createdAt": "2026-02-23T01:44:20.283602128+01:00",
      "closedAt": "2026-02-23T01:44:26.956642662+01:00",
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "shared-apodization-layer-for-d4ff610f",
      "title": "Apodization Layer",
      "status": "active",
      "kind": "task",
      "tags": [
        "methods",
        "question",
        "tapestry:apodization_layer"
      ],
      "body": "Common apodized-footprint mask layer shared by Euclid RR2 and CMB lensing map products, feeding harmonic-space estimators.",
      "outcome": null,
      "createdAt": "2026-02-23T01:58:33.367145157+01:00",
      "closedAt": null,
      "dependsOn": [
        "euclid-rr2-maps-0d4db3db",
        "cmb-lensing-maps-e7e9436c",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "catalog-based-harmonic-space-14a8b515",
      "title": "Catalog Harmonic Estimator",
      "status": "open",
      "kind": "task",
      "tags": [
        "methods",
        "tapestry:catalog_based_harmonic_estimator"
      ],
      "body": "Catalog-based pseudo-C_ell estimator path (NmtFieldCatalog), with map-based auxiliary mask geometry for covariance consistency checks.",
      "outcome": null,
      "createdAt": "2026-02-23T01:58:33.370189048+01:00",
      "closedAt": null,
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "map-based-harmonic-space-5f227b0f",
      "title": "Map Harmonic Estimator",
      "status": "open",
      "kind": "task",
      "tags": [
        "methods",
        "tapestry:map_based_harmonic_estimator"
      ],
      "body": "Map-based pseudo-C_ell estimator path (NmtField from maps), consuming formal apodized masks and producing harmonic-space spectra/covariance inputs.",
      "outcome": null,
      "createdAt": "2026-02-23T01:58:33.37203342+01:00",
      "closedAt": null,
      "dependsOn": [
        "methods-pseudo-cℓ-cross-3eedb9dd",
        "shared-apodization-layer-for-d4ff610f"
      ]
    },
    {
      "id": "wiener-filter-validation-46ee1c27",
      "title": "Wiener filter validation",
      "status": "closed",
      "kind": "task",
      "tags": [
        "region:validation:consistency",
        "tapestry:wiener_filter_validation"
      ],
      "body": "This node establishes whether the Wiener filtering used for ACT/SPT kappa map visualization is both scientifically justified and operationally legible in the tapestry. The result is that the filtering diagnosis is stable (ACT is noise-dominated relative to SPT in this setup), but the original evidence schema was slightly off for renderer discovery. We corrected the evidence document shape while preserving the quantitative conclusion, so the node now serves both analysis integrity and dashboard usability.\n\nThe rule computes Planck 2018 theory `C_ell^{kappa kappa}`, compares it to per-mode map spectra (`C_ell^map / f_sky`) for ACT and SPT, estimates noise as `max(C_ell^map / f_sky - C_ell^{kappa kappa}, 0)` with a high-ell floor, and plots both empirical and theory-informed `W(ell)`. The output figure is `cmbx/files/results_claims_wiener_filter_validation_wiener_filter_validation.png`, with sidecar `cmbx/files/results_claims_wiener_filter_validation_evidence.json`.\n\nConcretely, this figure shows: (1) theory `C_ell^{kappa kappa}`, (2) ACT/SPT data spectra, (3) ACT/SPT noise estimates, and (4) empirical versus theory-informed filter transfer functions. It answers the intended methods question directly and now conforms to the same evidence schema conventions as other rendered tapestry nodes.",
      "outcome": "Revalidated end-to-end and brought into tapestry evidence convention compliance. Evidence.json now includes top-level output field for renderer discovery. Scientific result unchanged: empirical filtering fails for ACT (noise floor 6.85e-08) versus SPT (2.72e-09, ratio 25.2). Theory-informed filter using Planck 2018 C_ell^{kk} yields act_ell_half_theory=null up to ell=1000 while SPT crosses at ell~353. ACT non-crossing remains a downstream methods question.\n",
      "createdAt": "2026-02-23T01:58:57.668264249+01:00",
      "closedAt": "2026-02-23T03:47:07.513130172+01:00",
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "wiener-filter-diagnostic-plot-w-14438464",
        "spt-3g-winter-lensing-ab712d17",
        "act-dr6-lensing-e4a3eae9",
        "cmb-lensing-maps-e7e9436c"
      ]
    },
    {
      "id": "catalog-estimator-f3e211f9",
      "title": "Catalog estimator",
      "status": "open",
      "kind": "task",
      "body": "Document the catalog-based cross-spectrum estimator: what it does, what choices go into setting it up, how it works. NmtFieldCatalog takes galaxy positions and ellipticities directly — no pixelization. Detail the configuration (lmax, spin, lonlat, sign conventions), what workspace caching looks like, and how covariance is handled (map-based auxiliary field, since NmtFieldCatalog can't expose masks).\n\nThis is a methods-level doc fiber. Should be clear enough that a collaborator understands what the estimator does without reading the code.",
      "outcome": "Catalog estimator formalized to a single compute path: exploration rule compute_catalog_cross_spectrum now calls the shared script workflow/scripts/compute_cross_spectrum.py with estimator='catalog', using the same masking/binning/workspace/covariance machinery as production map spectra. Removed the duplicate script workflow/scripts/compute_catalog_cross_spectrum.py so catalog-vs-map validation no longer has parallel NaMaster implementations that can drift.",
      "createdAt": "2026-02-23T02:02:10.260264058+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "map-estimator-e97a19ea",
      "title": "Map estimator",
      "status": "open",
      "kind": "task",
      "body": "Document the map-based cross-spectrum estimator: pixelized HEALPix maps → NmtField → pseudo-C_ℓ. Detail the map-building step (catalog_to_map), masking (footprint × weights → apodize), field construction (spin-2 shear with COSMO pol_conv, spin-0 density/convergence), binning, and workspace computation.\n\nThis is the validation estimator — the catalog estimator is production. Their agreement proves map-making introduces no bias. But the agreement is suspiciously perfect (r = 0.995-0.999) and should be scrutinized.",
      "outcome": null,
      "createdAt": "2026-02-23T02:02:10.600627654+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "formal-mask-outputs-76171c0b",
      "title": "Formal mask outputs",
      "status": "closed",
      "kind": "task",
      "tags": [
        "methods",
        "ralph"
      ],
      "outcome": "Added production rules build_apodized_pair_masks (per {method,bin,cmbk}) and build_rr2_apodized_masks (shared RR2/CMB tracer combinations). compute_cross_spectrum now consumes official apodized masks by default (fallback to inline only when patch masks are applied). Promoted plot_euclid_rr2_maps from explorations to Snakefile and removed plot_apodization_masks rule/script. Verified via python3 -m py_compile on touched scripts and dry-runs: snakemake -n results/.../masks/apodized_pairs/lensmc_bin1_x_act/summary.json; snakemake -n build_rr2_apodized_masks; snakemake -n plot_euclid_rr2_maps (DAG clean; expected upstream map rebuilds). Live SLURM validation run was started then manually cancelled during interactive iteration.",
      "createdAt": "2026-02-23T02:08:58.341715777+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "shared-apodization-layer-for-d4ff610f",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "tapestry-dag-thinning-04ee625d",
      "title": "Tapestry DAG thinning",
      "status": "open",
      "kind": "task",
      "body": "Reorganize the tapestry DAG for legibility. Currently nodes have too many connections and the section boundaries are blurred. Three changes:\n\n### 1. Theory nodes move to Results\n\nTheory comparison, theory residuals, and likelihood evaluation are *results* — they answer \"does the data match ΛCDM?\" Move them from Validation to Results. Validation should be about consistency checks and null tests, not about the science answer.\n\n### 2. Systematic contamination summary node\n\nCurrently individual systematic checks (null tests, bias budget, contamination metric, systematic spectra, deprojected spectra) all connect directly to the Validation spine. Instead, a single \"Systematic contamination\" summary node should sit between Validation and the individual checks. This node summarizes the overall contamination picture; the individual nodes are its children. Reduces Validation's direct connections and gives the contamination story a natural entry point.\n\n### 3. Wire ACT/SPT data nodes to downstream results\n\nThe ACT DR6 (`act-dr6-lensing-e4a3eae9`) and SPT winter (`spt-3g-winter-lensing-ab712d17`) data doc fibers exist in the Data section but aren't connected to the downstream fibers that use those experiments (ACT vs SPT comparison, SPT deficit, estimator comparisons, etc.). The DAG should show this provenance — the data nodes are upstream of the results that depend on them.\n\n### Legibility constraint\n\nAim for ~3 direct upstream/downstream connections per node. If a node has more, it's probably serving as a pass-through and something can be restructured. The DAG should be readable at a glance, not a hairball.",
      "outcome": "Rewired tapestry for legibility in three passes. (1) Theory ownership moved from Validation to Results by making theory_comparison, theory_residual_analysis, and evaluate_fiducial_likelihood downstream of Results and removing Validation as direct upstream. (2) Added summary node systematic-contamination-summary-e6c81e29 (tag tapestry:systematic_contamination_summary) between Validation and contamination-detail fibers: plot_systematic_null_tests, plot_contamination_metric, plot_systematic_spectra, plot_systematic_budget, and template_deprojection. (3) Added explicit ACT/SPT data provenance edges from act-dr6-lensing-e4a3eae9 and spt-3g-winter-lensing-ab712d17 into downstream results fibers: plot_act_vs_spt, overlap consistency, SPT estimator comparison, theory comparison, and SPT theory-fail node. Also repaired a pre-existing felt cycle by removing stale legacy edges from narrative-tapestry-compress-31-6c42a4d6; felt check now reports Graph OK.",
      "createdAt": "2026-02-23T02:11:25.533120553+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "cmb-map-doc-script-deduplication-4daeb8b6",
      "title": "CMB map-doc script deduplication",
      "status": "closed",
      "kind": "task",
      "tags": [
        "ralph",
        "data"
      ],
      "body": "Deduplicate ACT/SPT map-documentation plotting while preserving tapestry rule lineage.",
      "outcome": "Replaced duplicated scripts plot_act_dr6_lensing.py and plot_spt_winter_lensing.py with one shared implementation plot_cmb_lensing_doc.py parameterized by rule params (claim_id/labels). Kept rule names and claim directories unchanged (plot_act_dr6_lensing -> results/claims/act_dr6_lensing/, plot_spt_winter_lensing -> results/claims/spt_winter_lensing/) to preserve tapestry alignment. Removed unreferenced legacy scripts. Verified with python3 -m py_compile workflow/scripts/plot_cmb_lensing_doc.py and snakemake -n plot_act_dr6_lensing plot_spt_winter_lensing.",
      "createdAt": "2026-02-23T02:12:11.780729253+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "estimator-agreement-too-perfect-1f9d1acc",
      "title": "Estimator agreement too perfect?",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "Catalog-vs-map validation currently shows very high correlations (r~0.995-0.999). Need a targeted check that this is physical/expected and not a consequence of shared choices (identical masks, binning, workspace handling, or covariance assumptions).",
      "outcome": "Root cause identified: production compute_cross_spectrum was reading config cross_correlation.estimator=catalog, so the purported map-vs-catalog validation was not independent and could be exactly identical. Fixed by hard-wiring production compute_cross_spectrum to map estimator and reserving catalog estimator for compute_catalog_cross_spectrum. Targeted rerun (metacal bin1 x ACT) now executes map path (Estimator: map) and catalog path (Estimator: catalog) separately; outputs are no longer bitwise equal (max |ΔC_ell|≈6.0e-08). The prior near-perfect agreement was therefore an implementation-configuration coupling artifact, not a meaningful validation result.",
      "createdAt": "2026-02-23T02:15:00.891142278+01:00",
      "closedAt": "2026-02-23T02:50:30.306576757+01:00",
      "dependsOn": [
        "map-estimator-e97a19ea",
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "systematic-contamination-summary-e6c81e29",
      "title": "Systematic contamination summary",
      "status": "closed",
      "kind": "task",
      "tags": [
        "tapestry:systematic_contamination_summary",
        "region:validation:contamination"
      ],
      "body": "Summary node for systematic contamination evidence. This sits between the Validation spine and individual contamination analyses so readers can enter the contamination story once, then drill into detailed tests.",
      "outcome": "Validation contamination entry point introduced for DAG legibility: contamination storyline is summarized here, with detailed checks as downstream children (null pulls, contamination metric, raw spectra, bias budget, and template deprojection).",
      "createdAt": "2026-02-23T02:16:29.53996908+01:00",
      "closedAt": null,
      "dependsOn": [
        "validation-null-tests-and-48ab3654"
      ]
    },
    {
      "id": "container-python-leakage-ce40c784",
      "title": "Container Python leakage",
      "status": "open",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "outcome": null,
      "createdAt": "2026-02-23T02:32:42.313225678+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "map-estimator-e97a19ea"
      ]
    },
    {
      "id": "synthesis-replaces-summary-22ffcec4",
      "title": "Synthesis replaces summary",
      "status": "closed",
      "kind": "task",
      "body": "Delete the `plot_analysis_summary` tapestry node (`analysis-summary-one-page-c5170698`) and its rule. Replace it with a tier:1 \"Synthesis\" spine node — a place to draw together what we're learning across the analysis, without any notion of finality.\n\nThe current analysis summary is a one-page poster of fixed metrics. Synthesis is different: it's a living fiber that weaves threads from Data, Methods, Validation, and Results into a coherent understanding of where the analysis stands. What do we know? What's unresolved? What's surprising? It grows and changes as the analysis deepens — it's never \"done.\"\n\nThe spine becomes: Introduction → Data → Methods → Validation → Results → Synthesis.",
      "outcome": "Removed rule plot_analysis_summary from workflow/rules/explorations.smk and deleted workflow/scripts/plot_analysis_summary.py, shifting synthesis from a fixed terminal figure to living tapestry prose. Verified DAG parsing after removal with snakemake dry-runs. Attempted replacement execution through target results/claims/plot_signal_overview/signal_overview_lensmc.png; this exposed an upstream blocker in compute_theory_cls where Theory.__init__ no longer accepts ia_params in the current container/library combination. Completed a concrete fallback compute run to keep execution grounded: snakemake -s workflow/Snakefile -j1 results/rr2_v2_1_wl_031224-v0.0/cross_correlations/individual/lensmc_bin1_x_act_cls.npz produced fresh NPZ and evidence (Knox SNR 3.53, chi2/dof 12.5/20, PTE 0.899). Summary de-formalization is complete; theory-path API alignment is now the blocking next step for composite synthesis figures.",
      "createdAt": "2026-02-23T02:45:40.718654574+01:00",
      "closedAt": "2026-02-23T03:58:35.625038764+01:00",
      "dependsOn": [
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "map-vs-catalog-sign-mismatch-180398e2",
      "title": "Map-vs-catalog sign mismatch after estimator split",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "After forcing production spectra to estimator=map and rerunning metacal bin1 x ACT, catalog and map spectra are no longer identical but show strong anti-correlation in E-mode bandpowers for this pair (r≈-0.985). Need a targeted sign-convention audit between map and catalog branches under official apodized masks: verify e1 sign handling, pol_conv conventions, and whether one branch is effectively returning -C_ell.",
      "outcome": "Targeted rerun on February 23, 2026 (metacal bin1 × ACT) after convention unification removed the sign flip pathology: map/catalog E-mode bandpowers are now positively correlated (r=0.967), not anti-correlated. The fix was to stop ad hoc sign handling and use shared IAU convention flow across both estimators, including direct dr1_cmbx spectra primitives in compute_cross_spectrum and dr1_cmbx process_shear_catalog in build_maps. Residual disagreement remains substantial in amplitude/shape (RMS fractional difference ~0.59; max ~1.45), so the original sign-mismatch question is resolved but estimator-agreement validation is still open at the amplitude level.",
      "createdAt": "2026-02-23T02:50:34.708269799+01:00",
      "closedAt": "2026-02-23T03:16:52.035152348+01:00",
      "dependsOn": [
        "map-estimator-e97a19ea",
        "catalog-estimator-f3e211f9",
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "map-catalog-amplitude-gap-60328de2",
      "title": "Map/catalog amplitude gap",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "outcome": "On Monday, February 23, 2026, we reran plot_catalog_validation_summary after formalizing a signal-selected fractional metric (|C_map|/sigma_map >= 1.0) alongside legacy RMS. This resolves the core amplitude-gap interpretation question: extreme RMS tails were largely denominator artifacts from near-zero map bandpowers. Evidence now shows legacy median RMS_frac=0.921 and p95=20.48, but signal-selected median RMS_frac_signal=0.201 and p95=0.789 (max 1.395), with the prior worst case (metacal bin2 x ACT) dropping from RMS_frac 64.9 to RMS_frac_signal 0.0187. The remaining tension is not a generic map-vs-catalog amplitude failure; it is concentrated ACT-driven chi2 outliers (e.g., lensmc bin2 x ACT chi2_nu~19.7, metacal bin1 x ACT chi2_nu~10.6), now tracked explicitly in act-dominated-map-catalog-chi2-19797f04.",
      "createdAt": "2026-02-23T03:16:52.040998233+01:00",
      "closedAt": "2026-02-23T05:47:02.503765163+01:00",
      "dependsOn": [
        "map-vs-catalog-sign-mismatch-180398e2"
      ]
    },
    {
      "id": "method-chi2-calibration-95cd218e",
      "title": "Method chi2 calibration",
      "status": "open",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "outcome": "Composite-only method comparison now reports median chi2/dof ~1.76 (vs earlier near-zero values from per-wildcard evidence). Determine whether this shift is primarily from: (1) restricting to ACT+tomographic bins, (2) revised per-bin statistic computation, or (3) stale/legacy evidence path in prior runs. Clarify the intended covariance model for lensmc-metacal differences (diagonal approximation vs correlated-noise covariance) and decide which statistic should anchor the validation claim.",
      "createdAt": "2026-02-23T03:27:07.149920979+01:00",
      "closedAt": null,
      "dependsOn": [
        "lensmc-vs-metacal-method-7d4d724f",
        "map-estimator-e97a19ea"
      ]
    },
    {
      "id": "act-filter-crossing-975b0af6",
      "title": "ACT filter crossing",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "outcome": "Theory-informed ACT Wiener filter remains below 0.5 for all ell<=1000 (ell_half=None) despite visible improvement over empirical filtering. Determine whether this is expected from ACT noise/model assumptions or indicates an issue in map-spectrum normalization/noise estimation. Define an interpretation criterion for map-visualization filtering that does not rely on an ell_half crossing when S/N is low.",
      "createdAt": "2026-02-23T03:47:06.239394768+01:00",
      "closedAt": null,
      "dependsOn": [
        "wiener-filter-validation-46ee1c27",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "theory-api-drift-cb72d714",
      "title": "Theory API drift",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "outcome": "On February 23, 2026, we resolved the runtime break in workflow/scripts/compute_theory_cls.py by aligning it with the current dr1_cmbx.eDR1like.Theory constructor. The script no longer passes unsupported ia_params, and the blocked target results/rr2_v2_1_wl_031224-v0.0/theory/theory_cls_lensmc_x_act.npz built successfully via Snakemake/SLURM (job 34735472). We also made IA provenance explicit in logs and NPZ metadata with ia_params_applied_from_config=false so downstream interpretation is accurate while Theory API support remains unchanged.",
      "createdAt": "2026-02-23T03:58:32.945109893+01:00",
      "closedAt": "2026-02-23T04:05:20.761581281+01:00",
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "ia-config-not-propagated-to-2cf39a50",
      "title": "IA config propagation",
      "status": "open",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "compute_theory_cls reads IA settings from workflow config, but current dr1_cmbx.eDR1like.Theory does not accept ia_params and uses internal defaults when include_ia_bias=True. This node tracks whether we should (a) treat IA config as intentionally non-operative in this pipeline stage, (b) adapt the upstream Theory API to expose IA parameters, or (c) adjust pipeline semantics to avoid implying configurable IA amplitudes. The decision affects theory-comparison interpretation, likelihood inputs, and methods documentation.",
      "outcome": null,
      "createdAt": "2026-02-23T04:05:20.651214416+01:00",
      "closedAt": null,
      "dependsOn": [
        "theory-api-drift-cb72d714",
        "methods-pseudo-cℓ-cross-3eedb9dd"
      ]
    },
    {
      "id": "spt-estimator-composite-only-71c8d895",
      "title": "SPT estimator composite-only formalization",
      "status": "closed",
      "kind": "task",
      "body": "This iteration formalizes the SPT estimator comparison path as composite-only outputs at the method level, removing per-bin wildcard plot products while preserving estimator-consistency evidence. We rewired the exploration rules and aggregator so the workflow now produces one composite figure per shear method (lensmc, metacal), with evidence computed directly from the shared NPZ spectra and summarized into a single rule-level evidence document. This matters for the constitution because it shrinks wildcard plot sprawl without dropping validation content, and keeps the estimator story legible for collaborators.",
      "outcome": "Replaced the per-bin SPT estimator plotting path with method-level composites and validated it end-to-end in Snakemake. Removed rule plot_spt_estimator_comparison and rule plot_all_spt_estimator_comparisons, deleted workflow/scripts/plot_spt_estimator_comparison.py, and rewired rule plot_spt_estimator_composite to take NPZ inputs directly and emit spt_estimator_composite_{method}.png plus per-method evidence JSON. Updated aggregate_spt_estimator_evidence inputs and workflow/scripts/aggregate_evidence.py logic to summarize the composite format. A full run of snakemake -j20 plot_all_spt_estimator_composites aggregate_spt_estimator_evidence completed after fixing a runtime import bug where save_evidence must be imported from plot_utils. Final outputs were generated in results/claims/plot_spt_estimator_comparison/; evidence reports 36/36 estimator-variant comparisons consistent at p>=0.05 with median chi2/dof around 0.073 and minimum min-PTE 0.9995, so the composite path preserves the previous consistency conclusion while materially reducing wildcard plot outputs.",
      "createdAt": "2026-02-23T04:38:01.849478364+01:00",
      "closedAt": "2026-02-23T04:38:10.362669806+01:00",
      "dependsOn": [
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "summary-render-stall-5992d18c",
      "title": "Summary render stall",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "outcome": "On Monday, February 23, 2026, plot_catalog_validation_summary was restored to runnable state and completed successfully, producing results/claims/plot_catalog_validation_summary/catalog_validation_summary.png and results/claims/plot_catalog_validation_summary/evidence.json. The fix had two parts: mark the rule as a localrule in workflow/rules/explorations.smk, and explicitly disable TeX rendering in the plotting script after theme setup via plt.rcParams[\"text.usetex\"] = False, which removed the TinyTeX startup path that was driving multi-minute silent stalls. The refreshed evidence now includes explicit outlier tables (worst_rms_cases and worst_reduced_chi2_cases), so this node is no longer blocked by execution reliability and now feeds downstream interpretation directly.",
      "createdAt": "2026-02-23T05:03:11.806436591+01:00",
      "closedAt": "2026-02-23T05:43:07.380682675+01:00",
      "dependsOn": [
        "map-catalog-amplitude-gap-60328de2",
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "container-activation-stall-for-b33c231d",
      "title": "Container activation stall",
      "status": "open",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "This question isolates the unresolved runtime bottleneck behind plot_catalog_validation_summary. The rule now has persistent Matplotlib cache wiring and explicit stage logs, and standalone singularity cache warmup succeeds quickly, but the Snakemake SLURM jobs still spend minutes stuck at container activation without creating rule logs or outputs. We need to determine whether the stall is coming from nested Snakemake-in-SLURM execution, singularity image startup on specific nodes, or environment leakage in the container launcher path, then land a rule-level fix that makes this summary deterministic and closeable.",
      "outcome": null,
      "createdAt": "2026-02-23T05:19:37.758037804+01:00",
      "closedAt": null,
      "dependsOn": [
        "summary-render-stall-5992d18c",
        "container-python-leakage-ce40c784"
      ]
    },
    {
      "id": "apodization-memory-tuning-0eee27a3",
      "title": "Apodization memory tuning",
      "status": "closed",
      "kind": "task",
      "tags": [
        "methods",
        "ralph"
      ],
      "body": "This run resolved an execution-layer fragility in the apodization mask branch by calibrating rule resources against observed SLURM behavior, then rerunning the branch to completion. The key question was whether repeated \"Activating singularity image\" stalls were startup deadlocks or underprovisioned memory in containerized localrules. We traced the failure mode to OOM kills and converted that diagnosis into explicit Snakemake resource settings, so the apodization layer now executes reproducibly rather than failing ambiguously.",
      "outcome": "On February 23, 2026, target results/rr2_v2_1_wl_031224-v0.0/masks/rr2_apodized/summary.json was produced successfully after resource calibration in workflow/Snakefile: build_density_map mem_mb changed from 1000 to lambda (bin=all -> 24000, else 4000), and build_rr2_apodized_masks mem_mb changed from 6000 to 24000. SLURM logs showed prior failures were OOM kills (34738096.0 and earlier), not container startup deadlocks. Final rerun (job 34738159) completed and emitted RR2 apodized mask summary with overlap support/effective fractions, including shear_x_act support 0.0076758 and shear_x_spt support 0.0034369.",
      "createdAt": "2026-02-23T05:35:34.859648455+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "shared-apodization-layer-for-d4ff610f"
      ]
    },
    {
      "id": "act-dominated-map-catalog-chi2-19797f04",
      "title": "ACT-dominated map/catalog chi2 outliers",
      "status": "open",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "After replacing raw fractional-RMS emphasis with a signal-selected RMS diagnostic in the catalog-vs-map summary (S/N cut on map bandpowers), the extreme amplitude tail is no longer the dominant story. This node isolates the remaining high-significance ACT-driven residuals (large reduced chi2 in specific bins) as a distinct methodological question: whether they arise from covariance under-modeling, ACT-specific systematics, or estimator construction details. The goal is to resolve those outliers without conflating them with denominator artifacts from near-zero C_ell bins.",
      "outcome": null,
      "createdAt": "2026-02-23T05:46:56.690477752+01:00",
      "closedAt": null,
      "dependsOn": [
        "map-catalog-amplitude-gap-60328de2",
        "method-chi2-calibration-95cd218e"
      ]
    },
    {
      "id": "act-vs-spt-composite-only-d6c1557e",
      "title": "ACT vs SPT composite-only reduction",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "body": "ACT-vs-SPT currently still materializes many per-wildcard comparison plots (21 in the `generate_results_table` dry-run path), even though the scientific conclusion is already captured at rule level and in composite outputs.\n\nDecide and implement a composite-first formalization: keep one or a few summary figures plus evidence aggregation, remove per-bin figure proliferation unless a specific bin-level diagnostic is justified as a standing output.\n\nConventions target: tapestry tag alignment, claims directory consistency, and dashboard-readable evidence that does not depend on browsing dozens of PNGs.",
      "outcome": null,
      "createdAt": "2026-02-23T08:51:03.76024104+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79",
        "act-vs-spt-cross-spectra-b4181199"
      ]
    },
    {
      "id": "dag-shepherding-persistence-b22d4bd5",
      "title": "DAG shepherding persistence",
      "status": "open",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "The blocking question is execution persistence for the broad `generate_results_table` DAG: we can launch and make steady progress, but the full 478-job span is multi-hour and requires uninterrupted shepherding that outlasts one interactive loop turn. On Monday, February 23, 2026, we verified the broad run and advanced it across multiple waves (e.g., 32/478 completed under SLURM run ID `f7f5b7d5-be50-402b-bb0c-88266707b673`), but this exposed a control-plane gap rather than a science-code bug: we need a durable shepherd mechanism that can survive loop handoff while still enforcing explicit sleep/poll/check discipline.\n\n## Evidence from this iteration\n- Dry-run at 09:19 showed `total 497` jobs for `snakemake -n generate_results_table -j20`.\n- Active scheduler process observed: `snakemake -j20 generate_results_table`.\n- First run dropped scheduler with `Will exit after finishing currently running jobs (scheduler)` while leaving submitted jobs to drain.\n- Relaunched run at 09:24 under run ID `f7f5b7d5-be50-402b-bb0c-88266707b673`; observed repeated successful completions and new submissions through at least `32/478 steps`.\n- To leave clean state before handoff, scheduler was stopped intentionally and in-flight queue drained to zero (09:34:45).\n\n## Decision needed\nChoose and formalize one persistent execution pattern for this broad DAG:\n1. Keep a long-lived foreground shepherd session per iteration (strictly no exit until 100%).\n2. Add a formal shepherd wrapper (script/rule) that loops `snakemake -> poll queue -> rerun` until target exists, with clear logging and failure detection.\n3. Use a cluster-side persistent mechanism (e.g., dedicated SLURM shepherd job) with the same explicit polling semantics.\n\nThe goal is not to relax rigor; it is to make the rigorous 100%-completion requirement operationally sustainable.",
      "outcome": null,
      "createdAt": "2026-02-23T09:34:50.925864152+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "generate-results-table-shepherd-7457590d",
      "title": "Generate-results-table shepherd run 5471a86b",
      "status": "active",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "This fiber tracks a concrete execution wave of the broad  DAG under active shepherding, so handoff between Ralph iterations preserves operational state instead of resetting context. On Monday, February 23, 2026, the stale Snakemake controller process (PID 3301750) was diagnosed as stalled (no queue activity for >2 minutes despite lock ownership), cleared, and the DAG was relaunched cleanly with explicit target , yielding SLURM run ID . This matters because the top constitution priority is completion of the full broad DAG and this run is now the live execution thread to carry forward.\\n\\nExecution details: lock recovery required  because default-target unlock failed in this Snakefile due wildcard default-target behavior. Relaunch command: .\\n\\nObserved status during this iteration: active submission and completions resumed; queue reached ~17 concurrent running jobs; Snakemake progress reached 5/426 (1%) at 09:42:46 local time with no hard failures yet.\\n\\nNext-step question for following loop: continue explicit sleep/poll/check against this same run ID until either (a) workflow completes to 100% and produces final table/evidence outputs, or (b) a concrete failure appears (rule + log + blocker fiber).",
      "outcome": null,
      "createdAt": "2026-02-23T09:44:09.173255644+01:00",
      "closedAt": null,
      "dependsOn": [
        "dag-shepherding-persistence-b22d4bd5",
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "generate-results-table-shepherd-0dcdf59a",
      "title": "Generate results table shepherd handoff 2026-02-23",
      "status": "active",
      "kind": "task",
      "tags": [
        "question",
        "methods"
      ],
      "body": "This fiber captures the current live shepherd state for the broad generate_results_table DAG after an execution disruption and recovery pass on Monday, February 23, 2026. The key question is whether we can maintain one clean controller process across loop handoff while continuing explicit sleep, poll, and check discipline. During this iteration, a stale controller was removed, the DAG was relaunched, a duplicate controller was accidentally started via shell expansion in a felt command, then the duplicate wave was canceled and the workflow was relaunched cleanly with a higher latency wait. This matters because broad DAG completion is the current top constitution priority and this node is the operational spine for reaching it.\n\nObserved timeline:\n1) Initial healthy run launch: SLURM run ID 5471a86b-84cf-446a-93d2-8d8dc603cc00.\n2) Fault injection: accidental duplicate launch produced run ID 7f5266be-e021-49cc-b3be-a562a5270abd.\n3) Cleanup: canceled duplicate jobs and killed duplicate controller.\n4) Consequence: missing-output failures appeared in the original run due overlapping outputs during duplicate cancellation window.\n5) Recovery relaunch: SLURM run ID e1c4600e-1e84-4716-a551-3e9ecf17aed8 with --latency-wait 120.\n\nCurrent state at handoff: clean single controller active, jobs submitting/running normally, no immediate scheduler errors, remaining broad work count now 394 jobs for target results/claims/generate_results_table/evidence.json.\n\nNext-step instruction for following loop: continue explicit sleep/poll/check against run ID e1c4600e-1e84-4716-a551-3e9ecf17aed8 until completion or a concrete rule-level blocker, and avoid any second concurrent Snakemake controller in the same workdir.",
      "outcome": null,
      "createdAt": "2026-02-23T09:48:17.090143623+01:00",
      "closedAt": null,
      "dependsOn": [
        "dag-shepherding-persistence-b22d4bd5",
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "felt-depth-limited-traversal-246624f2",
      "title": "felt depth-limited traversal",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "felt upstream/downstream now default to 1 level (direct deps only). -d flag controls detail level (title/compact/summary/full). --all flag for full transitive closure. Previously returned full closure by default — 117 fibers from a spine node. Built, tested, installed.",
      "createdAt": "2026-02-23T10:19:39.967691612+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "codex-ralph-handoff-27482376",
      "title": "Codex ralph handoff",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Codex refuses kill $PPID as dangerous. Fixed: ralph script prompt now explicitly explains it's a bash loop handoff mechanism, not destructive. Also: $ralph (not /ralph) for codex skill activation.",
      "createdAt": "2026-02-23T10:19:39.977056991+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "constitution-is-collaborative-2e69c8f2",
      "title": "Constitution is collaborative",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Ralph constitutions are collaborative — human steers, ralph surveys and proposes. The constitution reshapes through use. Key principles added: early-stage mindset (nothing is finished), shepherd jobs to completion, reflect on results (code that compiles is not completion), weave the tapestry throughout (lede paragraphs required, no stubs), compress wildcard explosion into composites.",
      "createdAt": "2026-02-23T10:19:39.98275873+01:00",
      "closedAt": null,
      "dependsOn": [
        "pipeline-formalization-db91ef79"
      ]
    },
    {
      "id": "maps-wl-py-dropped-consolidated-c79920ae",
      "title": "maps_wl.py dropped, consolidated into maps.py",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Margherita's WLspectra branch added maps_wl.py with just read_partial_map + write_sparse_map. On merge, dropped it — those functions live in reader.py and nothing imported them from maps. WL shear map building (process_wl_catalog, wl_cat2map) stays in maps.py alongside GC. Cleaner: one module for all catalog→map conversion.",
      "createdAt": "2026-02-23T14:45:57.883449913+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "gctools-compat-shim-deprecation-47a54c65",
      "title": "gctools compat shim: deprecation, not removal",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Old import paths (from dr1_cmbx.eDR1data.gctools import spectra/maps/reader) preserved via gctools/__init__.py that re-exports from new top-level modules and emits DeprecationWarning. Mirror of what we did for get_cov. Gives collaborators time to migrate without breaking their code.",
      "createdAt": "2026-02-23T14:46:06.459931268+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "maps-py-four-function-naming-83e53d92",
      "title": "maps.py four-function naming",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Four functions in maps.py named symmetrically: process_gc_catalog / gc_cat2map (GC), process_wl_catalog / wl_cat2map (WL). process_*_catalog = low-level pixel aggregation (takes dict of arrays, returns sparse pixel data). *_cat2map = high-level catalog pipeline (reads catalog object, loops bins, saves pickle). Module docstring explains the two-layer split explicitly.",
      "createdAt": "2026-02-23T14:46:15.249022473+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "spectra-py-review-pending-c20e438d",
      "title": "spectra.py review pending",
      "status": "closed",
      "kind": "task",
      "tags": [
        "question"
      ],
      "outcome": "All remaining items complete:\n- Item 7+merge: map2cls added (wl_cat2map pickle-only). gc/wl accept {'map': path, 'masks': per_bin_dict} or bare string path. kappa/y as {'map': ..., 'mask': ...}. Masks can be arrays or file paths. Binary footprint derived from ipix when masks omitted. treat_bb_as_noise exposed and threaded.\n- Item 8: treat_bb_as_noise added to get_spectra signature, passed through to get_spectrum.\n- Item 9: _hash_fields catches ValueError/AttributeError on get_mask_alms() for NmtFieldCatalog, returns None. get_workspace skips caching when hash_key is None.\n- Item 10: cache subdirs renamed cl/ → wksp_cl/, cov/ → wksp_cov/.\n- Item 11: compute_knox_variance field2 now has same try/except as field1. Both-None case warns + returns zeros. One-None case falls back to available mask for fsky.\n- map2gccls: deprecated shim with masks=None default.\n- map2wlcls: replaced with RuntimeError migration notice.\n- Tests: 26 tests. map2cls gc/wl pkl tests + wl smoke integration test.\n- Committed as 3e53d9f, pushed to maps_refactor, MR !5.",
      "createdAt": "2026-02-23T14:46:21.396690147+01:00",
      "closedAt": "2026-02-23T17:54:49.64487596+01:00",
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "per-field-masks-dict-for-7495f4f0",
      "title": "per-field masks dict for map2gccls/map2wlcls",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "outcome": "Current separate params (visibility, effcov, footprint) should be unified into a masks dict for per-field control. Intersect with derived masks (ipix footprint, weight maps). Scope: map2gccls and map2wlcls. Deferred from MR !5 spectra.py review — do as follow-up.",
      "createdAt": "2026-02-23T16:16:23.752178907+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "map2cls-unified-entry-point-469986ff",
      "title": "map2cls unified entry point",
      "status": "closed",
      "kind": "task",
      "tags": [
        "spec"
      ],
      "outcome": "Implemented in spectra.py as map2cls(gc, wl, kappa, y, ...). See spectra-py-review-pending for full outcome.",
      "createdAt": "2026-02-23T17:31:32.940206462+01:00",
      "closedAt": "2026-02-23T17:54:49.780350235+01:00",
      "dependsOn": [
        "spectra-py-review-pending-c20e438d"
      ]
    },
    {
      "id": "spectra-py-test-fixes-mr-5-ready-43813e1e",
      "title": "spectra.py test fixes + MR !5 ready",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Fixed 6 failing tests in maps_refactor branch: (1) array truthiness bug in map2cls mask collection (if provided: with numpy array) — fixed to if mask_val is not None:; (2) _build_gc_filename missing s1_only/visibility/effcov params — added to signature, updated filename format (onlys1- prefix, weight_tag suffix); (3) tests referenced get_cl and compute_spectrum which no longer exist after meeting-notes design (merged into get_spectrum) — test_compute_spectrum rewired to use _DummyWorkspace and call get_spectrum directly; test_get_spectra patched get_spectrum instead of get_cl; (4) _FakeLoaded missing __iter__ for pickle iteration — added. Also fixed datetime.utcnow() deprecation in reader.py. 35/35 passing, zero warnings. MR description updated to reflect current API.",
      "createdAt": "2026-02-23T23:24:41.208109186+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "get-cl-merged-into-get-spectrum-ac044c46",
      "title": "get_cl merged into get_spectrum, compute_spectrum removed",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Meeting notes clarified design: old get_cl (pure spectrum) and old compute_spectrum (spectrum + covariance flag) merged into single get_spectrum(f1, f2, bins, *, compute_cov=False, compute_knox=False, ...). compute_spectrum removed entirely. get_spectra (plural) calls get_spectrum internally. Tests updated to monkeypatch get_spectrum instead of get_cl. The constructor-capture tests that patched nmt.NmtField etc. were also identified as lazy and replaced.",
      "createdAt": "2026-02-24T00:42:40.546968895+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "s1-only-removed-from-build-gc-435e3841",
      "title": "s1_only removed from _build_gc_filename",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "s1_only parameter was dropped from the maps_refactor design. Removed from _build_gc_filename signature and from the filename format (onlys1-{value} prefix removed). Tests updated accordingly.",
      "createdAt": "2026-02-24T00:42:40.80152932+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "no-namaster-mocking-in-tests-cd8c7b86",
      "title": "No NaMaster mocking in tests — real NmtField fixture",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "All nmt.* monkeypatches removed from test_spectra.py. Replaced with real NmtField objects at nside=8 via nmt_nside8 session fixture in conftest.py. Key findings: (1) NmtField.get_maps() returns input maps verbatim — usable for pol_conv flip verification (COSMO: map[1]==-e2, IAU: map[1]==e2). (2) Constructor-capture tests (patching NmtField ctor to capture args) are lazy — test behavioral output instead. (3) nmt.mask_apodization segfaults if aposcale < pixel size (~7° at nside=8) — fixture uses binary masks without apodization. Only remaining mocks are of our own functions or the _NoMaskField exception-handling path which genuinely cannot be exercised with real NmtField.",
      "createdAt": "2026-02-24T00:42:41.034498169+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "if-provided-array-truthiness-f5b591f4",
      "title": "if provided: array truthiness bug in map2cls",
      "status": "open",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Bug: provided = src['masks'] and src['masks'].get(fk) assigns a numpy array when mask is present. if provided: then raises ValueError (truth value of array is ambiguous). Fix: mask_val = src['masks'].get(fk) if src['masks'] else None; if mask_val is not None:. Affected both gc and wl mask collection paths in map2cls.",
      "createdAt": "2026-02-24T00:42:41.26520839+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "datetime-utcnow-deprecated-use-14dadab8",
      "title": "datetime.utcnow() deprecated — use datetime.now(UTC)",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "outcome": "datetime.utcnow() is deprecated in Python 3.12+ and will be removed. Use datetime.now(timezone.utc) instead. Fixed in reader.py write_sparse_map header DATE field.",
      "createdAt": "2026-02-24T00:42:55.826623064+01:00",
      "closedAt": null,
      "dependsOn": [
        "maps-refactor-goals-constraints-631ede76"
      ]
    },
    {
      "id": "fakeloaded-needs-iter-for-np-9bda69c3",
      "title": "_FakeLoaded needs __iter__ for np.load mocking",
      "status": "open",
      "kind": "task",
      "tags": [
        "question"
      ],
      "outcome": "When monkeypatching np.load to return _FakeLoaded(dict), iteration (for k in fake_loaded) fails because _FakeLoaded only has __getitem__. Python falls back to integer indexing (0, 1, ...) which raises KeyError on string-keyed dicts. Fix: add __iter__ = lambda self: iter(self.payload). Required for tests that mock pickle loading in map2cls.",
      "createdAt": "2026-02-24T00:42:56.047143409+01:00",
      "closedAt": null,
      "dependsOn": []
    },
    {
      "id": "hash-fields-uses-get-mask-not-dba2d38c",
      "title": "hash_fields uses get_mask not get_mask_alms",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Changed _hash_fields in spectra.py to use field.get_mask() (pixel space) instead of field.get_mask_alms(). get_mask_alms() triggers a full SHT on first call (expensive at nside=2048, cached only if not lite). get_mask() is a direct attribute access — no computation. The pixel-space mask uniquely determines the coupling matrix (SHT is deterministic), so it's an equally valid hash key. get_mask() raises ValueError/AttributeError on NmtFieldCatalog, same as get_mask_alms() — fallback to None still works. Change is in commit 597a128 on maps_refactor.",
      "createdAt": "2026-02-24T16:56:52.381332411+01:00",
      "closedAt": null,
      "dependsOn": [
        "spectra-py-test-fixes-mr-5-ready-43813e1e"
      ]
    },
    {
      "id": "mr-5-pre-review-pass-complete-d5ba08f9",
      "title": "MR !5 pre-review pass complete",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Reviewed MR !5 (maps_refactor) against all in-person meeting comments — all 14 items verified addressed. Additional changes this session: (1) get_mask() hashing (avoids SHT); (2) structural simplifications: _apply_pol_conv, _exp_tag, _safe_get_mask helpers extracted; pickle_spectra n_spec=2/4 branches collapsed; import re removed; maps.py tom_ids/effcov/mask_tag control flow tightened; (3) MR description updated: nz.py section removed (already on main via WLspectra), test counts corrected 35→37, get_cov backward-compat entry removed (no shim exists), maps.py function names corrected (process_gc_catalog, process_wl_catalog, gc_cat2map, wl_cat2map). 37/37 tests passing. Branch at 597a128, pushed, open for review at MR !5.",
      "createdAt": "2026-02-24T16:57:07.495615748+01:00",
      "closedAt": null,
      "dependsOn": [
        "spectra-py-test-fixes-mr-5-ready-43813e1e",
        "hash-fields-uses-get-mask-not-dba2d38c"
      ]
    },
    {
      "id": "local-main-stale-vs-origin-main-166bdd8c",
      "title": "local main stale vs origin/main",
      "status": "closed",
      "kind": "task",
      "tags": [
        "decision"
      ],
      "outcome": "Local main was 2 commits behind origin/main (WLspectra merge hadn't been pulled). Showed nz.py as 'new' in git diff main...maps_refactor when it was already on remote. Always git fetch + pull main before reviewing branch diffs. Fixed by: git checkout main && git pull origin main.",
      "createdAt": "2026-02-24T16:57:23.126601883+01:00",
      "closedAt": null,
      "dependsOn": []
    }
  ]
}